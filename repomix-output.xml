This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
accounts/__init__.py
accounts/admin.py
accounts/apps.py
accounts/forms.py
accounts/management/commands/__init__.py
accounts/management/commands/create_dean.py
accounts/management/commands/create_superuser.py
accounts/migrations/__init__.py
accounts/models.py
accounts/tests.py
accounts/urls.py
accounts/views.py
chat/__init__.py
chat/admin.py
chat/apps.py
chat/forms.py
chat/migrations/__init__.py
chat/models.py
chat/tests.py
chat/urls.py
chat/views.py
core/__init__.py
core/admin.py
core/apps.py
core/models.py
core/tests.py
core/urls.py
core/views.py
department_platform/__init__.py
department_platform/asgi.py
department_platform/settings.py
department_platform/urls.py
department_platform/wsgi.py
journal/__init__.py
journal/admin.py
journal/apps.py
journal/forms.py
journal/migrations/__init__.py
journal/models.py
journal/tests.py
journal/urls.py
journal/views.py
manage.py
news/__init__.py
news/admin.py
news/apps.py
news/forms.py
news/migrations/__init__.py
news/models.py
news/templatetags/__init__.py
news/templatetags/news_filters.py
news/tests.py
news/urls.py
news/views.py
requirements.txt
schedule/__init__.py
schedule/admin.py
schedule/apps.py
schedule/forms.py
schedule/management/commands/cleanup_schedule.py
schedule/management/commands/create_timeslots.py
schedule/migrations/__init__.py
schedule/models.py
schedule/templatetags/__init__.py
schedule/templatetags/schedule_filters.py
schedule/tests.py
schedule/urls.py
schedule/views.py
static/css/main.css
static/css/performance.css
static/js/main.js
static/js/performance.js
templates/accounts/add_group.html
templates/accounts/add_user.html
templates/accounts/change_password.html
templates/accounts/delete_group.html
templates/accounts/edit_group.html
templates/accounts/edit_profile.html
templates/accounts/edit_user.html
templates/accounts/group_management.html
templates/accounts/login.html
templates/accounts/profile_dean.html
templates/accounts/profile_student.html
templates/accounts/profile_teacher.html
templates/accounts/reset_password.html
templates/accounts/transfer_student.html
templates/accounts/user_management.html
templates/base.html
templates/chat/chat_list.html
templates/chat/chat_room.html
templates/chat/start_chat.html
templates/core/dashboard_dean.html
templates/core/dashboard_student.html
templates/core/dashboard_teacher.html
templates/journal/change_log.html
templates/journal/dean_view.html
templates/journal/department_report.html
templates/journal/group_detailed_report.html
templates/journal/journal_table_weekly.html
templates/journal/select_journal.html
templates/journal/student_view.html
templates/news/news_detail.html
templates/news/news_form.html
templates/news/news_list.html
templates/schedule/bulk_classroom_form.html
templates/schedule/classroom_form.html
templates/schedule/constructor_single.html
templates/schedule/constructor_with_limits.html
templates/schedule/group_list.html
templates/schedule/manage_academic_week.html
templates/schedule/manage_classrooms.html
templates/schedule/manage_semesters.html
templates/schedule/manage_subjects.html
templates/schedule/no_semester.html
templates/schedule/schedule_view_unified.html
templates/schedule/semester_form.html
templates/schedule/subject_form.html
templates/schedule/today_widget.html
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
*.py[cod]
*$py.class
*.so
__pycache__/
*.egg
*.egg-info/
dist/
build/

venv/
env/
ENV/
.venv

*.log
db.sqlite3
db.sqlite3-journal
/media
/staticfiles
/static_root

.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store

.env
.env.local

# ✅ ИСПРАВЛЕНО: Игнорируем файлы миграций, но НЕ __init__.py
*/migrations/[0-9]*.py
# НЕ игнорируем __init__.py в migrations!
</file>

<file path="accounts/__init__.py">

</file>

<file path="accounts/admin.py">
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from .models import User, Student, Teacher, Dean, Group, GroupTransferHistory

@admin.register(User)
class UserAdmin(BaseUserAdmin):
    list_display = ['username', 'first_name', 'last_name', 'role', 'is_active']
    list_filter = ['role', 'is_active', 'is_staff']
    fieldsets = BaseUserAdmin.fieldsets + (
        ('Дополнительная информация', {'fields': ('role', 'phone', 'photo')}),
    )
    add_fieldsets = BaseUserAdmin.add_fieldsets + (
        ('Дополнительная информация', {'fields': ('role', 'phone', 'photo')}),
    )

@admin.register(Group)
class GroupAdmin(admin.ModelAdmin):
    list_display = ['name', 'course', 'academic_year', 'specialty']
    list_filter = ['course', 'academic_year']
    search_fields = ['name', 'specialty']

@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = ['user', 'student_id', 'group', 'course', 'status']
    list_filter = ['course', 'status', 'financing_type', 'education_type']
    search_fields = ['user__first_name', 'user__last_name', 'student_id']
    raw_id_fields = ['user', 'group']

@admin.register(Teacher)
class TeacherAdmin(admin.ModelAdmin):
    list_display = ['user', 'degree', 'title']
    list_filter = ['degree', 'title']
    search_fields = ['user__first_name', 'user__last_name']
    raw_id_fields = ['user']

@admin.register(Dean)
class DeanAdmin(admin.ModelAdmin):
    list_display = ['user', 'contact_email']
    search_fields = ['user__first_name', 'user__last_name']
    raw_id_fields = ['user']

@admin.register(GroupTransferHistory)
class GroupTransferHistoryAdmin(admin.ModelAdmin):
    list_display = ['student', 'from_group', 'to_group', 'transfer_date', 'transferred_by']
    list_filter = ['transfer_date']
    search_fields = ['student__user__first_name', 'student__user__last_name']
    raw_id_fields = ['student', 'from_group', 'to_group', 'transferred_by']
</file>

<file path="accounts/apps.py">
from django.apps import AppConfig

class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'
    verbose_name = 'Управление пользователями'
</file>

<file path="accounts/forms.py">
from django import forms
from django.contrib.auth.forms import UserCreationForm, PasswordChangeForm
from .models import User, Student, Teacher, Dean, Group
from datetime import datetime

class UserCreateForm(forms.ModelForm):
    role = forms.ChoiceField(choices=User.ROLE_CHOICES, label="Роль")
    first_name = forms.CharField(max_length=150, required=True, label="Имя")
    last_name = forms.CharField(max_length=150, required=True, label="Фамилия")
    
    



    class Meta:
        model = User
        fields = ['role', 'first_name', 'last_name', 'phone', 'photo']
    
    def save(self, commit=True):
        user = super().save(commit=False)
        user.username = self.generate_unique_username()
        user.set_password('password123')  
        if commit:
            user.save()
        return user
    
    def generate_unique_username(self):
        year = datetime.now().year
        base_username = f"{year}502"
        
        last_user = User.objects.filter(username__startswith=base_username).order_by('-username').first()
        
        if last_user:
            try:
                last_number = int(last_user.username[len(base_username):])
                new_number = last_number + 1
            except ValueError:
                new_number = 1
        else:
            new_number = 1
        
        return f"{base_username}{new_number:03d}"

class StudentForm(forms.ModelForm):
    class Meta:
        model = Student
        fields = [
            'group', 'student_id', 'course', 'specialty', 'admission_year',
            'financing_type', 'status', 'education_type', 'education_language',
            'birth_date', 'gender', 'nationality',
            'passport_series', 'passport_number', 'passport_issued_by', 'passport_issue_date',
            'registration_address', 'residence_address',
            'sponsor_name', 'sponsor_phone', 'sponsor_relation'
        ]
        widgets = {
            'birth_date': forms.DateInput(attrs={'type': 'date'}),
            'passport_issue_date': forms.DateInput(attrs={'type': 'date'}),
            'registration_address': forms.Textarea(attrs={'rows': 3}),
            'residence_address': forms.Textarea(attrs={'rows': 3}),
        }

class TeacherForm(forms.ModelForm):
    class Meta:
        model = Teacher
        fields = [
            'degree', 'title', 'biography', 'research_interests',
            'consultation_hours', 'telegram', 'contact_email'
        ]
        widgets = {
            'biography': forms.Textarea(attrs={'rows': 4}),
            'research_interests': forms.Textarea(attrs={'rows': 4}),
        }

class DeanForm(forms.ModelForm):
    class Meta:
        model = Dean
        fields = ['office_location', 'reception_hours', 'contact_email']

class UserEditForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ['first_name', 'last_name', 'phone', 'photo']

class CustomPasswordChangeForm(PasswordChangeForm):
    old_password = forms.CharField(
        label="Старый пароль",
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )
    new_password1 = forms.CharField(
        label="Новый пароль",
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )
    new_password2 = forms.CharField(
        label="Подтверждение пароля",
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )

class PasswordResetByDeanForm(forms.Form):
    new_password = forms.CharField(
        label="Новый пароль",
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )
    confirm_password = forms.CharField(
        label="Подтвердите пароль",
        widget=forms.PasswordInput(attrs={'class': 'form-control'})
    )
    
    def clean(self):
        cleaned_data = super().clean()
        password = cleaned_data.get('new_password')
        confirm = cleaned_data.get('confirm_password')
        
        if password != confirm:
            raise forms.ValidationError("Пароли не совпадают")
        
        return cleaned_data

class GroupForm(forms.ModelForm):
    class Meta:
        model = Group
        fields = ['name', 'course', 'academic_year', 'specialty']

class GroupTransferForm(forms.Form):
    to_group = forms.ModelChoiceField(
        queryset=Group.objects.all(),
        label="Новая группа",
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    reason = forms.CharField(
        label="Причина перевода",
        widget=forms.Textarea(attrs={'rows': 3, 'class': 'form-control'}),
        required=False
    )
</file>

<file path="accounts/management/commands/__init__.py">

</file>

<file path="accounts/management/commands/create_dean.py">
from django.core.management.base import BaseCommand
from accounts.models import User, Dean

class Command(BaseCommand):
    help = 'Создание первого пользователя-декана'

    def handle(self, *args, **options):
        username = input("Введите логин: ")
        first_name = input("Введите имя: ")
        last_name = input("Введите фамилию: ")
        password = input("Введите пароль: ")
        
        # ✅ Проверка существующего пользователя
        if User.objects.filter(username=username).exists():
            existing_user = User.objects.get(username=username)
            
            # Если у пользователя уже есть Dean профиль
            if hasattr(existing_user, 'dean_profile'):
                self.stdout.write(self.style.ERROR(
                    f'Пользователь {username} уже является деканом!'
                ))
                return
            
            # Если пользователь существует, но не декан - делаем его деканом
            existing_user.role = 'DEAN'
            existing_user.set_password(password)
            existing_user.save()
            
            # ✅ ИСПРАВЛЕНО: Используем get_or_create вместо create
            Dean.objects.get_or_create(user=existing_user)
            self.stdout.write(self.style.SUCCESS(
                f'Пользователь {username} назначен деканом!'
            ))
            return
        
        # ✅ Создание нового пользователя
        user = User.objects.create_user(
            username=username,
            first_name=first_name,
            last_name=last_name,
            password=password,
            role='DEAN'
        )
        
        # ✅ ИСПРАВЛЕНО: НЕ создаем профиль вручную!
        # Профиль Dean уже создан автоматически через сигнал post_save
        # Просто проверяем, что он создался
        if hasattr(user, 'dean_profile'):
            self.stdout.write(self.style.SUCCESS(
                f'Декан {username} успешно создан! Профиль создан автоматически.'
            ))
        else:
            # На случай если сигнал не сработал - создаем вручную
            Dean.objects.get_or_create(user=user)
            self.stdout.write(self.style.SUCCESS(
                f'Декан {username} успешно создан! Профиль создан вручную.'
            ))
</file>

<file path="accounts/management/commands/create_superuser.py">
from django.core.management.base import BaseCommand
from accounts.models import User, Dean

class Command(BaseCommand):
    help = 'Создание суперпользователя с ролью декана'

    def handle(self, *args, **options):
        username = input("Введите логин суперпользователя: ")
        email = input("Введите email: ")
        password = input("Введите пароль: ")
        
        if User.objects.filter(username=username).exists():
            self.stdout.write(self.style.ERROR(
                f'Пользователь {username} уже существует!'
            ))
            return
        
        # Создаем суперпользователя с ролью DEAN
        user = User.objects.create_superuser(
            username=username,
            email=email,
            password=password,
            first_name='Администратор',
            last_name='Системы',
            role='DEAN'  # ✅ Обязательно указываем роль
        )
        
        # ✅ ИСПРАВЛЕНО: НЕ создаем профиль вручную!
        # Профиль Dean уже создан автоматически через сигнал post_save
        if hasattr(user, 'dean_profile'):
            self.stdout.write(self.style.SUCCESS(
                f'Суперпользователь {username} (декан) успешно создан! Профиль создан автоматически.'
            ))
        else:
            # На случай если сигнал не сработал - создаем вручную
            Dean.objects.get_or_create(user=user)
            self.stdout.write(self.style.SUCCESS(
                f'Суперпользователь {username} (декан) успешно создан! Профиль создан вручную.'
            ))
</file>

<file path="accounts/migrations/__init__.py">

</file>

<file path="accounts/models.py">
from django.db import models
from django.contrib.auth.models import AbstractUser
from django.core.validators import MinValueValidator, MaxValueValidator
from django.db.models.signals import post_save
from django.dispatch import receiver
from datetime import datetime

class User(AbstractUser):
    ROLE_CHOICES = [
        ('STUDENT', 'Студент'),
        ('TEACHER', 'Преподаватель'),
        ('DEAN', 'Декан'),
    ]

    role = models.CharField(
        max_length=10,
        choices=ROLE_CHOICES,
        default='STUDENT',
        blank=False
    )
    phone = models.CharField(max_length=20, blank=True)
    photo = models.ImageField(upload_to='profile_photos/', blank=True, null=True)

    def __str__(self):
        return f"{self.username} ({self.get_role_display()})"

class Group(models.Model):
    name = models.CharField(max_length=50, unique=True, verbose_name="Название группы")
    course = models.IntegerField(validators=[MinValueValidator(1), MaxValueValidator(5)], verbose_name="Курс")
    academic_year = models.IntegerField(verbose_name="Год обучения")
    specialty = models.CharField(max_length=200, verbose_name="Специальность")

    class Meta:
        verbose_name = "Группа"
        verbose_name_plural = "Группы"
        ordering = ['course', 'name']

    def __str__(self):
        return f"{self.name} ({self.course} курс)"

class Student(models.Model):
    GENDER_CHOICES = [
        ('M', 'Мужской'),
        ('F', 'Женский'),
    ]

    FINANCING_CHOICES = [
        ('BUDGET', 'Бюджет'),
        ('CONTRACT', 'Контракт'),
    ]

    STATUS_CHOICES = [
        ('ACTIVE', 'Активный'),
        ('ACADEMIC_LEAVE', 'Академический отпуск'),
        ('EXPELLED', 'Отчислен'),
    ]

    EDUCATION_TYPE_CHOICES = [
        ('FULL_TIME', 'Очное'),
        ('PART_TIME', 'Заочное'),
        ('EVENING', 'Вечернее'),
    ]

    LANGUAGE_CHOICES = [
        ('TJ', 'Таджикский'),
        ('RU', 'Русский'),
        ('EN', 'Английский'),
    ]

    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='student_profile')
    group = models.ForeignKey(Group, on_delete=models.SET_NULL, null=True, blank=True, related_name='students', verbose_name="Группа")

    student_id = models.CharField(max_length=20, unique=True, verbose_name="Номер зачетки")
    course = models.IntegerField(validators=[MinValueValidator(1), MaxValueValidator(5)], verbose_name="Курс")
    specialty = models.CharField(max_length=200, verbose_name="Специальность")
    admission_year = models.IntegerField(verbose_name="Год поступления")

    financing_type = models.CharField(max_length=10, choices=FINANCING_CHOICES, verbose_name="Тип финансирования")
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='ACTIVE', verbose_name="Статус")
    education_type = models.CharField(max_length=10, choices=EDUCATION_TYPE_CHOICES, default='FULL_TIME', verbose_name="Вид обучения")
    education_language = models.CharField(max_length=2, choices=LANGUAGE_CHOICES, verbose_name="Язык обучения")

    birth_date = models.DateField(verbose_name="Дата рождения")
    gender = models.CharField(max_length=1, choices=GENDER_CHOICES, verbose_name="Пол")
    nationality = models.CharField(max_length=50, verbose_name="Национальность")

    passport_series = models.CharField(max_length=10, verbose_name="Серия паспорта")
    passport_number = models.CharField(max_length=20, verbose_name="Номер паспорта")
    passport_issued_by = models.CharField(max_length=200, verbose_name="Кем выдан")
    passport_issue_date = models.DateField(verbose_name="Дата выдачи")

    registration_address = models.TextField(verbose_name="Адрес регистрации")
    residence_address = models.TextField(verbose_name="Адрес проживания")

    sponsor_name = models.CharField(max_length=200, blank=True, verbose_name="ФИО спонсора")
    sponsor_phone = models.CharField(max_length=20, blank=True, verbose_name="Телефон спонсора")
    sponsor_relation = models.CharField(max_length=50, blank=True, verbose_name="Отношение спонсора")

    class Meta:
        verbose_name = "Студент"
        verbose_name_plural = "Студенты"
        ordering = ['course', 'group', 'user__last_name']

    def __str__(self):
        return f"{self.user.get_full_name()} ({self.student_id})"

    def get_average_grade(self):
        try:
            from journal.models import StudentStatistics
            stats, _ = StudentStatistics.objects.get_or_create(student=self)
            stats.recalculate()
            return round(stats.overall_gpa, 2)
        except Exception as e:
            print(f"Ошибка get_average_grade: {e}")
            return 0.0

    def get_total_absent(self):
        try:
            from journal.models import StudentStatistics
            stats, _ = StudentStatistics.objects.get_or_create(student=self)
            stats.recalculate()
            return stats.total_absent
        except Exception as e:
            print(f"Ошибка get_total_absent: {e}")
            return 0

    def get_absent_breakdown(self):
        try:
            from journal.models import StudentStatistics
            stats, _ = StudentStatistics.objects.get_or_create(student=self)
            stats.recalculate()
            return {
                'illness': stats.absent_illness,
                'valid': stats.absent_valid,
                'invalid': stats.absent_invalid,
                'total': stats.total_absent
            }
        except Exception as e:
            print(f"Ошибка get_absent_breakdown: {e}")
            return {
                'illness': 0,
                'valid': 0,
                'invalid': 0,
                'total': 0
            }

    def get_attendance_percentage(self):
        try:
            from journal.models import StudentStatistics
            stats, _ = StudentStatistics.objects.get_or_create(student=self)
            stats.recalculate()
            return round(stats.attendance_percentage, 1)
        except Exception as e:
            print(f"Ошибка get_attendance_percentage: {e}")
            return 0.0

    def get_group_rank(self):
        try:
            from journal.models import StudentStatistics
            stats, _ = StudentStatistics.objects.get_or_create(student=self)
            stats.recalculate()
            return stats.group_rank
        except Exception as e:
            print(f"Ошибка get_group_rank: {e}")
            return 0

class Teacher(models.Model):
    DEGREE_CHOICES = [
        ('NONE', 'Без степени'),
        ('CANDIDATE', 'Кандидат наук'),
        ('DOCTOR', 'Доктор наук'),
    ]

    TITLE_CHOICES = [
        ('NONE', 'Без звания'),
        ('ASSISTANT', 'Ассистент'),
        ('SENIOR_TEACHER', 'Старший преподаватель'),
        ('DOCENT', 'Доцент'),
        ('PROFESSOR', 'Профессор'),
    ]

    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='teacher_profile')

    degree = models.CharField(max_length=20, choices=DEGREE_CHOICES, default='NONE', verbose_name="Ученая степень")
    title = models.CharField(max_length=20, choices=TITLE_CHOICES, default='NONE', verbose_name="Ученое звание")

    biography = models.TextField(blank=True, verbose_name="Биография")
    research_interests = models.TextField(blank=True, verbose_name="Научные интересы")

    consultation_hours = models.CharField(max_length=200, blank=True, verbose_name="Часы консультаций")
    telegram = models.CharField(max_length=100, blank=True, verbose_name="Telegram")
    contact_email = models.EmailField(blank=True, verbose_name="Email для связи")

    class Meta:
        verbose_name = "Преподаватель"
        verbose_name_plural = "Преподаватели"
        ordering = ['user__last_name']

    def __str__(self):
        return f"{self.get_degree_display()} {self.user.get_full_name()}"

class Dean(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='dean_profile')

    office_location = models.CharField(max_length=200, blank=True, verbose_name="Местоположение офиса")
    reception_hours = models.CharField(max_length=200, blank=True, verbose_name="Часы приема")
    contact_email = models.EmailField(blank=True, verbose_name="Email для связи")

    class Meta:
        verbose_name = "Декан"
        verbose_name_plural = "Деканы"

    def __str__(self):
        return f"Декан: {self.user.get_full_name()}"

class GroupTransferHistory(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='transfer_history')
    from_group = models.ForeignKey(Group, on_delete=models.SET_NULL, null=True, related_name='transfers_from')
    to_group = models.ForeignKey(Group, on_delete=models.SET_NULL, null=True, related_name='transfers_to')
    transfer_date = models.DateTimeField(auto_now_add=True)
    reason = models.TextField(blank=True)
    transferred_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)

    class Meta:
        verbose_name = "История переводов"
        verbose_name_plural = "История переводов"
        ordering = ['-transfer_date']

    def __str__(self):
        return f"{self.student}: {self.from_group} → {self.to_group}"

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    if created:
        if instance.role == 'STUDENT':
            year = datetime.now().year
            base_id = f"{year}S"

            last_student = Student.objects.filter(
                student_id__startswith=base_id
            ).order_by('-student_id').first()

            if last_student:
                try:
                    last_number = int(last_student.student_id[len(base_id):])
                    new_number = last_number + 1
                except (ValueError, IndexError):
                    new_number = 1
            else:
                new_number = 1

            student_id = f"{base_id}{new_number:04d}"

            Student.objects.create(
                user=instance,
                student_id=student_id,
                course=1,
                specialty='Не указано',
                admission_year=year,
                financing_type='BUDGET',
                education_type='FULL_TIME',
                education_language='RU',
                birth_date='2000-01-01',
                gender='M',
                nationality='Не указано',
                passport_series='AA',
                passport_number='0000000',
                passport_issued_by='Не указано',
                passport_issue_date='2000-01-01',
                registration_address='Не указано',
                residence_address='Не указано'
            )
        elif instance.role == 'TEACHER':
            Teacher.objects.get_or_create(user=instance)
        elif instance.role == 'DEAN':
            Dean.objects.get_or_create(user=instance)
</file>

<file path="accounts/tests.py">
from django.test import TestCase
</file>

<file path="accounts/urls.py">
from django.urls import path
from . import views

app_name = 'accounts'

urlpatterns = [
    path('login/', views.login_view, name='login'),
    path('logout/', views.logout_view, name='logout'),
    path('profile/', views.profile_view, name='profile'),
    path('profile/edit/', views.edit_profile, name='edit_profile'),
    path('password/change/', views.change_password, name='change_password'),

    path('management/', views.user_management, name='user_management'),
    path('management/add/', views.add_user, name='add_user'),
    path('management/edit/<int:user_id>/', views.edit_user, name='edit_user'),
    path('management/reset-password/<int:user_id>/', views.reset_password, name='reset_password'),
    path('management/toggle-active/<int:user_id>/', views.toggle_user_active, name='toggle_user_active'),
    path('management/transfer/<int:student_id>/', views.transfer_student, name='transfer_student'),


    path('groups/', views.group_management, name='group_management'),
    path('groups/add/', views.add_group, name='add_group'),
    path('groups/edit/<int:group_id>/', views.edit_group, name='edit_group'),
    path('profile/view/<int:user_id>/', views.view_user_profile, name='view_user_profile'),
    path('groups/delete/<int:group_id>/', views.delete_group, name='delete_group'),
]
</file>

<file path="accounts/views.py">
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import login, logout, authenticate, update_session_auth_hash
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from django.db import transaction
from django.db import models
from .models import User, Student, Teacher, Dean, Group, GroupTransferHistory
from .forms import (UserCreateForm, StudentForm, TeacherForm, DeanForm, 
                   UserEditForm, CustomPasswordChangeForm, PasswordResetByDeanForm,
                   GroupForm, GroupTransferForm)

from django.core.exceptions import ObjectDoesNotExist


def generate_student_id():
    
    from datetime import datetime
    
    year = datetime.now().year
    base_id = f"{year}S"  
    
    
    last_student = Student.objects.filter(
        student_id__startswith=base_id
    ).order_by('-student_id').first()
    
    if last_student:
        try:
            
            last_number = int(last_student.student_id[len(base_id):])
            new_number = last_number + 1
        except (ValueError, IndexError):
            new_number = 1
    else:
        new_number = 1
    
    
    return f"{base_id}{new_number:04d}"










def is_dean(user):
    return user.is_authenticated and user.role == 'DEAN'

def login_view(request):
    if request.user.is_authenticated:
        return redirect('core:dashboard')
    
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(request, username=username, password=password)
        
        if user is not None:
            login(request, user)
            return redirect('core:dashboard')
        else:
            messages.error(request, 'Неверный логин или пароль')
    
    return render(request, 'accounts/login.html')

@login_required
def logout_view(request):
    logout(request)
    messages.success(request, 'Вы успешно вышли из системы')
    return redirect('accounts:login')



@login_required
def profile_view(request):
    user = request.user
    profile = None
    context = {'profile': profile}
    
    if user.role == 'STUDENT':
        profile = get_object_or_404(Student, user=user)
        # Добавляем статистику для студента
        from journal.models import StudentStatistics
        stats, _ = StudentStatistics.objects.get_or_create(student=profile)
        stats.recalculate()
        profile.statistics = stats
        context['profile'] = profile
        
    elif user.role == 'TEACHER':
        profile = get_object_or_404(Teacher, user=user)
        
        # Получаем группы преподавателя с статистикой
        from schedule.models import ScheduleSlot
        from journal.models import StudentStatistics
        from django.db.models import Avg
        
        # Находим все группы, у которых этот преподаватель ведет занятия
        group_ids = ScheduleSlot.objects.filter(
            teacher=profile,
            is_active=True
        ).values_list('group_id', flat=True).distinct()
        
        groups = Group.objects.filter(id__in=group_ids)
        
        teacher_groups = []
        for group in groups:
            students = Student.objects.filter(group=group)
            students_count = students.count()
            
            if students_count > 0:
                # Рассчитываем средний GPA и посещаемость
                stats_list = []
                for student in students:
                    stats, _ = StudentStatistics.objects.get_or_create(student=student)
                    stats_list.append(stats)
                
                avg_gpa = sum(s.overall_gpa for s in stats_list) / len(stats_list) if stats_list else 0
                avg_attendance = sum(s.attendance_percentage for s in stats_list) / len(stats_list) if stats_list else 0
                
                teacher_groups.append({
                    'group': group,
                    'students_count': students_count,
                    'avg_gpa': avg_gpa,
                    'avg_attendance': avg_attendance,
                })
        
        context['profile'] = profile
        context['teacher_groups'] = teacher_groups
        
        # Добавляем расписание на сегодня
        from datetime import datetime
        today = datetime.now()
        day_of_week = today.weekday()
        current_time = today.time()
        
        classes = ScheduleSlot.objects.filter(
            teacher=profile,
            day_of_week=day_of_week,
            is_active=True
        ).select_related('subject', 'group').order_by('start_time')
        
        context['classes'] = classes
        context['current_time'] = current_time
        context['today'] = today
        
    elif user.role == 'DEAN':
        profile = get_object_or_404(Dean, user=user)
        context['profile'] = profile
    
    template_name = f'accounts/profile_{user.role.lower()}.html'
    return render(request, template_name, context)

@login_required
def edit_profile(request):
    user = request.user
    
    if request.method == 'POST':
        user_form = UserEditForm(request.POST, request.FILES, instance=user)
        
        profile_form = None
        if user.role == 'STUDENT':
            profile_form = StudentForm(request.POST, instance=user.student_profile)
        elif user.role == 'TEACHER':
            profile_form = TeacherForm(request.POST, instance=user.teacher_profile)
        elif user.role == 'DEAN':
            profile_form = DeanForm(request.POST, instance=user.dean_profile)
        
        if user_form.is_valid() and (profile_form is None or profile_form.is_valid()):
            user_form.save()
            if profile_form:
                profile_form.save()
            messages.success(request, 'Профиль успешно обновлен')
            return redirect('accounts:profile')
    else:
        user_form = UserEditForm(instance=user)
        
        profile_form = None
        if user.role == 'STUDENT':
            profile_form = StudentForm(instance=user.student_profile)
        elif user.role == 'TEACHER':
            profile_form = TeacherForm(instance=user.teacher_profile)
        elif user.role == 'DEAN':
            profile_form = DeanForm(instance=user.dean_profile)
    
    return render(request, 'accounts/edit_profile.html', {
        'user_form': user_form,
        'profile_form': profile_form
    })

@login_required
def change_password(request):
    if request.method == 'POST':
        form = CustomPasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)
            messages.success(request, 'Пароль успешно изменен')
            return redirect('accounts:profile')
    else:
        form = CustomPasswordChangeForm(request.user)
    
    return render(request, 'accounts/change_password.html', {'form': form})

@user_passes_test(is_dean)
def user_management(request):
    role_filter = request.GET.get('role', '')
    search = request.GET.get('search', '')
    
    users = User.objects.all()
    
    if role_filter:
        users = users.filter(role=role_filter)
    
    if search:
        users = users.filter(
            models.Q(username__icontains=search) |
            models.Q(first_name__icontains=search) |
            models.Q(last_name__icontains=search)
        )
    
    # ✅ ИСПРАВЛЕНО: Безопасная загрузка профилей
    users = users.select_related('student_profile', 'teacher_profile', 'dean_profile')
    
    users_with_profiles = []
    for user_obj in users:
        user_data = {
            'user': user_obj,
            'has_profile': True,
            'profile_id': None
        }
        
        # ✅ Безопасная проверка существования профилей
        try:
            if user_obj.role == 'STUDENT':
                if hasattr(user_obj, 'student_profile'):
                    user_data['profile_id'] = user_obj.student_profile.id
                else:
                    user_data['has_profile'] = False
                    
            elif user_obj.role == 'TEACHER':
                if not hasattr(user_obj, 'teacher_profile'):
                    user_data['has_profile'] = False
                    
            elif user_obj.role == 'DEAN':
                if not hasattr(user_obj, 'dean_profile'):
                    user_data['has_profile'] = False
                    
        except ObjectDoesNotExist:
            user_data['has_profile'] = False
        
        users_with_profiles.append(user_data)
    
    return render(request, 'accounts/user_management.html', {
        'users': users,
        'users_with_profiles': users_with_profiles,
        'role_filter': role_filter,
        'search': search
    })

@user_passes_test(is_dean)
def add_user(request):
    if request.method == 'POST':
        user_form = UserCreateForm(request.POST, request.FILES)
        
        if user_form.is_valid():
            with transaction.atomic():
                user = user_form.save()
                
                role = user_form.cleaned_data['role']
                
                # ✅ ИСПРАВЛЕНО: Профили создаются автоматически через сигнал post_save
                # Просто проверяем, что они создались
                try:
                    if role == 'STUDENT':
                        # Проверяем, не существует ли уже профиль студента
                        if not hasattr(user, 'student_profile'):
                            student_id = generate_student_id()
                            Student.objects.create(
                                user=user,
                                student_id=student_id,
                                course=1,
                                specialty='',
                                admission_year=2025,
                                financing_type='BUDGET',
                                education_type='FULL_TIME',
                                education_language='RU',
                                birth_date='2000-01-01',
                                gender='M',
                                nationality='',
                                passport_series='',
                                passport_number='',
                                passport_issued_by='',
                                passport_issue_date='2000-01-01',
                                registration_address='',
                                residence_address=''
                            )
                    elif role == 'TEACHER':
                        # Проверяем через get_or_create (на случай если сигнал не сработал)
                        Teacher.objects.get_or_create(user=user)
                    elif role == 'DEAN':
                        # Проверяем через get_or_create (на случай если сигнал не сработал)
                        Dean.objects.get_or_create(user=user)
                    
                    messages.success(request, f'Пользователь {user.username} успешно создан. Временный пароль: password123')
                    return redirect('accounts:user_management')
                    
                except Exception as e:
                    messages.error(request, f'Ошибка при создании профиля: {str(e)}')
                    raise
    else:
        user_form = UserCreateForm()
    
    return render(request, 'accounts/add_user.html', {'form': user_form})

@user_passes_test(is_dean)
def edit_user(request, user_id):
    user_obj = get_object_or_404(User, id=user_id)
    
    if request.method == 'POST':
        user_form = UserEditForm(request.POST, request.FILES, instance=user_obj)
        
        profile_form = None
        if user_obj.role == 'STUDENT':
            profile_form = StudentForm(request.POST, instance=user_obj.student_profile)
        elif user_obj.role == 'TEACHER':
            profile_form = TeacherForm(request.POST, instance=user_obj.teacher_profile)
        elif user_obj.role == 'DEAN':
            profile_form = DeanForm(request.POST, instance=user_obj.dean_profile)
        
        if user_form.is_valid() and (profile_form is None or profile_form.is_valid()):
            user_form.save()
            if profile_form:
                profile_form.save()
            messages.success(request, 'Пользователь успешно обновлен')
            return redirect('accounts:user_management')
    else:
        user_form = UserEditForm(instance=user_obj)
        
        profile_form = None
        if user_obj.role == 'STUDENT':
            profile_form = StudentForm(instance=user_obj.student_profile)
        elif user_obj.role == 'TEACHER':
            profile_form = TeacherForm(instance=user_obj.teacher_profile)
        elif user_obj.role == 'DEAN':
            profile_form = DeanForm(instance=user_obj.dean_profile)
    
    return render(request, 'accounts/edit_user.html', {
        'user_form': user_form,
        'profile_form': profile_form,
        'user_obj': user_obj
    })

@user_passes_test(is_dean)
def reset_password(request, user_id):
    user_obj = get_object_or_404(User, id=user_id)
    
    if request.method == 'POST':
        form = PasswordResetByDeanForm(request.POST)
        if form.is_valid():
            new_password = form.cleaned_data['new_password']
            user_obj.set_password(new_password)
            user_obj.save()
            messages.success(request, f'Пароль для {user_obj.username} успешно сброшен')
            return redirect('accounts:user_management')
    else:
        form = PasswordResetByDeanForm()
    
    return render(request, 'accounts/reset_password.html', {
        'form': form,
        'user_obj': user_obj
    })

@user_passes_test(is_dean)
def toggle_user_active(request, user_id):
    user_obj = get_object_or_404(User, id=user_id)
    
    # ✅ ЗАЩИТА: Нельзя заблокировать самого себя
    if user_obj.id == request.user.id:
        messages.error(request, '❌ Вы не можете заблокировать сам себя!')
        return redirect('accounts:user_management')
    
    # ✅ ЗАЩИТА: Нельзя заблокировать других суперпользователей (опционально)
    if user_obj.is_superuser and not request.user.is_superuser:
        messages.error(request, '❌ Вы не можете заблокировать суперпользователя!')
        return redirect('accounts:user_management')
    
    user_obj.is_active = not user_obj.is_active
    user_obj.save()
    
    status = "активирован" if user_obj.is_active else "заблокирован"
    messages.success(request, f'Пользователь {user_obj.username} {status}')
    return redirect('accounts:user_management')

@user_passes_test(is_dean)
def transfer_student(request, student_id):
    student = get_object_or_404(Student, id=student_id)
    
    if request.method == 'POST':
        form = GroupTransferForm(request.POST)
        if form.is_valid():
            with transaction.atomic():
                old_group = student.group
                new_group = form.cleaned_data['to_group']
                
                GroupTransferHistory.objects.create(
                    student=student,
                    from_group=old_group,
                    to_group=new_group,
                    reason=form.cleaned_data['reason'],
                    transferred_by=request.user
                )
                
                student.group = new_group
                student.save()
                
                messages.success(request, f'Студент переведен из {old_group} в {new_group}')
                return redirect('accounts:user_management')
    else:
        form = GroupTransferForm()
    
    return render(request, 'accounts/transfer_student.html', {
        'form': form,
        'student': student
    })

# В accounts/views.py заменить функцию view_user_profile на эту:

@login_required
def view_user_profile(request, user_id):
    """Просмотр профиля пользователя деканом"""
    if request.user.role != 'DEAN':
        messages.error(request, 'Доступ запрещен')
        return redirect('core:dashboard')
    
    user_obj = get_object_or_404(User, id=user_id)
    profile = None
    template = 'accounts/profile_student.html'
    context = {
        'user': user_obj,
        'viewing_as_dean': True
    }
    
    if user_obj.role == 'STUDENT':
        profile = get_object_or_404(Student, user=user_obj)
        # Получаем или создаем статистику
        from journal.models import StudentStatistics
        stats, _ = StudentStatistics.objects.get_or_create(student=profile)
        stats.recalculate()
        profile.statistics = stats
        context['profile'] = profile
        template = 'accounts/profile_student.html'
        
    elif user_obj.role == 'TEACHER':
        profile = get_object_or_404(Teacher, user=user_obj)
        
        # Получаем группы преподавателя с статистикой
        from schedule.models import ScheduleSlot
        from journal.models import StudentStatistics
        
        group_ids = ScheduleSlot.objects.filter(
            teacher=profile,
            is_active=True
        ).values_list('group_id', flat=True).distinct()
        
        groups = Group.objects.filter(id__in=group_ids)
        
        teacher_groups = []
        for group in groups:
            students = Student.objects.filter(group=group)
            students_count = students.count()
            
            if students_count > 0:
                stats_list = []
                for student in students:
                    stats, _ = StudentStatistics.objects.get_or_create(student=student)
                    stats_list.append(stats)
                
                avg_gpa = sum(s.overall_gpa for s in stats_list) / len(stats_list) if stats_list else 0
                avg_attendance = sum(s.attendance_percentage for s in stats_list) / len(stats_list) if stats_list else 0
                
                teacher_groups.append({
                    'group': group,
                    'students_count': students_count,
                    'avg_gpa': avg_gpa,
                    'avg_attendance': avg_attendance,
                })
        
        context['profile'] = profile
        context['teacher_groups'] = teacher_groups
        
        # Добавляем расписание на сегодня
        from datetime import datetime
        today = datetime.now()
        day_of_week = today.weekday()
        current_time = today.time()
        
        classes = ScheduleSlot.objects.filter(
            teacher=profile,
            day_of_week=day_of_week,
            is_active=True
        ).select_related('subject', 'group').order_by('start_time')
        
        context['classes'] = classes
        context['current_time'] = current_time
        context['today'] = today
        
        template = 'accounts/profile_teacher.html'
        
    elif user_obj.role == 'DEAN':
        profile = get_object_or_404(Dean, user=user_obj)
        context['profile'] = profile
        template = 'accounts/profile_dean.html'
    
    return render(request, template, context)


@user_passes_test(is_dean)
def group_management(request):
    
    groups = Group.objects.all().order_by('course', 'name')
    
    search = request.GET.get('search', '')
    course_filter = request.GET.get('course', '')
    
    if search:
        #group_management(request=)
        groups = groups.filter(
            models.Q(name__icontains=search) |
            models.Q(specialty__icontains=search)
        )
    
    if course_filter:
        groups = groups.filter(course=course_filter)
    
    return render(request, 'accounts/group_management.html', {
        'groups': groups,
        'search': search,
        'course_filter': course_filter,
    })

@user_passes_test(is_dean)
def add_group(request):
    
    if request.method == 'POST':
        form = GroupForm(request.POST)
        if form.is_valid():
            group = form.save()
            messages.success(request, f'Группа {group.name} успешно создана')
            return redirect('accounts:group_management')
    else:
        form = GroupForm()
    
    return render(request, 'accounts/add_group.html', {'form': form})

@user_passes_test(is_dean)
def edit_group(request, group_id):
    
    group = get_object_or_404(Group, id=group_id)
    
    if request.method == 'POST':
        form = GroupForm(request.POST, instance=group)
        if form.is_valid():
            form.save()
            messages.success(request, f'Группа {group.name} успешно обновлена')
            return redirect('accounts:group_management')
    else:
        form = GroupForm(instance=group)
    
    return render(request, 'accounts/edit_group.html', {
        'form': form,
        'group': group
    })

@user_passes_test(is_dean)
def delete_group(request, group_id):
    
    group = get_object_or_404(Group, id=group_id)
    
    students_count = Student.objects.filter(group=group).count()
    
    if request.method == 'POST':
        if students_count > 0:
            messages.error(request, f'Невозможно удалить группу {group.name}. В ней есть {students_count} студентов.')
        else:
            group_name = group.name
            group.delete()
            messages.success(request, f'Группа {group_name} успешно удалена')
        return redirect('accounts:group_management')
    
    return render(request, 'accounts/delete_group.html', {
        'group': group,
        'students_count': students_count
    })
</file>

<file path="chat/__init__.py">

</file>

<file path="chat/admin.py">
from django.contrib import admin
from .models import ChatRoom, ChatMessage

@admin.register(ChatRoom)
class ChatRoomAdmin(admin.ModelAdmin):
    list_display = ['id', 'name', 'room_type', 'participants_count', 'created_at', 'updated_at']
    list_filter = ['room_type', 'created_at']
    search_fields = ['name']
    filter_horizontal = ['participants']
    readonly_fields = ['created_at', 'updated_at']
    
    def participants_count(self, obj):
        return obj.participants.count()
    participants_count.short_description = 'Участников'

@admin.register(ChatMessage)
class ChatMessageAdmin(admin.ModelAdmin):
    list_display = ['sender', 'room', 'content_preview', 'is_read', 'created_at']
    list_filter = ['is_read', 'created_at']
    search_fields = ['content', 'sender__first_name', 'sender__last_name']
    date_hierarchy = 'created_at'
    readonly_fields = ['created_at']
    
    def content_preview(self, obj):
        return obj.content[:50] + '...' if len(obj.content) > 50 else obj.content
    content_preview.short_description = 'Сообщение'
</file>

<file path="chat/apps.py">
from django.apps import AppConfig

class ChatConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'chat'
    verbose_name = 'Чаты'
</file>

<file path="chat/forms.py">
from django import forms
from .models import ChatMessage



class ChatMessageForm(forms.ModelForm):
    class Meta:
        model = ChatMessage
        fields = ['content']
        widgets = {
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 2,
                'placeholder': 'Введите сообщение...',
            })
        }
</file>

<file path="chat/migrations/__init__.py">

</file>

<file path="chat/models.py">
from django.db import models
from accounts.models import User

class ChatRoom(models.Model):

    ROOM_TYPE_CHOICES = [
        ('PRIVATE', 'Личный'),
        ('GROUP', 'Групповой'),
    ]
    
    name = models.CharField(
        max_length=200,
        blank=True,
        verbose_name="Название"
    )
    
    room_type = models.CharField(
        max_length=10,
        choices=ROOM_TYPE_CHOICES,
        default='PRIVATE',
        verbose_name="Тип комнаты"
    )
    
    participants = models.ManyToManyField(
        User,
        related_name='chat_rooms',
        verbose_name="Участники"
    )
    
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Создан")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Обновлен")
    
    class Meta:
        verbose_name = "Чат"
        verbose_name_plural = "Чаты"
        ordering = ['-updated_at']
    
    def __str__(self):
        if self.name:
            return self.name
        
        names = [p.get_full_name() for p in self.participants.all()[:2]]
        return " — ".join(names)
    
    def get_last_message(self):
        
        return self.messages.order_by('-created_at').first()
    
    def get_unread_count(self, user):
        
        return self.messages.filter(is_read=False).exclude(sender=user).count()

class ChatMessage(models.Model):

    room = models.ForeignKey(
        ChatRoom,
        on_delete=models.CASCADE,
        related_name='messages',
        verbose_name="Комната"
    )
    
    sender = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='sent_messages',
        verbose_name="Отправитель"
    )
    
    content = models.TextField(verbose_name="Сообщение")
    
    is_read = models.BooleanField(default=False, verbose_name="Прочитано")
    
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Дата отправки")
    
    class Meta:
        verbose_name = "Сообщение"
        verbose_name_plural = "Сообщения"
        ordering = ['created_at']
    
    def __str__(self):
        return f"{self.sender.get_full_name()}: {self.content[:50]}"
</file>

<file path="chat/tests.py">
from django.test import TestCase
</file>

<file path="chat/urls.py">
from django.urls import path
from . import views

app_name = 'chat'

urlpatterns = [
    path('', views.chat_list, name='list'),
    path('room/<int:room_id>/', views.chat_room, name='room'),
    path('start/', views.start_chat, name='start'),
    path('message/<int:message_id>/delete/', views.delete_message, name='delete_message'),
    path('room/<int:room_id>/new-messages/', views.get_new_messages, name='new_messages'),
]
</file>

<file path="chat/views.py">
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.db.models import Q, Count, Max
from django.http import JsonResponse
from accounts.models import User
from .models import ChatRoom, ChatMessage
from .forms import ChatMessageForm

@login_required
def chat_list(request):
    
    rooms = ChatRoom.objects.filter(
        participants=request.user
    ).annotate(
        last_message_time=Max('messages__created_at')
    ).order_by('-last_message_time')

    for room in rooms:
        room.unread = room.get_unread_count(request.user)
        room.last_msg = room.get_last_message()
    
    return render(request, 'chat/chat_list.html', {
        'rooms': rooms,
    })

@login_required
def chat_room(request, room_id):
    
    room = get_object_or_404(ChatRoom, id=room_id, participants=request.user)

    messages_list = room.messages.select_related('sender').order_by('created_at')

    room.messages.filter(is_read=False).exclude(sender=request.user).update(is_read=True)

    if request.method == 'POST':
        form = ChatMessageForm(request.POST)
        if form.is_valid():
            message = form.save(commit=False)
            message.room = room
            message.sender = request.user
            message.save()

            room.save()
            
            return redirect('chat:room', room_id=room_id)
    else:
        form = ChatMessageForm()

    other_participants = room.participants.exclude(id=request.user.id)
    
    return render(request, 'chat/chat_room.html', {
        'room': room,
        'messages': messages_list,
        'form': form,
        'other_participants': other_participants,
    })

@login_required
def start_chat(request):
    
    if request.method == 'POST':
        user_id = request.POST.get('user_id')
        recipient = get_object_or_404(User, id=user_id)

        existing_room = ChatRoom.objects.filter(
            room_type='PRIVATE',
            participants=request.user
        ).filter(
            participants=recipient
        ).first()
        
        if existing_room:
            return redirect('chat:room', room_id=existing_room.id)

        room = ChatRoom.objects.create(room_type='PRIVATE')
        room.participants.add(request.user, recipient)
        
        messages.success(request, f'Чат с {recipient.get_full_name()} создан')
        return redirect('chat:room', room_id=room.id)

    users = User.objects.exclude(id=request.user.id).select_related(
        'student_profile', 'teacher_profile', 'dean_profile'
    )
    
    return render(request, 'chat/start_chat.html', {
        'users': users,
    })

@login_required
def delete_message(request, message_id):
    
    message = get_object_or_404(ChatMessage, id=message_id, sender=request.user)
    room_id = message.room.id
    message.delete()
    messages.success(request, 'Сообщение удалено')
    return redirect('chat:room', room_id=room_id)

@login_required
def get_new_messages(request, room_id):
    
    room = get_object_or_404(ChatRoom, id=room_id, participants=request.user)
    last_message_id = request.GET.get('last_id', 0)
    
    new_messages = room.messages.filter(
        id__gt=last_message_id
    ).select_related('sender').order_by('created_at')
    
    messages_data = []
    for msg in new_messages:
        messages_data.append({
            'id': msg.id,
            'sender_id': msg.sender.id,
            'sender_name': msg.sender.get_full_name(),
            'content': msg.content,
            'created_at': msg.created_at.strftime('%H:%M'),
            'is_mine': msg.sender == request.user,
        })
    
    return JsonResponse({'messages': messages_data})
</file>

<file path="core/__init__.py">

</file>

<file path="core/admin.py">
from django.contrib import admin
</file>

<file path="core/apps.py">
from django.apps import AppConfig

class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'core'
    verbose_name = 'Основной функционал'
</file>

<file path="core/models.py">
from django.db import models
</file>

<file path="core/tests.py">
from django.test import TestCase
</file>

<file path="core/urls.py">
from django.urls import path
from . import views

app_name = 'core'

urlpatterns = [
    path('', views.dashboard, name='dashboard'),
]
</file>

<file path="core/views.py">
from django.shortcuts import render
from django.contrib.auth.decorators import login_required
from datetime import datetime
from django.db.models import Avg, Count

@login_required
def dashboard(request):
    user = request.user
    
    template_map = {
        'STUDENT': 'core/dashboard_student.html',
        'TEACHER': 'core/dashboard_teacher.html',
        'DEAN': 'core/dashboard_dean.html',
    }
    
    template = template_map.get(user.role, 'core/dashboard_dean.html')
    
    context = {
        'user': user
    }

    from news.models import News
    context['news_list'] = News.objects.filter(is_published=True).order_by('-is_pinned', '-created_at')[:5]
    
    if user.role == 'STUDENT':
        context['profile'] = user.student_profile
    elif user.role == 'TEACHER':
        context['profile'] = user.teacher_profile
    elif user.role == 'DEAN':
        context['profile'] = user.dean_profile

        from accounts.models import Student, Teacher, Group
        from journal.models import StudentStatistics
        
        context['total_students'] = Student.objects.count()
        context['total_teachers'] = Teacher.objects.count()
        context['total_groups'] = Group.objects.count()
        
        all_stats = StudentStatistics.objects.all()
        if all_stats.exists():
            context['avg_gpa'] = all_stats.aggregate(Avg('overall_gpa'))['overall_gpa__avg'] or 0
        else:
            context['avg_gpa'] = 0
        
        course_stats = []
        for course_num in range(1, 6):
            groups = Group.objects.filter(course=course_num)
            students = Student.objects.filter(group__course=course_num)
            
            if students.exists():
                stats = StudentStatistics.objects.filter(student__in=students)
                course_stats.append({
                    'course': course_num,
                    'groups_count': groups.count(),
                    'students_count': students.count(),
                    'avg_gpa': stats.aggregate(Avg('overall_gpa'))['overall_gpa__avg'] or 0,
                    'avg_attendance': stats.aggregate(Avg('attendance_percentage'))['attendance_percentage__avg'] or 0,
                })
        
        context['course_stats'] = course_stats

    try:
        from schedule.models import ScheduleSlot
        from accounts.models import Student, Teacher
        
        today = datetime.now()
        day_of_week = today.weekday()
        current_time = today.time()
        
        classes = []
        if user.role == 'STUDENT':
            try:
                student = user.student_profile
                if student.group:
                    
                    classes = ScheduleSlot.objects.filter(
                        group=student.group,
                        day_of_week=day_of_week,
                        is_active=True
                    ).select_related('subject', 'teacher').order_by('start_time')
            except Student.DoesNotExist:
                pass
        
        elif user.role == 'TEACHER':
            try:
                teacher = user.teacher_profile
                classes = ScheduleSlot.objects.filter(
                    teacher=teacher,
                    day_of_week=day_of_week,
                    is_active=True
                ).select_related('subject', 'group').order_by('start_time')
            except Teacher.DoesNotExist:
                pass
        
        context['classes'] = classes
        context['current_time'] = current_time
        context['today'] = today
        
    except Exception as e:
        context['classes'] = []
        context['current_time'] = datetime.now().time()
        context['today'] = datetime.now()
    
    return render(request, template, context)
</file>

<file path="department_platform/__init__.py">

</file>

<file path="department_platform/asgi.py">
import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'department_platform.settings')

application = get_asgi_application()
</file>

<file path="department_platform/settings.py">
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = 'django-insecure-your-secret-key-change-in-production'

DEBUG = True

ALLOWED_HOSTS = ['*']

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # ВАШИ ПРИЛОЖЕНИЯ - ОБЯЗАТЕЛЬНО ДОЛЖНЫ БЫТЬ!
    'accounts.apps.AccountsConfig',      # ← ПРОВЕРЬТЕ
    'journal.apps.JournalConfig',        # ← ПРОВЕРЬТЕ
    'schedule.apps.ScheduleConfig',      # ← ПРОВЕРЬТЕ
    'news.apps.NewsConfig',              # ← ПРОВЕРЬТЕ
    'chat.apps.ChatConfig',              # ← ПРОВЕРЬТЕ
    'core.apps.CoreConfig',              # ← ПРОВЕРЬТЕ
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware', 
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'department_platform.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'department_platform.wsgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

LANGUAGE_CODE = 'ru-ru'

TIME_ZONE = 'Asia/Dushanbe'

USE_I18N = True

USE_TZ = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
CSRF_TRUSTED_ORIGINS = ['https://*.ngrok-free.app']
STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
STATIC_ROOT = BASE_DIR / 'staticfiles'

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

AUTH_USER_MODEL = 'accounts.User'

LOGIN_URL = 'accounts:login'
LOGIN_REDIRECT_URL = 'core:dashboard'
LOGOUT_REDIRECT_URL = 'accounts:login'

FILE_UPLOAD_MAX_MEMORY_SIZE = 104857600  
DATA_UPLOAD_MAX_MEMORY_SIZE = 104857600
</file>

<file path="department_platform/urls.py">
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('accounts/', include('accounts.urls')),
    path('schedule/', include('schedule.urls')),
    path('journal/', include('journal.urls')),
    path('news/', include('news.urls')),  
    path('chat/', include('chat.urls')),  
    path('', include('core.urls')),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
</file>

<file path="department_platform/wsgi.py">
import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'department_platform.settings')

application = get_wsgi_application()
</file>

<file path="journal/__init__.py">

</file>

<file path="journal/admin.py">
from django.contrib import admin
from django.utils.html import format_html
from .models import JournalEntry, JournalChangeLog, StudentStatistics

@admin.register(JournalEntry)
class JournalEntryAdmin(admin.ModelAdmin):
    list_display = ['student', 'subject', 'lesson_date', 'lesson_time', 
                    'grade', 'attendance_status', 'is_locked_display', 'modified_by']
    list_filter = ['lesson_date', 'subject', 'attendance_status', 'lesson_type']
    search_fields = ['student__user__first_name', 'student__user__last_name', 
                     'subject__name']
    date_hierarchy = 'lesson_date'
    raw_id_fields = ['student', 'subject', 'created_by', 'modified_by']
    readonly_fields = ['locked_at', 'created_at', 'updated_at', 'is_locked_display']
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('student', 'subject', 'lesson_date', 'lesson_time', 'lesson_type')
        }),
        ('Оценка и посещаемость', {
            'fields': ('grade', 'attendance_status')
        }),
        ('Блокировка', {
            'fields': ('locked_at', 'is_locked_display'),
            'classes': ('collapse',)
        }),
        ('Метаданные', {
            'fields': ('created_by', 'modified_by', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def is_locked_display(self, obj):
        if obj.is_locked():
            return format_html(
                '<span style="color: red; font-weight: bold;">🔒 Заблокировано</span>'
            )
        else:
            return format_html(
                '<span style="color: green;">✓ Редактируемо</span>'
            )
    is_locked_display.short_description = 'Статус блокировки'
    
    def get_readonly_fields(self, request, obj=None):
        if obj and obj.is_locked():
            
            return ['student', 'subject', 'lesson_date', 'lesson_time', 
                    'lesson_type', 'grade', 'attendance_status', 
                    'locked_at', 'created_at', 'updated_at', 'is_locked_display']
        return self.readonly_fields

@admin.register(JournalChangeLog)
class JournalChangeLogAdmin(admin.ModelAdmin):
    list_display = ['entry_display', 'changed_by', 'changed_at', 'change_description_display']
    list_filter = ['changed_at', 'changed_by']
    search_fields = ['entry__student__user__first_name', 'entry__student__user__last_name',
                     'changed_by__user__first_name', 'changed_by__user__last_name']
    date_hierarchy = 'changed_at'
    raw_id_fields = ['entry', 'changed_by']
    readonly_fields = ['changed_at']
    
    fieldsets = (
        ('Информация об изменении', {
            'fields': ('entry', 'changed_by', 'changed_at')
        }),
        ('Старые значения', {
            'fields': ('old_grade', 'old_attendance')
        }),
        ('Новые значения', {
            'fields': ('new_grade', 'new_attendance')
        }),
        ('Дополнительно', {
            'fields': ('comment',)
        }),
    )
    
    def entry_display(self, obj):
        return f"{obj.entry.student.user.get_full_name()} - {obj.entry.subject.name}"
    entry_display.short_description = 'Запись'
    
    def change_description_display(self, obj):
        return obj.get_change_description()
    change_description_display.short_description = 'Изменение'

@admin.register(StudentStatistics)
class StudentStatisticsAdmin(admin.ModelAdmin):
    list_display = ['student', 'overall_gpa', 'group_rank', 'attendance_percentage', 
                    'total_lessons', 'last_updated']
    list_filter = ['last_updated']
    search_fields = ['student__user__first_name', 'student__user__last_name']
    raw_id_fields = ['student']
    readonly_fields = ['last_updated']
    
    fieldsets = (
        ('Студент', {
            'fields': ('student',)
        }),
        ('Успеваемость', {
            'fields': ('overall_gpa', 'group_rank')
        }),
        ('Посещаемость', {
            'fields': ('attendance_percentage', 'total_lessons', 'attended_lessons')
        }),
        ('Дополнительно', {
            'fields': ('subjects_data', 'last_updated'),
            'classes': ('collapse',)
        }),
    )
    
    actions = ['recalculate_statistics']
    
    def recalculate_statistics(self, request, queryset):
        count = 0
        for stats in queryset:
            stats.recalculate()
            count += 1
        self.message_user(request, f'Пересчитана статистика для {count} студентов')
    recalculate_statistics.short_description = 'Пересчитать статистику'
</file>

<file path="journal/apps.py">
from django.apps import AppConfig

class JournalConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'journal'
    verbose_name = 'Журнал успеваемости'
</file>

<file path="journal/forms.py">
from django import forms
from django.core.exceptions import ValidationError
from .models import JournalEntry, JournalChangeLog
from accounts.models import Group
from schedule.models import Subject

class JournalEntryForm(forms.ModelForm):

    class Meta:
        model = JournalEntry
        fields = ['grade', 'attendance_status']
        widgets = {
            'grade': forms.NumberInput(attrs={
                'class': 'form-control form-control-sm',
                'min': 1,
                'max': 12,
                'placeholder': '1-12'
            }),
            'attendance_status': forms.Select(attrs={
                'class': 'form-select form-select-sm'
            }),
        }
    
    def clean(self):
        cleaned_data = super().clean()
        grade = cleaned_data.get('grade')
        attendance_status = cleaned_data.get('attendance_status')

        if grade is not None and grade > 0 and attendance_status != 'PRESENT':
            raise ValidationError(
                "Нельзя одновременно установить балл и статус отсутствия. "
                "Балл автоматически означает присутствие."
            )
        
        return cleaned_data
    
    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        if self.instance and self.instance.pk:
            if self.instance.is_locked():
                
                for field in self.fields.values():
                    field.disabled = True
                    field.widget.attrs['class'] += ' bg-secondary bg-opacity-25'
                    field.widget.attrs['title'] = '🔒 Заблокировано (прошло 24 часа)'

class BulkGradeForm(forms.Form):

    students = forms.MultipleChoiceField(
        widget=forms.CheckboxSelectMultiple,
        required=False,
        label="Выберите студентов"
    )
    
    grade = forms.IntegerField(
        min_value=1,
        max_value=12,
        required=False,
        label="Балл",
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': '1-12'
        })
    )
    
    attendance_status = forms.ChoiceField(
        choices=[('', '---')] + JournalEntry.ATTENDANCE_CHOICES,
        required=False,
        label="Статус посещения",
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    def __init__(self, *args, **kwargs):
        students_queryset = kwargs.pop('students_queryset', None)
        super().__init__(*args, **kwargs)
        
        if students_queryset:
            self.fields['students'].choices = [
                (s.id, s.user.get_full_name()) 
                for s in students_queryset
            ]
    
    def clean(self):
        cleaned_data = super().clean()
        grade = cleaned_data.get('grade')
        attendance_status = cleaned_data.get('attendance_status')
        
        if not grade and not attendance_status:
            raise ValidationError("Выберите либо балл, либо статус посещения")
        
        if grade and attendance_status and attendance_status != 'PRESENT':
            raise ValidationError("Нельзя одновременно установить балл и статус отсутствия")
        
        return cleaned_data

class JournalFilterForm(forms.Form):

    group = forms.ModelChoiceField(
        queryset=Group.objects.all(),
        required=True,
        empty_label="-- Выберите группу --",
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    subject = forms.ModelChoiceField(
        queryset=Subject.objects.all(),
        required=True,
        empty_label="-- Выберите предмет --",
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    week = forms.IntegerField(
        min_value=1,
        max_value=20,
        required=False,
        label="Учебная неделя",
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': 'I-XX'
        })
    )
    
    def __init__(self, *args, **kwargs):
        teacher = kwargs.pop('teacher', None)
        super().__init__(*args, **kwargs)

        if teacher:
            
            self.fields['subject'].queryset = Subject.objects.filter(teacher=teacher)

            from schedule.models import ScheduleSlot
            group_ids = ScheduleSlot.objects.filter(
                teacher=teacher,
                is_active=True
            ).values_list('group_id', flat=True).distinct()
            self.fields['group'].queryset = Group.objects.filter(id__in=group_ids)

class ChangeLogFilterForm(forms.Form):

    date_from = forms.DateField(
        required=False,
        label="С даты",
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )
    
    date_to = forms.DateField(
        required=False,
        label="По дату",
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )
    
    student = forms.ChoiceField(
        required=False,
        choices=[('', 'Все студенты')],
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    teacher = forms.ChoiceField(
        required=False,
        choices=[('', 'Все преподаватели')],
        widget=forms.Select(attrs={'class': 'form-select'})
    )
    
    def __init__(self, *args, **kwargs):
        group = kwargs.pop('group', None)
        subject = kwargs.pop('subject', None)
        super().__init__(*args, **kwargs)
        
        if group:
            from accounts.models import Student
            students = Student.objects.filter(group=group)
            self.fields['student'].choices = [('', 'Все студенты')] + [
                (s.id, s.user.get_full_name()) for s in students
            ]
        
        if subject:
            from accounts.models import Teacher
            teachers = Teacher.objects.filter(subjects=subject)
            self.fields['teacher'].choices = [('', 'Все преподаватели')] + [
                (t.id, t.user.get_full_name()) for t in teachers
            ]
</file>

<file path="journal/migrations/__init__.py">

</file>

<file path="journal/models.py">
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from django.utils import timezone
from datetime import timedelta
from accounts.models import Student, Teacher, User
from schedule.models import Subject, ScheduleSlot

class JournalEntry(models.Model):

    ATTENDANCE_CHOICES = [
        ('PRESENT', 'Присутствовал'),
        ('ABSENT_ILLNESS', 'НБ-Болезнь'),
        ('ABSENT_VALID', 'НБ-Уважительная'),
        ('ABSENT_INVALID', 'НБ-Неуважительная'),
    ]
    
    student = models.ForeignKey(
        Student,
        on_delete=models.CASCADE,
        related_name='journal_entries',
        verbose_name="Студент"
    )
    
    subject = models.ForeignKey(
        Subject,
        on_delete=models.CASCADE,
        related_name='journal_entries',
        verbose_name="Предмет"
    )
    
    lesson_date = models.DateField(verbose_name="Дата занятия")
    lesson_time = models.TimeField(verbose_name="Время начала пары")
    lesson_type = models.CharField(
        max_length=10,
        choices=Subject.TYPE_CHOICES,
        verbose_name="Тип занятия"
    )

    grade = models.IntegerField(
        null=True,
        blank=True,
        validators=[MinValueValidator(1), MaxValueValidator(12)],
        verbose_name="Балл (1-12)"
    )
    
    attendance_status = models.CharField(
        max_length=20,
        choices=ATTENDANCE_CHOICES,
        default='PRESENT',
        verbose_name="Статус посещения"
    )

    locked_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name="Время блокировки"
    )

    created_by = models.ForeignKey(
        Teacher,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_entries',
        verbose_name="Создал"
    )
    
    modified_by = models.ForeignKey(
        Teacher,
        on_delete=models.SET_NULL,
        null=True,
        related_name='modified_entries',
        verbose_name="Изменил"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = "Запись в журнале"
        verbose_name_plural = "Записи в журнале"
        ordering = ['-lesson_date', 'lesson_time', 'student__user__last_name']
        unique_together = ['student', 'subject', 'lesson_date', 'lesson_time']
    
    def __str__(self):
        return f"{self.student.user.get_full_name()} - {self.subject.name} ({self.lesson_date})"
    
    def save(self, *args, **kwargs):
        
        if not self.locked_at and self.lesson_date and self.lesson_time:
            lesson_datetime = timezone.make_aware(
                timezone.datetime.combine(self.lesson_date, self.lesson_time)
            )
            self.locked_at = lesson_datetime + timedelta(hours=24)

        if self.grade is not None and self.grade > 0:
            
            self.attendance_status = 'PRESENT'
        elif self.attendance_status != 'PRESENT':
            
            self.grade = None
        
        super().save(*args, **kwargs)
    
    def is_locked(self):
        
        if not self.locked_at:
            return False
        return timezone.now() >= self.locked_at
    
    def can_edit(self, user):

        if self.is_locked():
            return False

        if not hasattr(user, 'teacher_profile'):
            return False
        
        return True
    
    def get_display_value(self):
        
        if self.grade is not None and self.grade > 0:
            return str(self.grade)
        elif self.attendance_status == 'PRESENT':
            return "✓"
        else:
            return self.get_attendance_status_display()

class JournalChangeLog(models.Model):

    entry = models.ForeignKey(
        JournalEntry,
        on_delete=models.CASCADE,
        related_name='change_logs',
        verbose_name="Запись"
    )
    
    changed_by = models.ForeignKey(
        Teacher,
        on_delete=models.SET_NULL,
        null=True,
        verbose_name="Кто изменил"
    )
    
    changed_at = models.DateTimeField(auto_now_add=True, verbose_name="Когда")

    old_grade = models.IntegerField(null=True, blank=True, verbose_name="Старый балл")
    old_attendance = models.CharField(max_length=20, blank=True, verbose_name="Старая посещаемость")

    new_grade = models.IntegerField(null=True, blank=True, verbose_name="Новый балл")
    new_attendance = models.CharField(max_length=20, blank=True, verbose_name="Новая посещаемость")
    
    comment = models.TextField(blank=True, verbose_name="Комментарий")
    
    class Meta:
        verbose_name = "Лог изменений"
        verbose_name_plural = "Логи изменений"
        ordering = ['-changed_at']
    
    def __str__(self):
        return f"{self.changed_by.user.get_full_name() if self.changed_by else 'Система'} изменил запись {self.entry.id} в {self.changed_at}"
    
    def get_change_description(self):
        
        parts = []
        
        if self.old_grade != self.new_grade:
            old = self.old_grade if self.old_grade else "—"
            new = self.new_grade if self.new_grade else "—"
            parts.append(f"балл: {old} → {new}")
        
        if self.old_attendance != self.new_attendance:
            old_display = dict(JournalEntry.ATTENDANCE_CHOICES).get(self.old_attendance, self.old_attendance)
            new_display = dict(JournalEntry.ATTENDANCE_CHOICES).get(self.new_attendance, self.new_attendance)
            parts.append(f"посещаемость: {old_display} → {new_display}")
        
        return ", ".join(parts) if parts else "изменение"

class StudentStatistics(models.Model):
    
    student = models.OneToOneField(
        Student,
        on_delete=models.CASCADE,
        related_name='statistics',
        verbose_name="Студент"
    )
    
    # GPA и рейтинг
    overall_gpa = models.FloatField(default=0.0, verbose_name="Общий средний балл")
    group_rank = models.IntegerField(default=0, verbose_name="Рейтинг в группе")
    
    # Посещаемость
    attendance_percentage = models.FloatField(default=0.0, verbose_name="Процент посещаемости")
    total_lessons = models.IntegerField(default=0, verbose_name="Всего занятий")
    attended_lessons = models.IntegerField(default=0, verbose_name="Посещено занятий")
    
    # 🆕 ДОБАВЬТЕ ЭТИ ПОЛЯ
    absent_illness = models.IntegerField(default=0, verbose_name="НБ-Болезнь")
    absent_valid = models.IntegerField(default=0, verbose_name="НБ-Уважительная")
    absent_invalid = models.IntegerField(default=0, verbose_name="НБ-Неуважительная")
    total_absent = models.IntegerField(default=0, verbose_name="Всего прогулов")
    
    # Статистика по предметам (JSON для гибкости)
    subjects_data = models.JSONField(default=dict, verbose_name="Данные по предметам")
    
    last_updated = models.DateTimeField(auto_now=True, verbose_name="Последнее обновление")
    
    class Meta:
        verbose_name = "Статистика студента"
        verbose_name_plural = "Статистика студентов"
    
    def __str__(self):
        return f"Статистика: {self.student.user.get_full_name()}"
    
    def recalculate(self):
        
        entries = JournalEntry.objects.filter(student=self.student)
        
        
        grades = entries.filter(grade__isnull=False, grade__gt=0).values_list('grade', flat=True)
        self.overall_gpa = sum(grades) / len(grades) if grades else 0.0
        
        
        self.total_lessons = entries.count()
        self.attended_lessons = entries.filter(attendance_status='PRESENT').count()
        self.attendance_percentage = (
            (self.attended_lessons / self.total_lessons * 100) 
            if self.total_lessons > 0 else 0.0
        )
        
        
        self.absent_illness = entries.filter(attendance_status='ABSENT_ILLNESS').count()
        self.absent_valid = entries.filter(attendance_status='ABSENT_VALID').count()
        self.absent_invalid = entries.filter(attendance_status='ABSENT_INVALID').count()
        self.total_absent = self.absent_illness + self.absent_valid + self.absent_invalid
        
       
        from schedule.models import Subject
        subjects_stats = {}
        for subject in Subject.objects.filter(journal_entries__student=self.student).distinct():
            subject_entries = entries.filter(subject=subject)
            subject_grades = subject_entries.filter(grade__isnull=False, grade__gt=0).values_list('grade', flat=True)
            
            
            subject_absent = subject_entries.exclude(attendance_status='PRESENT').count()
            
            subjects_stats[subject.id] = {
                'name': subject.name,
                'average_grade': sum(subject_grades) / len(subject_grades) if subject_grades else 0.0,
                'total_lessons': subject_entries.count(),
                'attended': subject_entries.filter(attendance_status='PRESENT').count(),
                'absent': subject_absent,  # 🆕
            }
        
        self.subjects_data = subjects_stats
        
       
        if self.student.group:
            group_students = Student.objects.filter(group=self.student.group)
            ranked = []
            for s in group_students:
                stats, _ = StudentStatistics.objects.get_or_create(student=s)
                ranked.append((s.id, stats.overall_gpa))
            
            ranked.sort(key=lambda x: x[1], reverse=True)
            for rank, (student_id, _) in enumerate(ranked, 1):
                if student_id == self.student.id:
                    self.group_rank = rank
                    break
        
        self.save()
    
    @classmethod
    def recalculate_group(cls, group):
        """Пересчет статистики для всей группы (для рейтингов)"""
        students = Student.objects.filter(group=group)
        for student in students:
            stats, _ = cls.objects.get_or_create(student=student)
            stats.recalculate()
</file>

<file path="journal/tests.py">
from django.test import TestCase
</file>

<file path="journal/urls.py">
from django.urls import path
from . import views

app_name = 'journal'

urlpatterns = [
    
    path('', views.journal_view, name='journal_view'),
    path('entry/<int:entry_id>/update/', views.update_entry, name='update_entry'),
    path('bulk-update/', views.bulk_update, name='bulk_update'),
    path('changelog/', views.change_log_view, name='change_log'),

    path('student/', views.student_journal_view, name='student_view'),

    path('dean/', views.dean_journal_view, name='dean_view'),
    path('report/', views.department_report, name='department_report'),  
    path('report/group/<int:group_id>/', views.group_detailed_report, name='group_detail'),  
]
</file>

<file path="journal/views.py">
# journal/views.py - ПОЛНАЯ ИСПРАВЛЕННАЯ ВЕРСИЯ
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from django.db import transaction
from django.db.models import Avg, Count, Q
from django.utils import timezone
from datetime import datetime, timedelta

from .models import JournalEntry, JournalChangeLog, StudentStatistics
from .forms import JournalEntryForm, BulkGradeForm, JournalFilterForm, ChangeLogFilterForm
from accounts.models import Student, Teacher, Group
from schedule.models import Subject, ScheduleSlot, AcademicWeek

def is_teacher(user):
    return user.is_authenticated and user.role == 'TEACHER'

def is_dean(user):
    return user.is_authenticated and user.role == 'DEAN'

def is_student(user):
    return user.is_authenticated and user.role == 'STUDENT'

# ========== ДЛЯ ПРЕПОДАВАТЕЛЕЙ ==========

@login_required
@user_passes_test(is_teacher)
def journal_view(request):
    """Журнал преподавателя"""
    teacher = request.user.teacher_profile
    group_id = request.GET.get('group')
    subject_id = request.GET.get('subject')
    week_num = request.GET.get('week')
    
    if not group_id or not subject_id:
        form = JournalFilterForm(teacher=teacher)
        return render(request, 'journal/select_journal.html', {'form': form})
    
    group = get_object_or_404(Group, id=group_id)
    subject = get_object_or_404(Subject, id=subject_id, teacher=teacher)
    current_week = AcademicWeek.get_current()
    
    if week_num:
        week_num = int(week_num)
    elif current_week:
        week_num = current_week.current_week
    else:
        week_num = 1

    # ✅ Только АКТИВНЫЕ слоты расписания
    schedule_slots = ScheduleSlot.objects.filter(
        group=group, subject=subject, is_active=True
    ).order_by('day_of_week', 'start_time')
    
    if not schedule_slots.exists():
        messages.warning(request, f'Расписание для группы {group.name} по предмету {subject.name} не найдено')
        return redirect('journal:journal_view')

    if current_week:
        week_start = current_week.semester_start_date + timedelta(weeks=week_num - 1)
    else:
        week_start = datetime.now().date() - timedelta(days=datetime.now().weekday())

    students = Student.objects.filter(group=group).select_related('user').order_by('user__last_name')
    days_with_lessons = []
    
    for slot in schedule_slots:
        lesson_date = week_start + timedelta(days=slot.day_of_week)
        days_with_lessons.append({
            'date': lesson_date,
            'time': slot.start_time,
            'day_name': slot.get_day_of_week_display(),
            'slot': slot
        })

    journal_data = []
    for student in students:
        student_row = {'student': student, 'entries': []}
        for day_info in days_with_lessons:
            entry, _ = JournalEntry.objects.get_or_create(
                student=student, subject=subject,
                lesson_date=day_info['date'], lesson_time=day_info['time'],
                defaults={'lesson_type': subject.type, 'created_by': teacher, 'modified_by': teacher}
            )
            student_row['entries'].append({
                'entry': entry, 'is_locked': entry.is_locked(),
                'form': JournalEntryForm(instance=entry, user=request.user, prefix=f'entry_{entry.id}')
            })
        journal_data.append(student_row)

    day_stats = []
    for day_info in days_with_lessons:
        day_entries = JournalEntry.objects.filter(
            subject=subject, lesson_date=day_info['date'], lesson_time=day_info['time']
        )
        total = day_entries.count()
        present = day_entries.filter(attendance_status='PRESENT').count()
        avg_grade = day_entries.filter(grade__isnull=False).aggregate(Avg('grade'))['grade__avg'] or 0
        day_stats.append({
            'attendance_pct': (present / total * 100) if total > 0 else 0,
            'avg_grade': round(avg_grade, 1)
        })
    
    return render(request, 'journal/journal_table_weekly.html', {
        'group': group, 'subject': subject, 'week_num': week_num,
        'days_with_lessons': days_with_lessons, 'journal_data': journal_data,
        'day_stats': day_stats, 'can_edit': True
    })

@login_required
@user_passes_test(is_teacher)
def update_entry(request, entry_id):
    """✅ НОВАЯ ЛОГИКА: Баллы за неделю, НБ за день"""
    entry = get_object_or_404(JournalEntry, id=entry_id)
    teacher = request.user.teacher_profile

    if entry.is_locked():
        messages.error(request, '🔒 Запись заблокирована!')
        return redirect(request.META.get('HTTP_REFERER', 'journal:journal_view'))
    if entry.subject.teacher != teacher:
        messages.error(request, 'Нет прав на редактирование')
        return redirect('journal:journal_view')
    
    if request.method == 'POST':
        old_grade, old_attendance = entry.grade, entry.attendance_status
        new_grade = request.POST.get('grade')
        new_attendance = request.POST.get('attendance_status')
        
        with transaction.atomic():
            # ✅ Балл применяется ко ВСЕЙ НЕДЕЛЕ
            if new_grade and new_grade.strip():
                grade_value = int(new_grade)
                current_week = AcademicWeek.get_current()
                
                if current_week:
                    delta = entry.lesson_date - current_week.semester_start_date
                    week_num = (delta.days // 7) + 1
                    week_start = current_week.semester_start_date + timedelta(weeks=week_num - 1)
                    week_end = week_start + timedelta(days=6)
                    
                    weekly_entries = JournalEntry.objects.filter(
                        student=entry.student, subject=entry.subject,
                        lesson_date__gte=week_start, lesson_date__lte=week_end
                    )
                    for weekly_entry in weekly_entries:
                        if not weekly_entry.is_locked():
                            weekly_entry.grade = grade_value
                            weekly_entry.attendance_status = 'PRESENT'
                            weekly_entry.modified_by = teacher
                            weekly_entry.save()
                    messages.success(request, f'✅ Балл {grade_value} выставлен за неделю')
                else:
                    entry.grade, entry.attendance_status = grade_value, 'PRESENT'
                    entry.modified_by = teacher
                    entry.save()
                    messages.success(request, f'✅ Балл {grade_value} выставлен')
            
            # ✅ НБ только для этого дня
            elif new_attendance and new_attendance != old_attendance:
                entry.attendance_status = new_attendance
                if new_attendance != 'PRESENT':
                    entry.grade = None
                entry.modified_by = teacher
                entry.save()
                JournalChangeLog.objects.create(
                    entry=entry, changed_by=teacher,
                    old_grade=old_grade, old_attendance=old_attendance,
                    new_grade=entry.grade, new_attendance=entry.attendance_status,
                    comment="Обновление посещаемости"
                )
                messages.success(request, f'✅ НБ обновлено')
            
            stats, _ = StudentStatistics.objects.get_or_create(student=entry.student)
            stats.recalculate()
    
    return redirect(request.META.get('HTTP_REFERER', 'journal:journal_view'))

@login_required
@user_passes_test(is_teacher)
def bulk_update(request):
    """✅ Массовое обновление - только НБ"""
    if request.method != 'POST':
        return redirect('journal:journal_view')
    
    teacher = request.user.teacher_profile
    group_id, subject_id = request.POST.get('group_id'), request.POST.get('subject_id')
    lesson_date, lesson_time = request.POST.get('lesson_date'), request.POST.get('lesson_time')
    
    group = get_object_or_404(Group, id=group_id)
    subject = get_object_or_404(Subject, id=subject_id, teacher=teacher)
    
    students_queryset = Student.objects.filter(group=group)
    form = BulkGradeForm(request.POST, students_queryset=students_queryset)
    
    if form.is_valid():
        selected_students = form.cleaned_data['students']
        attendance = form.cleaned_data.get('attendance_status')
        
        if not attendance:
            messages.error(request, 'Выберите статус посещаемости')
            return redirect(request.META.get('HTTP_REFERER', 'journal:journal_view'))
        
        updated_count = locked_count = 0
        with transaction.atomic():
            for student_id in selected_students:
                student = Student.objects.get(id=student_id)
                try:
                    entry = JournalEntry.objects.get(
                        student=student, subject=subject,
                        lesson_date=lesson_date, lesson_time=lesson_time
                    )
                    if entry.is_locked():
                        locked_count += 1
                        continue
                    
                    old_attendance = entry.attendance_status
                    entry.attendance_status = attendance
                    if attendance != 'PRESENT':
                        entry.grade = None
                    entry.modified_by = teacher
                    entry.save()
                    
                    JournalChangeLog.objects.create(
                        entry=entry, changed_by=teacher,
                        old_grade=entry.grade, old_attendance=old_attendance,
                        new_grade=entry.grade, new_attendance=entry.attendance_status,
                        comment="Массовое обновление НБ"
                    )
                    updated_count += 1
                except JournalEntry.DoesNotExist:
                    pass
        
        StudentStatistics.recalculate_group(group)
        if updated_count > 0:
            messages.success(request, f'✅ Обновлено: {updated_count}')
        if locked_count > 0:
            messages.warning(request, f'⚠️ Заблокировано: {locked_count}')
    else:
        messages.error(request, 'Ошибка формы')
    
    return redirect(request.META.get('HTTP_REFERER', 'journal:journal_view'))

@login_required
@user_passes_test(is_teacher)
def change_log_view(request):
    """История изменений (без изменений)"""
    teacher = request.user.teacher_profile
    group_id, subject_id = request.GET.get('group'), request.GET.get('subject')
    
    if not group_id or not subject_id:
        return redirect('journal:journal_view')
    
    group = get_object_or_404(Group, id=group_id)
    subject = get_object_or_404(Subject, id=subject_id, teacher=teacher)
    logs = JournalChangeLog.objects.filter(
        entry__subject=subject, entry__student__group=group
    ).select_related('entry__student__user', 'changed_by__user').order_by('-changed_at')

    filter_form = ChangeLogFilterForm(request.GET, group=group, subject=subject)
    
    if filter_form.is_valid():
        date_from, date_to = filter_form.cleaned_data.get('date_from'), filter_form.cleaned_data.get('date_to')
        student_id, teacher_id = filter_form.cleaned_data.get('student'), filter_form.cleaned_data.get('teacher')
        
        if date_from:
            logs = logs.filter(changed_at__date__gte=date_from)
        if date_to:
            logs = logs.filter(changed_at__date__lte=date_to)
        if student_id:
            logs = logs.filter(entry__student_id=student_id)
        if teacher_id:
            logs = logs.filter(changed_by_id=teacher_id)
    
    return render(request, 'journal/change_log.html', {
        'logs': logs[:100], 'group': group, 'subject': subject, 'filter_form': filter_form
    })

# ========== ДЛЯ СТУДЕНТОВ ==========

@login_required
@user_passes_test(is_student)
def student_journal_view(request):
    """Журнал студента (без изменений)"""
    student = request.user.student_profile
    entries = JournalEntry.objects.filter(student=student).select_related('subject').order_by('lesson_date')
    subjects_data = {}
    
    for entry in entries:
        if entry.subject.id not in subjects_data:
            subjects_data[entry.subject.id] = {
                'subject': entry.subject, 'entries': [],
                'total_grade': 0, 'count_grades': 0,
                'attended': 0, 'total_lessons': 0
            }
        subjects_data[entry.subject.id]['entries'].append(entry)
        subjects_data[entry.subject.id]['total_lessons'] += 1
        if entry.grade:
            subjects_data[entry.subject.id]['total_grade'] += entry.grade
            subjects_data[entry.subject.id]['count_grades'] += 1
        if entry.attendance_status == 'PRESENT':
            subjects_data[entry.subject.id]['attended'] += 1
    
    for subject_id in subjects_data:
        data = subjects_data[subject_id]
        data['avg_grade'] = data['total_grade'] / data['count_grades'] if data['count_grades'] > 0 else 0
        data['attendance_pct'] = data['attended'] / data['total_lessons'] * 100 if data['total_lessons'] > 0 else 0
    
    stats, _ = StudentStatistics.objects.get_or_create(student=student)
    stats.recalculate()
    
    return render(request, 'journal/student_view.html', {
        'student': student, 'subjects_data': subjects_data.values(), 'stats': stats
    })

# ========== ДЛЯ ДЕКАНА ==========

@login_required
@user_passes_test(is_dean)
def dean_journal_view(request):
    """✅ Аналитика декана с именами преподавателей"""
    group_id, view_type = request.GET.get('group'), request.GET.get('view', 'summary')
    groups = Group.objects.all()
    selected_group, group_stats, at_risk_students = None, None, []
    
    if group_id:
        selected_group = get_object_or_404(Group, id=group_id)
        students = Student.objects.filter(group=selected_group)
        group_stats = {'total_students': students.count(), 'avg_gpa': 0, 'avg_attendance': 0, 'subjects': []}
        all_stats = []
        
        for student in students:
            stats, _ = StudentStatistics.objects.get_or_create(student=student)
            stats.recalculate()
            all_stats.append(stats)
            if stats.overall_gpa < 4.0 or stats.attendance_percentage < 60:
                at_risk_students.append({
                    'student': student, 'stats': stats, 'reason': []
                })
                if stats.overall_gpa < 4.0:
                    at_risk_students[-1]['reason'].append(f'Низкий балл: {stats.overall_gpa:.1f}')
                if stats.attendance_percentage < 60:
                    at_risk_students[-1]['reason'].append(f'Низкая посещаемость: {stats.attendance_percentage:.0f}%')
        
        if all_stats:
            group_stats['avg_gpa'] = sum(s.overall_gpa for s in all_stats) / len(all_stats)
            group_stats['avg_attendance'] = sum(s.attendance_percentage for s in all_stats) / len(all_stats)
        
        # ✅ С именами преподавателей
        subjects = Subject.objects.filter(
            journal_entries__student__group=selected_group
        ).distinct().select_related('teacher__user')
        
        for subject in subjects:
            subject_entries = JournalEntry.objects.filter(subject=subject, student__group=selected_group)
            grades = subject_entries.filter(grade__isnull=False).aggregate(Avg('grade'))
            attendance, total = subject_entries.filter(attendance_status='PRESENT').count(), subject_entries.count()
            group_stats['subjects'].append({
                'name': subject.name,
                'teacher_name': subject.teacher.user.get_full_name() if subject.teacher else 'Не назначен',
                'avg_grade': round(grades['grade__avg'] or 0, 1),
                'attendance_pct': (attendance / total * 100) if total > 0 else 0
            })
    
    return render(request, 'journal/dean_view.html', {
        'groups': groups, 'selected_group': selected_group, 'view_type': view_type,
        'group_stats': group_stats, 'at_risk_students': at_risk_students
    })

@login_required
@user_passes_test(is_dean)
def department_report(request):
    """✅ Отчёт кафедры с прогулами"""
    sort_by = request.GET.get('sort', 'group')
    groups = Group.objects.all()
    groups_data = []
    
    for group in groups:
        students = Student.objects.filter(group=group)
        if not students.exists():
            continue
        
        group_stats = []
        total_gpa = total_attendance = total_absent = count = 0
        
        for student in students:
            stats, _ = StudentStatistics.objects.get_or_create(student=student)
            stats.recalculate()
            group_stats.append({
                'student': student, 'stats': stats,
                'is_at_risk': stats.overall_gpa < 4.0 or stats.attendance_percentage < 60
            })
            total_gpa += stats.overall_gpa
            total_attendance += stats.attendance_percentage
            total_absent += stats.total_absent
            count += 1
        
        avg_gpa = total_gpa / count if count > 0 else 0
        avg_attendance = total_attendance / count if count > 0 else 0
        avg_absent = total_absent / count if count > 0 else 0
        
        groups_data.append({
            'group': group, 'students_count': count,
            'avg_gpa': avg_gpa, 'avg_attendance': avg_attendance,
            'avg_absent': avg_absent, 'total_absent': total_absent,
            'students': sorted(group_stats, key=lambda x: x['stats'].overall_gpa, reverse=True),
            'at_risk_count': sum(1 for s in group_stats if s['is_at_risk'])
        })
    
    if sort_by == 'gpa':
        groups_data.sort(key=lambda x: x['avg_gpa'], reverse=True)
    elif sort_by == 'attendance':
        groups_data.sort(key=lambda x: x['avg_attendance'], reverse=True)
    elif sort_by == 'absent':
        groups_data.sort(key=lambda x: x['avg_absent'], reverse=True)
    else:
        groups_data.sort(key=lambda x: x['group'].name)
    
    total_students = sum(g['students_count'] for g in groups_data)
    total_at_risk = sum(g['at_risk_count'] for g in groups_data)
    overall_gpa = sum(g['avg_gpa'] * g['students_count'] for g in groups_data) / total_students if total_students > 0 else 0
    overall_attendance = sum(g['avg_attendance'] * g['students_count'] for g in groups_data) / total_students if total_students > 0 else 0
    overall_absent = sum(g['total_absent'] for g in groups_data)
    
    return render(request, 'journal/department_report.html', {
        'groups_data': groups_data, 'total_students': total_students,
        'total_at_risk': total_at_risk, 'overall_gpa': overall_gpa,
        'overall_attendance': overall_attendance, 'overall_absent': overall_absent,
        'sort_by': sort_by
    })

@login_required
@user_passes_test(is_dean)
def group_detailed_report(request, group_id):
    """✅ Детальный отчёт группы с прогулами"""
    group = get_object_or_404(Group, id=group_id)
    students = Student.objects.filter(group=group).select_related('user')
    subjects = Subject.objects.filter(journal_entries__student__group=group).distinct()
    students_data = []
    
    for student in students:
        stats, _ = StudentStatistics.objects.get_or_create(student=student)
        stats.recalculate()
        subjects_performance = []
        
        for subject in subjects:
            entries = JournalEntry.objects.filter(student=student, subject=subject)
            if entries.exists():
                grades = entries.filter(grade__isnull=False).values_list('grade', flat=True)
                avg_grade = sum(grades) / len(grades) if grades else 0
                total_lessons = entries.count()
                attended = entries.filter(attendance_status='PRESENT').count()
                attendance_pct = (attended / total_lessons * 100) if total_lessons > 0 else 0
                absent = total_lessons - attended
                subjects_performance.append({
                    'subject': subject, 'avg_grade': avg_grade,
                    'attendance': attendance_pct, 'total_lessons': total_lessons,
                    'absent': absent
                })
        
        students_data.append({
            'student': student, 'stats': stats,
            'subjects': subjects_performance,
            'is_at_risk': stats.overall_gpa < 4.0 or stats.attendance_percentage < 60
        })
    
    students_data.sort(key=lambda x: x['stats'].overall_gpa, reverse=True)
    
    return render(request, 'journal/group_detailed_report.html', {
        'group': group, 'students_data': students_data, 'subjects': subjects
    })
</file>

<file path="manage.py">
import os
import sys

def main():
    
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'department_platform.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)

if __name__ == '__main__':
    main()
</file>

<file path="news/__init__.py">

</file>

<file path="news/admin.py">
from django.contrib import admin
from .models import News, NewsComment

@admin.register(News)
class NewsAdmin(admin.ModelAdmin):
    list_display = ['title', 'category', 'author', 'is_published', 'is_pinned', 'views_count', 'created_at']
    list_filter = ['category', 'is_published', 'is_pinned', 'created_at']
    search_fields = ['title', 'content']
    date_hierarchy = 'created_at'
    readonly_fields = ['views_count', 'created_at', 'updated_at']
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('title', 'content', 'category', 'author')
        }),
        ('Медиа', {
            'fields': ('image', 'video_url', 'video_file')
        }),
        ('Настройки публикации', {
            'fields': ('is_published', 'is_pinned', 'views_count')
        }),
        ('Даты', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

@admin.register(NewsComment)
class NewsCommentAdmin(admin.ModelAdmin):
    list_display = ['author', 'news', 'content_preview', 'created_at']
    list_filter = ['created_at']
    search_fields = ['content', 'author__first_name', 'author__last_name']
    date_hierarchy = 'created_at'
    
    def content_preview(self, obj):
        return obj.content[:50] + '...' if len(obj.content) > 50 else obj.content
    content_preview.short_description = 'Комментарий'
</file>

<file path="news/apps.py">
from django.apps import AppConfig

class NewsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'news'
    verbose_name = 'Новости'
</file>

<file path="news/forms.py">
from django import forms
from .models import News, NewsComment

class NewsForm(forms.ModelForm):
    class Meta:
        model = News
        fields = [
            'title', 'content', 'category', 'image', 
            'video_url', 'video_file', 'is_pinned', 'is_published'
        ]
        widgets = {
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Заголовок новости'
            }),
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 10,
                'placeholder': 'Содержание новости...'
            }),
            'category': forms.Select(attrs={'class': 'form-select'}),
            'image': forms.FileInput(attrs={'class': 'form-control'}),
            'video_url': forms.URLInput(attrs={
                'class': 'form-control',
                'placeholder': 'https://youtube.com/...'
            }),
            'video_file': forms.FileInput(attrs={'class': 'form-control'}),
            'is_pinned': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
            'is_published': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }

class NewsCommentForm(forms.ModelForm):
    class Meta:
        model = NewsComment
        fields = ['content']
        widgets = {
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'Ваш комментарий...'
            })
        }
</file>

<file path="news/migrations/__init__.py">

</file>

<file path="news/models.py">
from django.db import models
from accounts.models import User

class News(models.Model):

    CATEGORY_CHOICES = [
        ('ANNOUNCEMENT', 'Объявление'),
        ('EVENT', 'Мероприятие'),
        ('ACHIEVEMENT', 'Достижение'),
        ('SCHEDULE', 'Расписание'),
        ('OTHER', 'Другое'),
    ]
    
    title = models.CharField(max_length=200, verbose_name="Заголовок")
    content = models.TextField(verbose_name="Содержание")
    category = models.CharField(
        max_length=20,
        choices=CATEGORY_CHOICES,
        default='ANNOUNCEMENT',
        verbose_name="Категория"
    )
    
    image = models.ImageField(
        upload_to='news_images/',
        blank=True,
        null=True,
        verbose_name="Изображение"
    )
    
    video_url = models.URLField(
        blank=True,
        verbose_name="Ссылка на видео (YouTube, Vimeo)"
    )
    
    video_file = models.FileField(
        upload_to='news_videos/',
        blank=True,
        null=True,
        verbose_name="Видео файл"
    )
    
    is_pinned = models.BooleanField(
        default=False,
        verbose_name="Закреплено"
    )
    
    is_published = models.BooleanField(
        default=True,
        verbose_name="Опубликовано"
    )
    
    author = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        related_name='news_articles',
        verbose_name="Автор"
    )
    
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Дата создания")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Дата обновления")
    
    views_count = models.IntegerField(default=0, verbose_name="Просмотры")
    
    class Meta:
        verbose_name = "Новость"
        verbose_name_plural = "Новости"
        ordering = ['-is_pinned', '-created_at']
    
    def __str__(self):
        return self.title
    
    def increment_views(self):
        
        self.views_count += 1
        self.save(update_fields=['views_count'])

class NewsComment(models.Model):

    news = models.ForeignKey(
        News,
        on_delete=models.CASCADE,
        related_name='comments',
        verbose_name="Новость"
    )
    
    author = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        verbose_name="Автор"
    )
    
    content = models.TextField(verbose_name="Комментарий")
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Дата")
    
    class Meta:
        verbose_name = "Комментарий"
        verbose_name_plural = "Комментарии"
        ordering = ['created_at']
    
    def __str__(self):
        return f"Комментарий от {self.author.get_full_name()} к {self.news.title}"
</file>

<file path="news/templatetags/__init__.py">

</file>

<file path="news/templatetags/news_filters.py">
from django import template

register = template.Library()

@register.filter
def youtube_embed(url):
    
    if not url:
        return url
    
    if 'youtube.com/watch?v=' in url:
        video_id = url.split('watch?v=')[1].split('&')[0]
        return f'https://www.youtube.com/embed/{video_id}'
    elif 'youtu.be/' in url:
        video_id = url.split('youtu.be/')[1].split('?')[0]
        return f'https://www.youtube.com/embed/{video_id}'
    
    return url
</file>

<file path="news/tests.py">
from django.test import TestCase
</file>

<file path="news/urls.py">
from django.urls import path
from . import views

app_name = 'news'

urlpatterns = [
    path('', views.news_list, name='list'),
    path('<int:news_id>/', views.news_detail, name='detail'),
    path('create/', views.news_create, name='create'),
    path('<int:news_id>/edit/', views.news_edit, name='edit'),
    path('<int:news_id>/delete/', views.news_delete, name='delete'),
    path('<int:news_id>/toggle-publish/', views.news_toggle_publish, name='toggle_publish'),
    path('<int:news_id>/toggle-pin/', views.news_toggle_pin, name='toggle_pin'),
]
</file>

<file path="news/views.py">
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from django.core.paginator import Paginator
from .models import News, NewsComment
from .forms import NewsForm, NewsCommentForm

def is_dean(user):
    return user.is_authenticated and user.role == 'DEAN'

@login_required
def news_list(request):
    category = request.GET.get('category', '')
    
    news_queryset = News.objects.filter(is_published=True)
    
    if category:
        news_queryset = news_queryset.filter(category=category)
    
    paginator = Paginator(news_queryset, 10)
    page_number = request.GET.get('page')
    news_page = paginator.get_page(page_number)
    
    categories = News.CATEGORY_CHOICES
    
    return render(request, 'news/news_list.html', {
        'news_page': news_page,
        'categories': categories,
        'selected_category': category,
    })

@login_required
def news_detail(request, news_id):
    if request.user.role == 'DEAN':
        news = get_object_or_404(News, id=news_id)
    else:
        news = get_object_or_404(News, id=news_id, is_published=True)
    
    news.increment_views()
    
    comments = news.comments.select_related('author').order_by('-created_at')
    
    if request.method == 'POST':
        form = NewsCommentForm(request.POST)
        if form.is_valid():
            comment = form.save(commit=False)
            comment.news = news
            comment.author = request.user
            comment.save()
            messages.success(request, 'Комментарий добавлен')
            return redirect('news:detail', news_id=news_id)
    else:
        form = NewsCommentForm()
    
    return render(request, 'news/news_detail.html', {
        'news': news,
        'comments': comments,
        'form': form,
    })

@user_passes_test(is_dean)
def news_create(request):
    if request.method == 'POST':
        form = NewsForm(request.POST, request.FILES)
        if form.is_valid():
            news = form.save(commit=False)
            news.author = request.user
            news.save()
            messages.success(request, 'Новость успешно создана')
            return redirect('news:detail', news_id=news.id)
    else:
        form = NewsForm()
    
    return render(request, 'news/news_form.html', {
        'form': form,
        'title': 'Создать новость'
    })

@user_passes_test(is_dean)
def news_edit(request, news_id):
    news = get_object_or_404(News, id=news_id)
    
    if request.method == 'POST':
        form = NewsForm(request.POST, request.FILES, instance=news)
        if form.is_valid():
            form.save()
            messages.success(request, 'Новость обновлена')
            return redirect('news:detail', news_id=news_id)
    else:
        form = NewsForm(instance=news)
    
    return render(request, 'news/news_form.html', {
        'form': form,
        'title': 'Редактировать новость',
        'news': news
    })

@user_passes_test(is_dean)
def news_delete(request, news_id):
    news = get_object_or_404(News, id=news_id)
    news.delete()
    messages.success(request, 'Новость удалена')
    return redirect('news:list')

@user_passes_test(is_dean)
def news_toggle_publish(request, news_id):
    news = get_object_or_404(News, id=news_id)
    news.is_published = not news.is_published
    news.save()
    
    status = "опубликована" if news.is_published else "снята с публикации"
    messages.success(request, f'Новость {status}')
    return redirect('news:list')

@user_passes_test(is_dean)
def news_toggle_pin(request, news_id):
    news = get_object_or_404(News, id=news_id)
    news.is_pinned = not news.is_pinned
    news.save()
    
    status = "закреплена" if news.is_pinned else "откреплена"
    messages.success(request, f'Новость {status}')
    return redirect('news:detail', news_id=news_id)
</file>

<file path="requirements.txt">
asgiref==3.11.0
Django==5.2.9
lxml==6.0.2
pillow==12.0.0
python-docx==1.2.0
sqlparse==0.5.5
typing_extensions==4.15.0
tzdata==2025.3
gunicorn==23.0.0
whitenoise==6.8.2
</file>

<file path="schedule/__init__.py">

</file>

<file path="schedule/admin.py">
# schedule/admin.py - ПОЛНОСТЬЮ ИСПРАВЛЕННАЯ ВЕРСИЯ
from django.contrib import admin
from .models import (
    Subject, TimeSlot, ScheduleSlot, Semester, 
    Classroom, ScheduleException, AcademicWeek
)

@admin.register(Subject)
class SubjectAdmin(admin.ModelAdmin):
    list_display = ['name', 'code', 'type', 'credits', 'hours_per_semester', 'teacher']
    list_filter = ['type', 'teacher']
    search_fields = ['name', 'code']
    raw_id_fields = ['teacher']
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('name', 'code', 'type')
        }),
        ('Учебная нагрузка', {
            'fields': ('credits', 'hours_per_semester')
        }),
        ('Преподаватель', {
            'fields': ('teacher',)
        }),
    )

@admin.register(TimeSlot)
class TimeSlotAdmin(admin.ModelAdmin):
    list_display = ['name', 'start_time', 'end_time']
    ordering = ['start_time']

@admin.register(Semester)
class SemesterAdmin(admin.ModelAdmin):
    list_display = ['name', 'number', 'shift', 'start_date', 'end_date', 'is_active']
    list_filter = ['is_active', 'shift', 'number']
    ordering = ['-start_date']
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('name', 'number', 'shift')
        }),
        ('Период', {
            'fields': ('start_date', 'end_date')
        }),
        ('Статус', {
            'fields': ('is_active',)
        }),
    )

@admin.register(Classroom)
class ClassroomAdmin(admin.ModelAdmin):
    list_display = ['number', 'floor', 'capacity', 'is_active']
    list_filter = ['floor', 'is_active']
    search_fields = ['number']
    ordering = ['floor', 'number']

@admin.register(ScheduleSlot)
class ScheduleSlotAdmin(admin.ModelAdmin):
    list_display = ['group', 'subject', 'teacher', 'day_of_week', 'time_slot', 'classroom', 'semester', 'is_active']
    list_filter = ['day_of_week', 'semester', 'is_active', 'subject__type']
    search_fields = ['subject__name', 'group__name', 'teacher__user__first_name', 'teacher__user__last_name']
    raw_id_fields = ['group', 'subject', 'teacher', 'classroom']
    ordering = ['semester', 'day_of_week', 'time_slot__start_time']
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('group', 'subject', 'teacher', 'semester')
        }),
        ('Расписание', {
            'fields': ('day_of_week', 'time_slot')
        }),
        ('Место проведения', {
            'fields': ('classroom', 'room')
        }),
        ('Статус', {
            'fields': ('is_active',)
        }),
    )
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('group', 'subject', 'teacher__user', 'semester', 'time_slot', 'classroom')

@admin.register(ScheduleException)
class ScheduleExceptionAdmin(admin.ModelAdmin):
    list_display = ['schedule_slot', 'exception_type', 'exception_date', 'reason_short']
    list_filter = ['exception_type', 'exception_date']
    search_fields = ['schedule_slot__subject__name', 'reason']
    raw_id_fields = ['schedule_slot', 'new_classroom']
    date_hierarchy = 'exception_date'
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('schedule_slot', 'exception_type', 'exception_date', 'reason')
        }),
        ('Перенос (если применимо)', {
            'fields': ('new_date', 'new_start_time', 'new_end_time', 'new_classroom'),
            'classes': ('collapse',)
        }),
    )
    
    def reason_short(self, obj):
        return obj.reason[:50] + '...' if len(obj.reason) > 50 else obj.reason
    reason_short.short_description = 'Причина'

@admin.register(AcademicWeek)
class AcademicWeekAdmin(admin.ModelAdmin):
    list_display = ['week_number', 'semester', 'start_date', 'end_date', 'is_current']
    list_filter = ['is_current', 'semester']
    ordering = ['-start_date']
    
    fieldsets = (
        ('Информация о неделе', {
            'fields': ('semester', 'week_number')
        }),
        ('Период', {
            'fields': ('start_date', 'end_date')
        }),
        ('Статус', {
            'fields': ('is_current',)
        }),
    )
</file>

<file path="schedule/apps.py">
from django.apps import AppConfig

class ScheduleConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'schedule'
    verbose_name = 'Управление расписанием'
</file>

<file path="schedule/forms.py">
# schedule/forms.py - АВТОМАТИЧЕСКИЙ РАСЧЕТ ПО ФОРМУЛЕ (1 КРЕДИТ = 24 ЧАСА)

from django import forms
from .models import Subject, ScheduleSlot, ScheduleException, Semester, Classroom
from accounts.models import Group, Teacher

class SubjectForm(forms.ModelForm):
    """✅ Форма для создания предмета - ТОЛЬКО общие кредиты, всё остальное АВТОМАТИЧЕСКИ"""
    
    # ✅ Добавляем поле для ввода общих кредитов (не из модели)
    total_credits = forms.IntegerField(
        min_value=1,
        max_value=12,
        label='Общее количество кредитов',
        help_text='Например: 6 (система автоматически рассчитает все часы)',
        widget=forms.NumberInput(attrs={
            'class': 'form-control',
            'placeholder': 'Например: 6'
        })
    )
    
    class Meta:
        model = Subject
        fields = ['name', 'code', 'teacher', 'groups', 'description']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Например: Менеджменти экологї'
            }),
            'code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Например: MEN301'
            }),
            'teacher': forms.Select(attrs={'class': 'form-select'}),
            'groups': forms.SelectMultiple(attrs={
                'class': 'form-select',
                'size': '5'
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control', 
                'rows': 3,
                'placeholder': 'Дополнительная информация'
            }),
        }
        labels = {
            'name': 'Название предмета *',
            'code': 'Код предмета *',
            'teacher': 'Преподаватель',
            'groups': 'Группы (можно выбрать несколько)',
            'description': 'Описание',
        }
        help_texts = {
            'groups': 'Удерживайте Ctrl (Cmd на Mac) для выбора нескольких групп',
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # Если редактируем существующий предмет - заполняем total_credits
        if self.instance and self.instance.pk:
            # Вычисляем из существующих данных
            total_hours = (self.instance.lecture_hours + 
                          self.instance.practice_hours + 
                          self.instance.control_hours + 
                          self.instance.independent_work_hours)
            self.initial['total_credits'] = round(total_hours / 24)
    
    def save(self, commit=True):
        instance = super().save(commit=False)
        
        # ✅ АВТОМАТИЧЕСКИЙ РАСЧЕТ ПО ФОРМУЛЕ (1 кредит = 24 часа)
        total_credits = self.cleaned_data.get('total_credits', 0)
        
        # 1 кредит = 24 часа
        total_hours = total_credits * 24
        
        # КМД (самостоятельная работа) = 1/3 от общей трудоемкости
        kmd_hours = total_hours // 3
        
        # Аудиторные часы = 2/3 от общей трудоемкости
        auditory_hours = total_hours - kmd_hours
        
        # ✅ Аудиторные часы делятся ПОРОВНУ между Л, А, КМРО
        lecture_hours = auditory_hours // 3
        practice_hours = auditory_hours // 3
        control_hours = auditory_hours - lecture_hours - practice_hours  # остаток
        
        # Сохраняем в модель
        instance.lecture_hours = lecture_hours
        instance.practice_hours = practice_hours
        instance.control_hours = control_hours
        instance.independent_work_hours = kmd_hours
        instance.semester_weeks = 16  # стандартно
        
        # Устанавливаем тип (основной - лекция)
        instance.type = 'LECTURE'
        
        # Старые поля для совместимости
        instance.credits = total_credits
        instance.hours_per_semester = total_hours
        
        if commit:
            instance.save()
            if self.cleaned_data.get('groups'):
                instance.groups.set(self.cleaned_data['groups'])
        
        return instance


# ========== ОСТАЛЬНЫЕ ФОРМЫ БЕЗ ИЗМЕНЕНИЙ ==========

class ScheduleSlotForm(forms.ModelForm):
    class Meta:
        model = ScheduleSlot
        fields = ['group', 'subject', 'teacher', 'day_of_week', 'time_slot', 'classroom', 'room']
        widgets = {
            'group': forms.Select(attrs={'class': 'form-select'}),
            'subject': forms.Select(attrs={'class': 'form-select'}),
            'teacher': forms.Select(attrs={'class': 'form-select'}),
            'day_of_week': forms.Select(attrs={'class': 'form-select'}),
            'time_slot': forms.Select(attrs={'class': 'form-select'}),
            'classroom': forms.Select(attrs={'class': 'form-select'}),
            'room': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Номер кабинета'}),
        }
    
    def __init__(self, *args, **kwargs):
        semester = kwargs.pop('semester', None)
        super().__init__(*args, **kwargs)
        
        if semester:
            self.instance.semester = semester
        
        self.fields['classroom'].queryset = Classroom.objects.filter(is_active=True)
    
    def clean(self):
        cleaned_data = super().clean()
        if not self.instance.semester:
            raise forms.ValidationError("Семестр не указан")
        return cleaned_data

class SemesterForm(forms.ModelForm):
    class Meta:
        model = Semester
        fields = ['name', 'number', 'shift', 'course', 'start_date', 'end_date', 'is_active']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'number': forms.Select(attrs={'class': 'form-select'}),
            'shift': forms.Select(attrs={'class': 'form-select'}),
            'course': forms.Select(attrs={'class': 'form-select'}),  # ✅ НОВОЕ
            'start_date': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'end_date': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'is_active': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }
    
    def clean(self):
        cleaned_data = super().clean()
        start_date = cleaned_data.get('start_date')
        end_date = cleaned_data.get('end_date')
        
        if start_date and end_date and start_date >= end_date:
            raise forms.ValidationError('Дата окончания должна быть позже даты начала')
        
        return cleaned_data


class ClassroomForm(forms.ModelForm):
    class Meta:
        model = Classroom
        fields = ['number', 'floor', 'capacity', 'is_active']
        widgets = {
            'number': forms.TextInput(attrs={'class': 'form-control'}),
            'floor': forms.NumberInput(attrs={'class': 'form-control'}),
            'capacity': forms.NumberInput(attrs={'class': 'form-control'}),
            'is_active': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }

class BulkClassroomForm(forms.Form):
    floor = forms.IntegerField(
        label="Этаж",
        widget=forms.NumberInput(attrs={'class': 'form-control'})
    )
    start_number = forms.IntegerField(
        label="Начальный номер",
        widget=forms.NumberInput(attrs={'class': 'form-control'})
    )
    end_number = forms.IntegerField(
        label="Конечный номер",
        widget=forms.NumberInput(attrs={'class': 'form-control'})
    )
    capacity = forms.IntegerField(
        label="Вместимость",
        initial=30,
        widget=forms.NumberInput(attrs={'class': 'form-control'})
    )
    
    def clean(self):
        cleaned_data = super().clean()
        start = cleaned_data.get('start_number')
        end = cleaned_data.get('end_number')
        
        if start and end and start >= end:
            raise forms.ValidationError('Конечный номер должен быть больше начального')
        
        return cleaned_data

class ScheduleExceptionForm(forms.ModelForm):
    class Meta:
        model = ScheduleException
        fields = ['exception_type', 'exception_date', 'reason', 'new_date', 'new_start_time', 'new_end_time', 'new_classroom']
        widgets = {
            'exception_type': forms.Select(attrs={'class': 'form-select'}),
            'exception_date': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'reason': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'new_date': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'new_start_time': forms.TimeInput(attrs={'class': 'form-control', 'type': 'time'}),
            'new_end_time': forms.TimeInput(attrs={'class': 'form-control', 'type': 'time'}),
            'new_classroom': forms.Select(attrs={'class': 'form-select'}),
        }

class AcademicWeekForm(forms.Form):
    semester_start_date = forms.DateField(
        label="Дата начала семестра",
        widget=forms.DateInput(attrs={'type': 'date', 'class': 'form-control'})
    )
    current_week = forms.IntegerField(
        label="Текущая неделя",
        min_value=1,
        max_value=20,
        widget=forms.NumberInput(attrs={'class': 'form-control'})
    )
</file>

<file path="schedule/management/commands/cleanup_schedule.py">
from django.core.management.base import BaseCommand
from schedule.models import ScheduleSlot, Semester, TimeSlot

class Command(BaseCommand):
    help = 'Очистка висячих записей расписания'

    def handle(self, *args, **options):
        deleted_count = 0
        
        # Получаем все активные семестры
        for semester in Semester.objects.all():
            # Определяем допустимые временные слоты для этой смены
            if semester.shift == 'MORNING':
                valid_slots = TimeSlot.objects.filter(
                    start_time__gte='08:00:00',
                    start_time__lt='14:00:00'
                )
            else:  # DAY
                valid_slots = TimeSlot.objects.filter(
                    start_time__gte='13:00:00',
                    start_time__lt='19:00:00'
                )
            
            valid_slot_ids = list(valid_slots.values_list('id', flat=True))
            
            # Находим записи расписания для этого семестра с неправильными слотами
            invalid_slots = ScheduleSlot.objects.filter(
                semester=semester
            ).exclude(time_slot_id__in=valid_slot_ids)
            
            count = invalid_slots.count()
            if count > 0:
                self.stdout.write(
                    f'Семестр "{semester.name}": найдено {count} висячих записей'
                )
                for slot in invalid_slots:
                    self.stdout.write(
                        f'  - {slot.group.name}, {slot.subject.name}, '
                        f'{slot.get_day_of_week_display()} {slot.start_time}'
                    )
                
                invalid_slots.delete()
                deleted_count += count
        
        if deleted_count > 0:
            self.stdout.write(
                self.style.SUCCESS(f'\n✅ Удалено {deleted_count} висячих записей')
            )
        else:
            self.stdout.write(
                self.style.SUCCESS('✅ Висячих записей не найдено')
            )
</file>

<file path="schedule/management/commands/create_timeslots.py">
# schedule/management/commands/create_timeslots.py
from django.core.management.base import BaseCommand
from schedule.models import TimeSlot
from datetime import time

class Command(BaseCommand):
    help = 'Создание стандартных временных слотов'

    def handle(self, *args, **options):
        # Стандартные временные слоты (10 пар)
        slots = [
            (time(8, 0), time(8, 50), '1 пара'),
            (time(9, 0), time(9, 50), '2 пара'),
            (time(10, 0), time(10, 50), '3 пара'),
            (time(11, 0), time(11, 50), '4 пара'),
            (time(12, 0), time(12, 50), '5 пара'),
            (time(13, 0), time(13, 50), '6 пара'),
            (time(14, 0), time(14, 50), '7 пара'),
            (time(15, 0), time(15, 50), '8 пара'),
            (time(16, 0), time(16, 50), '9 пара'),
            (time(17, 0), time(17, 50), '10 пара'),
            (time(18, 0), time(18, 50), '11 пара'),
        ]
        
        created_count = 0
        for start, end, name in slots:
            obj, created = TimeSlot.objects.get_or_create(
                start_time=start,
                end_time=end,
                defaults={'name': name}
            )
            if created:
                created_count += 1
                self.stdout.write(self.style.SUCCESS(f'✓ Создан слот: {name} ({start}-{end})'))
            else:
                self.stdout.write(f'  Уже существует: {name}')
        
        self.stdout.write(self.style.SUCCESS(f'\n✅ Создано {created_count} новых временных слотов'))
        self.stdout.write(f'📊 Всего в системе: {TimeSlot.objects.count()} слотов')
</file>

<file path="schedule/migrations/__init__.py">

</file>

<file path="schedule/models.py">
# schedule/models.py - ПОЛНОСТЬЮ ИСПРАВЛЕННАЯ ВЕРСИЯ
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from accounts.models import User, Group, Teacher
from datetime import timedelta

# schedule/models.py - ИСПРАВЛЕННАЯ МОДЕЛЬ Subject

# schedule/models.py - ОБНОВЛЕННАЯ МОДЕЛЬ Subject

class Subject(models.Model):
    TYPE_CHOICES = [
        ('LECTURE', 'Лекция'),
        ('PRACTICE', 'Практика'),
        ('SRSP', 'СРСП (КМРО)'),
    ]
    
    name = models.CharField(max_length=200, verbose_name="Название")
    code = models.CharField(max_length=20, unique=True, verbose_name="Код")
    type = models.CharField(
        max_length=10,
        choices=TYPE_CHOICES,
        default='LECTURE',
        verbose_name="Основной тип"
    )
    
    # ✅ НОВЫЕ ПОЛЯ: Распределение часов по типам (за семестр)
    lecture_hours = models.IntegerField(default=0, verbose_name="Лекции (Л) часов за семестр")
    practice_hours = models.IntegerField(default=0, verbose_name="Практика (А) часов за семестр")
    control_hours = models.IntegerField(default=0, verbose_name="Контроль (КМРО) часов за семестр")
    independent_work_hours = models.IntegerField(default=0, verbose_name="КМД часов за семестр")
    
    semester_weeks = models.IntegerField(default=16, verbose_name="Недель в семестре")
    
    teacher = models.ForeignKey(
        'accounts.Teacher',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name="Преподаватель"
    )
    
    # ✅ НОВОЕ: Связь с группами (предмет может быть назначен нескольким группам)
    groups = models.ManyToManyField(
        'accounts.Group',
        related_name='assigned_subjects',
        blank=True,
        verbose_name="Группы"
    )
    
    description = models.TextField(blank=True, verbose_name="Описание")
    
    # СТАРЫЕ ПОЛЯ (оставляем для совместимости, но не используем)
    credits = models.IntegerField(default=0, verbose_name="Кредиты (устарело)")
    hours_per_semester = models.IntegerField(default=0, verbose_name="Часов (устарело)")
    
    class Meta:
        verbose_name = "Предмет"
        verbose_name_plural = "Предметы"
        ordering = ['name']
    
    def __str__(self):
        return f"{self.name} ({self.code})"
    
    # ========== РАСЧЕТНЫЕ СВОЙСТВА ПО ФОРМУЛЕ 1 КРЕДИТ = 24 ЧАСА ==========
    
    @property
    def total_auditory_hours(self):
        """Всего аудиторных часов = Л + А + КМРО"""
        return self.lecture_hours + self.practice_hours + self.control_hours
    
    @property
    def total_hours(self):
        """Общая трудоемкость = Аудиторные + КМД"""
        return self.total_auditory_hours + self.independent_work_hours
    
    @property
    def total_credits(self):
        """Общие кредиты = Общие часы / 24"""
        return round(self.total_hours / 24, 1) if self.total_hours > 0 else 0
    
    @property
    def teacher_credits(self):
        """Кредиты с преподавателем = Аудиторные часы / 24"""
        return round(self.total_auditory_hours / 24, 1) if self.total_auditory_hours > 0 else 0
    
    # ========== ЧАСЫ В НЕДЕЛЮ (для конструктора расписания) ==========
    
    @property
    def lecture_hours_per_week(self):
        """Лекций часов в неделю"""
        return round(self.lecture_hours / self.semester_weeks, 1) if self.semester_weeks > 0 else 0
    
    @property
    def practice_hours_per_week(self):
        """Практик часов в неделю"""
        return round(self.practice_hours / self.semester_weeks, 1) if self.semester_weeks > 0 else 0
    
    @property
    def control_hours_per_week(self):
        """Контроля часов в неделю"""
        return round(self.control_hours / self.semester_weeks, 1) if self.semester_weeks > 0 else 0
    
    @property
    def total_hours_per_week(self):
        """Всего аудиторных часов в неделю"""
        return self.lecture_hours_per_week + self.practice_hours_per_week + self.control_hours_per_week
    
    # ========== ДЛЯ КОНСТРУКТОРА: Сколько раз нужно добавить в расписание ==========
    
    def get_weekly_slots_needed(self, slot_duration=1):  # ✅ ИЗМЕНЕНО: 2 → 1

        return {
            'LECTURE': int(self.lecture_hours_per_week / slot_duration),
            'PRACTICE': int(self.practice_hours_per_week / slot_duration),
            'SRSP': int(self.control_hours_per_week / slot_duration),
        }
    
    def get_remaining_slots(self, group, lesson_type):
        """
        Сколько еще раз можно добавить предмет в расписание для группы
        lesson_type: 'LECTURE', 'PRACTICE', или 'SRSP'
        """
        needed = self.get_weekly_slots_needed()
        needed_count = needed.get(lesson_type, 0)
        
        # Считаем, сколько уже добавлено
        from schedule.models import ScheduleSlot
        existing_count = ScheduleSlot.objects.filter(
            subject=self,
            group=group,
            is_active=True
        ).count()
        
        return max(0, needed_count - existing_count)
    
    def can_add_to_schedule(self, group, lesson_type):
        """Можно ли еще добавить предмет в расписание"""
        return self.get_remaining_slots(group, lesson_type) > 0
    
    def get_color_class(self):
        """Цвет для отображения"""
        return {
            'LECTURE': 'primary',
            'PRACTICE': 'success',
            'SRSP': 'warning'
        }.get(self.type, 'secondary')

# ✅ ДОБАВЛЕНО: Модель TimeSlot для временных слотов
class TimeSlot(models.Model):
    """Временной слот (время пары)"""
    start_time = models.TimeField(verbose_name="Начало")
    end_time = models.TimeField(verbose_name="Конец")
    name = models.CharField(max_length=50, blank=True, verbose_name="Название")
    
    class Meta:
        verbose_name = "Временной слот"
        verbose_name_plural = "Временные слоты"
        ordering = ['start_time']
    
    def __str__(self):
        return f"{self.start_time.strftime('%H:%M')} - {self.end_time.strftime('%H:%M')}"


class Semester(models.Model):
    """Учебный семестр"""
    NUMBER_CHOICES = [
        (1, 'Первый'),
        (2, 'Второй'),
    ]
    
    SHIFT_CHOICES = [
        ('MORNING', 'Утренняя смена'),
        ('DAY', 'Дневная смена'),
    ]
    
    # ✅ НОВОЕ ПОЛЕ: Курс
    COURSE_CHOICES = [
        (1, '1 курс'),
        (2, '2 курс'),
        (3, '3 курс'),
        (4, '4 курс'),
        (5, '5 курс'),
    ]
    
    name = models.CharField(max_length=200, verbose_name="Название")
    number = models.IntegerField(choices=NUMBER_CHOICES, verbose_name="Номер семестра")
    shift = models.CharField(max_length=10, choices=SHIFT_CHOICES, verbose_name="Смена")
    
    # ✅ НОВОЕ ПОЛЕ
    course = models.IntegerField(
        choices=COURSE_CHOICES,
        verbose_name="Курс",
        help_text="Для какого курса этот семестр"
    )
    
    start_date = models.DateField(verbose_name="Дата начала")
    end_date = models.DateField(verbose_name="Дата окончания")
    is_active = models.BooleanField(default=False, verbose_name="Активный")
    
    class Meta:
        verbose_name = "Семестр"
        verbose_name_plural = "Семестры"
        ordering = ['-start_date']
        # ✅ НОВОЕ ОГРАНИЧЕНИЕ: Уникальность семестра по курсу+номеру+году
        unique_together = [['course', 'number', 'start_date']]
    
    def __str__(self):
        return f"{self.name} ({self.course} курс)"
    
    def save(self, *args, **kwargs):
        if self.is_active:
            # ✅ Деактивируем другие семестры ТОЛЬКО для этого курса
            Semester.objects.filter(course=self.course).exclude(id=self.id).update(is_active=False)
        super().save(*args, **kwargs)
    
    @classmethod
    def get_active(cls, course=None):
        """Получить активный семестр (опционально для конкретного курса)"""
        if course:
            return cls.objects.filter(is_active=True, course=course).first()
        return cls.objects.filter(is_active=True).first()


class Classroom(models.Model):
    """Учебный кабинет"""
    number = models.CharField(max_length=20, unique=True, verbose_name="Номер")
    floor = models.IntegerField(verbose_name="Этаж")
    capacity = models.IntegerField(default=30, verbose_name="Вместимость")
    is_active = models.BooleanField(default=True, verbose_name="Активен")
    
    class Meta:
        verbose_name = "Кабинет"
        verbose_name_plural = "Кабинеты"
        ordering = ['floor', 'number']
    
    def __str__(self):
        return f"Каб. {self.number}"


class ScheduleSlot(models.Model):
    """Занятие в расписании"""
    DAYS_OF_WEEK = [
        (0, 'Понедельник'),
        (1, 'Вторник'),
        (2, 'Среда'),
        (3, 'Четверг'),
        (4, 'Пятница'),
        (5, 'Суббота'),
    ]
    
    # ✅ ДОБАВЬТЕ ЭТО ПОЛЕ (используем те же типы, что в Subject)
    LESSON_TYPE_CHOICES = [
        ('LECTURE', 'Лекция'),
        ('PRACTICE', 'Практика'),
        ('SRSP', 'СРСП (КМРО)'),
    ]
    
    group = models.ForeignKey(Group, on_delete=models.CASCADE, verbose_name="Группа")
    subject = models.ForeignKey(Subject, on_delete=models.CASCADE, verbose_name="Предмет")
    teacher = models.ForeignKey(Teacher, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="Преподаватель")
    
    # ✅ НОВОЕ ПОЛЕ
    lesson_type = models.CharField(
        max_length=10,
        choices=LESSON_TYPE_CHOICES,
        default='LECTURE',
        verbose_name="Тип занятия"
    )
    
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, verbose_name="Семестр")
    day_of_week = models.IntegerField(choices=DAYS_OF_WEEK, verbose_name="День недели")
    time_slot = models.ForeignKey(TimeSlot, on_delete=models.CASCADE, verbose_name="Время")
    start_time = models.TimeField(verbose_name="Начало")
    end_time = models.TimeField(verbose_name="Конец")
    classroom = models.ForeignKey(Classroom, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="Кабинет")
    room = models.CharField(max_length=20, blank=True, null=True, verbose_name="Номер кабинета (текст)")
    is_active = models.BooleanField(default=True, verbose_name="Активно")
    
    class Meta:
        verbose_name = "Занятие"
        verbose_name_plural = "Занятия"
        ordering = ['day_of_week', 'start_time']
    
    def __str__(self):
        return f"{self.group.name} - {self.subject.name} ({self.get_lesson_type_display()}, {self.get_day_of_week_display()}, {self.start_time})"


class ScheduleException(models.Model):
    """Исключение в расписании (отмена, перенос)"""
    EXCEPTION_TYPES = [
        ('CANCEL', 'Отменено'),
        ('RESCHEDULE', 'Перенесено'),
    ]
    
    schedule_slot = models.ForeignKey(ScheduleSlot, on_delete=models.CASCADE, verbose_name="Занятие")
    exception_type = models.CharField(max_length=20, choices=EXCEPTION_TYPES, verbose_name="Тип")
    exception_date = models.DateField(verbose_name="Дата исключения")
    reason = models.TextField(verbose_name="Причина")
    
    # Для переноса
    new_date = models.DateField(null=True, blank=True, verbose_name="Новая дата")
    new_start_time = models.TimeField(null=True, blank=True, verbose_name="Новое время начала")
    new_end_time = models.TimeField(null=True, blank=True, verbose_name="Новое время окончания")
    new_classroom = models.ForeignKey(Classroom, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="Новый кабинет")
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        verbose_name = "Исключение в расписании"
        verbose_name_plural = "Исключения в расписании"
    
    def __str__(self):
        return f"{self.schedule_slot} - {self.get_exception_type_display()} ({self.exception_date})"


class AcademicWeek(models.Model):
    """Текущая учебная неделя"""
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, verbose_name="Семестр")
    week_number = models.IntegerField(validators=[MinValueValidator(1), MaxValueValidator(20)], verbose_name="Номер недели")
    start_date = models.DateField(verbose_name="Начало недели")
    end_date = models.DateField(verbose_name="Конец недели")
    is_current = models.BooleanField(default=True, verbose_name="Текущая неделя")
    
    class Meta:
        verbose_name = "Учебная неделя"
        verbose_name_plural = "Учебные недели"
    
    def __str__(self):
        return f"Неделя {self.week_number} ({self.start_date})"
    
    @classmethod
    def get_current(cls):
        return cls.objects.filter(is_current=True).first()
    
    @property
    def semester_start_date(self):
        """Дата начала семестра для обратной совместимости"""
        return self.semester.start_date if self.semester else self.start_date
    
    @property
    def current_week(self):
        """Номер текущей недели для обратной совместимости"""
        return self.week_number
    
    def calculate_current_week(self):
        """Рассчитать текущую неделю на основе даты"""
        from datetime import date
        today = date.today()
        delta = today - self.semester.start_date
        return (delta.days // 7) + 1
</file>

<file path="schedule/templatetags/__init__.py">

</file>

<file path="schedule/templatetags/schedule_filters.py">
from django import template

register = template.Library()

@register.filter(name='get_slot')
def get_slot(dictionary, key):
    """Получить значение из словаря по ключу"""
    if dictionary is None:
        return None
    return dictionary.get(key)
</file>

<file path="schedule/tests.py">
from django.test import TestCase
</file>

<file path="schedule/urls.py">
from django.urls import path
from . import views

app_name = 'schedule'

urlpatterns = [
    # Просмотр расписания (единый формат)
    path('', views.schedule_view, name='view'),
    
    # Сегодняшние занятия (виджет)
    path('today/', views.today_classes, name='today'),
    
    # Экспорт расписания
    path('export/', views.export_schedule, name='export'),
    
    # ✅ ИСПРАВЛЕНО: Конструктор расписания (главная страница)
    path('constructor/', views.schedule_constructor, name='constructor'),
    
    # AJAX endpoints для конструктора
    path('constructor/create/', views.create_schedule_slot, name='create_slot'),
    path('constructor/update-room/<int:slot_id>/', views.update_schedule_room, name='update_room'),
    path('constructor/delete/<int:slot_id>/', views.delete_schedule_slot, name='delete_slot'),
    
    # Управление предметами
    path('subjects/', views.manage_subjects, name='manage_subjects'),
    path('subjects/add/', views.add_subject, name='add_subject'),
    path('subjects/<int:subject_id>/edit/', views.edit_subject, name='edit_subject'),
    path('subjects/<int:subject_id>/delete/', views.delete_subject, name='delete_subject'),
    
    # Управление семестрами
    path('semesters/', views.manage_semesters, name='manage_semesters'),
    path('semesters/add/', views.add_semester, name='add_semester'),
    path('semesters/<int:semester_id>/edit/', views.edit_semester, name='edit_semester'),
    path('semesters/<int:semester_id>/toggle/', views.toggle_semester_active, name='toggle_semester'),
    
    # Управление учебными неделями
    path('academic-week/', views.manage_academic_week, name='manage_academic_week'),
    
    # Управление кабинетами
    path('classrooms/', views.manage_classrooms, name='manage_classrooms'),
    path('classrooms/add/', views.add_classroom, name='add_classroom'),
    path('classrooms/bulk-add/', views.bulk_add_classrooms, name='bulk_add_classrooms'),
    path('classrooms/<int:classroom_id>/delete/', views.delete_classroom, name='delete_classroom'),
    
    # Список групп
    path('groups/', views.group_list, name='group_list'),
]
</file>

<file path="schedule/views.py">
# schedule/views.py - ПОЛНОСТЬЮ ИСПРАВЛЕННАЯ ВЕРСИЯ

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from django.http import HttpResponse, JsonResponse
from django.db.models import Q
from django.views.decorators.http import require_POST
from datetime import datetime, timedelta
import json

try:
    from docx import Document
    from docx.shared import Inches, Pt
    DOCX_AVAILABLE = True
except ImportError:
    DOCX_AVAILABLE = False

from .models import Subject, ScheduleSlot, Semester, Classroom, AcademicWeek, TimeSlot
from .forms import SubjectForm, SemesterForm, ClassroomForm, BulkClassroomForm, AcademicWeekForm
from accounts.models import Group, Student, Teacher

def is_dean(user):
    return user.is_authenticated and user.role == 'DEAN'

def is_teacher(user):
    return user.is_authenticated and user.role == 'TEACHER'

def is_student(user):
    return user.is_authenticated and user.role == 'STUDENT'


# ========== HELPER ==========
def get_time_slots_for_shift(shift):
    """Возвращает временные слоты в зависимости от смены"""
    if shift == 'MORNING':
        return TimeSlot.objects.filter(
            start_time__gte='08:00:00',
            start_time__lt='14:00:00'
        ).order_by('start_time')
    else:  # DAY
        return TimeSlot.objects.filter(
            start_time__gte='13:00:00',
            start_time__lt='19:00:00'
        ).order_by('start_time')


# ============ КОНСТРУКТОР РАСПИСАНИЯ (ИСПРАВЛЕН) ============
@login_required
@user_passes_test(is_dean)
def schedule_constructor(request):
    """✅ ИСПРАВЛЕНО: Правильный подсчет по типам занятий + фильтрация семестров по курсу группы"""
    selected_group_id = request.GET.get('group')
    selected_semester_id = request.GET.get('semester')

    groups = Group.objects.all().order_by('name')

    # Фильтруем семестры в зависимости от выбранной группы
    if selected_group_id:
        try:
            group = Group.objects.get(id=selected_group_id)
            semesters = Semester.objects.filter(course=group.course).order_by('-start_date')
        except Group.DoesNotExist:
            semesters = Semester.objects.all().order_by('-start_date')
    else:
        semesters = Semester.objects.all().order_by('-start_date')

    schedule_data = {}
    selected_group = None
    selected_semester = None
    time_slots = []
    days = []

    lecture_subjects = []
    practice_subjects = []
    control_subjects = []

    # Выбор семестра
    if not selected_semester_id:
        if selected_group_id:
            group = Group.objects.get(id=selected_group_id)
            selected_semester = Semester.get_active(course=group.course)
        else:
            selected_semester = Semester.get_active()
    else:
        try:
            selected_semester = Semester.objects.get(id=selected_semester_id)
            if selected_group_id:
                group = Group.objects.get(id=selected_group_id)
                if selected_semester.course != group.course:
                    messages.error(request, f'❌ Семестр для {selected_semester.course} курса, а группа {group.name} на {group.course} курсе!')
                    selected_semester = Semester.get_active(course=group.course)
        except Semester.DoesNotExist:
            selected_semester = Semester.get_active()

    if not selected_semester:
        messages.error(request, 'Сначала создайте и активируйте семестр для этого курса')
        return redirect('schedule:manage_semesters')

    if selected_group_id:
        try:
            selected_group = Group.objects.get(id=selected_group_id)
            time_slots = get_time_slots_for_shift(selected_semester.shift)

            days = [
                (0, 'ДУШАНБЕ'), (1, 'СЕШАНБЕ'), (2, 'ЧОРШАНБЕ'),
                (3, 'ПАНҶШАНБЕ'), (4, 'ҶУМЪА'), (5, 'ШАНБЕ'),
            ]

            # Фильтр: только предметы этой группы
            assigned_subjects = Subject.objects.filter(
                groups=selected_group
            ).select_related('teacher__user')

            # ✅ ИСПРАВЛЕНО: Считаем по типам ОТДЕЛЬНО с фильтром по lesson_type
            for subject in assigned_subjects:
                slots_needed = subject.get_weekly_slots_needed()

                # ========== ЛЕКЦИИ ==========
                if slots_needed['LECTURE'] > 0:
                    # ✅ ИСПРАВЛЕНО: Фильтруем ТОЛЬКО лекции
                    existing_lectures = ScheduleSlot.objects.filter(
                        subject=subject,
                        group=selected_group,
                        semester=selected_semester,
                        lesson_type='LECTURE',  # ← ДОБАВЛЕНО
                        is_active=True
                    ).count()

                    remaining = max(0, slots_needed['LECTURE'] - existing_lectures)

                    if remaining > 0:
                        lecture_subjects.append({
                            'subject': subject,
                            'remaining': remaining,
                            'needed': slots_needed['LECTURE'],
                            'hours_per_week': subject.lecture_hours_per_week
                        })

                # ========== ПРАКТИКИ ==========
                if slots_needed['PRACTICE'] > 0:
                    # ✅ ИСПРАВЛЕНО: Фильтруем ТОЛЬКО практики
                    existing_practices = ScheduleSlot.objects.filter(
                        subject=subject,
                        group=selected_group,
                        semester=selected_semester,
                        lesson_type='PRACTICE',  # ← ДОБАВЛЕНО
                        is_active=True
                    ).count()

                    remaining = max(0, slots_needed['PRACTICE'] - existing_practices)

                    if remaining > 0:
                        practice_subjects.append({
                            'subject': subject,
                            'remaining': remaining,
                            'needed': slots_needed['PRACTICE'],
                            'hours_per_week': subject.practice_hours_per_week
                        })

                # ========== КМРО ==========
                if slots_needed['SRSP'] > 0:
                    # ✅ ИСПРАВЛЕНО: Фильтруем ТОЛЬКО КМРО
                    existing_control = ScheduleSlot.objects.filter(
                        subject=subject,
                        group=selected_group,
                        semester=selected_semester,
                        lesson_type='SRSP',  # ← ДОБАВЛЕНО
                        is_active=True
                    ).count()

                    remaining = max(0, slots_needed['SRSP'] - existing_control)

                    if remaining > 0:
                        control_subjects.append({
                            'subject': subject,
                            'remaining': remaining,
                            'needed': slots_needed['SRSP'],
                            'hours_per_week': subject.control_hours_per_week
                        })

            # Получаем существующее расписание
            valid_slot_ids = list(time_slots.values_list('id', flat=True))


            schedule_slots = ScheduleSlot.objects.filter(
                group=selected_group,
                semester=selected_semester,
                time_slot_id__in=valid_slot_ids,
                is_active=True
            ).select_related('subject', 'teacher__user', 'time_slot')

            schedule_data[selected_group.id] = {}
            for slot in schedule_slots:
                if slot.day_of_week not in schedule_data[selected_group.id]:
                    schedule_data[selected_group.id][slot.day_of_week] = {}
                schedule_data[selected_group.id][slot.day_of_week][slot.time_slot.id] = slot

        except Group.DoesNotExist:
            pass

    context = {
        'groups': groups,
        'semesters': semesters,
        'group': selected_group,
        'semester': selected_semester,
        'time_slots': time_slots,
        'lecture_subjects': lecture_subjects,
        'practice_subjects': practice_subjects,
        'control_subjects': control_subjects,
        'days': days,
        'schedule_data': schedule_data,
    }

    return render(request, 'schedule/constructor_with_limits.html', context)


# ============ AJAX ENDPOINTS ============
@login_required
@require_POST
def create_schedule_slot(request):
    """✅ ИСПРАВЛЕНО: Проверка конфликтов с учётом смены"""
    try:
        data = json.loads(request.body)
        group_id = data.get('group')
        subject_id = data.get('subject')
        day_of_week = data.get('day_of_week')
        time_slot_id = data.get('time_slot')
        lesson_type = data.get('lesson_type', 'LECTURE')

        if not all([group_id, subject_id, day_of_week is not None, time_slot_id]):
            return JsonResponse({'success': False, 'error': 'Не хватает данных'}, status=400)

        active_semester = Semester.get_active()
        if not active_semester:
            return JsonResponse({'success': False, 'error': 'Активный семестр не найден'}, status=400)

        try:
            group = Group.objects.get(id=group_id)
            subject = Subject.objects.get(id=subject_id)
            time_slot = TimeSlot.objects.get(id=time_slot_id)
        except Exception as e:
            return JsonResponse({'success': False, 'error': f'Объект не найден: {str(e)}'}, status=404)

        # ✅ ИСПРАВЛЕНО: Проверяем, что временной слот соответствует смене семестра
        from schedule.views import get_time_slots_for_shift
        valid_slots = get_time_slots_for_shift(active_semester.shift)
        if time_slot not in valid_slots:
            return JsonResponse({
                'success': False,
                'error': f'❌ Временной слот {time_slot} не соответствует смене {active_semester.get_shift_display()}'
            }, status=400)

        # ✅ ИСПРАВЛЕНО: Проверка конфликтов - только для текущего семестра
        if ScheduleSlot.objects.filter(
            group=group, 
            day_of_week=day_of_week, 
            time_slot=time_slot,
            semester=active_semester, 
            is_active=True
        ).exists():
            # Дополнительная отладка
            existing = ScheduleSlot.objects.filter(
                group=group, 
                day_of_week=day_of_week, 
                time_slot=time_slot,
                semester=active_semester, 
                is_active=True
            ).first()
            
            return JsonResponse({
                'success': False,
                'error': f'⚠️ У группы {group.name} уже есть занятие в это время: {existing.subject.name} ({existing.get_lesson_type_display()})'
            }, status=400)

        if subject.teacher:
            teacher_conflict = ScheduleSlot.objects.filter(
                teacher=subject.teacher, 
                day_of_week=day_of_week, 
                time_slot=time_slot,
                semester=active_semester, 
                is_active=True
            ).exclude(group=group)

            if teacher_conflict.exists():
                existing = teacher_conflict.first()
                return JsonResponse({
                    'success': False,
                    'error': f'❌ Преподаватель {subject.teacher.user.get_full_name()} занят (группа {existing.group.name})'
                }, status=400)

        # ✅ Создаём объект
        schedule_slot = ScheduleSlot(
            group=group, 
            subject=subject, 
            day_of_week=day_of_week,
            time_slot=time_slot, 
            semester=active_semester,
            teacher=subject.teacher, 
            lesson_type=lesson_type,
            start_time=time_slot.start_time,
            end_time=time_slot.end_time,
            room=None
        )
        schedule_slot.save()

        return JsonResponse({'success': True, 'slot': {'id': schedule_slot.id}})

    except Exception as e:
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': f'Ошибка: {str(e)}'}, status=500)

@login_required
@require_POST
def update_schedule_room(request, slot_id):
    """Обновление номера кабинета"""
    try:
        data = json.loads(request.body)
        room = data.get('room', '').strip()
        
        schedule_slot = ScheduleSlot.objects.get(id=slot_id)
        
        if room:
            classroom_exists = Classroom.objects.filter(number=room, is_active=True).exists()
            if not classroom_exists:
                return JsonResponse({
                    'success': False,
                    'error': f'❌ Кабинет {room} не найден. Добавьте его в "Управление кабинетами".'
                }, status=400)
        
        schedule_slot.room = room if room else None
        schedule_slot.save()
        
        return JsonResponse({'success': True, 'room': schedule_slot.room or '?'})

    except ScheduleSlot.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Занятие не найдено'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'error': f'Ошибка: {str(e)}'}, status=500)


@login_required
@require_POST
def delete_schedule_slot(request, slot_id):
    """Удаление занятия"""
    try:
        schedule_slot = ScheduleSlot.objects.get(id=slot_id)

        if not (request.user.is_staff or hasattr(request.user, 'dean_profile')):
            return JsonResponse({'success': False, 'error': 'Нет прав'}, status=403)

        schedule_slot.delete()
        return JsonResponse({'success': True, 'message': 'Занятие удалено'})

    except ScheduleSlot.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Занятие не найдено'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'error': f'Ошибка: {str(e)}'}, status=500)


# ============ ОСТАЛЬНЫЕ VIEWS БЕЗ ИЗМЕНЕНИЙ ============
@login_required
def schedule_view(request):
    """Просмотр расписания"""
    user = request.user
    group = None
    
    # ✅ ИСПРАВЛЕНО: Получаем активный семестр с учетом курса
    if user.role == 'STUDENT':
        try:
            student = user.student_profile
            group = student.group
            if group:
                active_semester = Semester.objects.filter(
                    course=group.course, is_active=True
                ).first()
            else:
                active_semester = None
        except Student.DoesNotExist:
            active_semester = None
    else:
        active_semester = Semester.objects.filter(is_active=True).first()

    if not active_semester:
        messages.warning(request, 'Активный семестр не найден.')
        return render(request, 'schedule/no_semester.html')

    if user.role == 'TEACHER':
        try:
            teacher = user.teacher_profile
            group_ids = ScheduleSlot.objects.filter(
                teacher=teacher, semester=active_semester, is_active=True
            ).values_list('group_id', flat=True).distinct()
            
            groups = Group.objects.filter(id__in=group_ids)
            group_id = request.GET.get('group')
            
            if group_id:
                group = get_object_or_404(Group, id=group_id, id__in=group_ids)
            
            context = {'groups': groups, 'group': group, 'active_semester': active_semester}
            if not group:
                return render(request, 'schedule/schedule_view_unified.html', context)
                
        except Teacher.DoesNotExist:
            pass

    elif user.role == 'DEAN':
        group_id = request.GET.get('group')
        groups = Group.objects.all()
        
        if group_id:
            group = get_object_or_404(Group, id=group_id)
            # ✅ Получаем семестр для курса этой группы
            active_semester = Semester.objects.filter(
                course=group.course, is_active=True
            ).first()
            if not active_semester:
                messages.warning(request, f'Нет активного семестра для {group.course} курса')
        
        context = {'groups': groups, 'group': group, 'active_semester': active_semester}
        if not group:
            return render(request, 'schedule/schedule_view_unified.html', context)

    if group and active_semester:
        time_slots = get_time_slots_for_shift(active_semester.shift)
        days = [(0, 'ДУШАНБЕ'), (1, 'СЕШАНБЕ'), (2, 'ЧОРШАНБЕ'), (3, 'ПАНҶШАНБЕ'), (4, 'ҶУМЪА'), (5, 'ШАНБЕ')]
        valid_slot_ids = list(time_slots.values_list('id', flat=True))
        
        slots = ScheduleSlot.objects.filter(
            group=group, 
            semester=active_semester, 
            time_slot_id__in=valid_slot_ids,  # ✅ ДОБАВЛЕНО
            is_active=True
        ).select_related('subject', 'teacher__user', 'time_slot')
        
        schedule_data = {group.id: {}}
        for slot in slots:
            if slot.day_of_week not in schedule_data[group.id]:
                schedule_data[group.id][slot.day_of_week] = {}
            schedule_data[group.id][slot.day_of_week][slot.time_slot.id] = slot
        
        return render(request, 'schedule/schedule_view_unified.html', {
            'group': group, 'groups': Group.objects.all() if user.role == 'DEAN' else None,
            'days': days, 'time_slots': time_slots, 'schedule_data': schedule_data,
            'active_semester': active_semester, 'is_view_mode': True,
        })
    
    return render(request, 'schedule/schedule_view_unified.html', {
        'groups': Group.objects.all() if user.role == 'DEAN' else None,
        'active_semester': active_semester,
    })


@login_required
def today_classes(request):
    """Сегодняшние занятия"""
    user = request.user
    today = datetime.now()
    day_of_week = today.weekday()
    current_time = today.time()
    
    # ✅ Получаем семестр с учетом курса
    if user.role == 'STUDENT':
        try:
            student = user.student_profile
            if student.group:
                active_semester = Semester.objects.filter(
                    course=student.group.course, is_active=True
                ).first()
            else:
                active_semester = None
        except:
            active_semester = None
    else:
        active_semester = Semester.objects.filter(is_active=True).first()

    classes = []
    if not active_semester:
        return render(request, 'schedule/today_widget.html', {'classes': classes, 'current_time': current_time, 'today': today})

    if user.role == 'STUDENT':
        try:
            student = user.student_profile
            if student.group:
                classes = ScheduleSlot.objects.filter(
                    group=student.group, semester=active_semester,
                    day_of_week=day_of_week, is_active=True
                ).select_related('subject', 'teacher__user').order_by('start_time')
        except Student.DoesNotExist:
            pass

    elif user.role == 'TEACHER':
        try:
            teacher = user.teacher_profile
            classes = ScheduleSlot.objects.filter(
                teacher=teacher, semester=active_semester,
                day_of_week=day_of_week, is_active=True
            ).select_related('subject', 'group').order_by('start_time')
        except Teacher.DoesNotExist:
            pass

    return render(request, 'schedule/today_widget.html', {
        'classes': classes, 'current_time': current_time, 'today': today
    })


# ========== УПРАВЛЕНИЕ (БЕЗ ИЗМЕНЕНИЙ) ==========
@user_passes_test(is_dean)
def manage_subjects(request):
    subjects = Subject.objects.all().select_related('teacher__user')
    search = request.GET.get('search', '')
    if search:
        subjects = subjects.filter(Q(name__icontains=search) | Q(code__icontains=search))
    return render(request, 'schedule/manage_subjects.html', {'subjects': subjects, 'search': search})

@user_passes_test(is_dean)
def add_subject(request):
    if request.method == 'POST':
        form = SubjectForm(request.POST)
        if form.is_valid():
            subject = form.save()
            messages.success(request, f'Предмет "{subject.name}" создан')
            return redirect('schedule:manage_subjects')
    else:
        form = SubjectForm()
    return render(request, 'schedule/subject_form.html', {'form': form, 'title': 'Добавить предмет'})

@user_passes_test(is_dean)
def edit_subject(request, subject_id):
    subject = get_object_or_404(Subject, id=subject_id)
    if request.method == 'POST':
        form = SubjectForm(request.POST, instance=subject)
        if form.is_valid():
            form.save()
            messages.success(request, 'Предмет обновлен')
            return redirect('schedule:manage_subjects')
    else:
        form = SubjectForm(instance=subject)
    return render(request, 'schedule/subject_form.html', {'form': form, 'subject': subject, 'title': 'Редактировать предмет'})

@user_passes_test(is_dean)
def delete_subject(request, subject_id):
    subject = get_object_or_404(Subject, id=subject_id)
    subject.delete()
    messages.success(request, 'Предмет удален')
    return redirect('schedule:manage_subjects')

@user_passes_test(is_dean)
def manage_semesters(request):
    semesters = Semester.objects.all()
    active_semester = Semester.objects.filter(is_active=True).first()
    return render(request, 'schedule/manage_semesters.html', {'semesters': semesters, 'active_semester': active_semester})

@user_passes_test(is_dean)
def add_semester(request):
    if request.method == 'POST':
        form = SemesterForm(request.POST)
        if form.is_valid():
            semester = form.save()
            messages.success(request, f'Семестр "{semester.name}" создан')
            return redirect('schedule:manage_semesters')
    else:
        form = SemesterForm()
    return render(request, 'schedule/semester_form.html', {'form': form, 'title': 'Добавить семестр'})

@user_passes_test(is_dean)
def edit_semester(request, semester_id):
    semester = get_object_or_404(Semester, id=semester_id)
    if request.method == 'POST':
        form = SemesterForm(request.POST, instance=semester)
        if form.is_valid():
            form.save()
            messages.success(request, 'Семестр обновлен')
            return redirect('schedule:manage_semesters')
    else:
        form = SemesterForm(instance=semester)
    return render(request, 'schedule/semester_form.html', {'form': form, 'semester': semester, 'title': 'Редактировать семестр'})

@user_passes_test(is_dean)
def toggle_semester_active(request, semester_id):
    semester = get_object_or_404(Semester, id=semester_id)
    semester.is_active = not semester.is_active
    semester.save()  # Это автоматически деактивирует другие семестры того же курса
    status = "активирован" if semester.is_active else "деактивирован"
    messages.success(request, f'Семестр {status}')
    return redirect('schedule:manage_semesters')

@user_passes_test(is_dean)
def manage_classrooms(request):
    classrooms = Classroom.objects.all().order_by('floor', 'number')
    return render(request, 'schedule/manage_classrooms.html', {'classrooms': classrooms})

@user_passes_test(is_dean)
def add_classroom(request):
    if request.method == 'POST':
        form = ClassroomForm(request.POST)
        if form.is_valid():
            classroom = form.save()
            messages.success(request, f'Кабинет {classroom.number} добавлен')
            return redirect('schedule:manage_classrooms')
    else:
        form = ClassroomForm()
    return render(request, 'schedule/classroom_form.html', {'form': form, 'title': 'Добавить кабинет'})

@user_passes_test(is_dean)
def bulk_add_classrooms(request):
    if request.method == 'POST':
        form = BulkClassroomForm(request.POST)
        if form.is_valid():
            floor = form.cleaned_data['floor']
            start = form.cleaned_data['start_number']
            end = form.cleaned_data['end_number']
            capacity = form.cleaned_data['capacity']

            created = 0
            for num in range(start, end + 1):
                number = f"{num}"
                if not Classroom.objects.filter(number=number).exists():
                    Classroom.objects.create(number=number, floor=floor, capacity=capacity)
                    created += 1

            messages.success(request, f'Создано {created} кабинетов')
            return redirect('schedule:manage_classrooms')
    else:
        form = BulkClassroomForm()
    return render(request, 'schedule/bulk_classroom_form.html', {'form': form})

@user_passes_test(is_dean)
def delete_classroom(request, classroom_id):
    classroom = get_object_or_404(Classroom, id=classroom_id)
    classroom.delete()
    messages.success(request, f'Кабинет {classroom.number} удален')
    return redirect('schedule:manage_classrooms')

@user_passes_test(is_dean)
def manage_academic_week(request):
    active_semester = Semester.objects.filter(is_active=True).first()
    current_week = AcademicWeek.get_current()

    if request.method == 'POST':
        form = AcademicWeekForm(request.POST, instance=current_week)
        if form.is_valid():
            week = form.save(commit=False)
            if active_semester:
                week.semester = active_semester
                AcademicWeek.objects.filter(is_current=True).update(is_current=False)
                week.is_current = True

                semester_start = form.cleaned_data['semester_start_date']
                week_num = form.cleaned_data['current_week']

                week.start_date = semester_start + timedelta(weeks=week_num - 1)
                week.end_date = week.start_date + timedelta(days=6)
                week.week_number = week_num

                week.save()
                messages.success(request, f'Учебная неделя {week_num} установлена')
            else:
                messages.error(request, 'Сначала создайте семестр')
            return redirect('schedule:manage_academic_week')
    else:
        initial = {}
        if current_week:
            initial = {
                'semester_start_date': current_week.semester.start_date if current_week.semester else None,
                'current_week': current_week.week_number
            }
        form = AcademicWeekForm(initial=initial)

    return render(request, 'schedule/manage_academic_week.html', {
        'form': form, 'current_week': current_week, 'active_semester': active_semester
    })

@login_required
def group_list(request):
    user = request.user

    if user.role == 'TEACHER':
        try:
            teacher = user.teacher_profile
            active_semester = Semester.objects.filter(is_active=True).first()
            if active_semester:
                group_ids = ScheduleSlot.objects.filter(
                    teacher=teacher, semester=active_semester, is_active=True
                ).values_list('group_id', flat=True).distinct()
                groups = Group.objects.filter(id__in=group_ids)
            else:
                groups = Group.objects.none()
        except Teacher.DoesNotExist:
            groups = Group.objects.none()
    elif user.role == 'DEAN':
        groups = Group.objects.all()
    else:
        messages.error(request, 'Доступ запрещен')
        return redirect('core:dashboard')

    groups_with_students = []
    for group in groups:
        students = Student.objects.filter(group=group).select_related('user').order_by('user__last_name')
        groups_with_students.append({'group': group, 'students': students})

    return render(request, 'schedule/group_list.html', {'groups_with_students': groups_with_students})

@login_required
def export_schedule(request):
    """Экспорт расписания в DOCX"""
    if not DOCX_AVAILABLE:
        messages.error(request, 'Библиотека python-docx не установлена')
        return redirect('schedule:view')

    user = request.user
    group = None
    
    group_id = request.GET.get('group')
    if group_id:
        group = get_object_or_404(Group, id=group_id)
    elif user.role == 'STUDENT':
        try:
            student = user.student_profile
            group = student.group
        except Student.DoesNotExist:
            messages.error(request, 'Профиль студента не найден')
            return redirect('schedule:view')
    
    if not group:
        messages.error(request, 'Группа не определена')
        return redirect('schedule:view')
    
    # ✅ Получаем семестр для курса группы
    active_semester = Semester.objects.filter(
        course=group.course, is_active=True
    ).first()
    
    if not active_semester:
        messages.error(request, f'Нет активного семестра для {group.course} курса')
        return redirect('schedule:view')

    doc = Document()
    heading
</file>

<file path="static/css/main.css">
:root {
    --primary-blue: #2563eb;
    --light-blue: #60a5fa;
    --accent-green: #10b981;
    --accent-amber: #f59e0b;
    --bg-light: #f8fafc;
    --bg-dark: #1e293b;
    --text-light: #1f2937;
    --text-dark: #f1f5f9;
    --card-light: #ffffff;
    --card-dark: #334155;
}

body {
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    opacity: 0.03;
    z-index: -2;
    pointer-events: none;
}

.animated-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
    overflow: hidden;
}

.floating-shape {
    position: absolute;
    border-radius: 50%;
    opacity: 0.1;
    animation: float 20s infinite ease-in-out;
}

.shape-1 {
    width: 300px;
    height: 300px;
    background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
    top: 10%;
    left: 5%;
    animation-delay: 0s;
}

.shape-2 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, var(--accent-green), var(--accent-amber));
    top: 60%;
    right: 10%;
    animation-delay: 5s;
}

.shape-3 {
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, var(--accent-amber), #f97316);
    bottom: 10%;
    left: 20%;
    animation-delay: 10s;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0) translateX(0) rotate(0deg);
    }
    25% {
        transform: translateY(-30px) translateX(20px) rotate(90deg);
    }
    50% {
        transform: translateY(-60px) translateX(-20px) rotate(180deg);
    }
    75% {
        transform: translateY(-30px) translateX(-40px) rotate(270deg);
    }
}

body.dark-mode {
    background-color: var(--bg-dark);
    color: var(--text-dark);
}

body.dark-mode::before {
    opacity: 0.08;
}

body.dark-mode .card {
    background-color: var(--card-dark);
    color: var(--text-dark);
}

body.dark-mode .navbar {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
}

body.dark-mode .table {
    color: var(--text-dark);
}

body.dark-mode .table-light {
    background-color: #475569;
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(30px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from { 
        transform: translateX(-100%);
        opacity: 0;
    }
    to { 
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1);
    }
    50% { 
        transform: scale(1.05);
    }
}

@keyframes scaleUp {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.fade-in {
    animation: fadeIn 0.6s ease-out;
}

.slide-in {
    animation: slideIn 0.5s ease-out;
}

.scale-up {
    animation: scaleUp 0.4s ease-out;
}

.card {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.card:hover::before {
    left: 100%;
}

.card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

/* ИСПРАВЛЕНО: Убрана анимация для dropdown toggles */
.btn:not(.dropdown-toggle):not([data-bs-toggle]) {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.btn:not(.dropdown-toggle):not([data-bs-toggle])::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    transform: translate(-50%, -50%);
    transition: width 0.5s, height 0.5s;
}

.btn:not(.dropdown-toggle):not([data-bs-toggle]):hover::after {
    width: 300px;
    height: 300px;
}

.btn:not(.dropdown-toggle):not([data-bs-toggle]):hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.btn:not(.dropdown-toggle):not([data-bs-toggle]):active {
    transform: translateY(-1px);
}

/* Dropdown специальные стили */
.dropdown-toggle {
    cursor: pointer;
    transition: color 0.3s ease;
}

.dropdown-toggle:hover {
    color: var(--accent-amber) !important;
}

.dropdown-menu {
    z-index: 1050;
    animation: fadeIn 0.2s ease-out;
}

.nav-link {
    transition: all 0.3s ease;
    position: relative;
    cursor: pointer;
}

.nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 3px;
    background: var(--accent-amber);
    transition: all 0.3s ease;
    transform: translateX(-50%);
    border-radius: 2px;
}

/* НЕ применяем подчеркивание к dropdown toggles */
.nav-link:not(.dropdown-toggle):hover::after {
    width: 80%;
}

.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.theme-toggle {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.theme-toggle:hover {
    transform: scale(1.15) rotate(15deg);
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.theme-toggle:active {
    transform: scale(0.95) rotate(15deg);
}

.page-content {
    animation: fadeIn 0.8s ease-out;
}

.stat-card {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(96, 165, 250, 0.1));
    opacity: 0;
    transition: opacity 0.3s;
    border-radius: inherit;
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card:hover {
    transform: translateY(-12px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
}

.table tbody tr {
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background-color: rgba(37, 99, 235, 0.08);
    transform: scale(1.01);
}

.form-control, .form-select {
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 0.3rem rgba(37, 99, 235, 0.25);
    transform: scale(1.02);
}

.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.alert {
    animation: slideIn 0.5s ease-out;
    border-left: 4px solid;
}

.alert-success {
    border-left-color: var(--accent-green);
}

.alert-danger {
    border-left-color: #ef4444;
}

.alert-warning {
    border-left-color: var(--accent-amber);
}

.alert-info {
    border-left-color: var(--light-blue);
}

.modal.show .modal-dialog {
    animation: scaleUp 0.4s ease-out;
}

.badge {
    transition: all 0.3s ease;
}

.badge:hover {
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .theme-toggle {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
    }
    
    .floating-shape {
        opacity: 0.05;
    }
}

.progress-bar {
    transition: width 0.6s ease;
    animation: progressShine 2s infinite;
}

@keyframes progressShine {
    0% {
        background-position: -200% center;
    }
    100% {
        background-position: 200% center;
    }
}

.list-group-item {
    transition: all 0.3s ease;
}

.list-group-item:hover {
    transform: translateX(5px);
    background-color: rgba(37, 99, 235, 0.05);
}

.navbar {
    transition: all 0.3s ease;
}

.navbar:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

a {
    transition: color 0.3s ease;
}

.container-fluid {
    animation: fadeIn 0.6s ease-out;
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="password"]:focus,
input[type="number"]:focus,
input[type="date"]:focus,
input[type="time"]:focus,
textarea:focus,
select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
}

.profile-img {
    transition: all 0.4s ease;
}

.profile-img:hover {
    transform: scale(1.05) rotate(3deg);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.card-header {
    transition: all 0.3s ease;
}

.card:hover .card-header {
    transform: translateY(-2px);
}

@keyframes glow {
    0%, 100% {
        box-shadow: 0 0 5px rgba(37, 99, 235, 0.5);
    }
    50% {
        box-shadow: 0 0 20px rgba(37, 99, 235, 0.8);
    }
}

.btn-primary:not(.dropdown-toggle):hover {
    animation: glow 2s infinite;
}
</file>

<file path="static/css/performance.css">
/* ===========================================
   ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ
   =========================================== */

/* 1. Использование will-change для плавных анимаций */
.card, .btn, .nav-link {
    will-change: transform;
}

/* 2. Использование transform вместо top/left для анимаций */
.smooth-move {
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000px;
}

/* 3. Отключение анимаций для prefers-reduced-motion */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* 4. Оптимизация изображений - скелетон при загрузке */
img[data-src] {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    min-height: 100px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* 5. Оптимизация таблиц - виртуальный скроллинг */
.table-container {
    contain: layout style paint;
}

.table-row {
    content-visibility: auto;
    contain-intrinsic-size: 50px;
}

/* 6. Критические стили для быстрого рендера */
.critical-content {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    font-size: 16px;
    line-height: 1.5;
    color: #212529;
}

/* 7. Отложенная загрузка некритического контента */
.lazy-load {
    opacity: 0;
    transition: opacity 0.3s ease-in;
}

.lazy-load.loaded {
    opacity: 1;
}

/* 8. Оптимизация шрифтов */
@font-face {
    font-family: 'System';
    font-style: normal;
    font-weight: 300;
    font-display: swap; /* Быстрая замена шрифта */
}

/* 9. GPU-ускоренные трансформации */
.gpu-accelerated {
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* 10. Оптимизация скроллинга */
.smooth-scroll {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
}

/* Отключение smooth scroll для быстрой навигации */
@media (prefers-reduced-motion: reduce) {
    .smooth-scroll {
        scroll-behavior: auto;
    }
}

/* 11. Содержимое вне экрана - минимальный рендеринг */
.offscreen {
    content-visibility: auto;
    contain-intrinsic-size: 1px 500px;
}

/* 12. Оптимизация форм */
input, select, textarea {
    font-synthesis: none;
    -webkit-font-smoothing: antialiased;
}

/* Отключение валидации в реальном времени для производительности */
input:not(:focus):invalid,
select:not(:focus):invalid,
textarea:not(:focus):invalid {
    box-shadow: none;
}

/* 13. Кастомный скроллбар для лучшей производительности */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* 14. Оптимизация модальных окон */
.modal {
    contain: layout style;
}

.modal-backdrop {
    will-change: opacity;
    backface-visibility: hidden;
}

/* 15. Отложенная загрузка видео */
video {
    content-visibility: auto;
    contain-intrinsic-size: 640px 360px;
}

/* 16. Оптимизация dropdown меню */
.dropdown-menu {
    contain: layout style;
    will-change: transform, opacity;
}

/* 17. Быстрый hover для кнопок */
.btn:hover,
.btn:focus {
    transform: translateY(-2px);
    will-change: transform;
}

/* 18. Оптимизация карточек */
.card {
    contain: layout style paint;
    content-visibility: auto;
}

/* 19. Индикатор загрузки контента */
.loading-skeleton {
    background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.5) 50%,
        rgba(255,255,255,0) 100%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* 20. Оптимизация для мобильных устройств */
@media (max-width: 768px) {
    /* Отключаем тяжелые эффекты */
    .card::before,
    .card::after {
        display: none;
    }
    
    /* Упрощаем анимации */
    * {
        animation-duration: 0.1s !important;
        transition-duration: 0.1s !important;
    }
    
    /* Уменьшаем тени */
    .card, .btn {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
    }
}

/* 21. Оптимизация для печати */
@media print {
    /* Удаляем ненужные элементы */
    .navbar,
    .sidebar,
    .btn,
    .modal,
    .theme-toggle,
    .floating-shape {
        display: none !important;
    }
    
    /* Оптимизируем для печати */
    body {
        font-size: 12pt;
        line-height: 1.3;
        background: white !important;
    }
    
    .card {
        page-break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd;
    }
}

/* 22. Предзагрузка критических ресурсов */
/* Используйте в HTML: */
/* <link rel="preload" href="/static/css/main.css" as="style"> */
/* <link rel="preload" href="/static/js/main.js" as="script"> */
/* <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"> */

/* 23. Оптимизация для темной темы */
@media (prefers-color-scheme: dark) {
    :root {
        color-scheme: dark;
    }
}

/* 24. Contain для изоляции */
.isolated-component {
    contain: layout style paint;
}

/* 25. Оптимизация градиентов */
.gradient-bg {
    background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    background-attachment: fixed;
    will-change: transform;
}

/* 26. Быстрые transitions */
.fast-transition {
    transition: all 0.15s ease-out;
}

.medium-transition {
    transition: all 0.3s ease-out;
}

.slow-transition {
    transition: all 0.5s ease-out;
}

/* 27. Оптимизация списков */
ul, ol {
    contain: layout style;
}

li {
    content-visibility: auto;
}

/* 28. Скрытие невидимого контента */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* 29. Оптимизация z-index слоев */
.z-base { z-index: 0; }
.z-dropdown { z-index: 1000; }
.z-sticky { z-index: 1020; }
.z-fixed { z-index: 1030; }
.z-modal-backdrop { z-index: 1040; }
.z-modal { z-index: 1050; }
.z-popover { z-index: 1060; }
.z-tooltip { z-index: 1070; }

/* 30. Критические стили inline (вставьте в <head>) */
/*
<style>
    body { margin: 0; font-family: system-ui; }
    .loading { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
</style>
*/
</file>

<file path="static/js/main.js">
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced main.js loaded');
    initThemeToggle();
    initAnimations();
    initTooltips();
    initTableSorting();
    animateNumbers();
    
    initSmoothScroll();
    initParallax();
    initCardAnimations();
});

function initThemeToggle() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
    }
    
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'theme-toggle';
    toggleBtn.innerHTML = '<i class="bi bi-moon-fill"></i>';
    toggleBtn.onclick = toggleTheme;
    document.body.appendChild(toggleBtn);
    
    updateThemeIcon();
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeIcon();
    
    createThemeChangeEffect();
    
    console.log('Theme toggled to:', isDark ? 'dark' : 'light');
}

function updateThemeIcon() {
    const btn = document.querySelector('.theme-toggle');
    if (btn) {
        const isDark = document.body.classList.contains('dark-mode');
        btn.innerHTML = isDark ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
    }
}

function createThemeChangeEffect() {
    const effect = document.createElement('div');
    effect.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.1) 100%);
        pointer-events: none;
        z-index: 9999;
        animation: themeChange 0.5s ease-out;
    `;
    document.body.appendChild(effect);
    
    setTimeout(() => effect.remove(), 500);
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes themeChange {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: scale(2); }
        }
    `;
    document.head.appendChild(style);
}

function initAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.classList.add('fade-in');
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
    });
    
    document.querySelectorAll('.alert').forEach(alert => {
        alert.classList.add('slide-in');
    });
}

function initTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function initTableSorting() {
    document.querySelectorAll('table.sortable thead th').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            sortTable(this);
        });
    });
}

function sortTable(header) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const columnIndex = Array.from(header.parentElement.children).indexOf(header);
    const isAscending = header.classList.contains('asc');
    
    table.querySelectorAll('th').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    
    header.classList.add(isAscending ? 'desc' : 'asc');
    
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
        const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? bNum - aNum : aNum - bNum;
        }
        
        return isAscending ? bValue.localeCompare(aValue) : aValue.localeCompare(bValue);
    });
    
    rows.forEach(row => {
        row.style.animation = 'fadeIn 0.3s ease-out';
        tbody.appendChild(row);
    });
}

function animateNumbers() {
    const stats = document.querySelectorAll('.stat-number');
    stats.forEach(stat => {
        const target = parseInt(stat.textContent);
        if (isNaN(target)) return;
        
        let current = 0;
        const increment = target / 60;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                stat.textContent = target;
                clearInterval(timer);
            } else {
                stat.textContent = Math.floor(current);
            }
        }, 20);
    });
}




function initSmoothScroll() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
}

function initParallax() {
    let ticking = false;
    
    window.addEventListener('scroll', function() {
        if (!ticking) {
            window.requestAnimationFrame(function() {
                const scrolled = window.pageYOffset;
                const shapes = document.querySelectorAll('.floating-shape');
                
                shapes.forEach((shape, index) => {
                    const speed = 0.5 + (index * 0.2);
                    shape.style.transform = `translateY(${scrolled * speed}px)`;
                });
                
                ticking = false;
            });
            
            ticking = true;
        }
    });
}

function initCardAnimations() {
    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', function() {
            this.style.animation = 'pulse 0.5s ease-out';
            setTimeout(() => {
                this.style.animation = '';
            }, 500);
        });
    });
}

document.querySelectorAll('[data-confirm]').forEach(element => {
    element.addEventListener('click', function(e) {
        if (!confirm(this.dataset.confirm)) {
            e.preventDefault();
        }
    });
});

document.addEventListener('mousemove', function(e) {
    const shapes = document.querySelectorAll('.floating-shape');
    const mouseX = e.clientX / window.innerWidth;
    const mouseY = e.clientY / window.innerHeight;
    
    shapes.forEach((shape, index) => {
        const speed = (index + 1) * 10;
        const x = (mouseX - 0.5) * speed;
        const y = (mouseY - 0.5) * speed;
        
        shape.style.transform = `translate(${x}px, ${y}px)`;
    });
});

window.addEventListener('load', function() {
    document.body.classList.add('loaded');
    
    setTimeout(() => {
        document.querySelectorAll('.btn:not(.dropdown-toggle):not([data-bs-toggle])').forEach((btn, index) => {
            setTimeout(() => {
                btn.style.animation = 'fadeIn 0.5s ease-out';
            }, index * 50);
        });
    }, 300);
});

function createRipple(event) {
    // НЕ применяем ripple к dropdown и nav-link
    if (event.currentTarget.classList.contains('dropdown-toggle') || 
        event.currentTarget.classList.contains('nav-link') ||
        event.currentTarget.hasAttribute('data-bs-toggle')) {
        return;
    }
    
    const button = event.currentTarget;
    const ripple = document.createElement('span');
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;
    
    ripple.style.width = ripple.style.height = `${diameter}px`;
    ripple.style.left = `${event.clientX - button.offsetLeft - radius}px`;
    ripple.style.top = `${event.clientY - button.offsetTop - radius}px`;
    ripple.classList.add('ripple');
    
    const rippleEffect = button.getElementsByClassName('ripple')[0];
    if (rippleEffect) {
        rippleEffect.remove();
    }
    
    button.appendChild(ripple);
}

// ИСПРАВЛЕНО: Применяем ripple только к обычным кнопкам, не к dropdown
document.querySelectorAll('.btn:not(.dropdown-toggle):not([data-bs-toggle="dropdown"])').forEach(button => {
    button.addEventListener('click', createRipple);
});

const style = document.createElement('style');
style.textContent = `
    .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple-animation 0.6s ease-out;
        pointer-events: none;
    }
    
    @keyframes ripple-animation {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</file>

<file path="static/js/performance.js">
/**
 * Модуль оптимизации производительности
 * Включает: ленивую загрузку, дебаунсинг, кеширование
 */

// ============================================
// 1. ЛЕНИВАЯ ЗАГРУЗКА ИЗОБРАЖЕНИЙ
// ============================================
class LazyLoader {
    constructor() {
        this.images = document.querySelectorAll('img[data-src]');
        this.init();
    }
    
    init() {
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        imageObserver.unobserve(img);
                    }
                });
            });
            
            this.images.forEach(img => imageObserver.observe(img));
        } else {
            // Fallback для старых браузеров
            this.images.forEach(img => {
                img.src = img.dataset.src;
            });
        }
    }
}

// ============================================
// 2. ДЕБАУНСИНГ И ТРОТТЛИНГ
// ============================================
const debounce = (func, wait = 300) => {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
};

const throttle = (func, limit = 100) => {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
};

// ============================================
// 3. КЕШИРОВАНИЕ AJAX-ЗАПРОСОВ
// ============================================
class CacheManager {
    constructor(ttl = 5 * 60 * 1000) { // 5 минут по умолчанию
        this.cache = new Map();
        this.ttl = ttl;
    }
    
    set(key, value) {
        const item = {
            value: value,
            expiry: Date.now() + this.ttl
        };
        this.cache.set(key, item);
    }
    
    get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        
        if (Date.now() > item.expiry) {
            this.cache.delete(key);
            return null;
        }
        
        return item.value;
    }
    
    clear() {
        this.cache.clear();
    }
}

const cache = new CacheManager();

// Обертка для fetch с кешированием
async function cachedFetch(url, options = {}) {
    const cacheKey = url + JSON.stringify(options);
    
    // Проверяем кеш
    const cached = cache.get(cacheKey);
    if (cached && !options.ignoreCache) {
        return Promise.resolve(cached);
    }
    
    // Делаем запрос
    try {
        const response = await fetch(url, options);
        const data = await response.json();
        
        // Сохраняем в кеш только успешные GET-запросы
        if (response.ok && (!options.method || options.method === 'GET')) {
            cache.set(cacheKey, data);
        }
        
        return data;
    } catch (error) {
        console.error('Fetch error:', error);
        throw error;
    }
}

// ============================================
// 4. ОПТИМИЗАЦИЯ СКРОЛЛА
// ============================================
const optimizeScroll = () => {
    let ticking = false;
    
    const handleScroll = () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                // Ваши действия при скролле
                document.body.classList.toggle('scrolled', window.pageYOffset > 50);
                ticking = false;
            });
            ticking = true;
        }
    };
    
    window.addEventListener('scroll', handleScroll, { passive: true });
};

// ============================================
// 5. ПРЕДЗАГРУЗКА ССЫЛОК ПРИ HOVER
// ============================================
class LinkPrefetcher {
    constructor() {
        this.prefetched = new Set();
        this.init();
    }
    
    init() {
        document.addEventListener('mouseover', (e) => {
            const link = e.target.closest('a[href^="/"]');
            if (link && !this.prefetched.has(link.href)) {
                this.prefetch(link.href);
            }
        });
    }
    
    prefetch(url) {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = url;
        document.head.appendChild(link);
        this.prefetched.add(url);
    }
}

// ============================================
// 6. ОПТИМИЗАЦИЯ ФОРМ
// ============================================
class FormOptimizer {
    constructor() {
        this.forms = document.querySelectorAll('form');
        this.init();
    }
    
    init() {
        this.forms.forEach(form => {
            // Автосохранение в localStorage
            if (form.dataset.autosave) {
                this.enableAutosave(form);
            }
            
            // Предотвращение двойной отправки
            form.addEventListener('submit', (e) => {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.disabled = true;
                    submitBtn.dataset.originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Отправка...';
                    
                    // Включаем кнопку обратно через 3 секунды (на случай ошибки)
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = submitBtn.dataset.originalText;
                    }, 3000);
                }
            });
        });
    }
    
    enableAutosave(form) {
        const formId = form.id || 'form_' + Date.now();
        
        // Восстанавливаем данные при загрузке
        const saved = localStorage.getItem('autosave_' + formId);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(name => {
                    const field = form.elements[name];
                    if (field) field.value = data[name];
                });
            } catch (e) {
                console.error('Autosave restore error:', e);
            }
        }
        
        // Сохраняем при изменении (с дебаунсингом)
        const saveData = debounce(() => {
            const data = {};
            Array.from(form.elements).forEach(el => {
                if (el.name && el.type !== 'password') {
                    data[el.name] = el.value;
                }
            });
            localStorage.setItem('autosave_' + formId, JSON.stringify(data));
        }, 1000);
        
        form.addEventListener('input', saveData);
        
        // Очищаем при успешной отправке
        form.addEventListener('submit', () => {
            localStorage.removeItem('autosave_' + formId);
        });
    }
}

// ============================================
// 7. ОПТИМИЗАЦИЯ ТАБЛИЦ
// ============================================
class TableOptimizer {
    constructor(selector = 'table') {
        this.tables = document.querySelectorAll(selector);
        this.init();
    }
    
    init() {
        this.tables.forEach(table => {
            if (table.rows.length > 50) {
                this.virtualize(table);
            }
        });
    }
    
    virtualize(table) {
        // Виртуализация больших таблиц
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.rows);
        const rowHeight = 50; // примерная высота строки
        const visibleRows = Math.ceil(window.innerHeight / rowHeight) + 5;
        
        let startIndex = 0;
        
        const render = throttle(() => {
            const scrollTop = table.parentElement.scrollTop || 0;
            startIndex = Math.floor(scrollTop / rowHeight);
            const endIndex = Math.min(startIndex + visibleRows, rows.length);
            
            // Скрываем все строки
            rows.forEach((row, i) => {
                row.style.display = (i >= startIndex && i < endIndex) ? '' : 'none';
            });
        }, 100);
        
        table.parentElement.addEventListener('scroll', render);
        render();
    }
}

// ============================================
// 8. ИНИЦИАЛИЗАЦИЯ
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Performance optimization initialized');
    
    // Запускаем оптимизаторы
    new LazyLoader();
    new LinkPrefetcher();
    new FormOptimizer();
    new TableOptimizer();
    optimizeScroll();
    
    // Очищаем кеш при выходе
    window.addEventListener('beforeunload', () => {
        // Не очищаем полностью, чтобы сохранить между вкладками
        // cache.clear();
    });
    
    // Экспортируем утилиты в глобальную область
    window.PerformanceUtils = {
        debounce,
        throttle,
        cachedFetch,
        cache
    };
});

// ============================================
// 9. МЕТРИКИ ПРОИЗВОДИТЕЛЬНОСТИ
// ============================================
if ('PerformanceObserver' in window) {
    // Отслеживание времени загрузки
    const perfObserver = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
            console.log('⏱️ Performance:', entry.name, entry.duration.toFixed(2) + 'ms');
        });
    });
    
    perfObserver.observe({ entryTypes: ['measure', 'navigation', 'resource'] });
}

// Измерение времени до первой отрисовки контента
window.addEventListener('load', () => {
    const perfData = performance.getEntriesByType('navigation')[0];
    if (perfData) {
        console.log('📊 Page Load Stats:');
        console.log('  DOM Content Loaded:', perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart, 'ms');
        console.log('  Full Load:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
        console.log('  DOM Interactive:', perfData.domInteractive - perfData.fetchStart, 'ms');
    }
});
</file>

<file path="templates/accounts/add_group.html">
{% extends 'base.html' %}

{% block title %}Добавить группу{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> Добавить группу
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Название группы *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Курс *</label>
                            {{ form.course }}
                            {% if form.course.errors %}
                                <div class="text-danger">{{ form.course.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Год обучения *</label>
                            {{ form.academic_year }}
                            {% if form.academic_year.errors %}
                                <div class="text-danger">{{ form.academic_year.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Специальность *</label>
                        {{ form.specialty }}
                        {% if form.specialty.errors %}
                            <div class="text-danger">{{ form.specialty.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Создать группу
                        </button>
                        <a href="{% url 'accounts:group_management' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    select, input[type="text"], input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
</style>
{% endblock %}
</file>

<file path="templates/accounts/add_user.html">
{% extends 'base.html' %}

{% block title %}Добавить пользователя{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-person-plus"></i> Добавить пользователя
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        Логин будет сгенерирован автоматически. Временный пароль: <strong>password123</strong>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Роль *</label>
                        {{ form.role }}
                        {% if form.role.errors %}
                            <div class="text-danger">{{ form.role.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Имя *</label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="text-danger">{{ form.first_name.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Фамилия *</label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="text-danger">{{ form.last_name.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Телефон</label>
                        {{ form.phone }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Фото</label>
                        {{ form.photo }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Создать пользователя
                        </button>
                        <a href="{% url 'accounts:user_management' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
                
                <div class="alert alert-warning mt-3">
                    <strong>Обратите внимание:</strong> После создания пользователя нужно будет заполнить дополнительные поля профиля через редактирование.
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    select, input[type="text"], input[type="file"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
</style>
{% endblock %}
</file>

<file path="templates/accounts/change_password.html">
{% extends 'base.html' %}
{% block title %}Сменить пароль{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header"><i class="bi bi-key"></i> Сменить пароль</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mb-3">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                        <div class="text-danger">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary">Сменить пароль</button>
                    <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">Отмена</a>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/delete_group.html">
{% extends 'base.html' %}

{% block title %}Удалить группу{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle"></i> Удалить группу
            </div>
            <div class="card-body">
                {% if students_count > 0 %}
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-x-circle"></i> Невозможно удалить группу</h5>
                        <p class="mb-0">
                            В группе <strong>{{ group.name }}</strong> есть <strong>{{ students_count }}</strong> студентов. 
                            Сначала переведите студентов в другие группы или удалите их.
                        </p>
                    </div>
                    
                    <a href="{% url 'accounts:group_management' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Назад к списку
                    </a>
                {% else %}
                    <div class="alert alert-warning">
                        <h5><i class="bi bi-exclamation-triangle"></i> Подтверждение удаления</h5>
                        <p>Вы действительно хотите удалить группу <strong>{{ group.name }}</strong>?</p>
                        <p class="mb-0">
                            <strong>Информация о группе:</strong><br>
                            Курс: {{ group.course }}<br>
                            Год: {{ group.academic_year }}<br>
                            Специальность: {{ group.specialty }}
                        </p>
                    </div>
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Да, удалить группу
                            </button>
                            <a href="{% url 'accounts:group_management' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Отмена
                            </a>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/edit_group.html">
{% extends 'base.html' %}

{% block title %}Редактировать группу{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pencil"></i> Редактировать группу: {{ group.name }}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Название группы *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Курс *</label>
                            {{ form.course }}
                            {% if form.course.errors %}
                                <div class="text-danger">{{ form.course.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Год обучения *</label>
                            {{ form.academic_year }}
                            {% if form.academic_year.errors %}
                                <div class="text-danger">{{ form.academic_year.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Специальность *</label>
                        {{ form.specialty }}
                        {% if form.specialty.errors %}
                            <div class="text-danger">{{ form.specialty.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        В этой группе <strong>{{ group.students.count }}</strong> студентов
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить изменения
                        </button>
                        <a href="{% url 'accounts:group_management' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    select, input[type="text"], input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
</style>
{% endblock %}
</file>

<file path="templates/accounts/edit_profile.html">
{% extends 'base.html' %}
{% block title %}Редактировать профиль{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header"><i class="bi bi-pencil"></i> Редактировать профиль</div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <h5>Основная информация</h5>
                    {% for field in user_form %}
                    <div class="mb-3">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    {% if profile_form %}
                    <hr><h5>Профильная информация</h5>
                    {% for field in profile_form %}
                    <div class="mb-3">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">Отмена</a>
                </form>
            </div>
        </div>
    </div>
</div>
<style>
    input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 0.375rem; }
</style>
{% endblock %}
</file>

<file path="templates/accounts/edit_user.html">
{% extends 'base.html' %}

{% block title %}Редактировать пользователя{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pencil"></i> Редактировать пользователя: {{ user_obj.get_full_name }}
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <h5 class="mb-3">Основная информация</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Имя</label>
                            {{ user_form.first_name }}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Фамилия</label>
                            {{ user_form.last_name }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Телефон</label>
                            {{ user_form.phone }}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Фото</label>
                            {{ user_form.photo }}
                            {% if user_obj.photo %}
                                <br><small>Текущее: <a href="{{ user_obj.photo.url }}" target="_blank">Посмотреть</a></small>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if profile_form %}
                    <hr class="my-4">
                    <h5 class="mb-3">Профильная информация ({{ user_obj.get_role_display }})</h5>
                    
                    <div class="row">
                        {% for field in profile_form %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger small">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить изменения
                        </button>
                        <a href="{% url 'accounts:user_management' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    select, input[type="text"], input[type="date"], input[type="email"], 
    input[type="number"], input[type="file"], textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    textarea {
        min-height: 80px;
    }
</style>
{% endblock %}
</file>

<file path="templates/accounts/group_management.html">
{% extends 'base.html' %}

{% block title %}Управление группами{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-collection"></i> Управление группами</span>
                <a href="{% url 'accounts:add_group' %}" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle"></i> Добавить группу
                </a>
            </div>
            <div class="card-body">
                
                <form method="get" class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="search" placeholder="Поиск по названию..." value="{{ search }}">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="course">
                            <option value="">Все курсы</option>
                            {% for i in "12345" %}
                                <option value="{{ i }}" {% if course_filter == i %}selected{% endif %}>{{ i }} курс</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Найти
                        </button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Курс</th>
                                <th>Год обучения</th>
                                <th>Специальность</th>
                                <th>Студентов</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups %}
                            <tr>
                                <td><strong>{{ group.name }}</strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ group.course }}</span>
                                </td>
                                <td>{{ group.academic_year }}</td>
                                <td>{{ group.specialty }}</td>
                                <td>
                                    <span class="badge bg-info">{{ group.students.count }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'accounts:edit_group' group.id %}" class="btn btn-outline-primary" title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'schedule:constructor' %}?group={{ group.id }}" class="btn btn-outline-info" title="Расписание">
                                            <i class="bi bi-calendar3"></i>
                                        </a>
                                        <a href="{% url 'accounts:delete_group' group.id %}" class="btn btn-outline-danger" title="Удалить">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">Группы не найдены</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/login.html">
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход в систему</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 3rem;
            min-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h2 {
            color: #2563eb;
            font-weight: 600;
        }
        
        .login-icon {
            font-size: 4rem;
            color: #2563eb;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
            border: none;
            padding: 0.75rem;
            font-weight: 500;
        }
        
        .btn-login:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="login-header">
            <div class="login-icon">🎓</div>
            <h2>Платформа деканата</h2>
            <p class="text-muted">Войдите в систему</p>
        </div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label for="username" class="form-label">Логин</label>
                <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Пароль</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary btn-login w-100">Войти</button>
        </form>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
</file>

<file path="templates/accounts/profile_dean.html">
{% extends 'accounts/profile_teacher.html' %}

{% block title %}Профиль декана{% endblock %}
</file>

<file path="templates/accounts/profile_student.html">
{% extends 'base.html' %}

{% block title %}Профиль студента{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body text-center">
                {% if user.photo %}
                    <img src="{{ user.photo.url }}" alt="Фото" class="profile-img mb-3">
                {% else %}
                    <div class="profile-img mb-3 bg-light d-flex align-items-center justify-content-center">
                        <i class="bi bi-person-circle" style="font-size: 5rem; color: #cbd5e1;"></i>
                    </div>
                {% endif %}
                
                <h4>{{ user.get_full_name }}</h4>
                <p class="text-muted">Студент</p>
                
                {# Показываем кнопки редактирования только если это свой профиль #}
                {% if not viewing_as_dean %}
                    <a href="{% url 'accounts:edit_profile' %}" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-pencil"></i> Редактировать профиль
                    </a>
                    <a href="{% url 'accounts:change_password' %}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-key"></i> Сменить пароль
                    </a>
                {% else %}
                    <a href="{% url 'accounts:user_management' %}" class="btn btn-secondary w-100">
                        <i class="bi bi-arrow-left"></i> Назад к списку
                    </a>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Академическая статистика
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Средний балл (GPA)</small>
                        <span class="badge {% if profile.get_average_grade >= 7 %}bg-success{% elif profile.get_average_grade >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                            {% if profile.get_average_grade >= 7 %}Отлично
                            {% elif profile.get_average_grade >= 4 %}Хорошо
                            {% else %}Требуется улучшение{% endif %}
                        </span>
                    </div>
                    <h2 class="mb-0 text-primary">{{ profile.get_average_grade|floatformat:2 }}</h2>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: {% widthratio profile.get_average_grade 1 8.33 %}%" 
                             aria-valuenow="{{ profile.get_average_grade }}" aria-valuemin="0" aria-valuemax="12">
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <small class="text-muted">Рейтинг в группе</small>
                    <h3 class="mb-0 text-warning">
                        {% if profile.get_group_rank > 0 %}
                            #{{ profile.get_group_rank }}
                        {% else %}
                            —
                        {% endif %}
                    </h3>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Посещаемость</small>
                        <span class="badge {% if profile.statistics.attendance_percentage >= 90 %}bg-success{% elif profile.statistics.attendance_percentage >= 75 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ profile.statistics.attendance_percentage|floatformat:0 }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ profile.statistics.attendance_percentage }}%" 
                             aria-valuenow="{{ profile.statistics.attendance_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Всего прогулов (НБ)</small>
                    <h3 class="mb-2 {% if profile.statistics.total_absent > 10 %}text-danger{% elif profile.statistics.total_absent > 5 %}text-warning{% else %}text-success{% endif %}">
                        {{ profile.statistics.total_absent }}
                    </h3>
                    
                    <div class="small">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">
                                <i class="bi bi-heart-pulse text-info"></i> Болезнь:
                            </span>
                            <strong class="text-info">{{ profile.statistics.absent_illness }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">
                                <i class="bi bi-check-circle text-success"></i> Уважительная:
                            </span>
                            <strong class="text-success">{{ profile.statistics.absent_valid }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">
                                <i class="bi bi-x-circle text-danger"></i> Неуважительная:
                            </span>
                            <strong class="text-danger">{{ profile.statistics.absent_invalid }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Личная информация
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Номер зачетки:</strong> {{ profile.student_id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Группа:</strong> {{ profile.group|default:"Не назначена" }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Курс:</strong> {{ profile.course }}
                    </div>
                    <div class="col-md-6">
                        <strong>Специальность:</strong> {{ profile.specialty }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Год поступления:</strong> {{ profile.admission_year }}
                    </div>
                    <div class="col-md-6">
                        <strong>Финансирование:</strong> {{ profile.get_financing_type_display }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Статус:</strong> 
                        <span class="badge bg-success">{{ profile.get_status_display }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Вид обучения:</strong> {{ profile.get_education_type_display }}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-person-badge"></i> Персональные данные
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Дата рождения:</strong> {{ profile.birth_date }}
                    </div>
                    <div class="col-md-6">
                        <strong>Пол:</strong> {{ profile.get_gender_display }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Национальность:</strong> {{ profile.nationality }}
                    </div>
                    <div class="col-md-6">
                        <strong>Язык обучения:</strong> {{ profile.get_education_language_display }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Паспорт:</strong> {{ profile.passport_series }} {{ profile.passport_number }}
                        <br><small class="text-muted">Выдан: {{ profile.passport_issued_by }}, {{ profile.passport_issue_date }}</small>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Адрес регистрации:</strong><br>
                        {{ profile.registration_address }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <strong>Адрес проживания:</strong><br>
                        {{ profile.residence_address }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/profile_teacher.html">
{% extends 'base.html' %}

{% block title %}Профиль преподавателя{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body text-center">
                {% if user.photo %}
                    <img src="{{ user.photo.url }}" alt="Фото" class="profile-img mb-3">
                {% else %}
                    <div class="profile-img mb-3 bg-light d-flex align-items-center justify-content-center">
                        <i class="bi bi-person-circle" style="font-size: 5rem; color: #cbd5e1;"></i>
                    </div>
                {% endif %}
                
                <h4>{{ profile.get_degree_display }}</h4>
                <h5>{{ user.get_full_name }}</h5>
                <p class="text-muted">{{ profile.get_title_display }}</p>
                
                {% if not viewing_as_dean %}
                    <a href="{% url 'accounts:edit_profile' %}" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-pencil"></i> Редактировать профиль
                    </a>
                    <a href="{% url 'accounts:change_password' %}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-key"></i> Сменить пароль
                    </a>
                {% else %}
                    <a href="{% url 'accounts:user_management' %}" class="btn btn-secondary w-100">
                        <i class="bi bi-arrow-left"></i> Назад к списку
                    </a>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-envelope"></i> Контакты
            </div>
            <div class="card-body">
                {% if profile.contact_email %}
                <p><strong>Email:</strong><br>{{ profile.contact_email }}</p>
                {% endif %}
                
                {% if profile.telegram %}
                <p><strong>Telegram:</strong><br>{{ profile.telegram }}</p>
                {% endif %}
                
                {% if profile.consultation_hours %}
                <p><strong>Часы консультаций:</strong><br>{{ profile.consultation_hours }}</p>
                {% endif %}
                
                {% if not profile.contact_email and not profile.telegram and not profile.consultation_hours %}
                <p class="text-muted">Контактная информация не заполнена</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-journal-text"></i> О преподавателе
            </div>
            <div class="card-body">
                {% if profile.biography %}
                <h6>Биография</h6>
                <p>{{ profile.biography|linebreaks }}</p>
                {% endif %}
                
                {% if profile.research_interests %}
                <h6 class="mt-3">Научные интересы</h6>
                <p>{{ profile.research_interests|linebreaks }}</p>
                {% endif %}
                
                {% if not profile.biography and not profile.research_interests %}
                <p class="text-muted">Информация не заполнена</p>
                {% endif %}
            </div>
        </div>
        
        <div class="row mt-3">
            <!-- Сегодняшние занятия -->
            <div class="col-md-6">
                {% include 'schedule/today_widget.html' %}
            </div>
            
            <!-- Статистика по группам -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-collection"></i> Мои группы
                    </div>
                    <div class="card-body">
                        {% if teacher_groups %}
                            <div class="list-group list-group-flush">
                                {% for group_data in teacher_groups %}
                                    <div class="list-group-item px-0">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">{{ group_data.group.name }}</h6>
                                                <small class="text-muted">
                                                    {{ group_data.students_count }} студентов | 
                                                    Курс {{ group_data.group.course }}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <div class="badge bg-primary mb-1">
                                                    GPA: {{ group_data.avg_gpa|floatformat:1 }}
                                                </div>
                                                <br>
                                                <small class="text-muted">
                                                    {{ group_data.avg_attendance|floatformat:0 }}% посещ.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <a href="{% url 'schedule:group_list' %}" class="btn btn-sm btn-primary w-100">
                                    <i class="bi bi-list-ul"></i> Подробнее о группах
                                </a>
                            </div>
                        {% else %}
                            <p class="text-muted text-center">Группы не назначены</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/reset_password.html">
{% extends 'base.html' %}
{% block title %}Сбросить пароль{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header"><i class="bi bi-key"></i> Сбросить пароль для {{ user_obj.get_full_name }}</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mb-3">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-warning">Сбросить пароль</button>
                    <a href="{% url 'accounts:user_management' %}" class="btn btn-secondary">Отмена</a>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/transfer_student.html">
{% extends 'base.html' %}
{% block title %}Перевод студента{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header"><i class="bi bi-arrow-left-right"></i> Перевод студента</div>
            <div class="card-body">
                <p><strong>Студент:</strong> {{ student.user.get_full_name }}</p>
                <p><strong>Текущая группа:</strong> {{ student.group|default:"не назначена" }}</p>
                <hr>
                <form method="post">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mb-3">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary">Перевести</button>
                    <a href="{% url 'accounts:user_management' %}" class="btn btn-secondary">Отмена</a>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/accounts/user_management.html">
{% extends 'base.html' %}

{% block title %}Управление пользователями{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-people"></i> Управление пользователями</span>
                <a href="{% url 'accounts:add_user' %}" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle"></i> Добавить пользователя
                </a>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="search" placeholder="Поиск..." value="{{ search }}">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="role">
                            <option value="">Все роли</option>
                            <option value="STUDENT" {% if role_filter == 'STUDENT' %}selected{% endif %}>Студенты</option>
                            <option value="TEACHER" {% if role_filter == 'TEACHER' %}selected{% endif %}>Преподаватели</option>
                            <option value="DEAN" {% if role_filter == 'DEAN' %}selected{% endif %}>Деканы</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Найти
                        </button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Логин</th>
                                <th>ФИО</th>
                                <th>Роль</th>
                                <th>Телефон</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_data in users_with_profiles %}
                            {% with user_obj=user_data.user %}
                            <tr>
                                <td>
                                    {{ user_obj.username }}
                                    {% if user_obj.is_superuser %}
                                        <span class="badge bg-danger ms-1" title="Суперпользователь">SUPER</span>
                                    {% endif %}
                                </td>
                                <td>{{ user_obj.get_full_name }}</td>
                                <td>
                                    <span class="badge
                                        {% if user_obj.role == 'STUDENT' %}bg-primary
                                        {% elif user_obj.role == 'TEACHER' %}bg-info
                                        {% else %}bg-warning{% endif %}">
                                        {{ user_obj.get_role_display|default:"Не указана" }}
                                    </span>
                                    
                                    {# ✅ Предупреждение об отсутствии профиля #}
                                    {% if not user_data.has_profile %}
                                        <span class="badge bg-danger" title="Профиль не создан">!</span>
                                    {% endif %}
                                </td>
                                <td>{{ user_obj.phone|default:"—" }}</td>
                                <td>
                                    {% if user_obj.is_active %}
                                        <span class="badge bg-success">Активен</span>
                                    {% else %}
                                        <span class="badge bg-danger">Заблокирован</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'accounts:view_user_profile' user_obj.id %}" 
                                           class="btn btn-outline-info" 
                                           title="Просмотр профиля">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        
                                        <a href="{% url 'accounts:edit_user' user_obj.id %}" 
                                           class="btn btn-outline-primary" 
                                           title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        
                                        <a href="{% url 'accounts:reset_password' user_obj.id %}" 
                                           class="btn btn-outline-warning" 
                                           title="Сбросить пароль">
                                            <i class="bi bi-key"></i>
                                        </a>
                                        
                                        {# ✅ ЗАЩИТА: Нельзя заблокировать себя #}
                                        {% if user_obj.id == user.id %}
                                            <button type="button" 
                                                    class="btn btn-outline-secondary" 
                                                    title="Нельзя заблокировать себя" 
                                                    disabled>
                                                <i class="bi bi-shield-lock"></i>
                                            </button>
                                        {% else %}
                                            <a href="{% url 'accounts:toggle_user_active' user_obj.id %}" 
                                               class="btn btn-outline-danger" 
                                               onclick="return confirm('{% if user_obj.is_active %}Заблокировать{% else %}Активировать{% endif %} пользователя {{ user_obj.username }}?')"
                                               title="{% if user_obj.is_active %}Заблокировать{% else %}Активировать{% endif %}">
                                                <i class="bi bi-{% if user_obj.is_active %}lock{% else %}unlock{% endif %}"></i>
                                            </a>
                                        {% endif %}
                                        
                                        {# ✅ ИСПРАВЛЕНО: Безопасная проверка профиля студента #}
                                        {% if user_obj.role == 'STUDENT' %}
                                            {% if user_data.has_profile and user_data.profile_id %}
                                                <a href="{% url 'accounts:transfer_student' user_data.profile_id %}" 
                                                   class="btn btn-outline-info" 
                                                   title="Перевести в другую группу">
                                                    <i class="bi bi-arrow-left-right"></i>
                                                </a>
                                            {% else %}
                                                <button type="button" 
                                                        class="btn btn-outline-secondary" 
                                                        title="Профиль студента не создан" 
                                                        disabled>
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/base.html">
<!DOCTYPE html>
<html lang="ru">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Платформа деканата{% endblock %}</title>

    <!-- Основные стили -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    <!-- Стили с тёмной/светлой темой -->
    <style>
        :root {
            --primary-blue: #2563eb;
            --light-blue: #60a5fa;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
            --card-light: #ffffff;
            --card-dark: #334155;
            --navbar-light: linear-gradient(135deg, var(--primary-blue) 0%, var(--light-blue) 100%);
            --navbar-dark: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        /* Светлая тема (по умолчанию) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .navbar {
            background: var(--navbar-light);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            z-index: 1030;
            transition: background 0.3s ease;
        }

        body.dark-mode .navbar {
            background: var(--navbar-dark) !important;
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .nav-link:hover {
            color: var(--accent-amber) !important;
        }

        /* Кнопки */
        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .btn-primary:hover {
            background-color: var(--light-blue);
            border-color: var(--light-blue);
        }

        .btn-success {
            background-color: var(--accent-green);
            border-color: var(--accent-green);
        }

        /* Карточки */
        .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 12px;
            background-color: var(--card-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode .card {
            background-color: var(--card-dark);
            color: var(--text-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .card-header {
            background-color: var(--primary-blue);
            color: white;
            border-radius: 12px 12px 0 0 !important;
        }

        /* Боковая панель */
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: white;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease;
        }

        body.dark-mode .sidebar {
            background-color: var(--card-dark);
        }

        .sidebar .nav-link {
            color: #4b5563;
            padding: 0.75rem 1rem;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        body.dark-mode .sidebar .nav-link {
            color: var(--text-dark);
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #eff6ff;
            border-left-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        body.dark-mode .sidebar .nav-link:hover,
        body.dark-mode .sidebar .nav-link.active {
            background-color: rgba(37, 99, 235, 0.2);
            color: var(--light-blue);
        }

        /* Таблицы */
        .table {
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        body.dark-mode .table {
            color: var(--text-dark);
        }

        body.dark-mode .table.table-light {
            background-color: #475569;
        }

        /* Алерты */
        .alert {
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Профиль */
        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--primary-blue);
        }

        /* КНОПКА ПЕРЕКЛЮЧЕНИЯ ТЕМЫ */
        .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--navbar-light);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.dark-mode .theme-toggle {
            background: var(--navbar-dark);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        /* КРИТИЧНО: Отключаем все анимации фона */
        .animated-bg,
        .floating-shape {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
            opacity: 0 !important;
        }

        /* Гарантируем работу dropdown */
        .dropdown-menu {
            z-index: 1050 !important;
            position: absolute !important;
            display: none;
            background-color: white;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .dropdown-menu {
            background-color: var(--card-dark);
            border: 1px solid #475569;
        }

        .dropdown-menu.show {
            display: block !important;
        }

        .dropdown-item {
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        body.dark-mode .dropdown-item {
            color: var(--text-dark);
        }

        body.dark-mode .dropdown-item:hover {
            background-color: rgba(37, 99, 235, 0.2);
            color: var(--light-blue);
        }

        /* Убираем любые возможные перекрытия */
        .dropdown-toggle,
        .navbar-toggler {
            z-index: 1051 !important;
            position: relative;
        }

        /* Простые ховер-эффекты */
        .nav-link:hover {
            opacity: 0.9;
        }

        .dropdown-toggle:hover {
            opacity: 0.9;
        }

        /* Формы */
        .form-control, .form-select {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #475569;
            color: var(--text-dark);
            border-color: #64748b;
        }

        body.dark-mode .form-control:focus,
        body.dark-mode .form-select:focus {
            background-color: #475569;
            color: var(--text-dark);
            border-color: var(--primary-blue);
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Обычная навигация Bootstrap -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'core:dashboard' %}">
                <i class="bi bi-mortarboard-fill"></i> Платформа деканата
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Переключить навигацию">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                {% if user.is_authenticated %}
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'core:dashboard' %}">
                            <i class="bi bi-house-door"></i> Главная
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'news:list' %}">
                            <i class="bi bi-newspaper"></i> Новости
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'chat:list' %}">
                            <i class="bi bi-chat-dots"></i> Чаты
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'schedule:view' %}">
                            <i class="bi bi-calendar-week"></i> Расписание
                        </a>
                    </li>

                    {% if user.role == 'TEACHER' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'journal:journal_view' %}">
                            <i class="bi bi-journal-text"></i> Журнал
                        </a>
                    </li>
                    {% elif user.role == 'STUDENT' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'journal:student_view' %}">
                            <i class="bi bi-journal-check"></i> Мои оценки
                        </a>
                    </li>
                    {% elif user.role == 'DEAN' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'journal:dean_view' %}">
                            <i class="bi bi-graph-up"></i> Аналитика
                        </a>
                    </li>
                    {% endif %}

                    {% if user.role == 'DEAN' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle"
                           href="#"
                           id="managementDropdown"
                           role="button"
                           data-bs-toggle="dropdown"
                           aria-expanded="false">
                            <i class="bi bi-gear"></i> Управление
                        </a>

                        <ul class="dropdown-menu" aria-labelledby="managementDropdown">
                            <li><h6 class="dropdown-header">Пользователи и группы</h6></li>
                            <li><a class="dropdown-item" href="{% url 'accounts:user_management' %}">
                                <i class="bi bi-people"></i> Пользователи
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'accounts:group_management' %}">
                                <i class="bi bi-collection"></i> Группы
                            </a></li>

                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Расписание</h6></li>
                            <li><a class="dropdown-item" href="{% url 'schedule:manage_subjects' %}">
                                <i class="bi bi-book"></i> Предметы
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'schedule:manage_semesters' %}">
                                <i class="bi bi-calendar-range"></i> Семестры
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'schedule:manage_classrooms' %}">
                                <i class="bi bi-door-open"></i> Кабинеты
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'schedule:constructor' %}">
                                <i class="bi bi-calendar3"></i> Конструктор расписания
                            </a></li>

                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Отчеты</h6></li>
                            <li><a class="dropdown-item" href="{% url 'journal:department_report' %}">
                                <i class="bi bi-bar-chart"></i> Отчет по кафедре
                            </a></li>
                        </ul>
                    </li>
                    {% elif user.role == 'TEACHER' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'schedule:group_list' %}">
                            <i class="bi bi-list-ul"></i> Мои группы
                        </a>
                    </li>
                    {% endif %}
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle"
                           href="#"
                           id="userDropdown"
                           role="button"
                           data-bs-toggle="dropdown"
                           aria-expanded="false">
                            <i class="bi bi-person-circle"></i> {{ user.get_full_name|default:user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">
                                <i class="bi bi-person"></i> Профиль
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'accounts:change_password' %}">
                                <i class="bi bi-key"></i> Сменить пароль
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'accounts:logout' %}">
                                <i class="bi bi-box-arrow-right"></i> Выход
                            </a></li>
                        </ul>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        {% if messages %}
            <div class="row">
                <div class="col-12">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <!-- Кнопка переключения темы -->
    <button class="theme-toggle" id="themeToggle">
        <i class="bi bi-moon-fill"></i>
    </button>

    <!-- Только базовые скрипты Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Скрипт для тёмной темы -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Сайт загружен');

            // Удаляем анимированный фон если он был создан
            const animatedBg = document.querySelector('.animated-bg');
            if (animatedBg) {
                animatedBg.remove();
            }

            // Удаляем плавающие фигуры
            const shapes = document.querySelectorAll('.floating-shape');
            shapes.forEach(shape => shape.remove());

            // === ТЁМНАЯ ТЕМА ===
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('i');

            // Проверяем сохранённую тему
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.className = 'bi bi-sun-fill';
            }

            // Функция переключения темы
            themeToggle.onclick = function() {
                document.body.classList.toggle('dark-mode');

                // Обновляем иконку
                const isDark = document.body.classList.contains('dark-mode');
                themeIcon.className = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-fill';

                // Сохраняем в localStorage
                localStorage.setItem('theme', isDark ? 'dark' : 'light');

                console.log('Тема изменена на: ' + (isDark ? 'тёмная' : 'светлая'));
            };

            // Добавляем плавный переход после загрузки
            setTimeout(() => {
                document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            }, 100);
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
</file>

<file path="templates/chat/chat_list.html">
{% extends 'base.html' %}

{% block title %}Чаты{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat-dots"></i> Мои чаты</span>
                <a href="{% url 'chat:start' %}" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle"></i> Новый чат
                </a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for room in rooms %}
                        <a href="{% url 'chat:room' room.id %}" class="list-group-item list-group-item-action {% if room.unread > 0 %}bg-light{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-chat-left-text me-2"></i>
                                        <strong>{{ room }}</strong>
                                        {% if room.unread > 0 %}
                                            <span class="badge bg-danger ms-2">{{ room.unread }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if room.last_msg %}
                                        <small class="text-muted d-block mt-1">
                                            <strong>{{ room.last_msg.sender.get_full_name }}:</strong>
                                            {{ room.last_msg.content|truncatewords:10 }}
                                        </small>
                                    {% endif %}
                                </div>
                                
                                {% if room.last_msg %}
                                    <small class="text-muted">
                                        {{ room.last_msg.created_at|date:"d.m H:i" }}
                                    </small>
                                {% endif %}
                            </div>
                        </a>
                    {% empty %}
                        <div class="p-5 text-center text-muted">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-3">У вас пока нет чатов</p>
                            <a href="{% url 'chat:start' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Начать новый чат
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/chat/chat_room.html">
{% extends 'base.html' %}

{% block title %}Чат: {{ room }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-chat-left-text"></i>
                    <strong>{{ room }}</strong>
                </span>
                <div>
                    <small class="text-muted">
                        Участники: 
                        {% for participant in room.participants.all %}
                            {{ participant.get_full_name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </small>
                </div>
            </div>
            
            <div class="card-body" style="height: 500px; overflow-y: auto;" id="messagesContainer">
                {% for message in messages %}
                    <div class="mb-3 {% if message.sender == user %}text-end{% endif %}" data-message-id="{{ message.id }}">
                        <div class="d-inline-block {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %} p-3 rounded" style="max-width: 70%;">
                            {% if message.sender != user %}
                                <small class="d-block mb-1">
                                    <strong>{{ message.sender.get_full_name }}</strong>
                                </small>
                            {% endif %}
                            <div>{{ message.content|linebreaks }}</div>
                            <small class="d-block mt-2 {% if message.sender == user %}text-white-50{% else %}text-muted{% endif %}">
                                {{ message.created_at|date:"d.m.Y H:i" }}
                                {% if message.sender == user %}
                                    <a href="{% url 'chat:delete_message' message.id %}" 
                                       class="text-white-50 ms-2" 
                                       onclick="return confirm('Удалить сообщение?')"
                                       title="Удалить">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <div class="card-footer">
                <form method="post" id="messageForm">
                    {% csrf_token %}
                    <div class="input-group">
                        {{ form.content }}
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="bi bi-send"></i> Отправить
                        </button>
                    </div>
                    <small class="text-muted">Нажмите Enter для отправки или Shift+Enter для новой строки</small>
                </form>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="{% url 'chat:list' %}" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> К чатам
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const textarea = document.querySelector('textarea[name="content"]');
    const sendButton = document.getElementById('sendButton');
    
    function scrollToBottom() {
        container.scrollTop = container.scrollHeight;
    }
    scrollToBottom();
    
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (textarea.value.trim()) {
                messageForm.submit();
            }
        }
    });
    
    messageForm.addEventListener('submit', function(e) {
        if (!textarea.value.trim()) {
            e.preventDefault();
            return;
        }
        
        sendButton.disabled = true;
        sendButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    });
    
    let lastMessageId = {% if messages %}{{ messages.last.id }}{% else %}0{% endif %};
    const processedMessages = new Set();
    
    // Инициализация: добавляем все существующие сообщения в Set
    document.querySelectorAll('[data-message-id]').forEach(el => {
        const msgId = parseInt(el.getAttribute('data-message-id'));
        processedMessages.add(msgId);
        lastMessageId = Math.max(lastMessageId, msgId);
    });
    
    function fetchNewMessages() {
        fetch('{% url "chat:new_messages" room.id %}?last_id=' + lastMessageId)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    let hasNewMessages = false;
                    
                    data.messages.forEach(msg => {
                        // Проверяем, не добавлено ли уже это сообщение
                        if (!processedMessages.has(msg.id)) {
                            processedMessages.add(msg.id);
                            
                            const div = document.createElement('div');
                            div.className = 'mb-3 ' + (msg.is_mine ? 'text-end' : '');
                            div.setAttribute('data-message-id', msg.id);
                            div.innerHTML = `
                                <div class="d-inline-block ${msg.is_mine ? 'bg-primary text-white' : 'bg-light'} p-3 rounded" style="max-width: 70%;">
                                    ${!msg.is_mine ? '<small class="d-block mb-1"><strong>' + escapeHtml(msg.sender_name) + '</strong></small>' : ''}
                                    <div>${escapeHtml(msg.content).replace(/\n/g, '<br>')}</div>
                                    <small class="d-block mt-2 ${msg.is_mine ? 'text-white-50' : 'text-muted'}">
                                        ${msg.created_at}
                                    </small>
                                </div>
                            `;
                            container.appendChild(div);
                            lastMessageId = Math.max(lastMessageId, msg.id);
                            hasNewMessages = true;
                        }
                    });
                    
                    if (hasNewMessages) {
                        scrollToBottom();
                    }
                }
            })
            .catch(error => console.error('Ошибка загрузки сообщений:', error));
    }
    
    // Задержка первого обновления после отправки формы для предотвращения дублирования
    setTimeout(() => {
        setInterval(fetchNewMessages, 3000);
    }, 1000);
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
});
</script>

<style>
#messagesContainer::-webkit-scrollbar {
    width: 8px;
}

#messagesContainer::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#messagesContainer::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#messagesContainer::-webkit-scrollbar-thumb:hover {
    background: #555;
}

textarea[name="content"] {
    resize: none;
    min-height: 60px;
}
</style>
{% endblock %}
</file>

<file path="templates/chat/start_chat.html">
{% extends 'base.html' %}

{% block title %}Начать чат{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-person-plus"></i> Выберите пользователя для начала чата
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" id="searchUsers" class="form-control" placeholder="Поиск пользователя...">
                </div>
                
                <div class="list-group" id="usersList">
                    {% for user in users %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <button type="submit" class="list-group-item list-group-item-action user-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-person-circle me-2"></i>
                                        <strong>{{ user.get_full_name }}</strong>
                                        <span class="badge bg-primary ms-2">{{ user.get_role_display }}</span>
                                    </div>
                                    <small class="text-muted">
                                        {% if user.role == 'STUDENT' %}
                                            {{ user.student_profile.group }}
                                        {% elif user.role == 'TEACHER' %}
                                            {{ user.teacher_profile.get_degree_display }}
                                        {% endif %}
                                    </small>
                                </div>
                            </button>
                        </form>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="{% url 'chat:list' %}" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Назад к чатам
            </a>
        </div>
    </div>
</div>

<script>
// Поиск пользователей
document.getElementById('searchUsers').addEventListener('input', function() {
    const search = this.value.toLowerCase();
    const items = document.querySelectorAll('.user-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(search)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
</file>

<file path="templates/core/dashboard_dean.html">
{% extends 'base.html' %}
{% block title %}Главная{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2>Добро пожаловать, {{ user.get_full_name }}!</h2>
        <p class="text-muted">Панель декана</p>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-people-fill" style="font-size: 3rem; color: var(--primary-blue);"></i>
                <h5 class="mt-2">Всего студентов</h5>
                <h3 class="stat-number">{{ total_students }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-person-badge" style="font-size: 3rem; color: var(--accent-green);"></i>
                <h5 class="mt-2">Преподавателей</h5>
                <h3 class="stat-number">{{ total_teachers }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-collection" style="font-size: 3rem; color: var(--accent-amber);"></i>
                <h5 class="mt-2">Групп</h5>
                <h3 class="stat-number">{{ total_groups }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
                <h5 class="mt-2">Задолженности</h5>
                <h3>Нету</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header"><i class="bi bi-speedometer2"></i> Быстрые действия</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{% url 'accounts:user_management' %}" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-people"></i><br>Управление пользователями
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'schedule:constructor' %}" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-calendar3"></i><br>Конструктор расписания
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'journal:department_report' %}" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-bar-chart"></i><br>Отчет по кафедре
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'news:create' %}" class="btn btn-success w-100 mb-2">
                            <i class="bi bi-newspaper"></i><br>Создать новость
                        </a>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-3">
                        <a href="{% url 'accounts:add_user' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-plus-circle"></i><br>Добавить пользователя
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'schedule:manage_academic_week' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-calendar-range"></i><br>Учебные недели
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'journal:dean_view' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-graph-up"></i><br>Аналитика успеваемости
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'chat:list' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-chat-dots"></i><br>Чаты
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if news_list %}
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-newspaper"></i> Последние новости</span>
                <div>
                    <a href="{% url 'news:create' %}" class="btn btn-sm btn-success me-2">
                        <i class="bi bi-plus-circle"></i> Добавить
                    </a>
                    <a href="{% url 'news:list' %}" class="btn btn-sm btn-primary">Все новости</a>
                </div>
            </div>
            <div class="card-body">
                {% for news in news_list %}
                    <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <h6 class="mb-1">
                            {% if news.is_pinned %}<i class="bi bi-pin-angle-fill text-warning"></i>{% endif %}
                            <a href="{% url 'news:detail' news.id %}">{{ news.title }}</a>
                        </h6>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ news.created_at|date:"d.m.Y H:i" }}
                            | <span class="badge bg-primary">{{ news.get_category_display }}</span>
                            | <i class="bi bi-eye"></i> {{ news.views_count }}
                        </small>
                        <p class="mb-0 mt-1 text-muted">{{ news.content|truncatewords:20 }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
</file>

<file path="templates/core/dashboard_student.html">
{% extends 'base.html' %}
{% load static %}
{% block title %}Главная{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2>Добро пожаловать, {{ user.get_full_name }}!</h2>
        <p class="text-muted">Студент {{ profile.course }} курса, группа {{ profile.group|default:"не назначена" }}</p>
    </div>
</div>

<div class="row mt-3">
    <!-- Средний балл -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-journal-check" style="font-size: 3rem; color: var(--accent-green);"></i>
                <h5 class="mt-2">Средний балл</h5>
                <h2 class="stat-number">{{ profile.get_average_grade|floatformat:2|default:"0.00" }}</h2>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {% widthratio profile.get_average_grade 1 8.33 %}%">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Рейтинг -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-trophy" style="font-size: 3rem; color: var(--accent-amber);"></i>
                <h5 class="mt-2">Рейтинг в группе</h5>
                <h2 class="stat-number">{{ profile.get_group_rank|default:"—" }}</h2>
                <small class="text-muted">
                    {% if profile.get_group_rank == 1 %}🥇 Лучший в группе!
                    {% elif profile.get_group_rank <= 3 %}🥈 В тройке лидеров!
                    {% else %}Продолжай стараться!{% endif %}
                </small>
            </div>
        </div>
    </div>
    
    <!-- Посещаемость -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-calendar2-check" style="font-size: 3rem; color: var(--primary-blue);"></i>
                <h5 class="mt-2">Посещаемость</h5>
                <h2 class="stat-number">{{ profile.get_attendance_percentage|floatformat:0|default:"0" }}%</h2>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar {% if profile.get_attendance_percentage >= 90 %}bg-success{% elif profile.get_attendance_percentage >= 75 %}bg-warning{% else %}bg-danger{% endif %}" 
                         role="progressbar" style="width: {{ profile.get_attendance_percentage|default:0 }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Прогулы -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: {% if profile.get_total_absent > 10 %}#ef4444{% elif profile.get_total_absent > 5 %}var(--accent-amber){% else %}var(--accent-green){% endif %};"></i>
                <h5 class="mt-2">Прогулов (НБ)</h5>
                <h2 class="stat-number {% if profile.get_total_absent > 10 %}text-danger{% elif profile.get_total_absent > 5 %}text-warning{% else %}text-success{% endif %}">
                    {{ profile.get_total_absent }}
                </h2>
                <small class="text-muted">
                    {% if profile.get_total_absent == 0 %}✅ Отлично!
                    {% elif profile.get_total_absent <= 5 %}⚠️ Будь внимательнее
                    {% else %}❌ Требует внимания!{% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Виджет расписания и быстрый доступ -->
<div class="row mt-3">
    <div class="col-lg-6">
        {% include 'schedule/today_widget.html' %}
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-link-45deg"></i> Быстрый доступ
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'schedule:view' %}" class="btn btn-outline-primary">
                        <i class="bi bi-calendar-week"></i> Мое расписание
                    </a>
                    <a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary">
                        <i class="bi bi-person"></i> Мой профиль
                    </a>
                    <a href="{% url 'journal:student_view' %}" class="btn btn-outline-primary">
                        <i class="bi bi-journal"></i> Мои оценки
                    </a>
                    <a href="{% url 'chat:list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-chat-dots"></i> Чаты
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Новости -->
{% if news_list %}
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-newspaper"></i> Последние новости</span>
                <a href="{% url 'news:list' %}" class="btn btn-sm btn-primary">Все новости</a>
            </div>
            <div class="card-body">
                {% for news in news_list %}
                    <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <h6 class="mb-1">
                            {% if news.is_pinned %}<i class="bi bi-pin-angle-fill text-warning"></i>{% endif %}
                            <a href="{% url 'news:detail' news.id %}">{{ news.title }}</a>
                        </h6>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ news.created_at|date:"d.m.Y H:i" }}
                            | <span class="badge bg-primary">{{ news.get_category_display }}</span>
                        </small>
                        <p class="mb-0 mt-1 text-muted">{{ news.content|truncatewords:20 }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
</file>

<file path="templates/core/dashboard_teacher.html">
{% extends 'base.html' %}
{% block title %}Главная{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2>Добро пожаловать, {{ profile.get_degree_display }} {{ user.get_full_name }}!</h2>
        <p class="text-muted">{{ profile.get_title_display }}</p>
    </div>
</div>

<div class="row mt-3">
    
    <div class="col-lg-6">
        {% include 'schedule/today_widget.html' %}
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-speedometer2"></i> Быстрые действия
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'journal:journal_view' %}" class="btn btn-primary">
                        <i class="bi bi-journal-text"></i> Журнал успеваемости
                    </a>
                    <a href="{% url 'schedule:view' %}" class="btn btn-outline-primary">
                        <i class="bi bi-calendar-week"></i> Мое расписание
                    </a>
                    <a href="{% url 'schedule:group_list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-people"></i> Мои студенты
                    </a>
                    <a href="{% url 'chat:list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-chat-dots"></i> Чаты
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if news_list %}
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-newspaper"></i> Последние новости</span>
                <a href="{% url 'news:list' %}" class="btn btn-sm btn-primary">Все новости</a>
            </div>
            <div class="card-body">
                {% for news in news_list %}
                    <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <h6 class="mb-1">
                            {% if news.is_pinned %}<i class="bi bi-pin-angle-fill text-warning"></i>{% endif %}
                            <a href="{% url 'news:detail' news.id %}">{{ news.title }}</a>
                        </h6>
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ news.created_at|date:"d.m.Y H:i" }}
                            | <span class="badge bg-primary">{{ news.get_category_display }}</span>
                        </small>
                        <p class="mb-0 mt-1 text-muted">{{ news.content|truncatewords:20 }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
</file>

<file path="templates/journal/change_log.html">
{% extends 'base.html' %}

{% block title %}История изменений{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-clock-history"></i> 
                    История изменений: {{ group.name }} - {{ subject.name }}
                </span>
                <a href="{% url 'journal:journal_view' %}?group={{ group.id }}&subject={{ subject.id }}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> К журналу
                </a>
            </div>
            <div class="card-body">
                
                <form method="get" class="mb-4">
                    <input type="hidden" name="group" value="{{ group.id }}">
                    <input type="hidden" name="subject" value="{{ subject.id }}">
                    
                    <div class="row g-3">
                        <div class="col-md-3">
                            {{ filter_form.date_from }}
                        </div>
                        <div class="col-md-3">
                            {{ filter_form.date_to }}
                        </div>
                        <div class="col-md-3">
                            {{ filter_form.student }}
                        </div>
                        <div class="col-md-3">
                            {{ filter_form.teacher }}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm mt-2">
                        <i class="bi bi-funnel"></i> Применить фильтры
                    </button>
                    <a href="{% url 'journal:change_log' %}?group={{ group.id }}&subject={{ subject.id }}" class="btn btn-outline-secondary btn-sm mt-2">
                        <i class="bi bi-x-circle"></i> Сбросить
                    </a>
                </form>

                {% if logs %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Дата и время</th>
                                <th>Преподаватель</th>
                                <th>Студент</th>
                                <th>Дата занятия</th>
                                <th>Изменение</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td>
                                    <small>{{ log.changed_at|date:"d.m.Y H:i:s" }}</small>
                                </td>
                                <td>
                                    {{ log.changed_by.user.get_full_name|default:"Система" }}
                                </td>
                                <td>
                                    {{ log.entry.student.user.get_full_name }}
                                </td>
                                <td>
                                    <small>{{ log.entry.lesson_date|date:"d.m.Y" }} {{ log.entry.lesson_time|time:"H:i" }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ log.get_change_description }}</span>
                                    {% if log.comment %}
                                        <br><small class="text-muted">{{ log.comment }}</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    Показано последние 100 записей. Используйте фильтры для уточнения поиска.
                </div>
                {% else %}
                <div class="alert alert-warning text-center">
                    <i class="bi bi-inbox"></i> Изменений не найдено
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/journal/dean_view.html">
{% extends 'base.html' %}

{% block title %}Аналитика успеваемости{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Аналитика успеваемости
            </div>
            <div class="card-body">
                
                <form method="get" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Группа</label>
                            <select name="group" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Выберите группу --</option>
                                {% for group in groups %}
                                    <option value="{{ group.id }}" {% if selected_group and selected_group.id == group.id %}selected{% endif %}>
                                        {{ group.name }} ({{ group.course }} курс)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Режим просмотра</label>
                            <select name="view" class="form-select" onchange="this.form.submit()">
                                <option value="summary" {% if view_type == 'summary' %}selected{% endif %}>Общая статистика</option>
                                <option value="at_risk" {% if view_type == 'at_risk' %}selected{% endif %}>Студенты под угрозой</option>
                            </select>
                        </div>
                    </div>
                </form>
                
                {% if not selected_group %}
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle"></i> Выберите группу для просмотра аналитики
                    </div>
                {% else %}
                    {% if view_type == 'summary' %}
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary bg-opacity-10">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Средний балл группы</h6>
                                        <h2 class="text-primary">{{ group_stats.avg_gpa|floatformat:2 }}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success bg-opacity-10">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Средняя посещаемость</h6>
                                        <h2 class="text-success">{{ group_stats.avg_attendance|floatformat:0 }}%</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info bg-opacity-10">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Всего студентов</h6>
                                        <h2 class="text-info">{{ group_stats.total_students }}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3">Статистика по предметам</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Предмет</th>
                                        <th>Преподаватель</th>
                                        <th>Средний балл</th>
                                        <th>Посещаемость</th>
                                        <th>Диаграмма</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for subject in group_stats.subjects %}
                                    <tr>
                                        <td><strong>{{ subject.name }}</strong></td>
                                        <td><i class="bi bi-person"></i> {{ subject.teacher_name }}</td>
                                        <td>
                                            <span class="badge {% if subject.avg_grade >= 7 %}bg-success{% elif subject.avg_grade >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ subject.avg_grade }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if subject.attendance_pct >= 80 %}bg-success{% elif subject.attendance_pct >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ subject.attendance_pct|floatformat:0 }}%
                                            </span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar bg-primary" style="width: {% widthratio subject.avg_grade 1 8.33 %}%">
                                                    {{ subject.avg_grade }}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                    {% elif view_type == 'at_risk' %}
                        
                        <h5 class="mb-3">
                            <i class="bi bi-exclamation-triangle text-danger"></i> 
                            Студенты под угрозой (балл < 4 или посещаемость < 60%)
                        </h5>
                        
                        {% if at_risk_students %}
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-danger">
                                    <tr>
                                        <th>Студент</th>
                                        <th>Средний балл</th>
                                        <th>Посещаемость</th>
                                        <th>Рейтинг в группе</th>
                                        <th>Причины</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in at_risk_students %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'accounts:view_user_profile' item.student.user.id %}">
                                                <strong>{{ item.student.user.get_full_name }}</strong>
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge {% if item.stats.overall_gpa < 4 %}bg-danger{% else %}bg-warning{% endif %}">
                                                {{ item.stats.overall_gpa|floatformat:2 }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if item.stats.attendance_percentage < 60 %}bg-danger{% else %}bg-warning{% endif %}">
                                                {{ item.stats.attendance_percentage|floatformat:0 }}%
                                            </span>
                                        </td>
                                        <td>{{ item.stats.group_rank }}</td>
                                        <td>
                                            {% for reason in item.reason %}
                                                <div class="text-danger"><small>• {{ reason }}</small></div>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-success text-center">
                            <i class="bi bi-check-circle"></i> 
                            <strong>Отлично!</strong> В группе нет студентов под угрозой
                        </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .card-body h2 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0;
    }
</style>
{% endblock %}
</file>

<file path="templates/journal/department_report.html">
{% extends 'base.html' %}

{% block title %}Отчет по кафедре{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Общая статистика кафедры
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary bg-opacity-10">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-0">Всего студентов</h6>
                                <h2 class="text-primary">{{ total_students }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-success bg-opacity-10">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-0">Средний GPA</h6>
                                <h2 class="text-success">{{ overall_gpa|floatformat:2 }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-info bg-opacity-10">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-0">Посещаемость</h6>
                                <h2 class="text-info">{{ overall_attendance|floatformat:0 }}%</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-warning bg-opacity-10">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-0">Всего НБ</h6>
                                <h2 class="text-warning">{{ overall_absent }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger bg-opacity-10">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-0">Под угрозой</h6>
                                <h2 class="text-danger">{{ total_at_risk }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-collection"></i> Статистика по группам</span>
                <div class="btn-group" role="group">
                    <a href="?sort=group" class="btn btn-sm {% if sort_by == 'group' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-sort-alpha-down"></i> По названию
                    </a>
                    <a href="?sort=gpa" class="btn btn-sm {% if sort_by == 'gpa' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-sort-numeric-down"></i> По среднему баллу
                    </a>
                    <a href="?sort=attendance" class="btn btn-sm {% if sort_by == 'attendance' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-calendar-check"></i> По посещаемости
                    </a>
                    <a href="?sort=absent" class="btn btn-sm {% if sort_by == 'absent' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-exclamation-triangle"></i> По прогулам
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr class="table-light">
                                <th>Группа</th>
                                <th class="text-center">Студентов</th>
                                <th class="text-center">Средний балл</th>
                                <th class="text-center">Посещаемость</th>
                                <th class="text-center">Средн. НБ</th>
                                <th class="text-center">Всего НБ</th>
                                <th class="text-center">Под угрозой</th>
                                <th>Диаграмма</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in groups_data %}
                                <tr>
                                    <td>
                                        <strong>{{ item.group.name }}</strong><br>
                                        <small class="text-muted">{{ item.group.course }} курс</small>
                                    </td>
                                    <td class="text-center">
                                        <strong>{{ item.students_count }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if item.avg_gpa >= 7 %}bg-success{% elif item.avg_gpa >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ item.avg_gpa|floatformat:2 }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if item.avg_attendance >= 80 %}bg-success{% elif item.avg_attendance >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ item.avg_attendance|floatformat:0 }}%
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if item.avg_absent <= 5 %}bg-success{% elif item.avg_absent <= 10 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ item.avg_absent|floatformat:1 }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <strong class="{% if item.total_absent > 50 %}text-danger{% elif item.total_absent > 20 %}text-warning{% else %}text-success{% endif %}">
                                            {{ item.total_absent }}
                                        </strong>
                                    </td>
                                    <td class="text-center">
                                        {% if item.at_risk_count > 0 %}
                                            <span class="badge bg-danger">{{ item.at_risk_count }}</span>
                                        {% else %}
                                            <span class="text-success">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar bg-success" style="width: {% widthratio item.avg_gpa 1 8.33 %}%" title="Средний балл">
                                                {{ item.avg_gpa|floatformat:1 }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{% url 'journal:group_detail' item.group.id %}" class="btn btn-sm btn-primary">
                                            <i class="bi bi-eye"></i> Подробнее
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card-body h2 {
        font-size: 2rem;
        font-weight: bold;
    }
</style>
{% endblock %}
</file>

<file path="templates/journal/group_detailed_report.html">
{% extends 'base.html' %}

{% block title %}Детальный отчет - {{ group.name }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-collection"></i> Детальный отчет - {{ group.name }}
                    <span class="badge bg-primary ms-2">{{ group.course }} курс</span>
                </span>
                <a href="{% url 'journal:department_report' %}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> К отчету по кафедре
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2" class="align-middle">Студент</th>
                                <th rowspan="2" class="align-middle text-center">GPA</th>
                                <th rowspan="2" class="align-middle text-center">Посещ.</th>
                                <th rowspan="2" class="align-middle text-center">НБ</th>
                                <th rowspan="2" class="align-middle text-center">Рейтинг</th>
                                {% for subject in subjects %}
                                    <th class="text-center">{{ subject.name }}</th>
                                {% endfor %}
                                <th rowspan="2" class="align-middle text-center">Статус</th>
                            </tr>
                            <tr>
                                {% for subject in subjects %}
                                    <th class="text-center"><small>Балл / Посещ.</small></th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in students_data %}
                                <tr {% if item.is_at_risk %}class="table-danger"{% endif %}>
                                    <td>
                                        {# ✅ ИСПРАВЛЕНО: Правильная ссылка на профиль студента #}
                                        <a href="{% url 'accounts:view_user_profile' item.student.user.id %}">
                                            <strong>{{ item.student.user.get_full_name }}</strong>
                                        </a><br>
                                        <small class="text-muted">{{ item.student.student_id }}</small>
                                    </td>
                                    <td class="text-center">
                                        <strong class="{% if item.stats.overall_gpa >= 7 %}text-success{% elif item.stats.overall_gpa >= 4 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ item.stats.overall_gpa|floatformat:2 }}
                                        </strong>
                                    </td>
                                    <td class="text-center">
                                        <strong class="{% if item.stats.attendance_percentage >= 80 %}text-success{% elif item.stats.attendance_percentage >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ item.stats.attendance_percentage|floatformat:0 }}%
                                        </strong>
                                    </td>
                                    <td class="text-center">
                                        {# ✅ НОВОЕ: Показываем прогулы #}
                                        <strong class="{% if item.stats.total_absent <= 5 %}text-success{% elif item.stats.total_absent <= 10 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ item.stats.total_absent }}
                                        </strong>
                                        <br>
                                        <small class="text-muted">
                                            Б:{{ item.stats.absent_illness }} 
                                            У:{{ item.stats.absent_valid }} 
                                            Н:{{ item.stats.absent_invalid }}
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning">{{ item.stats.group_rank }}</span>
                                    </td>
                                    
                                    {% for subject in subjects %}
                                        <td class="text-center">
                                            {% for subj_perf in item.subjects %}
                                                {% if subj_perf.subject == subject %}
                                                    <div>
                                                        <span class="badge {% if subj_perf.avg_grade >= 7 %}bg-success{% elif subj_perf.avg_grade >= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                                            {{ subj_perf.avg_grade|floatformat:1 }}
                                                        </span>
                                                    </div>
                                                    <small class="text-muted">
                                                        {{ subj_perf.attendance|floatformat:0 }}%
                                                    </small>
                                                    <br>
                                                    <small class="text-danger">
                                                        НБ: {{ subj_perf.absent }}
                                                    </small>
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                    {% endfor %}
                                    
                                    <td class="text-center">
                                        {% if item.is_at_risk %}
                                            <span class="badge bg-danger">Под угрозой</span>
                                        {% else %}
                                            <span class="badge bg-success">Норма</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Легенда:</h6>
                    <ul class="mb-0">
                        <li><strong>Зеленый</strong> — отличная успеваемость (балл ≥ 7, посещаемость ≥ 80%, НБ ≤ 5)</li>
                        <li><strong>Желтый</strong> — удовлетворительная (балл 4-7, посещаемость 60-80%, НБ 5-10)</li>
                        <li><strong>Красный</strong> — критическая (балл < 4, посещаемость < 60%, НБ > 10)</li>
                        <li><strong>НБ</strong> — Неявка на занятие (Б-Болезнь, У-Уважительная, Н-Неуважительная)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/journal/journal_table_weekly.html">
{% extends 'base.html' %}

{% block title %}Журнал - {{ subject.name }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-journal-text"></i> 
                    Журнал: {{ group.name }} - {{ subject.name }}
                    <span class="badge bg-info ms-2">Неделя {{ week_num }}</span>
                </span>
                <div>
                    <a href="{% url 'journal:change_log' %}?group={{ group.id }}&subject={{ subject.id }}" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-clock-history"></i> История изменений
                    </a>
                    <a href="{% url 'journal:journal_view' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Выбрать другую группу
                    </a>
                </div>
            </div>
            <div class="card-body">
                
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'-1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num <= 1 %}disabled{% endif %}">
                            <i class="bi bi-chevron-left"></i> Предыдущая неделя
                        </a>
                        <span class="mx-3"><strong>Неделя {{ week_num }}</strong></span>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num >= 20 %}disabled{% endif %}">
                            Следующая неделя <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>

                {# ========== РАЗДЕЛ 1: БАЛЛЫ ЗА НЕДЕЛЮ ========== #}
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-star"></i> Баллы за неделю {{ week_num }}
                        <small class="ms-2">(Оценки выставляются один раз за всю неделю)</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 200px;">Студент</th>
                                        <th style="width: 150px;" class="text-center">Балл за неделю (1-12)</th>
                                        <th>Комментарий</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in journal_data %}
                                    <tr>
                                        <td>
                                            <strong>{{ row.student.user.get_full_name }}</strong><br>
                                            <small class="text-muted">{{ row.student.student_id }}</small>
                                        </td>
                                        <td class="text-center">
                                            {# Берем первую запись недели для хранения балла #}
                                            {% with entry=row.entries.0.entry %}
                                            <form method="post" action="{% url 'journal:update_entry' entry.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <input type="number" 
                                                       name="grade" 
                                                       value="{{ entry.grade|default:'' }}"
                                                       min="1" max="12" 
                                                       class="form-control form-control-sm d-inline w-auto"
                                                       placeholder="1-12"
                                                       style="max-width: 80px;"
                                                       onchange="this.form.submit()">
                                            </form>
                                            {% if entry.grade %}
                                                <span class="badge bg-success ms-2">✓</span>
                                            {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <small class="text-muted">Автоматически сохраняется при вводе</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-info mt-2">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Как это работает:</strong> Балл выставляется один раз за всю неделю и отображается для всех дней недели.
                        </div>
                    </div>
                </div>

                {# ========== РАЗДЕЛ 2: ПОСЕЩАЕМОСТЬ (НБ) ПО ДНЯМ ========== #}
                <div class="card border-warning">
                    <div class="card-header bg-warning">
                        <i class="bi bi-calendar-check"></i> Посещаемость по дням (НБ)
                        <button type="button" class="btn btn-sm btn-success float-end" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
                            <i class="bi bi-check-all"></i> Массовое заполнение НБ
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered journal-table">
                                <thead>
                                    <tr class="table-light">
                                        <th style="width: 200px;">Студент</th>
                                        {% for day in days_with_lessons %}
                                            <th class="text-center" style="min-width: 120px;">
                                                {{ day.day_name }}<br>
                                                <small class="text-muted">{{ day.date|date:"d.m" }}</small><br>
                                                <small>{{ day.time|time:"H:i" }}</small>
                                            </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in journal_data %}
                                    <tr>
                                        <td>
                                            <strong>{{ row.student.user.get_full_name }}</strong><br>
                                            <small class="text-muted">{{ row.student.student_id }}</small>
                                        </td>
                                        {% for entry_data in row.entries %}
                                            <td class="text-center {% if entry_data.is_locked %}bg-secondary bg-opacity-10{% endif %}">
                                                <form method="post" action="{% url 'journal:update_entry' entry_data.entry.id %}">
                                                    {% csrf_token %}
                                                    
                                                    {% if entry_data.is_locked %}
                                                        <div class="locked-cell">
                                                            <i class="bi bi-lock-fill text-muted"></i>
                                                            <div class="mt-1">
                                                                <span class="badge {% if entry_data.entry.attendance_status == 'PRESENT' %}bg-success{% else %}bg-danger{% endif %}">
                                                                    {{ entry_data.entry.get_attendance_status_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <select name="attendance_status"
                                                                class="form-select form-select-sm"
                                                                onchange="this.form.submit()">
                                                            {% for value, label in entry_data.form.fields.attendance_status.choices %}
                                                                <option value="{{ value }}" 
                                                                        {% if entry_data.entry.attendance_status == value %}selected{% endif %}>
                                                                    {{ label }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    {% endif %}
                                                </form>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Важно:</strong> НБ отмечается отдельно для каждого дня. Баллы выставляются один раз за неделю выше.
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Правила работы с журналом:</h6>
                    <ul class="mb-0">
                        <li>✓ Баллы выставляются <strong>один раз за всю неделю</strong> в верхней таблице</li>
                        <li>✓ НБ (неявки) отмечаются <strong>отдельно для каждого дня</strong> в нижней таблице</li>
                        <li>🔒 Записи блокируются через <strong>24 часа</strong> после начала занятия</li>
                        <li>📝 Все изменения логируются автоматически</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{# Модальное окно для массового заполнения НБ #}
<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Массовое заполнение НБ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'journal:bulk_update' %}">
                {% csrf_token %}
                <input type="hidden" name="group_id" value="{{ group.id }}">
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Выберите день</label>
                        <select name="lesson_date" class="form-select" id="bulkDaySelect" required>
                            <option value="">-- Выберите день --</option>
                            {% for day in days_with_lessons %}
                                <option value="{{ day.date|date:'Y-m-d' }}" data-time="{{ day.time|time:'H:i:s' }}">
                                    {{ day.day_name }} ({{ day.date|date:"d.m" }})
                                </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="lesson_time" id="bulkTimeInput">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Выберите студентов</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">
                                    <strong>Выбрать всех</strong>
                                </label>
                            </div>
                            <hr>
                            {% for row in journal_data %}
                                <div class="form-check">
                                    <input class="form-check-input student-checkbox" 
                                           type="checkbox" 
                                           name="students" 
                                           value="{{ row.student.id }}"
                                           id="student_{{ row.student.id }}">
                                    <label class="form-check-label" for="student_{{ row.student.id }}">
                                        {{ row.student.user.get_full_name }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Статус НБ</label>
                        <select name="attendance_status" class="form-select" required>
                            <option value="">-- Выберите статус --</option>
                            <option value="PRESENT">Присутствовал</option>
                            <option value="ABSENT_ILLNESS">НБ-Болезнь</option>
                            <option value="ABSENT_VALID">НБ-Уважительная</option>
                            <option value="ABSENT_INVALID">НБ-Неуважительная</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Применить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .journal-table {
        font-size: 0.9rem;
    }
    
    .journal-table td {
        vertical-align: middle;
        padding: 0.5rem;
    }
</style>

<script>
// Выбрать всех студентов
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// Автозаполнение времени при выборе дня
document.getElementById('bulkDaySelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const time = selectedOption.getAttribute('data-time');
    document.getElementById('bulkTimeInput').value = time;
});
</script>
{% endblock %}
</file>

<file path="templates/journal/select_journal.html">
{% extends 'base.html' %}

{% block title %}Выбор журнала{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-journal-text"></i> Выбор журнала
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="mb-3">
                        <label class="form-label">Группа *</label>
                        {{ form.group }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Предмет *</label>
                        {{ form.subject }}
                        <small class="form-text text-muted">Показаны только ваши предметы</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Учебная неделя (опционально)</label>
                        {{ form.week }}
                        <small class="form-text text-muted">Если не указано - текущая неделя</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-arrow-right"></i> Открыть журнал
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/journal/student_view.html">
{% extends 'base.html' %}

{% block title %}Мои оценки{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-person-badge"></i> Моя успеваемость
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="text-center">
                            <h6 class="text-muted">Общий GPA</h6>
                            <h2 class="text-primary">{{ stats.overall_gpa|floatformat:2 }}</h2>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h6 class="text-muted">Рейтинг</h6>
                            <h2 class="text-warning">{{ stats.group_rank }}</h2>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h6 class="text-muted">Посещаемость</h6>
                            <h2 class="text-success">{{ stats.attendance_percentage|floatformat:0 }}%</h2>
                        </div>
                    </div>
                    <!-- 🆕 ПРОГУЛЫ -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <h6 class="text-muted">НБ-Болезнь</h6>
                            <h3 class="text-info">{{ stats.absent_illness }}</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h6 class="text-muted">НБ-Уваж.</h6>
                            <h3 class="text-success">{{ stats.absent_valid }}</h3>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h6 class="text-muted">НБ-Неуваж.</h6>
                            <h3 class="text-danger">{{ stats.absent_invalid }}</h3>
                        </div>
                    </div>
                </div>
                
                <!-- 🆕 Общий итог -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert {% if stats.total_absent > 10 %}alert-danger{% elif stats.total_absent > 5 %}alert-warning{% else %}alert-success{% endif %}">
                            <strong>Всего прогулов:</strong> {{ stats.total_absent }} из {{ stats.total_lessons }} занятий
                            ({{ stats.attendance_percentage|floatformat:1 }}% посещаемости)
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Остальные таблицы по предметам без изменений -->
        {% for subject_data in subjects_data %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-book"></i> {{ subject_data.subject.name }}
                    <span class="badge bg-{{ subject_data.subject.get_color_class }}">
                        {{ subject_data.subject.get_type_display }}
                    </span>
                </span>
                <div>
                    <span class="badge bg-primary me-2">
                        Ср. балл: {{ subject_data.avg_grade|floatformat:1 }}
                    </span>
                    <span class="badge bg-success">
                        Посещ: {{ subject_data.attendance_pct|floatformat:0 }}%
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Дата</th>
                                <th>Время</th>
                                <th>Тип</th>
                                <th>Балл</th>
                                <th>Посещение</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in subject_data.entries %}
                            <tr>
                                <td>{{ entry.lesson_date|date:"d.m.Y" }}</td>
                                <td>{{ entry.lesson_time|time:"H:i" }}</td>
                                <td>{{ entry.get_lesson_type_display }}</td>
                                <td class="text-center">
                                    {% if entry.grade %}
                                        <span class="badge bg-success">{{ entry.grade }}</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if entry.attendance_status == 'PRESENT' %}
                                        <span class="badge bg-success">✓</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ entry.get_attendance_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-info">
                            <tr>
                                <td colspan="3"><strong>Итого</strong></td>
                                <td class="text-center">
                                    <strong>{{ subject_data.avg_grade|floatformat:1 }}</strong>
                                </td>
                                <td class="text-center">
                                    <strong>{{ subject_data.attended }}/{{ subject_data.total_lessons }}</strong>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> Записей в журнале пока нет
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
</file>

<file path="templates/news/news_detail.html">
{% extends 'base.html' %}
{% load news_filters %}

{% block title %}{{ news.title }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">
                    {% if news.is_pinned %}
                        <i class="bi bi-pin-angle-fill text-warning"></i>
                    {% endif %}
                    {{ news.title }}
                </h2>
                
                <div class="mb-3">
                    <span class="badge bg-primary">{{ news.get_category_display }}</span>
                    <small class="text-muted ms-2">
                        <i class="bi bi-calendar"></i> {{ news.created_at|date:"d.m.Y H:i" }}
                    </small>
                    <small class="text-muted ms-2">
                        <i class="bi bi-person"></i> {{ news.author.get_full_name }}
                    </small>
                    <small class="text-muted ms-2">
                        <i class="bi bi-eye"></i> {{ news.views_count }}
                    </small>
                </div>
                
                <hr>
                
                {% if news.image %}
                    <div class="text-center mb-4">
                        <img src="{{ news.image.url }}" class="img-fluid rounded" alt="{{ news.title }}">
                    </div>
                {% endif %}
                
                <div class="news-content">
                    {{ news.content|linebreaks }}
                </div>
                
                {% if news.video_url %}
                    <div class="mt-4">
                        <h5>Видео</h5>
                        <div class="ratio ratio-16x9">
                            <iframe src="{{ news.video_url|youtube_embed }}" allowfullscreen></iframe>
                        </div>
                    </div>
                {% endif %}
                
                {% if news.video_file %}
                    <div class="mt-4">
                        <h5>Видео</h5>
                        <video controls class="w-100">
                            <source src="{{ news.video_file.url }}" type="video/mp4">
                        </video>
                    </div>
                {% endif %}
                
                <hr class="mt-4">
                
                {% if user.role == 'DEAN' %}
                    <div class="d-flex gap-2 mb-3">
                        <a href="{% url 'news:edit' news.id %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-pencil"></i> Редактировать
                        </a>
                        <a href="{% url 'news:toggle_pin' news.id %}" class="btn btn-warning btn-sm">
                            <i class="bi bi-pin"></i> {% if news.is_pinned %}Открепить{% else %}Закрепить{% endif %}
                        </a>
                        <a href="{% url 'news:toggle_publish' news.id %}" class="btn btn-info btn-sm">
                            <i class="bi bi-{% if news.is_published %}eye-slash{% else %}eye{% endif %}"></i>
                            {% if news.is_published %}Снять{% else %}Опубликовать{% endif %}
                        </a>
                        <a href="{% url 'news:delete' news.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Удалить?')">
                            <i class="bi bi-trash"></i> Удалить
                        </a>
                    </div>
                {% endif %}
                
                <a href="{% url 'news:list' %}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> К новостям
                </a>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-chat-left-text"></i> Комментарии ({{ comments.count }})
            </div>
            <div class="card-body">
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ form.content }}
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-send"></i> Отправить
                    </button>
                </form>
                
                <hr>
                
                {% for comment in comments %}
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>{{ comment.author.get_full_name }}</strong>
                            <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                        </div>
                        <p class="mb-0 mt-2">{{ comment.content|linebreaks }}</p>
                    </div>
                {% empty %}
                    <p class="text-muted text-center">Комментариев пока нет</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/news/news_form.html">
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-newspaper"></i> {{ title }}
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Заголовок *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Категория *</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="text-danger">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Содержание *</label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <div class="text-danger">{{ form.content.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Изображение</label>
                        {{ form.image }}
                        {% if news and news.image %}
                            <div class="mt-2">
                                <img src="{{ news.image.url }}" class="img-thumbnail" style="max-height: 200px;" alt="Текущее изображение">
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Рекомендуемый размер: 1200x630px
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ссылка на видео (YouTube/Vimeo)</label>
                        {{ form.video_url }}
                        <small class="form-text text-muted">
                            Например: https://www.youtube.com/watch?v=...
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Или загрузить видео файл</label>
                        {{ form.video_file }}
                        {% if news and news.video_file %}
                            <div class="mt-2">
                                <small>Текущий файл: {{ news.video_file.name }}</small>
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Максимальный размер: 100MB
                        </small>
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.is_pinned }}
                        <label class="form-check-label" for="{{ form.is_pinned.id_for_label }}">
                            Закрепить новость
                        </label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.is_published }}
                        <label class="form-check-label" for="{{ form.is_published.id_for_label }}">
                            Опубликовать
                        </label>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить
                        </button>
                        <a href="{% if news %}{% url 'news:detail' news.id %}{% else %}{% url 'news:list' %}{% endif %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/news/news_list.html">
{% extends 'base.html' %}

{% block title %}Новости кафедры{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-newspaper"></i> Новости кафедры</span>
                {% if user.role == 'DEAN' %}
                    <a href="{% url 'news:create' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> Добавить новость
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                
                <div class="mb-4">
                    <div class="btn-group" role="group">
                        <a href="{% url 'news:list' %}" class="btn btn-sm {% if not selected_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Все
                        </a>
                        {% for value, label in categories %}
                            <a href="{% url 'news:list' %}?category={{ value }}" 
                               class="btn btn-sm {% if selected_category == value %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                {{ label }}
                            </a>
                        {% endfor %}
                    </div>
                </div>

                {% for news in news_page %}
                    <div class="card mb-3 {% if news.is_pinned %}border-warning{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">
                                        {% if news.is_pinned %}
                                            <i class="bi bi-pin-angle-fill text-warning"></i>
                                        {% endif %}
                                        <a href="{% url 'news:detail' news.id %}" class="text-decoration-none">
                                            {{ news.title }}
                                        </a>
                                    </h5>
                                    
                                    <div class="mb-2">
                                        <span class="badge bg-primary">{{ news.get_category_display }}</span>
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-calendar"></i> {{ news.created_at|date:"d.m.Y H:i" }}
                                        </small>
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-person"></i> {{ news.author.get_full_name }}
                                        </small>
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-eye"></i> {{ news.views_count }}
                                        </small>
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-chat"></i> {{ news.comments.count }}
                                        </small>
                                    </div>
                                    
                                    <p class="card-text text-muted">
                                        {{ news.content|truncatewords:50 }}
                                    </p>
                                    
                                    {% if news.image %}
                                        <img src="{{ news.image.url }}" class="img-fluid rounded mt-2" style="max-height: 200px;" alt="{{ news.title }}">
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <a href="{% url 'news:detail' news.id %}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-arrow-right"></i> Читать далее
                                </a>
                                
                                {% if user.role == 'DEAN' %}
                                    <a href="{% url 'news:edit' news.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i> Редактировать
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle"></i> Новостей пока нет
                    </div>
                {% endfor %}

                {% if news_page.has_other_pages %}
                    <nav>
                        <ul class="pagination justify-content-center">
                            {% if news_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ news_page.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                                        Предыдущая
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in news_page.paginator.page_range %}
                                <li class="page-item {% if news_page.number == num %}active{% endif %}">
                                    <a class="page-link" href="?page={{ num }}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                                        {{ num }}
                                    </a>
                                </li>
                            {% endfor %}
                            
                            {% if news_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ news_page.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                                        Следующая
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/bulk_classroom_form.html">
{% extends 'base.html' %}

{% block title %}Массовое добавление кабинетов{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plus-square"></i> Массовое добавление кабинетов
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Этаж *</label>
                        {{ form.floor }}
                        {% if form.floor.errors %}
                            <div class="text-danger">{{ form.floor.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Начальный номер *</label>
                            {{ form.start_number }}
                            {% if form.start_number.errors %}
                                <div class="text-danger">{{ form.start_number.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Конечный номер *</label>
                            {{ form.end_number }}
                            {% if form.end_number.errors %}
                                <div class="text-danger">{{ form.end_number.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Вместимость *</label>
                        {{ form.capacity }}
                        {% if form.capacity.errors %}
                            <div class="text-danger">{{ form.capacity.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Пример:</strong> Этаж 3, с 300 по 340 создаст кабинеты: 300, 301, 302... 340
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Создать кабинеты
                        </button>
                        <a href="{% url 'schedule:manage_classrooms' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/classroom_form.html">
{% extends 'base.html' %}

{% block title %}{{ title|default:"Добавить кабинет" }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-door-open"></i> {{ title|default:"Добавить кабинет" }}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Номер кабинета *</label>
                        {{ form.number }}
                        {% if form.number.errors %}
                            <div class="text-danger">{{ form.number.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Этаж *</label>
                            {{ form.floor }}
                            {% if form.floor.errors %}
                                <div class="text-danger">{{ form.floor.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Вместимость *</label>
                            {{ form.capacity }}
                            {% if form.capacity.errors %}
                                <div class="text-danger">{{ form.capacity.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            Активен
                        </label>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить
                        </button>
                        <a href="{% url 'schedule:manage_classrooms' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/constructor_single.html">
{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}

{% block title %}Конструктор расписания{% endblock %}

{% block content %}
<div class="row mt-4">
    <!-- Выбор группы -->
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> Выбор группы для составления расписания
            </div>
            <div class="card-body">
                <form method="get" id="groupSelectionForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Группа</label>
                            <select class="form-select" name="group" id="groupSelect">
                                <option value="">Выбрать...</option>
                                {% for g in groups %}
                                    <option value="{{ g.id }}" 
                                            {% if group and group.id == g.id %}selected{% endif %}>
                                        {{ g.name }} - {{ g.specialty|truncatewords:5 }} ({{ g.students.count }} чел.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Загрузить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if group %}
    <!-- ЛЕВАЯ ПАНЕЛЬ: Предметы -->
    <div class="col-lg-2">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <i class="bi bi-book"></i> Предметы
            </div>
            <div class="card-body p-0" style="max-height: 700px; overflow-y: auto;">
                <div class="list-group list-group-flush" id="subjectsList">
                    {% for subject in subjects %}
                        <div class="list-group-item subject-item p-2"
                             draggable="true"
                             data-subject-id="{{ subject.id }}"
                             data-subject-name="{{ subject.name }}"
                             data-subject-type="{{ subject.get_type_display }}"
                             data-teacher-name="{{ subject.teacher.user.get_full_name|default:'Не назначен' }}"
                             data-credits="{{ subject.credits }}"
                             data-hours="{{ subject.hours_per_semester }}"
                             style="cursor: move; font-size: 0.8rem;">
                            <strong>{{ subject.name }}</strong><br>
                            <small class="text-muted">{{ subject.teacher.user.get_full_name|default:'—' }}</small><br>
                            <span class="badge bg-{{ subject.get_color_class }}">{{ subject.get_type_display }}</span>
                            <br><small class="text-muted">{{ subject.credits }} кр. | {{ subject.hours_per_semester }} ч.</small>
                        </div>
                    {% empty %}
                        <div class="list-group-item text-muted small">Нет предметов</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ЦЕНТРАЛЬНАЯ ЧАСТЬ: Расписание -->
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-week"></i> ҶАДВАЛИ ДАРСӢ - {{ group.name }}</span>
                <div>
                    <a href="{% url 'schedule:manage_academic_week' %}" class="btn btn-light btn-sm">
                        <i class="bi bi-calendar-range"></i> Недели
                    </a>
                    <a href="{% url 'schedule:export' %}?group={{ group.id }}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Экспорт
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px; vertical-align: middle; text-align: center;">
                                    <strong>ҲАФТА<br>СОАТ</strong>
                                </th>
                                <th style="width: 45%;">Дарс / Устод</th>
                                <th style="width: 60px;">АУД</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <!-- Заголовок дня -->
                                <tr class="table-secondary">
                                    <td colspan="3" class="text-center">
                                        <strong>{{ day_name }}</strong>
                                    </td>
                                </tr>
                                
                                <!-- Временные слоты для этого дня -->
                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center align-middle time-cell">
                                            <strong style="font-size: 0.9rem;">{{ time_slot.start_time|time:"H" }}<sup>{{ time_slot.start_time|time:"i" }}</sup>-{{ time_slot.end_time|time:"H" }}<sup>{{ time_slot.end_time|time:"i" }}</sup></strong>
                                        </td>
                                        
                                        {% with slot=schedule_data|get_slot:group.id|get_slot:day_num|get_slot:time_slot.id %}
                                        <td class="schedule-drop-zone p-2"
                                            data-group-id="{{ group.id }}"
                                            data-day="{{ day_num }}"
                                            data-time-slot="{{ time_slot.id }}">
                                            {% if slot %}
                                            <div class="lesson-content" data-slot-id="{{ slot.id }}">
                                                <strong style="font-size: 0.9rem;">{{ slot.subject.name }} ({{ slot.subject.get_type_display }})</strong><br>
                                                <small class="text-muted">{{ slot.teacher.user.get_full_name|default:'—' }}</small><br>
                                                <small class="text-muted">{{ slot.subject.credits }} кр. | {{ slot.subject.hours_per_semester }} ч.</small>
                                                <button class="btn btn-sm btn-danger delete-slot float-end" 
                                                        data-slot-id="{{ slot.id }}" 
                                                        style="font-size: 0.7rem; padding: 2px 6px;">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="aud-cell align-middle text-center" 
                                            style="font-size: 0.85rem; cursor: pointer;"
                                            {% if slot %}data-slot-id="{{ slot.id }}"{% endif %}>
                                            {% if slot %}
                                            <div class="aud-display" onclick="editAud(this)">
                                                <strong>{{ slot.room|default:'?' }}</strong>
                                            </div>
                                            <input type="text" 
                                                   class="form-control form-control-sm aud-input" 
                                                   value="{{ slot.room|default:'' }}"
                                                   maxlength="10"
                                                   style="display: none; width: 100%; font-size: 0.8rem;"
                                                   onblur="saveAud(this, {{ slot.id }})"
                                                   onkeypress="if(event.key==='Enter') saveAud(this, {{ slot.id }})">
                                            {% endif %}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Инструкция -->
        <div class="alert alert-info mt-3">
            <h6><i class="bi bi-info-circle"></i> Инструкция:</h6>
            <ol class="mb-0">
                <li>Перетащите предмет из левой панели в нужную ячейку</li>
                <li>Нажмите на номер аудитории (АУД) чтобы изменить его</li>
                <li>Система автоматически проверит конфликты</li>
                <li>Для удаления нажмите <i class="bi bi-trash text-danger"></i></li>
            </ol>
        </div>
    </div>
    {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> Выберите группу для составления расписания
            </div>
        </div>
    {% endif %}
</div>

<!-- Модальное окно конфликтов -->
<div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Конфликт</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="conflictMessage"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<style>
.schedule-table {
    font-size: 0.85rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
}

.schedule-drop-zone {
    min-height: 60px;
    background-color: #fff;
    border: 2px dashed transparent;
    transition: all 0.2s;
}

.schedule-drop-zone:hover {
    background-color: #f8f9fa;
}

.schedule-drop-zone.drag-over {
    background-color: #d1e7dd;
    border-color: #198754;
    border-style: solid;
}

.lesson-content {
    position: relative;
    padding: 4px;
}

.aud-cell {
    background-color: #f8f9fa;
}

.aud-display:hover {
    background-color: #e9ecef;
    cursor: pointer;
}

.subject-item {
    cursor: move;
    transition: all 0.2s;
    user-select: none;
}

.subject-item:hover {
    background-color: #f0f0f0;
    transform: translateX(3px);
}

.subject-item:active {
    opacity: 0.5;
}

.delete-slot {
    opacity: 0.7;
}

.delete-slot:hover {
    opacity: 1;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Конструктор загружен');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let draggedData = {};

    // DRAG AND DROP
    const subjectItems = document.querySelectorAll('.subject-item');
    subjectItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedData = {
                subjectId: this.dataset.subjectId,
                subjectName: this.dataset.subjectName,
                subjectType: this.dataset.subjectType,
                teacherName: this.dataset.teacherName,
                credits: this.dataset.credits,
                hours: this.dataset.hours
            };
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.4';
        });

        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
        });
    });

    // Drop зоны
    const dropZones = document.querySelectorAll('.schedule-drop-zone');
    dropZones.forEach(cell => {
        cell.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        cell.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });

        cell.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const groupId = this.dataset.groupId;
            const dayOfWeek = this.dataset.day;
            const timeSlot = this.dataset.timeSlot;

            if (!draggedData.subjectId) return;

            createScheduleSlot(groupId, draggedData.subjectId, dayOfWeek, timeSlot, this);
        });
    });

    // Создание занятия
    function createScheduleSlot(groupId, subjectId, dayOfWeek, timeSlot, cellElement) {
        const originalContent = cellElement.innerHTML;
        cellElement.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

        fetch('/schedule/constructor/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                group: groupId,
                subject: subjectId,
                day_of_week: dayOfWeek,
                time_slot: timeSlot
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                cellElement.innerHTML = originalContent;
                showConflictModal(data.error, data.conflicts || []);
            }
        })
        .catch(error => {
            cellElement.innerHTML = originalContent;
            showNotification('❌ Ошибка: ' + error.message, 'danger');
        });
    }

    // Удаление занятия
    document.querySelectorAll('.delete-slot').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!confirm('Удалить занятие?')) return;

            const slotId = this.dataset.slotId;
            fetch(`/schedule/constructor/delete/${slotId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showNotification('❌ ' + data.error, 'danger');
                }
            });
        });
    });

    function showConflictModal(message, conflicts) {
        const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
        const messageEl = document.getElementById('conflictMessage');
        
        let html = `<div class="alert alert-danger"><strong>${message}</strong></div>`;
        if (conflicts && conflicts.length > 0) {
            html += '<ul>';
            conflicts.forEach(c => html += `<li>${c}</li>`);
            html += '</ul>';
        }
        
        messageEl.innerHTML = html;
        modal.show();
    }

    function showNotification(message, type) {
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
            document.body.appendChild(container);
        }

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        container.appendChild(alert);

        setTimeout(() => alert.remove(), 4000);
    }
});

// Редактирование аудитории
function editAud(element) {
    const display = element;
    const input = element.nextElementSibling;
    
    display.style.display = 'none';
    input.style.display = 'block';
    input.focus();
    input.select();
}

function saveAud(input, slotId) {
    const display = input.previousElementSibling;
    const value = input.value.trim();
    
    console.log('💾 Сохранение кабинета:', value, 'для слота:', slotId);
    
    // Получаем CSRF токен
    function getCsrfToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === 'csrftoken=') {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    fetch(`/schedule/constructor/update-room/${slotId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ room: value })
    })
    .then(response => {
        console.log('📡 Ответ сервера:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('📦 Данные от сервера:', data);
        
        if (data.success) {
            // Успешно сохранено
            display.querySelector('strong').textContent = data.room || '?';
            display.style.display = 'block';
            input.style.display = 'none';
            console.log('✅ Кабинет сохранен:', data.room);
            
            // Показываем уведомление
            showNotification('✅ Кабинет сохранен: ' + (data.room || 'не указан'), 'success');
        } else {
            // Ошибка валидации
            console.error('❌ Ошибка:', data.error);
            alert(data.error || 'Ошибка сохранения кабинета');
            
            // Возвращаем фокус и не закрываем поле
            input.focus();
            input.select();
        }
    })
    .catch(error => {
        console.error('💥 Ошибка запроса:', error);
        alert('Ошибка соединения с сервером: ' + error.message);
        
        // Возвращаем фокус
        input.focus();
    });
}
function showNotification(message, type) {
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;max-width:350px;';
        document.body.appendChild(container);
    }

    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show shadow`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alert);

    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 150);
    }, 3000);
}


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
</file>

<file path="templates/schedule/constructor_with_limits.html">
{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}

{% block title %}Конструктор расписания{% endblock %}

{% block content %}
<div class="row mt-4">
    <!-- Выбор группы и семестра -->
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> Выбор группы и семестра
            </div>
            <div class="card-body">
                <form method="get" id="groupSelectionForm">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label">Группа</label>
                            <select class="form-select" name="group" required>
                                <option value="">Выберите группу...</option>
                                {% for g in groups %}
                                    <option value="{{ g.id }}" {% if group and group.id == g.id %}selected{% endif %}>
                                        {{ g.name }} - {{ g.specialty|truncatewords:5 }} ({{ g.students.count }} чел.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Семестр</label>
                            <select class="form-select" name="semester">
                                {% for sem in semesters %}
                                    <option value="{{ sem.id }}" {% if semester and semester.id == sem.id %}selected{% endif %}>
                                        {{ sem.name }} ({{ sem.get_shift_display }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Загрузить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if group %}
    <!-- ЛЕВАЯ ПАНЕЛЬ: Предметы с лимитами -->
    <div class="col-lg-3">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <i class="bi bi-book"></i> Доступные предметы
                <small class="d-block mt-1">Перетащите в расписание</small>
            </div>
            <div class="card-body p-0" style="max-height: 700px; overflow-y: auto;">

                <!-- ✅ ЛЕКЦИИ -->
                {% if lecture_subjects %}
                <div class="bg-primary bg-opacity-10 p-2">
                    <strong><i class="bi bi-mortarboard"></i> Лекции (2 группы)</strong>
                </div>
                <div class="list-group list-group-flush">
                    {% for item in lecture_subjects %}
                        <div class="list-group-item subject-item p-2"
                             draggable="true"
                             data-subject-id="{{ item.subject.id }}"
                             data-subject-name="{{ item.subject.name }}"
                             data-subject-type="LECTURE"
                             data-teacher-name="{{ item.subject.teacher.user.get_full_name|default:'Не назначен' }}"
                             data-remaining="{{ item.remaining }}"
                             style="cursor: move; font-size: 0.85rem; {% if item.remaining == 0 %}opacity: 0.3; pointer-events: none;{% endif %}">
                            <strong>{{ item.subject.name }}</strong><br>
                            <small class="text-muted">{{ item.subject.teacher.user.get_full_name|default:'—' }}</small><br>
                            <span class="badge bg-primary">Лекция (2 гр.)</span><br>
                            <small class="text-muted">{{ item.hours_per_week }} ч/нед</small><br>
                            <strong class="{% if item.remaining > 0 %}text-success{% else %}text-danger{% endif %}">
                                Осталось: {{ item.remaining }} / {{ item.needed }}
                            </strong>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ✅ ПРАКТИКИ -->
                {% if practice_subjects %}
                <div class="bg-success bg-opacity-10 p-2 mt-2">
                    <strong><i class="bi bi-gear"></i> Практики (1 группа)</strong>
                </div>
                <div class="list-group list-group-flush">
                    {% for item in practice_subjects %}
                        <div class="list-group-item subject-item p-2"
                             draggable="true"
                             data-subject-id="{{ item.subject.id }}"
                             data-subject-name="{{ item.subject.name }}"
                             data-subject-type="PRACTICE"
                             data-teacher-name="{{ item.subject.teacher.user.get_full_name|default:'Не назначен' }}"
                             data-remaining="{{ item.remaining }}"
                             style="cursor: move; font-size: 0.85rem; {% if item.remaining == 0 %}opacity: 0.3; pointer-events: none;{% endif %}">
                            <strong>{{ item.subject.name }}</strong><br>
                            <small class="text-muted">{{ item.subject.teacher.user.get_full_name|default:'—' }}</small><br>
                            <span class="badge bg-success">Практика</span><br>
                            <small class="text-muted">{{ item.hours_per_week }} ч/нед</small><br>
                            <strong class="{% if item.remaining > 0 %}text-success{% else %}text-danger{% endif %}">
                                Осталось: {{ item.remaining }} / {{ item.needed }}
                            </strong>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ✅ КМРО/СРСП -->
                {% if control_subjects %}
                <div class="bg-warning bg-opacity-10 p-2 mt-2">
                    <strong><i class="bi bi-pencil-square"></i> КМРО/СРСП (1 группа)</strong>
                </div>
                <div class="list-group list-group-flush">
                    {% for item in control_subjects %}
                        <div class="list-group-item subject-item p-2"
                             draggable="true"
                             data-subject-id="{{ item.subject.id }}"
                             data-subject-name="{{ item.subject.name }}"
                             data-subject-type="SRSP"
                             data-teacher-name="{{ item.subject.teacher.user.get_full_name|default:'Не назначен' }}"
                             data-remaining="{{ item.remaining }}"
                             style="cursor: move; font-size: 0.85rem; {% if item.remaining == 0 %}opacity: 0.3; pointer-events: none;{% endif %}">
                            <strong>{{ item.subject.name }}</strong><br>
                            <small class="text-muted">{{ item.subject.teacher.user.get_full_name|default:'—' }}</small><br>
                            <span class="badge bg-warning">КМРО/СРСП</span><br>
                            <small class="text-muted">{{ item.hours_per_week }} ч/нед</small><br>
                            <strong class="{% if item.remaining > 0 %}text-success{% else %}text-danger{% endif %}">
                                Осталось: {{ item.remaining }} / {{ item.needed }}
                            </strong>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if not lecture_subjects and not practice_subjects and not control_subjects %}
                    <div class="p-3 text-center text-muted">
                        <i class="bi bi-inbox"></i><br>
                        Нет доступных предметов.<br>
                        Назначьте предметы группе.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ЦЕНТРАЛЬНАЯ ЧАСТЬ: Расписание -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-week"></i> ҶАДВАЛИ ДАРСӢ - {{ group.name }}</span>
                <div>
                    <a href="{% url 'schedule:export' %}?group={{ group.id }}"
                       class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Экспорт
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">СОАТ</th>
                                <th>Дарс / Устод</th>
                                <th style="width: 60px;">АУД</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <tr class="table-secondary">
                                    <td colspan="3" class="text-center"><strong>{{ day_name }}</strong></td>
                                </tr>

                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center time-cell">
                                            <strong>{{ time_slot.start_time|time:"H:i" }}-{{ time_slot.end_time|time:"H:i" }}</strong>
                                        </td>

                                        {% with slot=schedule_data|get_slot:group.id|get_slot:day_num|get_slot:time_slot.id %}
                                        <td class="schedule-drop-zone p-2"
                                            data-group-id="{{ group.id }}"
                                            data-day="{{ day_num }}"
                                            data-time-slot="{{ time_slot.id }}">
                                            {% if slot %}
                                            <div class="lesson-content">
                                                <strong>{{ slot.subject.name }}</strong>
                                                <span class="badge bg-{% if slot.lesson_type == 'LECTURE' %}primary{% elif slot.lesson_type == 'PRACTICE' %}success{% else %}warning{% endif %} ms-1">
                                                    {{ slot.get_lesson_type_display }}
                                                </span>
                                                <br>
                                                <small class="text-muted">{{ slot.teacher.user.get_full_name|default:'—' }}</small>
                                                <button class="btn btn-sm btn-danger delete-slot float-end"
                                                        data-slot-id="{{ slot.id }}"
                                                        data-subject-id="{{ slot.subject.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            {% else %}
                                            <div class="empty-slot" style="min-height: 50px;">
                                                <!-- Перетащите предмет сюда -->
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="aud-cell text-center"
                                            {% if slot %}data-slot-id="{{ slot.id }}"{% endif %}>
                                            {% if slot %}
                                            <div class="aud-display" onclick="editAud(this)">
                                                <strong>{{ slot.room|default:'?' }}</strong>
                                            </div>
                                            <input type="text"
                                                   class="form-control form-control-sm aud-input"
                                                   value="{{ slot.room|default:'' }}"
                                                   style="display: none;"
                                                   onblur="saveAud(this, {{ slot.id }})"
                                                   onkeypress="if(event.key==='Enter') saveAud(this, {{ slot.id }})">
                                            {% endif %}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <h6><i class="bi bi-info-circle"></i> Инструкция:</h6>
            <ul class="mb-0">
                <li>Перетащите предмет из левой панели в расписание</li>
                <li>Предмет исчезнет из списка, когда достигнут лимит</li>
                <li>При удалении предмет вернется в список</li>
                <li>Лекции проводятся для 2 групп одновременно</li>
            </ul>
        </div>
    </div>
    {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> Выберите группу для составления расписания
            </div>
        </div>
    {% endif %}
</div>

<style>
.schedule-table { 
    font-size: 0.85rem; 
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
    vertical-align: middle !important;
}

/* Все ячейки должны быть drop-zone */
.schedule-drop-zone {
    min-height: 60px !important;
    background-color: #fff;
    border: 2px dashed transparent;
    transition: all 0.2s;
    position: relative;
    cursor: crosshair;
}

.schedule-drop-zone .empty-slot {
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    font-size: 0.75rem;
}

.schedule-drop-zone:hover {
    background-color: #f8f9fa;
    border-color: #ccc;
}

.schedule-drop-zone.drag-over {
    background-color: #d1e7dd !important;
    border-color: #198754 !important;
    border-style: solid !important;
}

.lesson-content {
    position: relative;
    min-height: 50px;
}

.subject-item {
    cursor: move;
    transition: all 0.2s;
    user-select: none;
}

.subject-item:hover { 
    background-color: #f0f0f0; 
    transform: translateX(3px); 
}

.subject-item:active { 
    opacity: 0.5; 
}

.aud-cell {
    background-color: #f8f9fa;
    vertical-align: middle !important;
}

.aud-display:hover {
    background-color: #e9ecef;
    cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Конструктор загружен');

    function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let i = 0; i < cookies.length; i++) {
            const c = cookies[i].trim();
            if (c.startsWith(name + '=')) {
                return decodeURIComponent(c.substring(name.length + 1));
            }
        }
        return null;
    }
    const csrftoken = getCookie('csrftoken') || '';

    let draggedData = null;

    // helper: safe parse JSON
    function safeJson(response) {
        return response.text().then(text => {
            try { return JSON.parse(text); } catch(e) { return { success: false, error: 'Invalid JSON response' }; }
        });
    }

    // ATTACH drag listeners to subject items - support items that might be re-rendered
    function attachDragHandlers(el) {
        if (!el) return;
        // prevent double attaching
        if (el._hasDragHandler) return;
        el._hasDragHandler = true;

        el.addEventListener('dragstart', function(e) {
            try {
                const rem = parseInt(this.dataset.remaining || '0');
                draggedData = {
                    subjectId: this.dataset.subjectId,
                    subjectName: this.dataset.subjectName,
                    subjectType: this.dataset.subjectType,
                    teacherName: this.dataset.teacherName || '',
                    remaining: isNaN(rem) ? 0 : rem
                };

                // Make sure drag image is not huge and does not shift view
                try {
                    const img = document.createElement('canvas');
                    img.width = img.height = 1;
                    e.dataTransfer.setDragImage(img, 0, 0);
                } catch (err) {
                    // ignore if not supported
                }

                // set transferable data for browsers that require it
                try { e.dataTransfer.setData('text/plain', JSON.stringify(draggedData)); } catch(e) {}
                e.dataTransfer.effectAllowed = 'copy';
                this.style.opacity = '0.4';
                console.log('dragstart', draggedData);
            } catch (ex) { console.error('dragstart err', ex); }
        });

        el.addEventListener('dragend', function() {
            try { this.style.opacity = '1'; } catch(e){}
            draggedData = null;
            stopAutoScroll();
            console.log('dragend');
        });
    }

    document.querySelectorAll('.subject-item').forEach(attachDragHandlers);

    // DELETE (делегируем обработку, на случай перерендеринга)
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.delete-slot');
        if (!btn) return;
        e.stopPropagation();
        if (!confirm('Удалить?')) return;
        const slotId = btn.dataset.slotId;
        if (!slotId) return;
        fetch(`/schedule/constructor/delete/${slotId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => safeJson(r))
        .then(data => {
            if (data.success) {
                location.reload();
            } else alert(data.error || 'Ошибка удаления');
        })
        .catch(err => { alert('Ошибка соединения: ' + (err.message || err)); });
    });

    // EDIT ROOM helpers
    window.editAud = function(el) {
        if (!el) return;
        const input = el.nextElementSibling;
        if (!input) return;
        el.style.display = 'none';
        input.style.display = 'block';
        input.focus();
    }

    window.saveAud = function(input, slotId) {
        if (!input) return;
        const value = input.value.trim();
        if (!slotId) return alert('Нет id слота');
        fetch(`/schedule/constructor/update-room/${slotId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ room: value })
        })
        .then(r => safeJson(r))
        .then(data => {
            if (data.success) {
                const prev = input.previousElementSibling;
                if (prev) prev.querySelector('strong').textContent = data.room || '?';
                input.style.display = 'none';
                if (prev) prev.style.display = 'block';
            } else alert(data.error || 'Ошибка сохранения');
        })
        .catch(err => { alert('Ошибка соединения: ' + (err.message || err)); });
    }

    // -------------------------
    // Автоскролл (window + контейнеры)
    // -------------------------
    let autoScrollState = {
        active: false,
        direction: 0, // -1 up, +1 down
        container: null,
        rafId: null
    };

    function autoScrollStep() {
        try {
            if (!autoScrollState.active) return;
            const dir = autoScrollState.direction;
            const container = autoScrollState.container;
            // adaptive speed: если контейнер большой — увеличить шаг
            const step = Math.max(8, Math.min(40, Math.round((container ? container.clientHeight : window.innerHeight) * 0.02)));
            if (container) container.scrollTop += dir * step;
            else window.scrollBy(0, dir * step);
        } finally {
            autoScrollState.rafId = requestAnimationFrame(autoScrollStep);
        }
    }

    function startAutoScroll(direction, container = null) {
        if (autoScrollState.active && autoScrollState.direction === direction && autoScrollState.container === container) return;
        stopAutoScroll();
        autoScrollState.active = true;
        autoScrollState.direction = direction;
        autoScrollState.container = container;
        autoScrollState.rafId = requestAnimationFrame(autoScrollStep);
    }

    function stopAutoScroll() {
        autoScrollState.active = false;
        autoScrollState.direction = 0;
        autoScrollState.container = null;
        if (autoScrollState.rafId) {
            cancelAnimationFrame(autoScrollState.rafId);
            autoScrollState.rafId = null;
        }
    }

    // Обработка dragover на документе (для прокрутки окна)
    document.addEventListener('dragover', function(e) {
        try {
            e.preventDefault();
            const margin = 120; // px от края
            const y = e.clientY;
            const h = window.innerHeight;
            if (y < margin) startAutoScroll(-1, null);
            else if (y > h - margin) startAutoScroll(1, null);
            else stopAutoScroll();
        } catch (ex) { console.error(ex); }
    });

    // Останавливаем и на drop
    document.addEventListener('drop', function(e) { stopAutoScroll(); });
    document.addEventListener('dragend', function(e) { stopAutoScroll(); });

    // Автоскролл для прокручиваемых контейнеров (левый список предметов и таблица)
    const containerSelectors = ['.card-body.p-0', '.table-responsive'];
    const scrollContainers = [];
    containerSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(c => scrollContainers.push(c));
    });

    // Добавляем dragover listener для контейнеров
    scrollContainers.forEach(container => {
        container.addEventListener('dragover', function(e) {
            try {
                e.preventDefault();
                const rect = this.getBoundingClientRect();
                const localY = e.clientY - rect.top;
                const margin = Math.min(80, rect.height * 0.18);
                if (localY < margin) startAutoScroll(-1, this);
                else if (localY > rect.height - margin) startAutoScroll(1, this);
                else stopAutoScroll();
            } catch (ex) { console.error(ex); }
        });
        container.addEventListener('dragleave', function(e) { stopAutoScroll(); });
        container.addEventListener('drop', function(e) { stopAutoScroll(); });
    });

    // DROP ZONES
    function handleDropZone(cell) {
        // avoid double attach
        if (cell._hasDropHandler) return;
        cell._hasDropHandler = true;

        cell.addEventListener('dragover', function(e) {
            try { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; this.classList.add('drag-over'); } catch(e){}
        });

        cell.addEventListener('dragleave', function(e) {
            try {
                // если курсор действительно ушёл
                if (!this.contains(e.relatedTarget)) this.classList.remove('drag-over');
            } catch(e) { this.classList.remove('drag-over'); }
        });

        cell.addEventListener('drop', function(e) {
            try {
                e.preventDefault();
                this.classList.remove('drag-over');
                stopAutoScroll();
                // если draggedData null — попробуем получить из dataTransfer
                if (!draggedData) {
                    try {
                        const txt = e.dataTransfer.getData('text/plain');
                        if (txt) draggedData = JSON.parse(txt);
                    } catch (ex) { /* ignore */ }
                }

                console.log('drop target', this.dataset, 'dragged', draggedData);

                if (!draggedData) return alert('Не удалось определить перетаскиваемый предмет.');
                if (parseInt(draggedData.remaining || 0) <= 0) return alert('Достигнут лимит для этого предмета!');

                const groupId = this.dataset.groupId;
                const dayOfWeek = this.dataset.day;
                const timeSlot = this.dataset.timeSlot;
                if (!groupId || !dayOfWeek || !timeSlot) return alert('Недостаточно данных для размещения предмета.');

                // блокируем UI простым семафором
                const prevCursor = document.body.style.cursor;
                document.body.style.cursor = 'wait';

                fetch('/schedule/constructor/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        group: groupId,
                        subject: draggedData.subjectId,
                        day_of_week: dayOfWeek,
                        time_slot: timeSlot,
                        lesson_type: draggedData.subjectType
                    })
                })
                .then(r => {
                    // допустим сервер возвращает код ошибки и HTML
                    if (!r.ok) return safeJson(r).then(j => { throw new Error(j.error || 'Server error'); });
                    return safeJson(r);
                })
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || 'Не удалось создать запись');
                    }
                })
                .catch(err => { alert('Ошибка: ' + (err.message || err)); })
                .finally(() => { document.body.style.cursor = prevCursor; draggedData = null; });

            } catch (ex) { console.error(ex); }
        });
    }

    // Инициализация drop zones
    document.querySelectorAll('.schedule-drop-zone').forEach(handleDropZone);

    // наблюдатель за DOM: если бекенд подгружает элементы через ajax, прикрепим обработчики
    try {
        const mo = new MutationObserver(muts => {
            for (const m of muts) {
                if (m.addedNodes && m.addedNodes.length) {
                    m.addedNodes.forEach(n => {
                        if (!(n instanceof HTMLElement)) return;
                        if (n.matches && n.matches('.subject-item')) attachDragHandlers(n);
                        n.querySelectorAll && n.querySelectorAll('.subject-item').forEach(attachDragHandlers);
                        if (n.matches && n.matches('.schedule-drop-zone')) handleDropZone(n);
                        n.querySelectorAll && n.querySelectorAll('.schedule-drop-zone').forEach(handleDropZone);
                    });
                }
            }
        });
        mo.observe(document.body, { childList: true, subtree: true });
    } catch (e) { /* не критично */ }

});
</script>

{% endblock %}
</file>

<file path="templates/schedule/group_list.html">
{% extends 'base.html' %}

{% block title %}Список групп{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        {% for item in groups_with_students %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-collection"></i> Группа {{ item.group.name }} - {{ item.group.specialty }}
                <span class="badge bg-primary ms-2">{{ item.group.course }} курс</span>
                <span class="badge bg-info ms-2">{{ item.students|length }} студентов</span>
            </div>
            <div class="card-body">
                {% if item.students %}
                <div class="table-responsive">
                    <table class="table table-hover sortable-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(this, 0)" class="sortable">№</th>
                                <th onclick="sortTable(this, 1)" class="sortable">ФИО студента</th>
                                <th onclick="sortTable(this, 2)" class="sortable">День рождения</th>
                                <th onclick="sortTable(this, 3)" class="sortable">Последний вход</th>
                                <th onclick="sortTable(this, 4)" class="sortable">Средний балл</th>
                                <th onclick="sortTable(this, 5)" class="sortable">Рейтинг</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in item.students %}
                            <tr onclick="window.location='{% url 'accounts:profile' %}?user_id={{ student.user.id }}'" style="cursor: pointer;">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <a href="{% url 'accounts:profile' %}?user_id={{ student.user.id }}">
                                        {{ student.user.get_full_name }}
                                    </a>
                                </td>
                                <td>{{ student.birth_date|date:"d.m.Y" }}</td>
                                <td>
                                    {% if student.user.last_login %}
                                        {{ student.user.last_login|date:"d.m.Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">Никогда</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ student.get_average_grade|default:"—" }}</strong>
                                </td>
                                <td>
                                    {% if student.get_group_rank > 0 %}
                                        <span class="badge bg-warning">{{ student.get_group_rank }}</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> В этой группе пока нет студентов
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="card">
            <div class="card-body text-center text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-2">Нет доступных групп</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .sortable:hover {
        background-color: #f0f0f0;
    }
    
    .sortable::after {
        content: ' ⇅';
        color: #ccc;
        font-size: 0.8em;
    }
    
    tr:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
function sortTable(header, columnIndex) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Определяем направление сортировки
    const isAscending = header.classList.contains('asc');
    
    // Удаляем классы сортировки со всех заголовков
    table.querySelectorAll('th').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    
    // Добавляем класс к текущему заголовку
    header.classList.add(isAscending ? 'desc' : 'asc');
    
    // Сортируем строки
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // Попытка преобразовать в число
        const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
        const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? bNum - aNum : aNum - bNum;
        }
        
        // Сортировка как строки
        return isAscending ? bValue.localeCompare(aValue) : aValue.localeCompare(bValue);
    });
    
    // Обновляем таблицу
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}
</file>

<file path="templates/schedule/manage_academic_week.html">
{% extends 'base.html' %}

{% block title %}Управление учебными неделями{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar-range"></i> Управление учебными неделями
            </div>
            <div class="card-body">
                {% if current_week %}
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Текущая учебная неделя</h5>
                    <p class="mb-0"><strong>Неделя {{ current_week.current_week }}</strong> (начало семестра: {{ current_week.semester_start_date|date:"d.m.Y" }})</p>
                </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Дата начала семестра *</label>
                        {{ form.semester_start_date }}
                        <small class="form-text text-muted">
                            Система автоматически рассчитает текущую неделю на основе этой даты
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Номер текущей недели *</label>
                        {{ form.current_week }}
                        <small class="form-text text-muted">
                            Можно корректировать вручную (от 1 до 20)
                        </small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Внимание:</strong> При создании нового семестра предыдущий будет деактивирован
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить
                        </button>
                        <a href="{% url 'schedule:constructor' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Назад к конструктору
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        {% if current_week %}
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-calculator"></i> Автоматический расчет
            </div>
            <div class="card-body">
                <p>
                    На основе даты начала семестра ({{ current_week.semester_start_date|date:"d.m.Y" }}) 
                    система рассчитывает текущую неделю автоматически.
                </p>
                <p class="mb-0">
                    <strong>Рассчитанная неделя:</strong> 
                    <span class="badge bg-primary">{{ current_week.calculate_current_week }}</span>
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/manage_classrooms.html">
{% extends 'base.html' %}

{% block title %}Управление кабинетами{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-door-open"></i> Управление кабинетами</span>
                <div>
                    <a href="{% url 'schedule:bulk_add_classrooms' %}" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-plus-square"></i> Массовое добавление
                    </a>
                    <a href="{% url 'schedule:add_classroom' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> Добавить кабинет
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Номер</th>
                                <th>Этаж</th>
                                <th>Вместимость</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for classroom in classrooms %}
                            <tr>
                                <td><strong>{{ classroom.number }}</strong></td>
                                <td>{{ classroom.floor }}</td>
                                <td>{{ classroom.capacity }} мест</td>
                                <td>
                                    {% if classroom.is_active %}
                                        <span class="badge bg-success">Активен</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Неактивен</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'schedule:delete_classroom' classroom.id %}" 
                                       class="btn btn-outline-danger btn-sm"
                                       onclick="return confirm('Удалить кабинет?')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Кабинеты не созданы</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/manage_semesters.html">
{% extends 'base.html' %}

{% block title %}Управление семестрами{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-range"></i> Управление семестрами</span>
                <a href="{% url 'schedule:add_semester' %}" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle"></i> Добавить семестр
                </a>
            </div>
            <div class="card-body">
                {% if active_semester %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 
                    <strong>Активный семестр:</strong> {{ active_semester.name }} ({{ active_semester.get_shift_display }})
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Активный семестр не установлен. Создайте семестр и активируйте его.
                </div>
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Название</th>
                                <th>Номер</th>
                                <th>Смена</th>
                                <th>Период</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for semester in semesters %}
                            <tr>
                                <td><strong>{{ semester.name }}</strong></td>
                                <td><span class="badge bg-primary">{{ semester.get_number_display }}</span></td>
                                <td>{{ semester.get_shift_display }}</td>
                                <td>
                                    <small>{{ semester.start_date|date:"d.m.Y" }} - {{ semester.end_date|date:"d.m.Y" }}</small>
                                </td>
                                <td>
                                    {% if semester.is_active %}
                                        <span class="badge bg-success">Активный</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Неактивный</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'schedule:edit_semester' semester.id %}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'schedule:toggle_semester' semester.id %}" class="btn btn-outline-info">
                                            <i class="bi bi-toggle-{% if semester.is_active %}on{% else %}off{% endif %}"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">Семестры не созданы</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/manage_subjects.html">
{% extends 'base.html' %}

{% block title %}Управление предметами{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-book"></i> Управление предметами</span>
                <a href="{% url 'schedule:add_subject' %}" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle"></i> Добавить предмет
                </a>
            </div>
            <div class="card-body">
                <form method="get" class="mb-3">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="search" placeholder="Поиск по названию или коду..." value="{{ search }}">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Найти
                            </button>
                        </div>
                    </div>
                </form>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Код</th>
                                <th>Название</th>
                                <th>Кредиты</th>
                                <th>Преподаватель</th>
                                <th>Распределение</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subject in subjects %}
                            <tr>
                                <td><code>{{ subject.code }}</code></td>
                                <td><strong>{{ subject.name }}</strong></td>
                                <td><span class="badge bg-primary">{{ subject.credits }}</span></td>
                                <td>{{ subject.teacher.user.get_full_name|default:'Не назначен' }}</td>
                                <td>
                                    {% with dist=subject.get_credits_distribution %}
                                    <small>
                                        Лекция: {{ dist.LECTURE }} | 
                                        Практика: {{ dist.PRACTICE }} | 
                                        СРСП: {{ dist.SRSP }}
                                    </small>
                                    {% endwith %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'schedule:edit_subject' subject.id %}" class="btn btn-outline-primary" title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'schedule:delete_subject' subject.id %}" class="btn btn-outline-danger" 
                                           onclick="return confirm('Удалить предмет?')" title="Удалить">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">Предметы не найдены</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/no_semester.html">
{% extends 'base.html' %}

{% block title %}Семестр не активирован{% endblock %}

{% block content %}
<div class="row mt-5">
    <div class="col-lg-6 mx-auto">
        <div class="card border-warning">
            <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 5rem;"></i>
                <h3 class="mt-4">Активный семестр не найден</h3>
                <p class="text-muted mb-4">
                    Для работы с расписанием необходимо создать и активировать семестр
                </p>
                
                {% if user.role == 'DEAN' %}
                <div class="alert alert-info text-start">
                    <h6><i class="bi bi-info-circle"></i> Что нужно сделать:</h6>
                    <ol class="mb-0">
                        <li>Перейдите в "Управление семестрами"</li>
                        <li>Создайте новый семестр</li>
                        <li>Укажите:
                            <ul>
                                <li>Название (например: "Осенний семестр 2025-2026")</li>
                                <li>Номер семестра (1 или 2)</li>
                                <li>Смену (утреннее или дневное)</li>
                                <li>Даты начала и окончания</li>
                            </ul>
                        </li>
                        <li>Отметьте "Сделать активным семестром"</li>
                    </ol>
                </div>
                
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <a href="{% url 'schedule:manage_semesters' %}" class="btn btn-primary">
                        <i class="bi bi-calendar-range"></i> Управление семестрами
                    </a>
                    <a href="{% url 'schedule:add_semester' %}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Создать семестр
                    </a>
                </div>
                {% else %}
                <p class="mb-4">
                    Обратитесь к декану для настройки текущего семестра
                </p>
                <a href="{% url 'core:dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Вернуться на главную
                </a>
                {% endif %}
            </div>
        </div>
        
        {% if user.role == 'DEAN' %}
        <div class="card mt-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-lightbulb"></i> Подсказка
            </div>
            <div class="card-body">
                <h6>Рекомендуемый порядок настройки:</h6>
                <ol>
                    <li>Создайте семестр и активируйте его</li>
                    <li>Добавьте кабинеты (можно массово)</li>
                    <li>Создайте предметы с распределением кредитов</li>
                    <li>Назначьте преподавателей предметам</li>
                    <li>Используйте конструктор для создания расписания</li>
                </ol>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/schedule_view_unified.html">
{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}

{% block title %}Расписание{% endblock %}

{% block content %}
<div class="row mt-4">
    <!-- Выбор группы (только для декана и преподавателя) -->
    {% if groups %}
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> Выбор группы
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Группа</label>
                            <select class="form-select" name="group" onchange="this.form.submit()">
                                <option value="">Выбрать...</option>
                                {% for g in groups %}
                                    <option value="{{ g.id }}" {% if group and group.id == g.id %}selected{% endif %}>
                                        {{ g.name }} - {{ g.specialty|truncatewords:8 }} ({{ g.students.count }} чел.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Загрузить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if group %}
    <!-- РАСПИСАНИЕ В ТАБЛИЧНОМ ФОРМАТЕ -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-calendar-week"></i> ҶАДВАЛИ ДАРСӢ - {{ group.name }}
                </span>
                <div>
                    <a href="{% url 'schedule:export' %}?group={{ group.id }}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Экспорт DOCX
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px; vertical-align: middle; text-align: center;">
                                    <strong>ҲАФТА<br>СОАТ</strong>
                                </th>
                                <th style="width: 45%;">Дарс / Устод</th>
                                <th style="width: 60px;">АУД</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <!-- Заголовок дня -->
                                <tr class="table-secondary">
                                    <td colspan="3" class="text-center">
                                        <strong>{{ day_name }}</strong>
                                    </td>
                                </tr>
                                
                                <!-- Временные слоты для этого дня -->
                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center align-middle time-cell">
                                            <strong style="font-size: 0.9rem;">
                                                {{ time_slot.start_time|time:"H" }}<sup>{{ time_slot.start_time|time:"i" }}</sup>-{{ time_slot.end_time|time:"H" }}<sup>{{ time_slot.end_time|time:"i" }}</sup>
                                            </strong>
                                        </td>
                                        
                                        {% with slot=schedule_data|get_slot:group.id|get_slot:day_num|get_slot:time_slot.id %}
                                        <td class="p-2">
                                            {% if slot %}
                                            <div>
                                                <strong style="font-size: 0.9rem;">{{ slot.subject.name }} ({{ slot.subject.get_type_display }})</strong><br>
                                                <small class="text-muted">{{ slot.teacher.user.get_full_name|default:'—' }}</small><br>
                                                <small class="text-muted">{{ slot.subject.credits }} кр. | {{ slot.subject.hours_per_semester }} ч.</small>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle text-center" style="font-size: 0.85rem;">
                                            {% if slot %}
                                                <strong>{{ slot.room|default:'—' }}</strong>
                                            {% endif %}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Легенда -->
        <div class="card mt-3">
            <div class="card-body">
                <h6>Обозначения:</h6>
                <span class="badge bg-primary me-2">Лекция</span>
                <span class="badge bg-success me-2">Практика</span>
                <span class="badge bg-warning me-2">СРСП (КМРО)</span>
            </div>
        </div>
    </div>
    {% elif active_semester %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> 
                {% if user.role == 'STUDENT' %}
                    Расписание для вашей группы пока не составлено. Обратитесь к декану.
                {% else %}
                    Выберите группу для просмотра расписания.
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<style>
.schedule-table {
    font-size: 0.85rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
}

.schedule-table tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
</file>

<file path="templates/schedule/semester_form.html">
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar-range"></i> {{ title }}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Название семестра *</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Номер *</label>
                            {{ form.number }}
                            {% if form.number.errors %}
                                <div class="text-danger">{{ form.number.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Смена *</label>
                            {{ form.shift }}
                            <small class="form-text text-muted">Определяет временные слоты расписания</small>
                            {% if form.shift.errors %}
                                <div class="text-danger">{{ form.shift.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- ✅ НОВОЕ ПОЛЕ: КУРС -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Курс *</label>
                            {{ form.course }}
                            <small class="form-text text-muted">Для какого курса этот семестр</small>
                            {% if form.course.errors %}
                                <div class="text-danger">{{ form.course.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Дата начала *</label>
                            {{ form.start_date }}
                            {% if form.start_date.errors %}
                                <div class="text-danger">{{ form.start_date.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Дата окончания *</label>
                            {{ form.end_date }}
                            {% if form.end_date.errors %}
                                <div class="text-danger">{{ form.end_date.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            Сделать активным семестром (для {{ form.course.value }} курса)
                        </label>
                    </div>
                    {% if semester and semester.pk %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Внимание при изменении смены:</strong><br>
                        Если вы меняете смену (утренняя ↔ дневная), рекомендуется запустить команду очистки:
                        <pre class="mb-0 mt-2"><code>python manage.py cleanup_schedule</code></pre>
                    </div>
                    {% endif %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Важно:</strong> Семестр будет доступен только для групп {{ form.course.value }} курса
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить
                        </button>
                        <a href="{% url 'schedule:manage_semesters' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
</file>

<file path="templates/schedule/subject_form.html">
{% extends 'base.html' %}

{% block title %}{{ title|default:"Добавить предмет" }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-book"></i> {{ title|default:"Добавить предмет" }}
            </div>
            <div class="card-body">
                <form method="post" id="subjectForm">
                    {% csrf_token %}
                    
                    <!-- ✅ УПРОЩЕННАЯ ФОРМА: ТОЛЬКО КРЕДИТЫ -->
                    <div class="alert alert-success">
                        <h5><i class="bi bi-magic"></i> Автоматический расчет</h5>
                        <p class="mb-0">Введите только <strong>общее количество кредитов</strong>, система сама рассчитает все часы по формуле: <code>1 кредит = 24 часа</code></p>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-info-circle"></i> Основная информация
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">{{ form.code.label }}</label>
                                    {{ form.code }}
                                    {% if form.code.errors %}
                                        <div class="text-danger small">{{ form.code.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">{{ form.name.label }}</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="text-danger small">{{ form.name.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ form.teacher.label }}</label>
                                    {{ form.teacher }}
                                    {% if form.teacher.errors %}
                                        <div class="text-danger small">{{ form.teacher.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ form.groups.label }}</label>
                                    {{ form.groups }}
                                    <small class="form-text text-muted">{{ form.groups.help_text }}</small>
                                    {% if form.groups.errors %}
                                        <div class="text-danger small">{{ form.groups.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ ГЛАВНОЕ ПОЛЕ: КРЕДИТЫ -->
                    <div class="card mb-3 border-success">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-calculator"></i> Учебная нагрузка
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label"><strong>{{ form.total_credits.label }}</strong></label>
                                {{ form.total_credits }}
                                <small class="form-text text-muted d-block">{{ form.total_credits.help_text }}</small>
                                {% if form.total_credits.errors %}
                                    <div class="text-danger small">{{ form.total_credits.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ✅ Автоматический расчет (живое обновление) -->
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>📊 Автоматический расчет:</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <small class="text-muted">Лекции (Л):</small>
                                            <h5 class="text-primary" id="calc-lecture">0 ч</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">Практика (А):</small>
                                            <h5 class="text-success" id="calc-practice">0 ч</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">КМРО:</small>
                                            <h5 class="text-warning" id="calc-control">0 ч</h5>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">КМД:</small>
                                            <h5 class="text-info" id="calc-kmd">0 ч</h5>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Аудиторные часы:</strong>
                                            <h4 class="text-primary mb-0" id="calc-auditory">0 ч</h4>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Общая трудоемкость:</strong>
                                            <h4 class="text-success mb-0" id="calc-total">0 ч</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Описание -->
                    <div class="mb-3">
                        <label class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                    </div>
                    
                    <!-- ✅ ПРИМЕРЫ ИЗ ТАБЛИЦЫ -->

                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Сохранить предмет
                        </button>
                        <a href="{% url 'schedule:manage_subjects' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const creditsInput = document.querySelector('input[name="total_credits"]');
    
    function calculateAll() {
        const credits = parseInt(creditsInput.value) || 0;
        
        // ✅ ПО ФОРМУЛЕ: 1 кредит = 24 часа
        const totalHours = credits * 24;
        
        // КМД = 1/3 от общей трудоемкости
        const kmdHours = Math.floor(totalHours / 3);
        
        // Аудиторные = 2/3
        const auditoryHours = totalHours - kmdHours;
        
        // Делим поровну: Л, А, КМРО
        const lecture = Math.floor(auditoryHours / 3);
        const practice = Math.floor(auditoryHours / 3);
        const control = auditoryHours - lecture - practice;
        
        // Обновляем интерфейс
        document.getElementById('calc-lecture').textContent = lecture + ' ч';
        document.getElementById('calc-practice').textContent = practice + ' ч';
        document.getElementById('calc-control').textContent = control + ' ч';
        document.getElementById('calc-kmd').textContent = kmdHours + ' ч';
        document.getElementById('calc-auditory').textContent = auditoryHours + ' ч';
        document.getElementById('calc-total').textContent = totalHours + ' ч';
    }
    
    // Вызываем при загрузке
    calculateAll();
    
    // Слушаем изменения
    creditsInput.addEventListener('input', calculateAll);
});
</script>
{% endblock %}
</file>

<file path="templates/schedule/today_widget.html">
{# templates/schedule/today_widget.html - ИСПРАВЛЕНО #}
<div class="card">
    <div class="card-header">
        <i class="bi bi-calendar-day"></i> Сегодня - {{ today|date:"d.m.Y" }} ({{ today|date:"l" }})
    </div>
    <div class="card-body">
        {% if not classes %}
            <div class="text-center text-muted py-3">
                <i class="bi bi-sun" style="font-size: 2rem;"></i>
                <p class="mt-2">Сегодня занятий нет</p>
            </div>
        {% else %}
            {% for lesson in classes %}
                {# Определяем, является ли занятие текущим #}
                {% if lesson.start_time <= lesson.end_time %}
                    {# Обычное занятие в пределах одного дня #}
                    {% if lesson.start_time <= current_time and lesson.end_time >= current_time %}
                        <div class="class-item mb-3 p-3 rounded border border-success border-2 bg-success bg-opacity-10">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">
                                    <span class="badge bg-success me-2">СЕЙЧАС</span>
                                    {{ lesson.subject.name }}
                                </h6>
                                <span class="badge bg-{{ lesson.get_color_class }}">
                                    {{ lesson.subject.get_type_display }}
                                </span>
                            </div>
                            <p class="mb-1">
                                <i class="bi bi-clock"></i>
                                <strong>{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</strong>
                            </p>
                            <p class="mb-1">
                                {% if user.role == 'STUDENT' %}
                                    <i class="bi bi-person"></i> {{ lesson.teacher.user.get_full_name }}
                                {% else %}
                                    <i class="bi bi-people"></i> {{ lesson.group.name }}
                                {% endif %}
                            </p>
                            <p class="mb-0">
                                <i class="bi bi-geo-alt"></i> Аудитория {{ lesson.classroom }}
                            </p>
                        </div>
                    {% else %}
                        <div class="class-item mb-3 p-3 rounded border">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">{{ lesson.subject.name }}</h6>
                                <span class="badge bg-{{ lesson.get_color_class }}">
                                    {{ lesson.subject.get_type_display }}
                                </span>
                            </div>
                            <p class="mb-1">
                                <i class="bi bi-clock"></i>
                                <strong>{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</strong>
                            </p>
                            <p class="mb-1">
                                {% if user.role == 'STUDENT' %}
                                    <i class="bi bi-person"></i> {{ lesson.teacher.user.get_full_name }}
                                {% else %}
                                    <i class="bi bi-people"></i> {{ lesson.group.name }}
                                {% endif %}
                            </p>
                            <p class="mb-0">
                                <i class="bi bi-geo-alt"></i> Аудитория {{ lesson.classroom }}
                            </p>
                        </div>
                    {% endif %}
                {% else %}
                    {# Занятие через полночь #}
                    {% if current_time >= lesson.start_time or current_time <= lesson.end_time %}
                        <div class="class-item mb-3 p-3 rounded border border-success border-2 bg-success bg-opacity-10">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">
                                    <span class="badge bg-success me-2">СЕЙЧАС</span>
                                    {{ lesson.subject.name }}
                                </h6>
                                <span class="badge bg-{{ lesson.get_color_class }}">
                                    {{ lesson.subject.get_type_display }}
                                </span>
                            </div>
                            <p class="mb-1">
                                <i class="bi bi-clock"></i>
                                <strong>{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</strong>
                            </p>
                            <p class="mb-1">
                                {% if user.role == 'STUDENT' %}
                                    <i class="bi bi-person"></i> {{ lesson.teacher.user.get_full_name }}
                                {% else %}
                                    <i class="bi bi-people"></i> {{ lesson.group.name }}
                                {% endif %}
                            </p>
                            <p class="mb-0">
                                <i class="bi bi-geo-alt"></i> Аудитория {{ lesson.classroom }}
                            </p>
                        </div>
                    {% else %}
                        <div class="class-item mb-3 p-3 rounded border">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">{{ lesson.subject.name }}</h6>
                                <span class="badge bg-{{ lesson.get_color_class }}">
                                    {{ lesson.subject.get_type_display }}
                                </span>
                            </div>
                            <p class="mb-1">
                                <i class="bi bi-clock"></i>
                                <strong>{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</strong>
                            </p>
                            <p class="mb-1">
                                {% if user.role == 'STUDENT' %}
                                    <i class="bi bi-person"></i> {{ lesson.teacher.user.get_full_name }}
                                {% else %}
                                    <i class="bi bi-people"></i> {{ lesson.group.name }}
                                {% endif %}
                            </p>
                            <p class="mb-0">
                                <i class="bi bi-geo-alt"></i> Аудитория {{ lesson.classroom }}
                            </p>
                        </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
</div>

<style>
    .class-item {
        transition: all 0.3s ease;
    }

    .class-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
</style>
</file>

</files>
