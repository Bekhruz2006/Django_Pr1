{% extends 'base.html' %}

{% block title %}аббаНаАаЛ - {{ subject.name }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-journal-text"></i> 
                    аббаНаАаЛ: {{ group.name }} - {{ subject.name }}
                    <span class="badge bg-info ms-2">ааЕаДаЕаЛб {{ week_num }}</span>
                </span>
                <div>
                    <a href="{% url 'journal:change_log' %}?group={{ group.id }}&subject={{ subject.id }}" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-clock-history"></i> аббаОбаИб аИаЗаМаЕаНаЕаНаИаЙ
                    </a>
                    <a href="{% url 'journal:journal_view' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> абаБбаАбб аДббаГбб аГббаПаПб
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- ааАаВаИаГаАбаИб аПаО аНаЕаДаЕаЛбаМ -->
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'-1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num <= 1 %}disabled{% endif %}">
                            <i class="bi bi-chevron-left"></i> абаЕаДбаДббаАб аНаЕаДаЕаЛб
                        </a>
                        <span class="mx-3"><strong>ааЕаДаЕаЛб {{ week_num }}</strong></span>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num >= 20 %}disabled{% endif %}">
                            аЁаЛаЕаДбббаАб аНаЕаДаЕаЛб <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                    
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
                        <i class="bi bi-check-all"></i> ааАббаОаВаОаЕ аЗаАаПаОаЛаНаЕаНаИаЕ
                    </button>
                </div>
                
                <!-- аЂаАаБаЛаИбаА аЖббаНаАаЛаА -->
                <div class="table-responsive">
                    <table class="table table-bordered journal-table">
                        <thead>
                            <tr class="table-primary">
                                <th style="width: 200px;">аЁббаДаЕаНб</th>
                                {% for day in days_with_lessons %}
                                    <th class="text-center" style="min-width: 120px;">
                                        {{ day.day_name }}<br>
                                        <small class="text-muted">{{ day.date|date:"d.m" }}</small><br>
                                        <small>{{ day.time|time:"H:i" }}</small>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in journal_data %}
                            <tr>
                                <td>
                                    <strong>{{ row.student.user.get_full_name }}</strong><br>
                                    <small class="text-muted">{{ row.student.student_id }}</small>
                                </td>
                                {% for entry_data in row.entries %}
                                    <td class="text-center {% if entry_data.is_locked %}bg-secondary bg-opacity-10{% endif %}">
                                        <form method="post" action="{% url 'journal:update_entry' entry_data.entry.id %}" class="entry-form">
                                            {% csrf_token %}
                                            
                                            {% if entry_data.is_locked %}
                                                <div class="locked-cell" title="ааАаБаЛаОаКаИбаОаВаАаНаО - аПбаОбаЛаО 24 баАбаА">
                                                    <i class="bi bi-lock-fill text-muted"></i>
                                                    <div class="mt-1">
                                                        {% if entry_data.entry.grade %}
                                                            <span class="badge bg-success">{{ entry_data.entry.grade }}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">{{ entry_data.entry.get_attendance_status_display }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="editable-cell">
                                                    <!-- ааАаЛаЛ -->
                                                    <input type="number" 
                                                           name="{{ entry_data.form.grade.name }}" 
                                                           value="{{ entry_data.entry.grade|default:'' }}"
                                                           min="1" max="12" 
                                                           class="form-control form-control-sm mb-1 grade-input"
                                                           placeholder="1-12"
                                                           onchange="this.form.submit()">
                                                    
                                                    <!-- аЁбаАббб -->
                                                    <select name="{{ entry_data.form.attendance_status.name }}"
                                                            class="form-select form-select-sm status-select"
                                                            onchange="this.form.submit()">
                                                        {% for value, label in entry_data.form.fields.attendance_status.choices %}
                                                            <option value="{{ value }}" 
                                                                    {% if entry_data.entry.attendance_status == value %}selected{% endif %}>
                                                                {{ label }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            {% endif %}
                                        </form>
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                        
                        <!-- аЁаВаОаДаНаАб бббаОаКаА -->
                        <tfoot>
                            <tr class="table-info">
                                <td><strong>абаОаГаО</strong></td>
                                {% for stats in day_stats %}
                                    <td class="text-center">
                                        <small>
                                            ааОбаЕб: <strong>{{ stats.attendance_pct|floatformat:0 }}%</strong><br>
                                            аЁб.аБаАаЛаЛ: <strong>{{ stats.avg_grade }}</strong>
                                        </small>
                                    </td>
                                {% endfor %}
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- ааЕаГаЕаНаДаА -->
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> абаАаВаИаЛаА баАаБаОбб б аЖббаНаАаЛаОаМ:</h6>
                    <ul class="mb-0">
                        <li>т ааАаПаИбаИ аМаОаЖаНаО баЕаДаАаКбаИбаОаВаАбб аВ баЕбаЕаНаИаЕ <strong>24 баАбаОаВ</strong> аПаОбаЛаЕ аНаАбаАаЛаА аЗаАаНббаИб</li>
                        <li>№ ааОбаЛаЕ аБаЛаОаКаИбаОаВаКаИ аИаЗаМаЕаНаЕаНаИб <strong>аНаЕаВаОаЗаМаОаЖаНб</strong> (аДаАаЖаЕ аДаЛб аДаЕаКаАаНаА)</li>
                        <li>т абаЛаИ баКаАаЗаАаН аБаАаЛаЛ (1-12), ббаАббб аАаВбаОаМаАбаИбаЕбаКаИ "абаИбббббаВаОаВаАаЛ"</li>
                        <li>т ааЕаЛбаЗб аОаДаНаОаВбаЕаМаЕаНаНаО бббаАаНаОаВаИбб аБаАаЛаЛ аИ ббаАббб аОббббббаВаИб</li>
                        <li>№ абаЕ аИаЗаМаЕаНаЕаНаИб аЛаОаГаИбббббб аАаВбаОаМаАбаИбаЕбаКаИ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ааОаДаАаЛбаНаОаЕ аОаКаНаО аМаАббаОаВаОаГаО аЗаАаПаОаЛаНаЕаНаИб -->
<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ааАббаОаВаОаЕ аЗаАаПаОаЛаНаЕаНаИаЕ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'journal:bulk_update' %}">
                {% csrf_token %}
                <input type="hidden" name="group_id" value="{{ group.id }}">
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">абаБаЕбаИбаЕ аДаЕаНб</label>
                        <select name="lesson_date" class="form-select" id="bulkDaySelect" required>
                            <option value="">-- абаБаЕбаИбаЕ аДаЕаНб --</option>
                            {% for day in days_with_lessons %}
                                <option value="{{ day.date|date:'Y-m-d' }}" data-time="{{ day.time|time:'H:i:s' }}">
                                    {{ day.day_name }} ({{ day.date|date:"d.m" }})
                                </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="lesson_time" id="bulkTimeInput">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">абаБаЕбаИбаЕ бббаДаЕаНбаОаВ</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">
                                    <strong>абаБбаАбб аВбаЕб</strong>
                                </label>
                            </div>
                            <hr>
                            {% for row in journal_data %}
                                <div class="form-check">
                                    <input class="form-check-input student-checkbox" 
                                           type="checkbox" 
                                           name="students" 
                                           value="{{ row.student.id }}"
                                           id="student_{{ row.student.id }}">
                                    <label class="form-check-label" for="student_{{ row.student.id }}">
                                        {{ row.student.user.get_full_name }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ааАаЛаЛ (1-12)</label>
                        <input type="number" name="grade" class="form-control" min="1" max="12" placeholder="аббаАаВббаЕ аПббббаМ аДаЛб ббаАбббаА">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ааЛаИ ббаАббб аПаОбаЕбаЕаНаИб</label>
                        <select name="attendance_status" class="form-select">
                            <option value="">-- ааЕ аИаЗаМаЕаНббб --</option>
                            <option value="PRESENT">абаИбббббаВаОаВаАаЛ</option>
                            <option value="ABSENT_ILLNESS">аа-ааОаЛаЕаЗаНб</option>
                            <option value="ABSENT_VALID">аа-аЃаВаАаЖаИбаЕаЛбаНаАб</option>
                            <option value="ABSENT_INVALID">аа-ааЕбаВаАаЖаИбаЕаЛбаНаАб</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small>
                            <i class="bi bi-exclamation-triangle"></i> 
                            ааАаБаЛаОаКаИбаОаВаАаНаНбаЕ аЗаАаПаИбаИ (аПбаОбаЛаО 24 баАбаА) аБбаДбб аПбаОаПббаЕаНб
                        </small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">абаМаЕаНаА</button>
                    <button type="submit" class="btn btn-primary">абаИаМаЕаНаИбб</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .journal-table {
        font-size: 0.9rem;
    }
    
    .journal-table td {
        vertical-align: middle;
        padding: 0.5rem;
    }
    
    .grade-input, .status-select {
        font-size: 0.85rem;
    }
    
    .locked-cell {
        padding: 0.5rem;
    }
    
    .editable-cell:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
// абаБбаАбб аВбаЕб бббаДаЕаНбаОаВ
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// ааВбаОаЗаАаПаОаЛаНаЕаНаИаЕ аВбаЕаМаЕаНаИ аПбаИ аВбаБаОбаЕ аДаНб
document.getElementById('bulkDaySelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const time = selectedOption.getAttribute('data-time');
    document.getElementById('bulkTimeInput').value = time;
});
</script>
{% endblock %}