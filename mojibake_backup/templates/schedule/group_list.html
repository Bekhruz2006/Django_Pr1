{% extends 'base.html' %}

{% block title %}аЁаПаИбаОаК аГббаПаП{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        {% for item in groups_with_students %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-collection"></i> аббаПаПаА {{ item.group.name }} - {{ item.group.specialty }}
                <span class="badge bg-primary ms-2">{{ item.group.course }} аКббб</span>
                <span class="badge bg-info ms-2">{{ item.students|length }} бббаДаЕаНбаОаВ</span>
            </div>
            <div class="card-body">
                {% if item.students %}
                <div class="table-responsive">
                    <table class="table table-hover sortable-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(this, 0)" class="sortable">т</th>
                                <th onclick="sortTable(this, 1)" class="sortable">аЄаа бббаДаЕаНбаА</th>
                                <th onclick="sortTable(this, 2)" class="sortable">ааЕаНб баОаЖаДаЕаНаИб</th>
                                <th onclick="sortTable(this, 3)" class="sortable">ааОбаЛаЕаДаНаИаЙ аВбаОаД</th>
                                <th onclick="sortTable(this, 4)" class="sortable">аЁбаЕаДаНаИаЙ аБаАаЛаЛ</th>
                                <th onclick="sortTable(this, 5)" class="sortable">а аЕаЙбаИаНаГ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in item.students %}
                            <tr onclick="window.location='{% url 'accounts:profile' %}?user_id={{ student.user.id }}'" style="cursor: pointer;">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <a href="{% url 'accounts:profile' %}?user_id={{ student.user.id }}">
                                        {{ student.user.get_full_name }}
                                    </a>
                                </td>
                                <td>{{ student.birth_date|date:"d.m.Y" }}</td>
                                <td>
                                    {% if student.user.last_login %}
                                        {{ student.user.last_login|date:"d.m.Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">ааИаКаОаГаДаА</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ student.get_average_grade|default:"т" }}</strong>
                                </td>
                                <td>
                                    {% if student.get_group_rank > 0 %}
                                        <span class="badge bg-warning">{{ student.get_group_rank }}</span>
                                    {% else %}
                                        <span class="text-muted">т</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> а ббаОаЙ аГббаПаПаЕ аПаОаКаА аНаЕб бббаДаЕаНбаОаВ
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="card">
            <div class="card-body text-center text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-2">ааЕб аДаОбббаПаНбб аГббаПаП</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .sortable:hover {
        background-color: #f0f0f0;
    }
    
    .sortable::after {
        content: ' т';
        color: #ccc;
        font-size: 0.8em;
    }
    
    tr:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
function sortTable(header, columnIndex) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // ааПбаЕаДаЕаЛбаЕаМ аНаАаПбаАаВаЛаЕаНаИаЕ баОббаИбаОаВаКаИ
    const isAscending = header.classList.contains('asc');
    
    // аЃаДаАаЛбаЕаМ аКаЛаАббб баОббаИбаОаВаКаИ баО аВбаЕб аЗаАаГаОаЛаОаВаКаОаВ
    table.querySelectorAll('th').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    
    // ааОаБаАаВаЛбаЕаМ аКаЛаАбб аК баЕаКббаЕаМб аЗаАаГаОаЛаОаВаКб
    header.classList.add(isAscending ? 'desc' : 'asc');
    
    // аЁаОббаИббаЕаМ бббаОаКаИ
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // ааОаПббаКаА аПбаЕаОаБбаАаЗаОаВаАбб аВ баИбаЛаО
        const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
        const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? bNum - aNum : aNum - bNum;
        }
        
        // аЁаОббаИбаОаВаКаА аКаАаК бббаОаКаИ
        return isAscending ? bValue.localeCompare(aValue) : aValue.localeCompare(bValue);
    });
    
    // ааБаНаОаВаЛбаЕаМ баАаБаЛаИбб
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}