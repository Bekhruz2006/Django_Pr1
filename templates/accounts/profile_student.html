{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Профиль студента" %}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid mt-4">
    
    <div class="card border-0 shadow-sm mb-4 bg-white">
        <div class="card-body p-4">
            <div class="d-flex align-items-center flex-wrap gap-4">
                <div class="position-relative">
                    {% if user.photo %}
                        <img src="{{ user.photo.url }}" class="rounded-circle shadow-sm" style="width: 100px; height: 100px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center shadow-sm" style="width: 100px; height: 100px;">
                            <i class="bi bi-person text-secondary" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                    <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-primary border border-white">
                        {{ profile.course }} {% trans "курс" %}
                    </span>
                </div>

                <div class="flex-grow-1">
                    <h2 class="fw-bold mb-1">{{ user.get_full_name }}</h2>
                    <p class="text-muted mb-2">
                        <i class="bi bi-mortarboard-fill me-1 text-primary"></i> {{ profile.specialty.name }} 
                        <span class="mx-2">•</span> 
                        <i class="bi bi-people-fill me-1 text-primary"></i> {% trans "Группа:" %} <strong>{{ profile.group.name }}</strong>
                    </p>
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge bg-light text-dark border"><i class="bi bi-card-heading"></i> {{ profile.student_id }}</span>
                        <span class="badge bg-light text-dark border">{{ profile.get_financing_type_display }}</span>
                        {% if not viewing_as_dean %}
                            <a href="{% url 'accounts:edit_profile' %}" class="btn btn-sm btn-outline-primary ms-auto">
                                <i class="bi bi-pencil"></i> {% trans "Редактировать" %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-bottom: 4px solid #10b981 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">{% trans "Средний GPA" %}</h6>
                        <div class="icon-box bg-success bg-opacity-10 text-success rounded-circle p-2"><i class="bi bi-graph-up-arrow"></i></div>
                    </div>
                    <h2 class="fw-bold text-success mb-0">{{ profile.statistics.overall_gpa|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-bottom: 4px solid #3b82f6 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">{% trans "Посещаемость" %}</h6>
                        <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle p-2"><i class="bi bi-calendar-check"></i></div>
                    </div>
                    <h2 class="fw-bold text-primary mb-0">{{ profile.statistics.attendance_percentage|floatformat:0 }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-bottom: 4px solid #f59e0b !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">{% trans "Рейтинг" %}</h6>
                        <div class="icon-box bg-warning bg-opacity-10 text-warning rounded-circle p-2"><i class="bi bi-trophy"></i></div>
                    </div>
                    <h2 class="fw-bold text-warning mb-0">#{{ profile.statistics.group_rank }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="border-bottom: 4px solid #ef4444 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">{% trans "Прогулы (НБ)" %}</h6>
                        <div class="icon-box bg-danger bg-opacity-10 text-danger rounded-circle p-2"><i class="bi bi-exclamation-triangle"></i></div>
                    </div>
                    <h2 class="fw-bold text-danger mb-0">{{ profile.statistics.total_absent }}</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-activity me-2 text-primary"></i>{% trans "Динамика обучения" %}</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="studentHistoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-pie-chart me-2 text-info"></i>{% trans "Структура посещения" %}</h5>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <div style="height: 220px; width: 100%; position: relative;">
                        <canvas id="attendanceDoughnutChart"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle text-center">
                            <h3 class="fw-bold mb-0 text-dark">{{ profile.statistics.total_lessons }}</h3>
                            <small class="text-muted">{% trans "Пар всего" %}</small>
                        </div>
                    </div>
                    <div class="mt-3 text-center small text-muted">
                        <span class="me-2"><i class="bi bi-circle-fill text-success"></i> {% trans "Присут." %}</span>
                        <span class="me-2"><i class="bi bi-circle-fill text-primary"></i> {% trans "Болезнь" %}</span>
                        <span class="me-2"><i class="bi bi-circle-fill text-warning"></i> {% trans "Уваж." %}</span>
                        <span><i class="bi bi-circle-fill text-danger"></i> {% trans "НБ" %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-list-ul me-2 text-primary"></i>{% trans "Успеваемость по предметам" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 py-3">{% trans "Предмет" %}</th>
                                    <th class="text-center">{% trans "Показатели" %}</th>
                                    <th class="text-center" style="width: 200px;">{% trans "Эффективность" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subj_id, data in profile.statistics.subjects_data.items %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold text-dark">{{ data.name }}</div>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-2">
                                            <span class="badge {% if data.average_grade >= 4 %}bg-success{% elif data.average_grade >= 3 %}bg-warning{% else %}bg-danger{% endif %} bg-opacity-10 text-dark border">
                                                GPA: {{ data.average_grade|floatformat:1 }}
                                            </span>
                                            {% widthratio data.attended data.total_lessons 100 as att_pct_calc %}
                                            <span class="badge bg-light text-dark border">
                                                {{ att_pct_calc }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div class="mini-chart-container">
                                            <div class="target-line"></div>
                                            <div class="chart-bar-group">
                                                <div class="chart-value">{{ data.average_grade|floatformat:1 }}</div>
                                                <div class="chart-bar {% if data.average_grade < 3 %}bar-danger{% else %}bar-gpa{% endif %}" style="height: {% widthratio data.average_grade 1 20 %}%;"></div>
                                            </div>
                                            <div class="chart-bar-group">
                                                <div class="chart-value">{{ att_pct_calc }}%</div>
                                                <div class="chart-bar {% if att_pct_calc|add:0 < 60 %}bar-danger{% else %}bar-att{% endif %}" style="height: {{ att_pct_calc }}%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center py-4 text-muted">{% trans "Нет данных по предметам" %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-person-lines-fill me-2 text-primary"></i>{% trans "Личные данные" %}</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item px-0 py-3">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">{% trans "Дата рождения" %}</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar3 me-2 text-secondary"></i>
                                <span class="fw-medium">{{ profile.birth_date|date:"d.m.Y"|default:"Не указана" }}</span>
                            </div>
                        </li>
                        <li class="list-group-item px-0 py-3">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">{% trans "Пол / Нац." %}</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-gender-ambiguous me-2 text-secondary"></i>
                                <span class="fw-medium">{{ profile.get_gender_display }} / {{ profile.nationality|default:"-" }}</span>
                            </div>
                        </li>
                        <li class="list-group-item px-0 py-3">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">{% trans "Паспорт" %}</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-credit-card-2-front me-2 text-secondary"></i>
                                <span class="fw-medium">{{ profile.passport_series }} {{ profile.passport_number }}</span>
                            </div>
                        </li>
                        <li class="list-group-item px-0 py-3">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">{% trans "Адрес" %}</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-geo-alt me-2 text-secondary"></i>
                                <span class="fw-medium small">{{ profile.residence_address|default:"Не указан" }}</span>
                            </div>
                        </li>
                        <li class="list-group-item px-0 py-3">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">{% trans "Телефон" %}</small>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-telephone me-2 text-secondary"></i>
                                <span class="fw-medium">{{ user.phone|default:"Не указан" }}</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .mini-chart-container {
        position: relative;
        height: 40px;
        width: 100%;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 8px;
        background-color: transparent;
    }
    .target-line {
        position: absolute;
        bottom: 60%;
        left: 0; right: 0;
        border-top: 1px dashed #cbd5e1;
    }
    .chart-bar-group {
        width: 12px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        position: relative;
    }
    .chart-bar {
        width: 100%;
        border-radius: 2px 2px 0 0;
        min-height: 2px;
        transition: height 0.5s ease;
    }
    .chart-value {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 9px;
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
        background: #334155;
        color: white;
        padding: 1px 3px;
        border-radius: 2px;
    }
    .chart-bar-group:hover .chart-value { opacity: 1; }
    
    .bar-gpa { background: #6366f1; }
    .bar-att { background: #10b981; }
    .bar-danger { background: #ef4444; }
</style>

<script>
    const labels = {{ chart_labels|safe }};
    const gpaData = {{ chart_gpa|safe }};
    const attData = {{ chart_attendance|safe }};

    const ctxLine = document.getElementById('studentHistoryChart').getContext('2d');
    
    let gradGPA = ctxLine.createLinearGradient(0, 0, 0, 300);
    gradGPA.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
    gradGPA.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

    new Chart(ctxLine, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'GPA',
                    data: gpaData,
                    borderColor: '#6366f1',
                    backgroundColor: gradGPA,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y',
                    pointRadius: 4,
                    pointBackgroundColor: '#fff'
                },
                {
                    label: '{% trans "Посещаемость %" %}',
                    data: attData,
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.4,
                    fill: false,
                    yAxisID: 'y1',
                    pointRadius: 4,
                    pointBackgroundColor: '#fff'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top' } },
            scales: {
                y: { min: 0, max: 5, position: 'left' },
                y1: { min: 0, max: 100, position: 'right', grid: { display: false } },
                x: { grid: { display: false } }
            }
        }
    });

    const donutData = {{ donut_data|safe }};
    const isDonutEmpty = {{ donut_empty|lower }};
    const ctxDonut = document.getElementById('attendanceDoughnutChart').getContext('2d');

    const donutColors = isDonutEmpty 
        ? ['#e2e8f0', '#e2e8f0', '#e2e8f0', '#e2e8f0'] 
        : ['#10b981', '#3b82f6', '#f59e0b', '#ef4444']; 

    new Chart(ctxDonut, {
        type: 'doughnut',
        data: {
            labels: ['{% trans "Присутствовал" %}', '{% trans "Болезнь" %}', '{% trans "Уважительная" %}', '{% trans "Прогул" %}'],
            datasets: [{
                data: donutData,
                backgroundColor: donutColors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: { display: false },
                tooltip: { enabled: !isDonutEmpty }
            }
        }
    });
</script>
{% endblock %}