{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Управление структурой ВУЗа" %}{% endblock %}
{% block breadcrumbs %}
    <li class="breadcrumb-item active">{% trans "Структура университета" %}</li>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-1">{% trans "Структура университета" %}</h3>
            <p class="text-muted small mb-0">{% trans "Управление институтами, факультетами, кафедрами и специальностями" %}</p>
        </div>
        {% if is_admin %}
        <div class="d-flex gap-2">
            <a href="{% url 'accounts:add_institute' %}" class="btn btn-success btn-sm shadow-sm">
                <i class="bi bi-plus-lg"></i> {% trans "Институт" %}
            </a>
            <a href="{% url 'accounts:add_faculty' %}" class="btn btn-primary btn-sm shadow-sm">
                <i class="bi bi-plus-lg"></i> {% trans "Факультет" %}
            </a>
        </div>
        {% endif %}
    </div>

    {% if is_admin %}
        <div class="accordion" id="structureAccordion">
            {% for inst_data in structure_data %}
            <div class="card border-0 shadow-sm mb-3 overflow-hidden" id="inst-{{ inst_data.obj.id }}">
                <div class="card-header bg-white border-bottom py-3 d-flex align-items-center justify-content-between" 
                     data-bs-toggle="collapse" data-bs-target="#collapseInst{{ inst_data.obj.id }}" 
                     style="cursor: pointer;">
                    
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-2 rounded me-3">
                            <i class="bi bi-bank text-primary fs-5"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold text-dark">{{ inst_data.obj.name }}</h5>
                            <div class="small text-muted mt-1">
                                <i class="bi bi-person-badge me-1"></i>{% trans "Директор:" %} 
                                <span class="fw-medium text-dark">
                                    {{ inst_data.director.user.get_full_name|default:"{% trans 'Не назначен' %}" }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3">
                        <span class="badge bg-light text-dark border">
                            {{ inst_data.faculties|length }} {% trans "факультетов" %}
                        </span>
                        <div class="btn-group" role="group">
                            <a href="{% url 'accounts:edit_institute' inst_data.obj.id %}" class="btn btn-sm btn-outline-secondary" title="{% trans 'Настройки' %}">
                                <i class="bi bi-gear"></i>
                            </a>
                            <a href="{% url 'accounts:delete_institute' inst_data.obj.id %}" class="btn btn-sm btn-outline-danger" title="{% trans 'Удалить' %}">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                        <i class="bi bi-chevron-down text-muted"></i>
                    </div>
                </div>

                <div id="collapseInst{{ inst_data.obj.id }}" class="accordion-collapse collapse" data-bs-parent="#structureAccordion">
                    <div class="card-body bg-light p-3">
                        
                        {% if inst_data.faculties %}
                            {% for fac_data in inst_data.faculties %}
                            <div class="card border border-light shadow-sm mb-3">
                                <div class="card-header bg-white py-2 px-3 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-diagram-2-fill text-success me-2"></i>
                                        <span class="fw-bold">{{ fac_data.obj.name }}</span>
                                        <span class="badge bg-light text-muted border ms-2">{{ fac_data.obj.code }}</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <small class="text-muted">
                                            {% trans "Декан:" %} <b>{{ fac_data.dean.user.get_full_name|default:"-" }}</b>
                                        </small>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'accounts:add_department' %}?faculty={{ fac_data.obj.id }}" class="btn btn-outline-success" title="{% trans 'Добавить кафедру' %}">{% trans "+ Каф" %}</a>
                                            <a href="{% url 'accounts:edit_faculty' fac_data.obj.id %}" class="btn btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                                            <a href="{% url 'accounts:delete_faculty' fac_data.obj.id %}" class="btn btn-outline-danger"><i class="bi bi-trash"></i></a>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0" style="font-size: 0.85rem;">
                                            <thead class="bg-light text-muted">
                                                <tr>
                                                    <th class="ps-4" style="width: 30%;">{% trans "Кафедра" %}</th>
                                                    <th style="width: 20%;">{% trans "Заведующий" %}</th>
                                                    <th style="width: 15%;">{% trans "Статистика" %}</th>
                                                    <th style="width: 25%;">{% trans "Специальности" %}</th>
                                                    <th class="text-end pe-3" style="width: 10%;">{% trans "Действия" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for dept_data in fac_data.departments %}
                                                <tr>
                                                    <td class="ps-4 align-middle fw-medium">
                                                        {{ dept_data.obj.name }}
                                                    </td>
                                                    <td class="align-middle">
                                                        {{ dept_data.head.user.get_full_name|default:"<span class='text-muted'>-</span>"|safe }}
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="d-flex flex-column small">
                                                            <span><i class="bi bi-person text-muted"></i> {{ dept_data.stats.teachers }} {% trans "преп." %}</span>
                                                            <span><i class="bi bi-people text-muted"></i> {{ dept_data.stats.students }} {% trans "студ." %}</span>
                                                        </div>
                                                    </td>
                                                    <td class="align-middle">
                                                        {% for spec in dept_data.specialties %}
                                                            <span class="badge bg-info bg-opacity-10 text-dark border mb-1" title="{{ spec.name }}">
                                                                {{ spec.code }}
                                                            </span>
                                                        {% empty %}
                                                            <span class="text-muted small">-</span>
                                                        {% endfor %}
                                                    </td>
                                                    <td class="text-end pe-3 align-middle">
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'accounts:add_specialty' %}?department={{ dept_data.obj.id }}" class="btn btn-light text-primary" title="{% trans 'Добавить специальность' %}">{% trans "+Спец" %}</a>
                                                            <a href="{% url 'accounts:edit_department' dept_data.obj.id %}" class="btn btn-light text-secondary"><i class="bi bi-gear"></i></a>
                                                            <a href="{% url 'accounts:delete_department' dept_data.obj.id %}" class="btn btn-light text-danger"><i class="bi bi-trash"></i></a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center py-3 text-muted small">
                                                        {% trans "Кафедры отсутствуют." %} 
                                                        <a href="{% url 'accounts:add_department' %}?faculty={{ fac_data.obj.id }}">{% trans "Добавить первую" %}</a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-diagram-2 fs-3 d-block mb-2 opacity-50"></i>
                                {% trans "В этом институте пока нет факультетов." %}
                                <br>
                                <a href="{% url 'accounts:add_faculty' %}?institute={{ inst_data.obj.id }}" class="btn btn-sm btn-primary mt-2">{% trans "Добавить факультет" %}</a>
                            </div>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="bi bi-building-dash text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
                </div>
                <h4>{% trans "Структура пуста" %}</h4>
                <p class="text-muted">{% trans "Начните с создания первого института." %}</p>
                <a href="{% url 'accounts:add_institute' %}" class="btn btn-primary btn-lg mt-2">
                    <i class="bi bi-plus-lg"></i> {% trans "Создать Институт" %}
                </a>
            </div>
            {% endfor %}
        </div>

    {% elif is_dean %}
        <div class="alert alert-info border-0 shadow-sm d-flex align-items-center">
            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
            <div>
                <strong>{% trans "Панель Декана:" %}</strong> {% blocktrans %}Вы управляете факультетом <u>{{ faculty.name }}</u>.{% endblocktrans %}
                <br><small>{% trans "Используйте этот раздел для настройки кафедр, специальностей и назначения заведующих." %}</small>
            </div>
        </div>
        
        <div class="d-flex justify-content-end mb-3">
            <a href="{% url 'accounts:add_department' %}" class="btn btn-primary shadow-sm">
                <i class="bi bi-plus-lg"></i> {% trans "Новая кафедра" %}
            </a>
        </div>

        <div class="accordion" id="deptAccordion">
            {% for item in dept_data %}
            <div class="accordion-item shadow-sm mb-3 border-0 overflow-hidden">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-white text-dark py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.obj.id }}">
                        <div class="d-flex w-100 justify-content-between align-items-center me-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-diagram-3-fill me-3 text-primary fs-5"></i>
                                <div>
                                    <span class="fw-bold fs-6 text-dark">{{ item.obj.name }}</span>
                                    <div class="small text-muted mt-1 fw-normal">
                                        <i class="bi bi-person-badge"></i> {% trans "Зав:" %} <span class="text-dark fw-medium">{{ item.obj.head.user.get_full_name|default:"{% trans 'Не назначен' %}" }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end d-none d-md-block">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">{% trans "НАГРУЗКА" %}</small>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress" style="width: 80px; height: 6px;">
                                        <div class="progress-bar {% if item.load_percent > 100 %}bg-danger{% else %}bg-success{% endif %}" 
                                             role="progressbar" style="width: {{ item.load_percent }}%"></div>
                                    </div>
                                    <small class="fw-bold text-dark">{{ item.load_percent }}%</small>
                                </div>
                            </div>
                        </div>
                    </button>
                </h2>
                
                <div id="collapse{{ item.obj.id }}" class="accordion-collapse collapse">
                    <div class="accordion-body bg-light p-3">
                        <div class="d-flex gap-2 mb-3 p-2 bg-white rounded border flex-wrap align-items-center">
                            <span class="text-muted small text-uppercase fw-bold ms-2 me-auto">{% trans "Действия:" %}</span>
                            
                            <a href="{% url 'accounts:add_specialty' %}?department={{ item.obj.id }}" class="btn btn-xs btn-outline-primary">
                                <i class="bi bi-mortarboard-plus"></i> {% trans "+Специальность" %}
                            </a>
                            <a href="{% url 'accounts:add_user' %}?role=TEACHER&department={{ item.obj.id }}" class="btn btn-xs btn-outline-success">
                                <i class="bi bi-person-plus"></i> {% trans "+Преподаватель" %}
                            </a>
                            <a href="{% url 'accounts:user_management' %}?role=TEACHER&department={{ item.obj.id }}" class="btn btn-xs btn-info text-white">
                                <i class="bi bi-people"></i> {% trans "Штат" %} ({{ item.teachers_count }})
                            </a>
                            <div class="vr mx-2"></div>
                            <a href="{% url 'accounts:edit_department' item.obj.id %}" class="btn btn-xs btn-secondary">
                                <i class="bi bi-gear"></i> {% trans "Настройки" %}
                            </a>
                        </div>

                        <div class="row g-3">
                            {% for spec_data in item.specialties_data %}
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-2">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary me-2">{{ spec_data.obj.code }}</span>
                                            <span class="small fw-bold text-dark">{{ spec_data.obj.name|truncatechars:30 }}</span>
                                        </div>
                                        <div>
                                            <a href="{% url 'accounts:edit_specialty' spec_data.obj.id %}" class="text-muted small"><i class="bi bi-pencil"></i></a>
                                        </div>
                                    </div>
                                    <div class="card-body p-2 bg-light bg-opacity-10">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted fw-bold">{% trans "ГРУППЫ:" %}</small>
                                            {% if not spec_data.plan %}
                                                <a href="{% url 'schedule:create_plan' %}?specialty={{ spec_data.obj.id }}" class="badge bg-warning text-dark text-decoration-none">{% trans "Нет РУП! Создать" %}</a>
                                            {% else %}
                                                <a href="{% url 'schedule:plan_detail' spec_data.plan.id %}" class="badge bg-success text-decoration-none">{% trans "РУП" %} {{ spec_data.plan.admission_year }}</a>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for group in spec_data.groups %}
                                                <a href="{% url 'schedule:constructor' %}?group={{ group.id }}" 
                                                   class="btn btn-sm btn-white border d-flex align-items-center px-2 py-1"
                                                   style="font-size: 0.75rem;"
                                                   title="{% trans 'Расписание' %}">
                                                    <span class="fw-bold me-1">{{ group.name }}</span>
                                                    <span class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">{{ group.course }}</span>
                                                </a>
                                            {% empty %}
                                                <small class="text-muted fst-italic">{% trans "Групп нет" %}</small>
                                                <a href="{% url 'accounts:add_group' %}?specialty={{ spec_data.obj.id }}" class="ms-2 small text-primary text-decoration-none">{% trans "+Доб." %}</a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<style>
    .btn-xs {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
    }
    .accordion-button:not(.collapsed) {
        background-color: #f8fafc;
        color: var(--bs-primary);
        box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
    }
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }
</style>
{% endblock %}