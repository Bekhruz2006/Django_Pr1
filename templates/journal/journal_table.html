{% extends 'base.html' %}

{% block title %}–ñ—É—Ä–Ω–∞–ª - {{ subject.name }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-journal-text"></i> 
                    –ñ—É—Ä–Ω–∞–ª: {{ group.name }} - {{ subject.name }}
                    <span class="badge bg-info ms-2">–ù–µ–¥–µ–ª—è {{ week_num }}</span>
                </span>
                <div>
                    <a href="{% url 'journal:change_log' %}?group={{ group.id }}&subject={{ subject.id }}" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    </a>
                    <a href="{% url 'journal:journal_view' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –≥—Ä—É–ø–ø—É
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º -->
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'-1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num <= 1 %}disabled{% endif %}">
                            <i class="bi bi-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è
                        </a>
                        <span class="mx-3"><strong>–ù–µ–¥–µ–ª—è {{ week_num }}</strong></span>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num >= 20 %}disabled{% endif %}">
                            –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                    
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
                        <i class="bi bi-check-all"></i> –ú–∞—Å—Å–æ–≤–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                    </button>
                </div>
                
                <!-- –¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞ -->
                <div class="table-responsive">
                    <table class="table table-bordered journal-table">
                        <thead>
                            <tr class="table-primary">
                                <th style="width: 200px;">–°—Ç—É–¥–µ–Ω—Ç</th>
                                {% for day in days_with_lessons %}
                                    <th class="text-center" style="min-width: 120px;">
                                        {{ day.day_name }}<br>
                                        <small class="text-muted">{{ day.date|date:"d.m" }}</small><br>
                                        <small>{{ day.time|time:"H:i" }}</small>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in journal_data %}
                            <tr>
                                <td>
                                    <strong>{{ row.student.user.get_full_name }}</strong><br>
                                    <small class="text-muted">{{ row.student.student_id }}</small>
                                </td>
                                {% for entry_data in row.entries %}
                                    <td class="text-center {% if entry_data.is_locked %}bg-secondary bg-opacity-10{% endif %}">
                                        <form method="post" action="{% url 'journal:update_entry' entry_data.entry.id %}" class="entry-form">
                                            {% csrf_token %}
                                            
                                            {% if entry_data.is_locked %}
                                                <div class="locked-cell" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ - –ø—Ä–æ—à–ª–æ 24 —á–∞—Å–∞">
                                                    <i class="bi bi-lock-fill text-muted"></i>
                                                    <div class="mt-1">
                                                        {% if entry_data.entry.grade %}
                                                            <span class="badge bg-success">{{ entry_data.entry.grade }}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">{{ entry_data.entry.get_attendance_status_display }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="editable-cell">
                                                    <!-- –ë–∞–ª–ª -->
                                                    <input type="number" 
                                                           name="{{ entry_data.form.grade.name }}" 
                                                           value="{{ entry_data.entry.grade|default:'' }}"
                                                           min="1" max="12" 
                                                           class="form-control form-control-sm mb-1 grade-input"
                                                           placeholder="1-12"
                                                           onchange="this.form.submit()">
                                                    
                                                    <!-- –°—Ç–∞—Ç—É—Å -->
                                                    <select name="{{ entry_data.form.attendance_status.name }}"
                                                            class="form-select form-select-sm status-select"
                                                            onchange="this.form.submit()">
                                                        {% for value, label in entry_data.form.fields.attendance_status.choices %}
                                                            <option value="{{ value }}" 
                                                                    {% if entry_data.entry.attendance_status == value %}selected{% endif %}>
                                                                {{ label }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            {% endif %}
                                        </form>
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                        
                        <!-- –°–≤–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
                        <tfoot>
                            <tr class="table-info">
                                <td><strong>–ò—Ç–æ–≥–æ</strong></td>
                                {% for stats in day_stats %}
                                    <td class="text-center">
                                        <small>
                                            –ü–æ—Å–µ—â: <strong>{{ stats.attendance_pct|floatformat:0 }}%</strong><br>
                                            –°—Ä.–±–∞–ª–ª: <strong>{{ stats.avg_grade }}</strong>
                                        </small>
                                    </td>
                                {% endfor %}
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∂—É—Ä–Ω–∞–ª–æ–º:</h6>
                    <ul class="mb-0">
                        <li>‚úì –ó–∞–ø–∏—Å–∏ –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ <strong>24 —á–∞—Å–æ–≤</strong> –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∑–∞–Ω—è—Ç–∏—è</li>
                        <li>üîí –ü–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è <strong>–Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã</strong> (–¥–∞–∂–µ –¥–ª—è –¥–µ–∫–∞–Ω–∞)</li>
                        <li>‚úì –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –±–∞–ª–ª (1-12), —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª"</li>
                        <li>‚úó –ù–µ–ª—å–∑—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–ª –∏ —Å—Ç–∞—Ç—É—Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è</li>
                        <li>üìù –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Å–æ–≤–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ú–∞—Å—Å–æ–≤–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'journal:bulk_update' %}">
                {% csrf_token %}
                <input type="hidden" name="group_id" value="{{ group.id }}">
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</label>
                        <select name="lesson_date" class="form-select" id="bulkDaySelect" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å --</option>
                            {% for day in days_with_lessons %}
                                <option value="{{ day.date|date:'Y-m-d' }}" data-time="{{ day.time|time:'H:i:s' }}">
                                    {{ day.day_name }} ({{ day.date|date:"d.m" }})
                                </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="lesson_time" id="bulkTimeInput">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">
                                    <strong>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</strong>
                                </label>
                            </div>
                            <hr>
                            {% for row in journal_data %}
                                <div class="form-check">
                                    <input class="form-check-input student-checkbox" 
                                           type="checkbox" 
                                           name="students" 
                                           value="{{ row.student.id }}"
                                           id="student_{{ row.student.id }}">
                                    <label class="form-check-label" for="student_{{ row.student.id }}">
                                        {{ row.student.user.get_full_name }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ë–∞–ª–ª (1-12)</label>
                        <input type="number" name="grade" class="form-control" min="1" max="12" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ò–ª–∏ —Å—Ç–∞—Ç—É—Å –ø–æ—Å–µ—â–µ–Ω–∏—è</label>
                        <select name="attendance_status" class="form-select">
                            <option value="">-- –ù–µ –∏–∑–º–µ–Ω—è—Ç—å --</option>
                            <option value="PRESENT">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</option>
                            <option value="ABSENT_ILLNESS">–ù–ë-–ë–æ–ª–µ–∑–Ω—å</option>
                            <option value="ABSENT_VALID">–ù–ë-–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</option>
                            <option value="ABSENT_INVALID">–ù–ë-–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small>
                            <i class="bi bi-exclamation-triangle"></i> 
                            –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–ø—Ä–æ—à–ª–æ 24 —á–∞—Å–∞) –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã
                        </small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .journal-table {
        font-size: 0.9rem;
    }
    
    .journal-table td {
        vertical-align: middle;
        padding: 0.5rem;
    }
    
    .grade-input, .status-select {
        font-size: 0.85rem;
    }
    
    .locked-cell {
        padding: 0.5rem;
    }
    
    .editable-cell:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–Ω—è
document.getElementById('bulkDaySelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const time = selectedOption.getAttribute('data-time');
    document.getElementById('bulkTimeInput').value = time;
});
</script>
{% endblock %}