{% extends 'base.html' %}

{% block title %}Аналитический отчет{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid mt-4">
    
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="bi bi-people fs-4 text-primary"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Студентов</h6>
                        <h3 class="mb-0 fw-bold">{{ total_students }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="bi bi-graph-up-arrow fs-4 text-success"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Средний GPA</h6>
                        <h3 class="mb-0 fw-bold text-success">{{ overall_gpa|floatformat:2 }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="bi bi-calendar-check fs-4 text-warning"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Посещаемость</h6>
                        <h3 class="mb-0 fw-bold text-warning">{{ overall_attendance|floatformat:1 }}%</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle me-3">
                        <i class="bi bi-exclamation-octagon fs-4 text-danger"></i>
                    </div>
                    <div>
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Группа риска</h6>
                        <h3 class="mb-0 fw-bold text-danger">{{ total_at_risk }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>Сводный анализ групп</h6>
                </div>
                <div class="card-body">
                    <canvas id="mainChart" height="140"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-pie-chart-fill me-2 text-info"></i>Структура пропусков (НБ)</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div style="width: 100%; max-width: 320px;">
                        <canvas id="polarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-shield-exclamation me-2 text-danger"></i>Топ групп в зоне риска</h6>
                </div>
                <div class="card-body">
                    <canvas id="riskChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-list-columns-reverse me-2 text-secondary"></i>Детализация пропусков</h6>
                </div>
                <div class="card-body">
                    <canvas id="absentStackChart" height="140"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-5">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#dataTableCollapse" style="cursor: pointer;">
            <h6 class="mb-0 fw-bold"><i class="bi bi-table me-2"></i>Таблица данных</h6>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="collapse show" id="dataTableCollapse">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Группа</th>
                                <th class="text-center">Студентов</th>
                                <th class="text-center">GPA</th>
                                <th class="text-center">Посещаемость</th>
                                <th class="text-center">НБ (Всего)</th>
                                <th class="text-center">Риск</th>
                                <th class="text-end pe-4">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in groups_data %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.group.name }}</td>
                                <td class="text-center">{{ item.students_count }}</td>
                                <td class="text-center">
                                    <span class="badge {% if item.avg_gpa >= 4.0 %}bg-success{% elif item.avg_gpa >= 3.0 %}bg-warning{% else %}bg-danger{% endif %} bg-opacity-75">
                                        {{ item.avg_gpa|floatformat:2 }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px; max-width: 60px;">
                                            <div class="progress-bar bg-primary" style="width: {{ item.avg_attendance|floatformat:0 }}%"></div>
                                        </div>
                                        <span class="small">{{ item.avg_attendance|floatformat:0 }}%</span>
                                    </div>
                                </td>
                                <td class="text-center">{{ item.total_absent }}</td>
                                <td class="text-center">
                                    {% if item.at_risk_count > 0 %}
                                        <span class="badge bg-danger rounded-pill">{{ item.at_risk_count }}</span>
                                    {% else %}
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <a href="{% url 'journal:group_detail' item.group.id %}" class="btn btn-sm btn-light text-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const labels = {{ chart_labels|safe }};
    const gpaData = {{ chart_gpa|safe }};
    const attendanceData = {{ chart_attendance|safe }};
    
    const illnessData = {{ chart_illness|safe }};
    const validData = {{ chart_valid|safe }};
    const invalidData = {{ chart_invalid|safe }};
    
    const riskLabels = {{ chart_risk_labels|safe }};
    const riskValues = {{ chart_risk_values|safe }};

    Chart.defaults.font.family = "'Segoe UI', sans-serif";
    Chart.defaults.color = '#64748b';
    Chart.defaults.scale.grid.color = '#f1f5f9';

    const ctxMain = document.getElementById('mainChart').getContext('2d');
    
    let gradGPA = ctxMain.createLinearGradient(0, 0, 0, 300);
    gradGPA.addColorStop(0, 'rgba(99, 102, 241, 0.8)'); 
    gradGPA.addColorStop(1, 'rgba(99, 102, 241, 0.2)');

    new Chart(ctxMain, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'GPA',
                    data: gpaData,
                    backgroundColor: gradGPA,
                    borderRadius: 6,
                    barPercentage: 0.6,
                    yAxisID: 'y',
                    order: 2
                },
                {
                    label: 'Посещаемость %',
                    data: attendanceData,
                    type: 'line',
                    borderColor: '#10b981', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#10b981',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    order: 1,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top' } },
            scales: {
                y: {
                    position: 'left',
                    title: { display: true, text: 'Балл (0-5)' },
                    max: 5
                },
                y1: {
                    position: 'right',
                    title: { display: true, text: 'Проценты (0-100)' },
                    max: 100,
                    grid: { drawOnChartArea: false }
                },
                x: { grid: { display: false } }
            }
        }
    });

    const sumIllness = illnessData.reduce((a, b) => a + b, 0);
    const sumValid = validData.reduce((a, b) => a + b, 0);
    const sumInvalid = invalidData.reduce((a, b) => a + b, 0);

    const ctxPolar = document.getElementById('polarChart').getContext('2d');
    new Chart(ctxPolar, {
        type: 'polarArea',
        data: {
            labels: ['Болезнь', 'Уважительная', 'Прогул'],
            datasets: [{
                data: [sumIllness, sumValid, sumInvalid],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)', 
                    'rgba(16, 185, 129, 0.7)', 
                    'rgba(239, 68, 68, 0.7)'   
                ],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    ticks: { display: false }, 
                    grid: { color: '#e2e8f0' }
                }
            },
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    const ctxRisk = document.getElementById('riskChart').getContext('2d');
    new Chart(ctxRisk, {
        type: 'bar',
        data: {
            labels: riskLabels,
            datasets: [{
                label: 'Студентов в зоне риска',
                data: riskValues,
                backgroundColor: 'rgba(239, 68, 68, 0.8)', 
                borderRadius: 4,
                barPercentage: 0.7
            }]
        },
        options: {
            indexAxis: 'y', 
            responsive: true,
            scales: {
                x: { beginAtZero: true, grid: { display: true } },
                y: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });

    const ctxStack = document.getElementById('absentStackChart').getContext('2d');
    new Chart(ctxStack, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Болезнь',
                    data: illnessData,
                    backgroundColor: '#93c5fd',
                    stack: 'Stack 0'
                },
                {
                    label: 'Уважительная',
                    data: validData,
                    backgroundColor: '#86efac', 
                    stack: 'Stack 0'
                },
                {
                    label: 'Прогул',
                    data: invalidData,
                    backgroundColor: '#fca5a5',
                    stack: 'Stack 0'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true, grid: { display: false } },
                y: { stacked: true }
            },
            plugins: {
                legend: { position: 'top', align: 'end' }
            }
        }
    });
</script>
{% endblock %}