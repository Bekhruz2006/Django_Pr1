{% extends 'base.html' %}

{% block title %}–ñ—É—Ä–Ω–∞–ª - {{ subject.name }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-journal-text"></i> 
                    –ñ—É—Ä–Ω–∞–ª: {{ group.name }} - {{ subject.name }}
                    <span class="badge bg-info ms-2">–ù–µ–¥–µ–ª—è {{ week_num }}</span>
                </span>
                <div>
                    <a href="{% url 'journal:change_log' %}?group={{ group.id }}&subject={{ subject.id }}" class="btn btn-info btn-sm me-2">
                        <i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    </a>
                    <a href="{% url 'journal:journal_view' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –≥—Ä—É–ø–ø—É
                    </a>
                </div>
            </div>
            <div class="card-body">
                
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'-1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num <= 1 %}disabled{% endif %}">
                            <i class="bi bi-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è
                        </a>
                        <span class="mx-3"><strong>–ù–µ–¥–µ–ª—è {{ week_num }}</strong></span>
                        <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'1' }}" 
                           class="btn btn-outline-primary btn-sm {% if week_num >= 20 %}disabled{% endif %}">
                            –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>

                {# ========== –†–ê–ó–î–ï–õ 1: –ë–ê–õ–õ–´ –ó–ê –ù–ï–î–ï–õ–Æ ========== #}
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-star"></i> –ë–∞–ª–ª—ã –∑–∞ –Ω–µ–¥–µ–ª—é {{ week_num }}
                        <small class="ms-2">(–û—Ü–µ–Ω–∫–∏ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é)</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 200px;">–°—Ç—É–¥–µ–Ω—Ç</th>
                                        <th style="width: 150px;" class="text-center">–ë–∞–ª–ª –∑–∞ –Ω–µ–¥–µ–ª—é (1-12)</th>
                                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in journal_data %}
                                    <tr>
                                        <td>
                                            <strong>{{ row.student.user.get_full_name }}</strong><br>
                                            <small class="text-muted">{{ row.student.student_id }}</small>
                                        </td>
                                        <td class="text-center">
                                            {# –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–ª–∞ #}
                                            {% with entry=row.entries.0.entry %}
                                            <form method="post" action="{% url 'journal:update_entry' entry.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <input type="number" 
                                                       name="grade" 
                                                       value="{{ entry.grade|default:'' }}"
                                                       min="1" max="12" 
                                                       class="form-control form-control-sm d-inline w-auto"
                                                       placeholder="1-12"
                                                       style="max-width: 80px;"
                                                       onchange="this.form.submit()">
                                            </form>
                                            {% if entry.grade %}
                                                <span class="badge bg-success ms-2">‚úì</span>
                                            {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <small class="text-muted">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-info mt-2">
                            <i class="bi bi-info-circle"></i> 
                            <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –ë–∞–ª–ª –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏.
                        </div>
                    </div>
                </div>

                {# ========== –†–ê–ó–î–ï–õ 2: –ü–û–°–ï–©–ê–ï–ú–û–°–¢–¨ (–ù–ë) –ü–û –î–ù–Ø–ú ========== #}
                <div class="card border-warning">
                    <div class="card-header bg-warning">
                        <i class="bi bi-calendar-check"></i> –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø–æ –¥–Ω—è–º (–ù–ë)
                        <button type="button" class="btn btn-sm btn-success float-end" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
                            <i class="bi bi-check-all"></i> –ú–∞—Å—Å–æ–≤–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ù–ë
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered journal-table">
                                <thead>
                                    <tr class="table-light">
                                        <th style="width: 200px;">–°—Ç—É–¥–µ–Ω—Ç</th>
                                        {% for day in days_with_lessons %}
                                            <th class="text-center" style="min-width: 120px;">
                                                {{ day.day_name }}<br>
                                                <small class="text-muted">{{ day.date|date:"d.m" }}</small><br>
                                                <small>{{ day.time|time:"H:i" }}</small>
                                            </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in journal_data %}
                                    <tr>
                                        <td>
                                            <strong>{{ row.student.user.get_full_name }}</strong><br>
                                            <small class="text-muted">{{ row.student.student_id }}</small>
                                        </td>
                                        {% for entry_data in row.entries %}
                                            <td class="text-center {% if entry_data.is_locked %}bg-secondary bg-opacity-10{% endif %}">
                                                <form method="post" action="{% url 'journal:update_entry' entry_data.entry.id %}">
                                                    {% csrf_token %}
                                                    
                                                    {% if entry_data.is_locked %}
                                                        <div class="locked-cell">
                                                            <i class="bi bi-lock-fill text-muted"></i>
                                                            <div class="mt-1">
                                                                <span class="badge {% if entry_data.entry.attendance_status == 'PRESENT' %}bg-success{% else %}bg-danger{% endif %}">
                                                                    {{ entry_data.entry.get_attendance_status_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <select name="attendance_status"
                                                                class="form-select form-select-sm"
                                                                onchange="this.form.submit()">
                                                            {% for value, label in entry_data.form.fields.attendance_status.choices %}
                                                                <option value="{{ value }}" 
                                                                        {% if entry_data.entry.attendance_status == value %}selected{% endif %}>
                                                                    {{ label }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    {% endif %}
                                                </form>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>–í–∞–∂–Ω–æ:</strong> –ù–ë –æ—Ç–º–µ—á–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è. –ë–∞–ª–ª—ã –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –Ω–µ–¥–µ–ª—é –≤—ã—à–µ.
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∂—É—Ä–Ω–∞–ª–æ–º:</h6>
                    <ul class="mb-0">
                        <li>‚úì –ë–∞–ª–ª—ã –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è <strong>–æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é</strong> –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç–∞–±–ª–∏—Ü–µ</li>
                        <li>‚úì –ù–ë (–Ω–µ—è–≤–∫–∏) –æ—Ç–º–µ—á–∞—é—Ç—Å—è <strong>–æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è</strong> –≤ –Ω–∏–∂–Ω–µ–π —Ç–∞–±–ª–∏—Ü–µ</li>
                        <li>üîí –ó–∞–ø–∏—Å–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ <strong>24 —á–∞—Å–∞</strong> –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∑–∞–Ω—è—Ç–∏—è</li>
                        <li>üìù –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ù–ë #}
<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ú–∞—Å—Å–æ–≤–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ù–ë</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'journal:bulk_update' %}">
                {% csrf_token %}
                <input type="hidden" name="group_id" value="{{ group.id }}">
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</label>
                        <select name="lesson_date" class="form-select" id="bulkDaySelect" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å --</option>
                            {% for day in days_with_lessons %}
                                <option value="{{ day.date|date:'Y-m-d' }}" data-time="{{ day.time|time:'H:i:s' }}">
                                    {{ day.day_name }} ({{ day.date|date:"d.m" }})
                                </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="lesson_time" id="bulkTimeInput">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label" for="selectAll">
                                    <strong>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</strong>
                                </label>
                            </div>
                            <hr>
                            {% for row in journal_data %}
                                <div class="form-check">
                                    <input class="form-check-input student-checkbox" 
                                           type="checkbox" 
                                           name="students" 
                                           value="{{ row.student.id }}"
                                           id="student_{{ row.student.id }}">
                                    <label class="form-check-label" for="student_{{ row.student.id }}">
                                        {{ row.student.user.get_full_name }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å –ù–ë</label>
                        <select name="attendance_status" class="form-select" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
                            <option value="PRESENT">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</option>
                            <option value="ABSENT_ILLNESS">–ù–ë-–ë–æ–ª–µ–∑–Ω—å</option>
                            <option value="ABSENT_VALID">–ù–ë-–£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</option>
                            <option value="ABSENT_INVALID">–ù–ë-–ù–µ—É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .journal-table {
        font-size: 0.9rem;
    }
    
    .journal-table td {
        vertical-align: middle;
        padding: 0.5rem;
    }
</style>

<script>
// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–Ω—è
document.getElementById('bulkDaySelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const time = selectedOption.getAttribute('data-time');
    document.getElementById('bulkTimeInput').value = time;
});
</script>
{% endblock %}