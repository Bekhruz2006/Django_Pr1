{% extends 'base.html' %}

{% block title %}Журнал - {{ subject.name }}{% endblock %}
{% block breadcrumbs %}
    <li class="breadcrumb-item"><a href="{% url 'journal:journal_view' %}">Выбор журнала</a></li>
    <li class="breadcrumb-item active">{{ group.name }} — {{ subject.name }}</li>
{% endblock %}
{% block content %}
<style>
    .journal-grid input {
        border: none;
        background: transparent;
        width: 100%;
        text-align: center;
        font-weight: 500;
        outline: none;
    }
    .journal-grid input:focus {
        background-color: #e8f0fe;
        box-shadow: inset 0 0 0 2px #2563eb;
    }
    .journal-grid td {
        padding: 0 !important; 
        height: 40px;
        vertical-align: middle;
        position: relative;
    }
    .cell-locked {
        background-color: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    .val-grade { color: #2563eb; font-weight: bold; }
    .val-absent { color: #dc2626; font-weight: bold; }
</style>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">
                    <i class="bi bi-journal-bookmark-fill"></i> 
                    {{ group.name }} | {{ subject.name }}
                </h5>
                <div>
                    <span class="badge bg-light text-dark border me-2">Неделя {{ week_num }}</span>
                    <a href="{% url 'journal:journal_view' %}" class="btn btn-outline-secondary btn-sm">Назад</a>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="d-flex justify-content-between bg-light p-2 border-bottom">
                    <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'-1' }}" class="btn btn-sm btn-link text-decoration-none">&larr; Пред. неделя</a>
                    
                    <small class="text-muted align-self-center">
                        Вводите <b>1-12</b> для оценки или <b>нб</b> для прогула. Tab для перемещения.
                    </small>
                    
                    <a href="?group={{ group.id }}&subject={{ subject.id }}&week={{ week_num|add:'1' }}" class="btn btn-sm btn-link text-decoration-none">След. неделя &rarr;</a>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered mb-0 journal-grid table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 250px;" class="ps-3 align-middle">ФИО Студента</th>
                                {% for day in days_with_lessons %}
                                    <th class="text-center" style="width: 80px;">
                                        <div style="font-size: 0.8rem;">{{ day.day_name|slice:":2" }}</div>
                                        <div style="font-size: 0.7rem;" class="text-muted">{{ day.date|date:"d.m" }}</div>
                                        <div style="font-size: 0.65rem; color: #aaa;">{{ day.time|time:"H:i" }}</div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in journal_data %}
                            <tr>
                                <td class="ps-3 py-2">
                                    <span class="fw-medium">{{ row.student.user.last_name }} {{ row.student.user.first_name|slice:":1" }}.</span>
                                </td>
                                {% for entry_data in row.entries %}
                                    <td>
                                        {% if entry_data.is_locked %}
                                            <div class="cell-locked" title="Заблокировано (время истекло)">
                                                {{ entry_data.entry.get_display_value }}
                                                {% if entry_data.entry.attendance_status != 'PRESENT' and not entry_data.entry.grade %}
                                                    <small>НБ</small>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <input type="text" 
                                                   value="{% if entry_data.entry.grade %}{{ entry_data.entry.grade }}{% elif entry_data.entry.attendance_status != 'PRESENT' %}нб{% endif %}" 
                                                   class="journal-input {% if entry_data.entry.grade %}val-grade{% elif entry_data.entry.attendance_status != 'PRESENT' %}val-absent{% endif %}"
                                                   data-entry-id="{{ entry_data.entry.id }}"
                                                   autocomplete="off">
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.journal-input');

    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.dataset.oldValue = this.value;
            this.select();
        });


        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                this.blur(); 
                
                const currentTd = this.parentElement;
                const currentTr = currentTd.parentElement;
                const cellIndex = Array.from(currentTr.children).indexOf(currentTd);
                const nextTr = currentTr.nextElementSibling;
                
                if (nextTr) {
                    const nextInput = nextTr.children[cellIndex]?.querySelector('input');
                    if (nextInput) nextInput.focus();
                }
            }
        });

        input.addEventListener('change', function() {
            const newVal = this.value.trim();
            const entryId = this.dataset.entryId;
            
            if (newVal === this.dataset.oldValue) return;

            this.style.opacity = '0.5';

            fetch('{% url "journal:update_journal_cell" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    entry_id: entryId,
                    value: newVal
                })
            })
            .then(r => r.json())
            .then(data => {
                this.style.opacity = '1';


                if (data.success) {
                    this.value = data.display;
                    this.classList.remove('val-grade', 'val-absent');
                    
                    if (data.type === 'grade') this.classList.add('val-grade');
                    if (data.type === 'absent') this.classList.add('val-absent');
                    
                    this.dataset.oldValue = data.display;
                } else {
                    alert(data.error);
                    this.value = this.dataset.oldValue;
                    this.focus();
                }
            })
            
            .catch(err => {
                alert('Ошибка соединения');
                this.style.opacity = '1';
                this.value = this.dataset.oldValue;
            });
        });
    });
});
</script>
{% endblock %}