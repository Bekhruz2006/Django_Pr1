

{% extends "lms/base_lms.html" %}
{% load i18n %}
{% block title %}{% trans "Журнал оценок" %} — {{ course.short_name }}{% endblock %}
{% block breadcrumb_extra %}<li class="breadcrumb-item active">{% trans "Журнал оценок" %}</li>{% endblock %}
{% load lms_extras %}
{% block lms_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0"><i class="bi bi-table me-2"></i>{% trans "Журнал оценок" %}: {{ course.short_name }}</h5>
  {% if is_manager %}
  <a href="{% url 'lms:grade_item_manage' course.pk %}" class="btn btn-sm btn-outline-primary">
    <i class="bi bi-table me-2"></i>{% trans "Добавить элемент" %}
  </a>
  {% endif %}
</div>

{% if is_manager %}
<div class="table-responsive">
<table class="table table-bordered table-sm table-hover">
  <thead class="table-light">
    <tr>
      <th>{% trans "Студент" %}</th>
      {% for gi in grade_items %}
      <th class="text-center" title="{{ gi.name }}">
        <span class="small">{{ gi.name|truncatechars:20 }}</span>
        <br><span class="text-muted" style="font-size:.7rem">/{{ gi.max_score|floatformat:0 }}</span>
      </th>
      {% endfor %}
      <th class="text-center fw-bold">{% trans "Итог %" %}</th>
    </tr>
  </thead>
  <tbody>
    {% for row in matrix %}
    <tr>
      <td>{{ row.user.get_full_name }}</td>
      {% for entry in row.grades %}
      <td class="text-center">
        {% if entry %}
          <span class="{% if entry.percentage >= 90 %}text-success{% elif entry.percentage >= 60 %}text-warning{% else %}text-danger{% endif %}">
            {{ entry.score|floatformat:1 }}
          </span>
        {% else %}
          <span class="text-muted">—</span>
        {% endif %}
      </td>
      {% endfor %}
      <td class="text-center fw-bold">
        {% if row.total is not None %}{{ row.total }}%{% else %}—{% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="100" class="text-center text-muted">{% trans "Нет студентов" %}</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% else %}
<div class="card shadow-sm" style="max-width:600px">
  <div class="card-body">
    <table class="table table-sm">
      <thead><tr><th>{% trans "Элемент" %}</th><th class="text-center">{% trans "Оценка" %}</th><th class="text-center">%</th></tr></thead>
      <tbody>
        {% for gi in grade_items %}
        <tr>
          <td>{{ gi.name }}</td>
          <td class="text-center">
            {% with e=my_entries|get_item:gi.pk %}
            {% if e %}{{ e.score|floatformat:1 }} / {{ gi.max_score|floatformat:0 }}
            {% else %}<span class="text-muted">—</span>{% endif %}
            {% endwith %}
          </td>
          <td class="text-center">
            {% with e=my_entries|get_item:gi.pk %}
            {% if e and e.percentage %}
            <span class="badge {% if e.percentage >= 90 %}bg-success{% elif e.percentage >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
              {{ e.percentage }}%
            </span>
            {% else %}—{% endif %}
            {% endwith %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="fw-bold">
          <td>{% trans "Итоговый балл" %}</td>
          <td colspan="2" class="text-center">
            {% if my_total is not None %}{{ my_total }}%{% else %}—{% endif %}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}