{% extends "lms/base_lms.html" %}
{% load i18n %}

{% block title %}{{ course.short_name }}{% endblock %}

{% block lms_content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card mb-3 shadow-sm">
      {% if course.image %}
      <div style="height: 200px; overflow: hidden; border-radius: 11px 11px 0 0;">
          <img src="{{ course.image.url }}" style="width: 100%; height: 100%; object-fit: cover;" alt="{{ course.short_name }}">
      </div>
      {% endif %}
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h4 class="mb-1">{{ course.full_name }}</h4>
            <p class="text-muted mb-0">{{ course.category.get_full_path }}</p>
          </div>
          {% if can_manage %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <form action="{% url 'lms:sync_schedule' course.pk %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-warning btn-sm shadow-sm fw-bold" onclick="return confirm('Внимание! Это удалит текущие секции и сгенерирует новые на основе расписания. Продолжить?');">
                      <i class="bi bi-magic"></i>{% trans "Сгенерировать структуру из расписания"  %}
                  </button>
              </form>
              <small class="text-muted">
                <i class="bi bi-arrows-move me-1"></i>{% trans "Перетащите секции для сортировки" %}
              </small>
            </div>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'lms:course_edit' course.pk %}"><i class="bi bi-pencil me-2"></i>{% trans "Редактировать" %}</a></li>
                <li><a class="dropdown-item" href="{% url 'lms:section_create' course.pk %}"><i class="bi bi-plus me-2"></i>{% trans "Добавить секцию" %}</a></li>
                <li><a class="dropdown-item" href="{% url 'lms:enrolment_manage' course.pk %}"><i class="bi bi-people me-2"></i>{% trans "Участники" %}</a></li>
                <li><a class="dropdown-item" href="{% url 'lms:gradebook' course.pk %}"><i class="bi bi-table me-2"></i>{% trans "Журнал оценок" %}</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{% url 'lms:course_delete' course.pk %}"><i class="bi bi-trash me-2"></i>{% trans "Удалить курс" %}</a></li>
              </ul>
            </div>
          {% endif %}
        </div>
        {% if course.summary %}
        <p class="mt-2 mb-0">{{ course.summary }}</p>
        {% endif %}
      </div>
    </div>

    {% if enrolment and enrolment.role == 'STUDENT' %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3">
          <span class="text-muted small">{% trans "Прогресс:" %}</span>
          <div class="progress flex-grow-1" style="height:10px">
            <div class="progress-bar bg-success" style="width:{{ progress }}%" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <span class="fw-bold small">{{ progress }}%</span>
        </div>
      </div>
    </div>
    {% endif %}

    {% if announcements %}
    <div class="mb-3">
      {% for ann in announcements %}
      <div class="alert alert-info d-flex gap-2 py-2">
        <i class="bi bi-megaphone mt-1"></i>
        <div>
          <strong>{{ ann.title }}</strong>
          <div class="small">{{ ann.body|truncatewords:30 }}</div>
          <div class="text-muted" style="font-size:.75rem">{{ ann.created_at|date:"d.m.Y H:i" }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {% if can_manage %}
    <div class="mb-2 text-end">
      <small class="text-muted">
        <i class="bi bi-arrows-move me-1"></i>{% trans "Перетащите секции для сортировки" %}
      </small>
    </div>
    {% endif %}
    <div id="sections-list">
    {% for section in sections %}
    <div class="card mb-4 shadow-sm 
        {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}border-warning bg-warning bg-opacity-10
        {% elif section.section_type == 'RED' %}border-danger bg-danger bg-opacity-10
        {% elif section.section_type == 'BLUE' %}border-primary bg-primary bg-opacity-10{% endif %}" 
        data-section-id="{{ section.pk }}">
      
      <div class="card-header d-flex justify-content-between align-items-center 
        {% if not section.is_visible %}bg-light
        {% elif section.section_type == 'RATING1' or section.section_type == 'RATING2' %}bg-warning text-dark border-warning
        {% elif section.section_type == 'RED' %}bg-danger text-white border-danger
        {% elif section.section_type == 'BLUE' %}bg-primary text-white border-primary{% endif %}">
        
        <h6 class="mb-0 fw-bold {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}text-dark{% else %}text-white{% endif %}">
          {% if not section.is_visible %}<i class="bi bi-eye-slash me-1 text-muted"></i>{% endif %}
          {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}<i class="bi bi-star-fill text-danger me-1"></i>{% endif %}
          {{ section.name }}
        </h6>
        {% if can_manage %}
        <div class="d-flex gap-1">
          <a href="{% url 'lms:section_edit' section.pk %}" class="btn btn-sm {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}btn-outline-dark{% else %}btn-outline-light{% endif %} py-0">
            <i class="bi bi-pencil"></i>
          </a>
          <button class="btn btn-sm {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}btn-outline-dark{% else %}btn-outline-light{% endif %} py-0" data-bs-toggle="modal" data-bs-target="#addModuleModal{{ section.id }}">
            <i class="bi bi-plus-lg me-1"></i> {% trans "Добавить элемент" %}
          </button>
          <form action="{% url 'lms:section_delete' section.pk %}" method="post" class="d-inline" onsubmit="return confirm('{% trans "Удалить секцию?" %}');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}btn-outline-danger{% else %}btn-outline-light{% endif %} py-0"><i class="bi bi-trash"></i></button>
          </form>
        </div>
        {% endif %}
      </div>

      {% if section.summary %}
      <div class="card-body py-2 text-dark small">{{ section.summary }}</div>
      {% endif %}

      <ul class="list-group list-group-flush" id="modules-{{ section.pk }}">
        {% for module in section.modules.all %}
        {% if module.is_visible or can_manage %}
        <li class="list-group-item d-flex align-items-center gap-2 py-3 bg-transparent 
            {% if section.section_type == 'RATING1' or section.section_type == 'RATING2' %}border-warning border-opacity-50
            {% elif section.section_type == 'RED' %}border-danger border-opacity-25
            {% elif section.section_type == 'BLUE' %}border-primary border-opacity-25{% endif %}
            {% if not module.is_visible %}opacity-50 bg-light{% endif %}"
            id="module-item-{{ module.pk }}"
            data-module-id="{{ module.pk }}">

          <i class="bi {{ module.get_icon }} fs-5 text-dark"></i>

          <a href="{% url 'lms:module_detail' module.pk %}" class="flex-grow-1 text-decoration-none fw-bold text-dark">
            {{ module.title }}
          </a>

          <span class="badge bg-secondary ms-2 {% if module.is_visible %}d-none{% endif %}" id="badge-hidden-{{ module.pk }}">
            <i class="bi bi-eye-slash"></i> Скрыто от студентов
          </span>

          {% if module.pk in completed_ids %}
          <i class="bi bi-check-circle-fill text-success" title="{% trans 'Пройдено' %}"></i>
          {% elif module.completion_required %}
          <i class="bi bi-circle text-dark opacity-50" title="{% trans 'Обязателен' %}"></i>
          {% endif %}

          {% if can_manage %}
          <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 toggle-visibility-btn" data-module-id="{{ module.pk }}" title="Скрыть/Показать студентам">
            <i class="bi {% if module.is_visible %}bi-eye{% else %}bi-eye-slash{% endif %}" id="icon-visibility-{{ module.pk }}"></i>
          </button>

          <a href="{% url 'lms:module_edit' module.pk %}" class="btn btn-sm btn-outline-dark py-0 px-1">
            <i class="bi bi-pencil"></i>
          </a>
          <form action="{% url 'lms:module_delete' module.pk %}" method="post" class="d-inline" onsubmit="return confirm('{% trans "Удалить модуль?" %}');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1"><i class="bi bi-trash"></i></button>
          </form>
          {% endif %}
        </li>
        {% endif %}
        {% empty %}
        {% if can_manage %}
        <li class="list-group-item text-center text-dark opacity-75 small py-3 bg-transparent">{% trans "Секция пуста" %}</li>
        {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% empty %}
    <div class="text-center text-muted py-5">
      <i class="bi bi-folder-x" style="font-size:3rem"></i>
      <p class="mt-2">{% trans "В курсе нет секций" %}</p>
    </div>
    {% endfor %}
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card mb-3 shadow-sm">
      <div class="card-header"><strong>{% trans "Информация о курсе" %}</strong></div>
      <ul class="list-group list-group-flush">
        {% if course.start_date %}
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Начало" %}</span>
          <span class="small">{{ course.start_date|date:"d.m.Y" }}</span>
        </li>
        {% endif %}
        {% if course.end_date %}
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Окончание" %}</span>
          <span class="small">{{ course.end_date|date:"d.m.Y" }}</span>
        </li>
        {% endif %}
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Участников" %}</span>
          <span class="small">{{ course.enrolments.count }}</span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Формат" %}</span>
          <span class="small">{{ course.get_format_display }}</span>
        </li>
      </ul>
    </div>

    {% if can_manage %}
    <div class="card mb-3 shadow-sm">
      <div class="card-header"><strong>{% trans "Управление" %}</strong></div>
      <div class="card-body d-grid gap-2">
        <a href="{% url 'lms:gradebook' course.pk %}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-table me-1"></i>{% trans "Журнал оценок" %}
        </a>
        <a href="{% url 'lms:enrolment_manage' course.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-people me-1"></i>{% trans "Участники" %}
        </a>
        <a href="{% url 'lms:course_edit' course.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-gear me-1"></i>{% trans "Настройки курса" %}
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% if can_manage %}
    {% for section in sections %}
    <div class="modal fade" id="addModuleModal{{ section.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="bi bi-grid-fill me-2 text-primary"></i>Добавить в: {{ section.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{% url 'lms:module_create' section.pk %}?type=FILE" class="card h-100 text-decoration-none shadow-sm module-card-hover">
                                <div class="card-body text-center">
                                    <i class="bi bi-file-earmark-pdf text-info fs-1"></i>
                                    <h6 class="mt-2 text-dark">Файл / Лекция</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'lms:module_create' section.pk %}?type=ASSIGNMENT" class="card h-100 text-decoration-none shadow-sm module-card-hover border-primary">
                                <div class="card-body text-center">
                                    <i class="bi bi-journal-arrow-up text-primary fs-1"></i>
                                    <h6 class="mt-2 text-dark">Задание</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'lms:module_create' section.pk %}?type=QUIZ" class="card h-100 text-decoration-none shadow-sm module-card-hover border-success">
                                <div class="card-body text-center">
                                    <i class="bi bi-ui-checks text-success fs-1"></i>
                                    <h6 class="mt-2 text-dark">Тест (Quiz)</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'lms:module_create' section.pk %}?type=URL" class="card h-100 text-decoration-none shadow-sm module-card-hover">
                                <div class="card-body text-center">
                                    <i class="bi bi-link-45deg text-secondary fs-1"></i>
                                    <h6 class="mt-2 text-dark">Ссылка</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'lms:module_create' section.pk %}?type=VIDEO" class="card h-100 text-decoration-none shadow-sm module-card-hover border-danger">
                                <div class="card-body text-center">
                                    <i class="bi bi-play-circle text-danger fs-1"></i>
                                    <h6 class="mt-2 text-dark">Видео</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'lms:module_create' section.pk %}?type=FOLDER" class="card h-100 text-decoration-none shadow-sm module-card-hover border-warning">
                                <div class="card-body text-center">
                                    <i class="bi bi-folder-fill text-warning fs-1"></i>
                                    <h6 class="mt-2 text-dark">Папка</h6>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <style>
        .module-card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .module-card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    </style>
{% endif %}

<style>
  .module-card-hover:hover {
    transform: scale(1.05);
    transition: 0.2s;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const courseId = "{{ course.pk }}";
    const scrollKey = "lms_scroll_pos_course_" + courseId;

    const savedScroll = sessionStorage.getItem(scrollKey);
    if (savedScroll) {
        window.scrollTo(0, parseInt(savedScroll));
        sessionStorage.removeItem(scrollKey);
    }

    document.querySelectorAll('a, button[type="submit"]').forEach(el => {
        el.addEventListener('click', () => {
            sessionStorage.setItem(scrollKey, window.scrollY);
        });
    });
    const today = new Date();
    today.setHours(0,0,0,0);

    const sections = document.querySelectorAll(".card[data-section-id]");

    sections.forEach(function(section) {
        const headerText = section.querySelector(".card-header h6").innerText;
        const match = headerText.match(/Дата:\s*(\d{2})\.(\d{2})\.(\d{4})\s*-\s*(\d{2})\.(\d{2})\.(\d{4})/);

        if (match) {
            const startStr = match[3] + '-' + match[2] + '-' + match[1];
            const endStr = match[6] + '-' + match[5] + '-' + match[4];

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            endDate.setHours(23, 59, 59, 999);

            if (today >= startDate && today <= endDate) {
                section.classList.remove('shadow-sm');
                section.classList.add('shadow', 'border-primary');
                section.style.borderWidth = '2px';

                const badge = document.createElement("span");
                badge.className = "badge bg-primary ms-2 animate-pulse";
                badge.innerHTML = '<i class="bi bi-clock-history"></i> Текущая неделя';
                section.querySelector(".card-header h6").appendChild(badge);

                if (!savedScroll) {
                    setTimeout(() => {
                        section.scrollIntoView({behavior: "smooth", block: "center"});
                    }, 500);
                }
            }
        }
    });
});


document.addEventListener("DOMContentLoaded", function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const moduleId = this.dataset.moduleId;
            const icon = document.getElementById(`icon-visibility-${moduleId}`);
            
            icon.className = 'bi bi-hourglass-split';

            fetch(`/lms/modules/${moduleId}/toggle-visibility/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const badge = document.getElementById(`badge-hidden-${moduleId}`);
                    const listItem = document.getElementById(`module-item-${moduleId}`);

                    if (data.is_visible) {
                        icon.className = 'bi bi-eye';
                        badge.classList.add('d-none');
                        listItem.classList.remove('opacity-50', 'bg-light');
                    } else {
                        icon.className = 'bi bi-eye-slash';
                        badge.classList.remove('d-none');
                        listItem.classList.add('opacity-50', 'bg-light');
                    }
                } else {
                    alert('Ошибка: ' + data.error);
                    icon.className = 'bi bi-exclamation-circle text-danger';
                }
            })
            .catch(err => {
                console.error(err);
                alert('Ошибка сети');
            });
        });
    });
});




</script>

<style>
    @keyframes highlightPulse {
        0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
        100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
    .animate-pulse {
        animation: highlightPulse 2s infinite;
    }
</style>

{% endblock %}
