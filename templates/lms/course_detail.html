{% extends "lms/base_lms.html" %}
{% load i18n %}

{% block title %}{{ course.short_name }}{% endblock %}

{% block lms_content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h4 class="mb-1">{{ course.full_name }}</h4>
            <p class="text-muted mb-0">{{ course.category.get_full_path }}</p>
          </div>
          {% if can_manage %}
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-gear"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'lms:course_edit' course.pk %}"><i class="bi bi-pencil me-2"></i>{% trans "Редактировать" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:section_create' course.pk %}"><i class="bi bi-plus me-2"></i>{% trans "Добавить секцию" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:enrolment_manage' course.pk %}"><i class="bi bi-people me-2"></i>{% trans "Участники" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:gradebook' course.pk %}"><i class="bi bi-table me-2"></i>{% trans "Журнал оценок" %}</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{% url 'lms:course_delete' course.pk %}"><i class="bi bi-trash me-2"></i>{% trans "Удалить курс" %}</a></li>
            </ul>
          </div>
          {% endif %}
        </div>
        {% if course.summary %}
        <p class="mt-2 mb-0">{{ course.summary }}</p>
        {% endif %}
      </div>
    </div>

    {% if enrolment and enrolment.role == 'STUDENT' %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body py-2">
        <div class="d-flex align-items-center gap-3">
          <span class="text-muted small">{% trans "Прогресс:" %}</span>
          <div class="progress flex-grow-1" style="height:10px">
            <div class="progress-bar bg-success" style="width:{{ progress }}%" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <span class="fw-bold small">{{ progress }}%</span>
        </div>
      </div>
    </div>
    {% endif %}

    {% if announcements %}
    <div class="mb-3">
      {% for ann in announcements %}
      <div class="alert alert-info d-flex gap-2 py-2">
        <i class="bi bi-megaphone mt-1"></i>
        <div>
          <strong>{{ ann.title }}</strong>
          <div class="small">{{ ann.body|truncatewords:30 }}</div>
          <div class="text-muted" style="font-size:.75rem">{{ ann.created_at|date:"d.m.Y H:i" }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {% if can_manage %}
    <div class="mb-2 text-end">
      <small class="text-muted">
        <i class="bi bi-arrows-move me-1"></i>{% trans "Перетащите секции для сортировки" %}
      </small>
    </div>
    {% endif %}
    <div id="sections-list">
    {% for section in sections %}
    <div class="card mb-3 shadow-sm" data-section-id="{{ section.pk }}">
      <div class="card-header d-flex justify-content-between align-items-center {% if not section.is_visible %}bg-light{% endif %}">
        <h6 class="mb-0">
          {% if not section.is_visible %}<i class="bi bi-eye-slash me-1 text-muted"></i>{% endif %}
          {{ section.name }}
        </h6>
        {% if can_manage %}
        <div class="d-flex gap-1">
          <a href="{% url 'lms:section_edit' section.pk %}" class="btn btn-sm btn-outline-secondary py-0">
            <i class="bi bi-pencil"></i>
          </a>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-primary py-0 dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-plus"></i> {% trans "Добавить" %}
            </button>
            <ul class="dropdown-menu">
              {% for mtype, mlabel in module_types %}
              <li>
                <a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type={{ mtype }}">
                  {{ mlabel }}
                </a>
              </li>
              {% endfor %}
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=PAGE"><i class="bi bi-file-text me-2"></i>{% trans "Страница" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=FILE"><i class="bi bi-file-earmark me-2"></i>{% trans "Файл" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=FOLDER"><i class="bi bi-folder me-2"></i>{% trans "Папка" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=VIDEO"><i class="bi bi-play-circle me-2"></i>{% trans "Видео" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=ASSIGNMENT"><i class="bi bi-journal-arrow-up me-2"></i>{% trans "Задание" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=QUIZ"><i class="bi bi-ui-checks me-2"></i>{% trans "Тест" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=FORUM"><i class="bi bi-chat me-2"></i>{% trans "Форум" %}</a></li>
              <li><a class="dropdown-item" href="{% url 'lms:module_create' section.pk %}?type=URL"><i class="bi bi-link me-2"></i>{% trans "Ссылка" %}</a></li>
            </ul>
          </div>
          <a href="{% url 'lms:section_delete' section.pk %}" class="btn btn-sm btn-outline-danger py-0"
             onclick="return confirm('{% trans "Удалить секцию?" %}')">
            <i class="bi bi-trash"></i>
          </a>
        </div>
        {% endif %}
      </div>
      {% if section.summary %}
      <div class="card-body py-2 text-muted small">{{ section.summary }}</div>
      {% endif %}
      <ul class="list-group list-group-flush" id="modules-{{ section.pk }}">
        {% for module in section.modules.all %}
        {% if module.is_visible or can_manage %}
        <li class="list-group-item d-flex align-items-center gap-2 py-2 {% if not module.is_visible %}text-muted{% endif %}"
            data-module-id="{{ module.pk }}">
          <i class="bi {{ module.get_icon }} fs-5"></i>
          <a href="{% url 'lms:module_detail' module.pk %}" class="flex-grow-1 text-decoration-none {% if not module.is_visible %}text-muted{% endif %}">
            {{ module.title }}
          </a>
          {% if module.pk in completed_ids %}
          <i class="bi bi-check-circle-fill text-success" title="{% trans 'Пройдено' %}"></i>
          {% elif module.completion_required %}
          <i class="bi bi-circle text-muted" title="{% trans 'Обязателен' %}"></i>
          {% endif %}
          {% if can_manage %}
          <a href="{% url 'lms:module_edit' module.pk %}" class="btn btn-sm btn-outline-secondary py-0 px-1">
            <i class="bi bi-pencil"></i>
          </a>
          <a href="{% url 'lms:module_delete' module.pk %}" class="btn btn-sm btn-outline-danger py-0 px-1"
             onclick="return confirm('{% trans "Удалить модуль?" %}')">
            <i class="bi bi-trash"></i>
          </a>
          {% endif %}
        </li>
        {% endif %}
        {% empty %}
        {% if can_manage %}
        <li class="list-group-item text-center text-muted small py-2">{% trans "Секция пуста" %}</li>
        {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% empty %}
    <div class="text-center text-muted py-5">
      <i class="bi bi-folder-x" style="font-size:3rem"></i>
      <p class="mt-2">{% trans "В курсе нет секций" %}</p>
      {% if can_manage %}
      <a href="{% url 'lms:section_create' course.pk %}" class="btn btn-primary">
        <i class="bi bi-plus me-1"></i>{% trans "Добавить секцию" %}
      </a>
      {% endif %}
    </div>
    {% endfor %}
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card mb-3 shadow-sm">
      <div class="card-header"><strong>{% trans "Информация о курсе" %}</strong></div>
      <ul class="list-group list-group-flush">
        {% if course.start_date %}
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Начало" %}</span>
          <span class="small">{{ course.start_date|date:"d.m.Y" }}</span>
        </li>
        {% endif %}
        {% if course.end_date %}
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Окончание" %}</span>
          <span class="small">{{ course.end_date|date:"d.m.Y" }}</span>
        </li>
        {% endif %}
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Участников" %}</span>
          <span class="small">{{ course.enrolments.count }}</span>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted small">{% trans "Формат" %}</span>
          <span class="small">{{ course.get_format_display }}</span>
        </li>
      </ul>
    </div>

    {% if can_manage %}
    <div class="card mb-3 shadow-sm">
      <div class="card-header"><strong>{% trans "Управление" %}</strong></div>
      <div class="card-body d-grid gap-2">
        <a href="{% url 'lms:gradebook' course.pk %}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-table me-1"></i>{% trans "Журнал оценок" %}
        </a>
        <a href="{% url 'lms:enrolment_manage' course.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-people me-1"></i>{% trans "Участники" %}
        </a>
        <a href="{% url 'lms:course_edit' course.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-gear me-1"></i>{% trans "Настройки курса" %}
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}