{% extends 'base.html' %}

{% block title %}Панель деканата{% endblock %}
{% block breadcrumb_container %}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row mb-4 animate-fade-in">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    {% if faculty %}
                        <h2 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-building me-2"></i>{{ faculty.name }}
                        </h2>
                        <p class="text-muted mb-0 mt-1">
                            <i class="bi bi-bank me-1"></i>Институт: {{ faculty.institute.name }}
                        </p>
                    {% else %}
                        <h2 class="fw-bold text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>Факультет не привязан
                        </h2>
                    {% endif %}
                </div>
                <div class="text-end">
                    <span class="text-muted d-block small">Сегодня</span>
                    <span class="fs-5 fw-bold text-primary">{% now "d E Y" %}</span>
                </div>
            </div>
        </div>
    </div>

    {% if faculty %}
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-xl-3 animate-slide-in">
            <div class="stat-card-modern card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="stat-icon-wrapper bg-primary-soft">
                            <i class="bi bi-people fs-2 text-primary"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'accounts:user_management' %}?role=STUDENT">
                                        <i class="bi bi-eye me-2"></i>Просмотр
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <h3 class="mb-1 fw-bold">{{ students_count }}</h3>
                    <p class="text-muted mb-0 small">Всего студентов</p>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-xl-3 animate-slide-in" style="animation-delay: 0.1s;">
            <div class="stat-card-modern card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="stat-icon-wrapper bg-success-soft">
                            <i class="bi bi-collection fs-2 text-success"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'accounts:group_management' %}">
                                        <i class="bi bi-eye me-2"></i>Управление
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <h3 class="mb-1 fw-bold">{{ groups_count }}</h3>
                    <p class="text-muted mb-0 small">Учебных групп</p>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-xl-3 animate-slide-in" style="animation-delay: 0.2s;">
            <div class="stat-card-modern card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="stat-icon-wrapper bg-info-soft">
                            <i class="bi bi-person-badge fs-2 text-info"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'accounts:user_management' %}?role=TEACHER">
                                        <i class="bi bi-eye me-2"></i>Список
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <h3 class="mb-1 fw-bold">{{ teachers_count }}</h3>
                    <p class="text-muted mb-0 small">Преподавателей</p>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-info" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-xl-3 animate-slide-in" style="animation-delay: 0.3s;">
            <div class="stat-card-modern card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="stat-icon-wrapper bg-warning-soft">
                            <i class="bi bi-bar-chart fs-2 text-warning"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'journal:dean_view' %}">
                                        <i class="bi bi-graph-up me-2"></i>Аналитика
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <h3 class="mb-1 fw-bold">
                        {% if course_stats %}
                            {{ course_stats.0.avg_gpa|floatformat:1 }}
                        {% else %}
                            —
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-0 small">Средний балл</p>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-warning" style="width: {% if course_stats %}{% widthratio course_stats.0.avg_gpa 1 8.33 %}%{% else %}0%{% endif %}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8 animate-slide-in" style="animation-delay: 0.4s;">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-diagram-3 me-2"></i>Структура факультета
                        </h5>
                        <a href="{% url 'accounts:manage_structure' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil me-1"></i>Управление
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 ps-4">Кафедра</th>
                                    <th class="border-0">Заведующий</th>
                                    <th class="border-0 text-center">Специальностей</th>
                                    <th class="border-0 text-end pe-4">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dept in departments %}
                                <tr>
                                    <td class="ps-4 fw-medium">
                                        <i class="bi bi-diagram-3-fill text-primary me-2"></i>
                                        {{ dept.name }}
                                    </td>
                                    <td>
                                        {% if dept.head %}
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    <i class="bi bi-person text-primary"></i>
                                                </div>
                                                <span>{{ dept.head.user.get_full_name }}</span>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-light text-muted">Свободно</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info bg-opacity-10 text-info">
                                            {{ dept.specialties.count }}
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <a href="{% url 'accounts:edit_department' dept.id %}"
                                           class="btn btn-sm btn-light">
                                            <i class="bi bi-gear"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        Кафедры еще не созданы
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4 animate-slide-in" style="animation-delay: 0.5s;">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-lightning-charge me-2 text-warning"></i>Быстрые действия
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="{% url 'schedule:manage_plans' %}" class="list-group-item list-group-item-action border-0 d-flex align-items-center py-3">
                            <div class="icon-wrapper bg-indigo-soft me-3"> <!-- Используем indigo или purple -->
                                <i class="bi bi-journal-text text-indigo"></i>
                            </div>
                            <div>
                                <div class="fw-medium">Учебные планы (РУП)</div>
                                <small class="text-muted">Создание нагрузки и дисциплин</small>
                            </div>
                        </a>

                        <a href="{% url 'schedule:constructor' %}" class="list-group-item list-group-item-action border-0 d-flex align-items-center py-3">
                            <div class="icon-wrapper bg-primary-soft me-3">
                                <i class="bi bi-calendar-week text-primary"></i>
                            </div>
                            <div>
                                <div class="fw-medium">Конструктор расписания</div>
                                <small class="text-muted">Управление расписанием групп</small>
                            </div>
                        </a>
                        <a href="{% url 'schedule:manage_classrooms' %}" class="list-group-item list-group-item-action border-0 d-flex align-items-center py-3">
                            <div class="icon-wrapper bg-success-soft me-3">
                                <i class="bi bi-door-open text-success"></i>
                            </div>
                            <div>
                                <div class="fw-medium">Управление аудиториями</div>
                                <small class="text-muted">Кабинеты и вместимость</small>
                            </div>
                        </a>
                        <a href="{% url 'journal:dean_view' %}" class="list-group-item list-group-item-action border-0 d-flex align-items-center py-3">
                            <div class="icon-wrapper bg-info-soft me-3">
                                <i class="bi bi-graph-up text-info"></i>
                            </div>
                            <div>
                                <div class="fw-medium">Аналитика</div>
                                <small class="text-muted">Успеваемость студентов</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <div class="card border-0 shadow-sm animate-slide-in" style="animation-delay: 0.6s;">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-pie-chart me-2 text-primary"></i>Успеваемость по курсам
                    </h6>
                </div>
                <div class="card-body">
                    {% if course_stats %}
                        {% for stat in course_stats %}
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">{{ stat.course }} курс</span>
                                <span class="text-muted small">{{ stat.students_count }} студ.</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">
                                    GPA: <span class="fw-bold text-dark">{{ stat.avg_gpa|floatformat:2 }}</span>
                                </small>
                                <small class="text-muted">
                                    Посещ: <span class="fw-bold text-dark">{{ stat.avg_attendance|floatformat:0 }}%</span>
                                </small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-gradient"
                                     style="width: {{ stat.avg_attendance }}%;
                                            background: linear-gradient(90deg, #10b981, #3b82f6);">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <a href="{% url 'journal:dean_view' %}" class="btn btn-primary w-100 btn-sm mt-3">
                            <i class="bi bi-arrow-right me-1"></i>Подробная аналитика
                        </a>
                    {% else %}
                        <p class="text-center text-muted py-3 mb-0">
                            <i class="bi bi-inbox d-block fs-1 mb-2"></i>
                            Нет данных
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 animate-slide-in" style="animation-delay: 0.7s;">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-activity me-2 text-primary"></i>Динамика по курсам
                    </h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="chartToggle" id="btnGpa" autocomplete="off" checked onclick="updateMainChart('gpa')">
                        <label class="btn btn-outline-primary btn-sm" for="btnGpa">Успеваемость (GPA)</label>

                        <input type="radio" class="btn-check" name="chartToggle" id="btnAtt" autocomplete="off" onclick="updateMainChart('attendance')">
                        <label class="btn btn-outline-success btn-sm" for="btnAtt">Посещаемость (%)</label>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 350px; width: 100%;">
                        <canvas id="dashboardMainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const coursesLabels = {{ json_courses|safe }};
        const dataGPA = {{ json_gpa|safe }};
        const dataAttendance = {{ json_attendance|safe }};

        const ctxDash = document.getElementById('dashboardMainChart').getContext('2d');

        let gradientGPA = ctxDash.createLinearGradient(0, 0, 0, 400);
        gradientGPA.addColorStop(0, 'rgba(37, 99, 235, 0.7)');
        gradientGPA.addColorStop(1, 'rgba(37, 99, 235, 0.1)');

        let gradientAtt = ctxDash.createLinearGradient(0, 0, 0, 400);
        gradientAtt.addColorStop(0, 'rgba(16, 185, 129, 0.7)');
        gradientAtt.addColorStop(1, 'rgba(16, 185, 129, 0.1)');

        let dashboardChart = new Chart(ctxDash, {
            type: 'bar',
            data: {
                labels: coursesLabels,
                datasets: [{
                    label: 'Средний балл (GPA)',
                    data: dataGPA,
                    backgroundColor: gradientGPA,
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    borderRadius: 8,
                    barPercentage: 0.5,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: { size: 14 },
                        bodyFont: { size: 14 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [5, 5], color: '#e2e8f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        function updateMainChart(type) {
            if (type === 'gpa') {
                dashboardChart.data.datasets[0].label = 'Средний балл (GPA)';
                dashboardChart.data.datasets[0].data = dataGPA;
                dashboardChart.data.datasets[0].backgroundColor = gradientGPA;
                dashboardChart.data.datasets[0].borderColor = '#2563eb';
                dashboardChart.data.datasets[0].type = 'bar';
                dashboardChart.options.scales.y.max = 5;
            } else {
                dashboardChart.data.datasets[0].label = 'Посещаемость (%)';
                dashboardChart.data.datasets[0].data = dataAttendance;
                dashboardChart.data.datasets[0].backgroundColor = gradientAtt;
                dashboardChart.data.datasets[0].borderColor = '#10b981';
                dashboardChart.data.datasets[0].type = 'line';
                dashboardChart.data.datasets[0].tension = 0.4;
                dashboardChart.data.datasets[0].pointRadius = 6;
                dashboardChart.data.datasets[0].pointBackgroundColor = '#fff';
                dashboardChart.data.datasets[0].pointBorderWidth = 2;
                dashboardChart.options.scales.y.max = 100;
            }
            dashboardChart.update();
        }
    </script>
    {% endif %}
{% endblock %}

<style>
    .stat-card-modern {
        transition: all 0.3s ease;
        border-left: 4px solid transparent !important;
    }

    .stat-card-modern:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
        border-left-color: var(--primary-blue) !important;
    }

    .bg-indigo-soft { background-color: rgba(102, 16, 242, 0.1); }
    .text-indigo { color: #6610f2; }

    .stat-icon-wrapper {
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
    }

    .bg-primary-soft { background-color: rgba(37, 99, 235, 0.1); }
    .bg-success-soft { background-color: rgba(16, 185, 129, 0.1); }
    .bg-info-soft { background-color: rgba(59, 130, 246, 0.1); }
    .bg-warning-soft { background-color: rgba(245, 158, 11, 0.1); }

    .icon-wrapper {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
    }

    .avatar-sm {
        width: 32px;
        height: 32px;
    }

    .list-group-item:hover {
        background-color: #f8fafc;
    }
</style>
