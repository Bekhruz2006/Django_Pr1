{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}

{% block title %}Расписание{% endblock %}
{% block breadcrumbs %}
    <li class="breadcrumb-item active">Расписание занятий</li>
{% endblock %}
{% block content %}
<div class="row mt-4">
    {% if groups %}
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> Выбор группы
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Группа</label>
                            <select class="form-select" name="group" onchange="this.form.submit()">
                                <option value="">Выбрать...</option>
                                {% for g in groups %}
                                    <option value="{{ g.id }}" {% if group and group.id == g.id %}selected{% endif %}>
                                        {{ g.name }} - {{ g.specialty|truncatewords:8 }} ({{ g.students.count }} чел.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Загрузить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if group %}
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-calendar-week"></i> ҶАДВАЛИ ДАРСӢ - {{ group.name }}
                </span>
                <div>
                    <a href="{% url 'schedule:export' %}?group={{ group.id }}"
                       class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Экспорт DOCX
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px; vertical-align: middle; text-align: center;">
                                    <strong>ҲАФТА<br>СОАТ</strong>
                                </th>
                                <th style="width: 45%;">Дарс / Устод</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <tr class="table-secondary">
                                    <td colspan="2" class="text-center">
                                        <strong>{{ day_name }}</strong>
                                    </td>
                                </tr>

                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center align-middle time-cell">
                                            <strong style="font-size: 0.9rem;">
                                                {{ time_slot.start_time|time:"H" }}<sup>{{ time_slot.start_time|time:"i" }}</sup>-{{ time_slot.end_time|time:"H" }}<sup>{{ time_slot.end_time|time:"i" }}</sup>
                                            </strong>
                                        </td>

                                        {% with slot_list=schedule_data|get_slot:group.id|get_slot:day_num|get_slot:time_slot.id %}
                                        <td class="p-1">
                                            {% if slot_list %}
                                                <div class="d-flex flex-column gap-2">
                                                {% for slot in slot_list %}
                                                    <div class="p-2 rounded {% if slot.week_type == 'RED' %}bg-danger bg-opacity-10 border-start border-danger border-3{% elif slot.week_type == 'BLUE' %}bg-primary bg-opacity-10 border-start border-primary border-3{% else %}bg-light border-start border-secondary border-3{% endif %}">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <strong style="font-size: 0.95rem;" class="text-dark">{{ slot.subject.name }}</strong>
                                                            <div>
                                                                <span class="badge bg-{{ slot.get_color_class }}">{{ slot.get_lesson_type_display }}</span>
                                                                {% if slot.week_type == 'RED' %}<span class="badge bg-danger">Красная</span>{% endif %}
                                                                {% if slot.week_type == 'BLUE' %}<span class="badge bg-primary">Синяя</span>{% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="d-flex justify-content-between align-items-end mt-2">
                                                            <small class="text-muted"><i class="bi bi-person"></i> {{ slot.teacher.user.get_full_name|default:'—' }}</small>
                                                            <span class="badge bg-white text-dark border"><i class="bi bi-door-open"></i> Каб. {{ slot.room|default:'—' }}</span>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                </div>
                                            {% else %}
                                                <div class="text-center text-muted opacity-25 mt-3"><i class="bi bi-dash-lg"></i></div>
                                            {% endif %}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h6>Обозначения:</h6>
                <span class="badge bg-primary me-2">Лекция</span>
                <span class="badge bg-success me-2">Практика</span>
                <span class="badge bg-warning me-2">СРСП (КМРО)</span>
            </div>
        </div>
    </div>
    {% elif active_semester %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i>
                {% if user.role == 'STUDENT' %}
                    Расписание для вашей группы пока не составлено. Обратитесь к декану.
                {% else %}
                    Выберите группу для просмотра расписания.
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<style>
.schedule-table {
    font-size: 0.85rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
}

.schedule-table tbody tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
