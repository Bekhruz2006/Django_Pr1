{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}
{% load i18n %}
{% block title %}–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-3 shadow-sm border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-week"></i> {% trans "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è" %}</span>
            </div>
            <div class="card-body bg-light">
                <form method="get" id="groupSelectionForm" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">{% trans "–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É" %}</label>
                        <div class="btn-group w-100 mb-2 btn-group-sm" role="group">
                            <input type="radio" class="btn-check course-filter" name="c_filter" id="c_all" value="all" checked>
                            <label class="btn btn-outline-secondary" for="c_all">{% trans "–í—Å–µ" %}</label>

                            <input type="radio" class="btn-check course-filter" name="c_filter" id="c_1" value="1">
                            <label class="btn btn-outline-secondary" for="c_1">1 {% trans "–∫—É—Ä—Å" %}</label>

                            <input type="radio" class="btn-check course-filter" name="c_filter" id="c_2" value="2">
                            <label class="btn btn-outline-secondary" for="c_2">2 {% trans "–∫—É—Ä—Å" %}</label>

                            <input type="radio" class="btn-check course-filter" name="c_filter" id="c_3" value="3">
                            <label class="btn btn-outline-secondary" for="c_3">3 {% trans "–∫—É—Ä—Å" %}</label>

                            <input type="radio" class="btn-check course-filter" name="c_filter" id="c_4" value="4">
                            <label class="btn btn-outline-secondary" for="c_4">4 {% trans "–∫—É—Ä—Å" %}</label>
                        </div>

                        <select class="form-select border-primary form-select-lg" name="group" id="groupSelect" required>
                            <option value="" data-course="all">-- {% trans "–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞" %} --</option>
                            {% for g in groups %}
                                <option value="{{ g.id }}" data-course="{{ g.course }}" {% if group and group.id == g.id %}selected{% endif %}>
                                    {{ g.name }} ({{ g.course }} –∫—É—Ä—Å)
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">{% trans "–°–µ–º–µ—Å—Ç—Ä" %}</label>
                        <select class="form-select border-primary" name="semester">
                            {% for sem in all_semesters %}
                                <option value="{{ sem.id }}" {% if semester and semester.id == sem.id %}selected{% endif %}>
                                    {% if sem.is_active %}‚úÖ{% endif %}
                                    {{ sem.name }} ({{ sem.academic_year }}) ‚Äî {{ sem.get_shift_display }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-muted small">
                            {% trans "–ê–∫—Ç–∏–≤–Ω—ã–π —Å–µ–º–µ—Å—Ç—Ä –≤—ã–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" %}
                        </div>
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 fw-bold py-2">
                            <i class="bi bi-arrow-right-circle"></i> {% trans "–û—Ç–∫—Ä—ã—Ç—å" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if group %}
    <div class="col-lg-3">
        {% if group.has_military_training %}
        <div class="card mb-3 border-dark shadow-sm">
            <div class="card-body p-2 text-center bg-dark text-white rounded">
                <div draggable="true" id="militaryDragItem" style="cursor: move;">
                    <i class="bi bi-shield-shaded mb-1"></i> –í–û–ï–ù–ù–ê–Ø –ö–ê–§–ï–î–†–ê
                    <br><small style="font-size: 0.9rem;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å</small>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card shadow-sm sticky-top" style="top: 20px; max-height: 85vh;">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0 fw-bold text-muted text-uppercase small">–ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —á–∞—Å—ã</h6>
            </div>
            <div class="card-body p-0 overflow-auto">
                <div class="list-group list-group-flush">
                    {% for item in subjects_to_schedule %}
                    <div class="list-group-item subject-item p-3 border-bottom"
                        draggable="true"
                        data-subject-id="{{ item.obj.id }}"
                        data-subject-name="{{ item.obj.name }}"
                        data-subject-type="{{ item.type }}"
                        data-teacher-name="{{ item.obj.teacher.user.get_full_name|default:'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' }}"
                        data-remaining="{{ item.remaining }}"
                        data-subject-is-stream="{{ item.obj.is_stream_subject|yesno:'true,false' }}"
                        style="cursor: move;">

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold text-dark">{{ item.obj.name }}</span>
                            <span class="badge bg-{{ item.color }}">{{ item.label }}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-end">
                            <small class="text-muted">
                                <i class="bi bi-person"></i> {{ item.obj.teacher.user.get_full_name|default:'-' }}
                            </small>
                            <span class="fw-bold text-{{ item.color }}">
                                {{ item.remaining }} —á.
                            </span>
                        </div>

                        {% if item.obj.is_stream_subject %}
                        <div class="mt-1">
                            <span class="badge bg-indigo w-100" style="font-size: 0.65rem;">
                                <i class="bi bi-diagram-3"></i> –ü–û–¢–û–ö ({{ item.obj.groups.count }} –≥—Ä—É–ø–ø)
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-check-circle fs-1 text-success opacity-50"></i>
                        <p class="mt-2 small mb-0">–í—Å–µ —á–∞—Å—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="card shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="bi bi-calendar-week"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: {{ group.name }}</h5>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center gap-2 bg-light p-1 rounded border">
                        <span class="small text-muted fw-bold ms-2">–í–∏–¥:</span>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="view_week" id="vw_all" value="ALL" checked>
                            <label class="btn btn-outline-secondary" for="vw_all">–í—Å–µ</label>
                            
                            <input type="radio" class="btn-check" name="view_week" id="vw_red" value="RED">
                            <label class="btn btn-outline-danger" for="vw_red">üî¥ –ö—Ä–∞—Å–Ω</label>
                            
                            <input type="radio" class="btn-check" name="view_week" id="vw_blue" value="BLUE">
                            <label class="btn btn-outline-primary" for="vw_blue">üîµ –°–∏–Ω</label>
                        </div>
                    </div>

                    <a href="{% url 'schedule:export' %}?group={{ group.id }}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-file-word"></i> –°–∫–∞—á–∞—Ç—å DOCX
                    </a>
                </div>


            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 100px;" class="text-center align-middle">–í—Ä–µ–º—è</th>
                                <th>–ü—Ä–µ–¥–º–µ—Ç / –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å / –ö–∞–±–∏–Ω–µ—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                            <tr class="table-secondary border-bottom-0">
                                <td colspan="3" class="fw-bold ps-3 text-uppercase text-secondary" style="letter-spacing: 1px;">
                                    {{ day_name }}
                                </td>
                            </tr>

                            {% for time_slot in time_slots %}
                            <tr>
                                <td class="text-center align-middle time-cell text-muted">
                                    {{ time_slot.start_time|time:"H:i" }}<br>
                                    <span style="font-size: 0.8em;">{{ time_slot.end_time|time:"H:i" }}</span>
                                </td>

                                {% with slot_list=schedule_data|get_slot:day_num|get_slot:time_slot.id %}
                                <td class="schedule-drop-zone p-1 align-middle"
                                    data-group-id="{{ group.id }}"
                                    data-day="{{ day_num }}"
                                    data-time-slot="{{ time_slot.id }}">
                                    
                                    {% if slot_list %}
                                        <div class="d-flex flex-column gap-1 h-100">
                                            {% for slot in slot_list %}
                                            {% if not forloop.first %}<hr class="my-1 border-dashed opacity-50">{% endif %}
                                            <div class="lesson-card p-2 rounded shadow-sm position-relative d-flex flex-column
                                                {% if slot.week_type == 'RED' %}border-start border-4 border-danger
                                                {% elif slot.week_type == 'BLUE' %}border-start border-4 border-primary
                                                {% else %}border-start border-4 border-{{ slot.get_color_class }}{% endif %}" 
                                                style="background-color: {% if slot.week_type == 'RED' %}#fff5f5{% elif slot.week_type == 'BLUE' %}#f0f7ff{% else %}#fff{% endif %}; min-width: 0;"
                                                data-week-type="{{ slot.week_type }}">
                                                
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <div class="fw-bold text-dark lh-sm pe-2" style="font-size: 0.9rem;">
                                                        {{ slot.subject.name }}
                                                    </div>
                                                    <button class="btn btn-link text-danger p-0 delete-slot flex-shrink-0" data-slot-id="{{ slot.id }}" title="–£–¥–∞–ª–∏—Ç—å">
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    </button>
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <span class="badge bg-{{ slot.get_color_class }}">
                                                        {{ slot.get_lesson_type_display }}
                                                        {% if slot.stream_id %}<i class="bi bi-diagram-3-fill ms-1" title="–ü–æ—Ç–æ–∫"></i>{% endif %}
                                                    </span>
                                                    {% if slot.week_type == 'RED' %}<span class="badge bg-danger ms-1">üî¥ –ö—Ä–∞—Å–Ω–∞—è</span>{% endif %}
                                                    {% if slot.week_type == 'BLUE' %}<span class="badge bg-primary ms-1">üîµ –°–∏–Ω—è—è</span>{% endif %}
                                                    {% if slot.week_type == 'EVERY' %}<span class="badge bg-secondary ms-1" style="opacity:0.6;">–û–±–µ –Ω–µ–¥.</span>{% endif %}
                                                </div>
                                                
                                                <div class="d-flex justify-content-between align-items-end mt-auto pt-2 border-top" style="border-color: rgba(0,0,0,0.06) !important;">
                                                    
                                                    <div class="small text-muted text-truncate pe-2" style="max-width: 60%;" title="{{ slot.teacher.user.get_full_name|default:'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' }}">
                                                        <i class="bi bi-person-fill text-secondary"></i> 
                                                        {% if slot.teacher %}
                                                            {{ slot.teacher.user.last_name }} {{ slot.teacher.user.first_name|slice:":1" }}.
                                                        {% else %}
                                                            –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="aud-cell d-flex align-items-center justify-content-end" style="max-width: 40%;">
                                                        <div class="aud-display badge bg-white text-dark border shadow-sm" 
                                                            style="cursor: pointer; font-size: 0.8rem; padding: 0.35em 0.6em;" 
                                                            onclick="editAud(this)" title="–ò–∑–º–µ–Ω–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç">
                                                            <i class="bi bi-door-open text-primary"></i> {{ slot.room|default:'–í—ã–±—Ä–∞—Ç—å' }}
                                                        </div>
                                                        
                                                        <select class="form-select form-select-sm aud-input p-0 text-center shadow-sm" 
                                                                style="display: none; min-width: 90px; font-size: 0.8rem;" 
                                                                onchange="saveAud(this, {{ slot.id }})">
                                                            <option value="">-- –í—ã–±—Ä–∞—Ç—å --</option>
                                                            {% regroup classrooms by building as building_list %}
                                                            {% for bg in building_list %}
                                                                <optgroup label="{{ bg.grouper.name }}">
                                                                    {% for c in bg.list %}
                                                                        {% is_room_busy_tag occupied_rooms day_num time_slot.id c.id slot.id slot.stream_id slot.week_type as room_busy %}
                                                                        {% if not room_busy %}
                                                                            <option value="{{ c.id }}" {% if slot.classroom_id == c.id %}selected{% endif %}>
                                                                                {{ c.number }} (–í–º: {{ c.capacity }}, {{ c.get_room_type_display|truncatechars:12 }})
                                                                            </option>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </optgroup>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="empty-slot d-flex align-items-center justify-content-center text-muted h-100" style="min-height: 60px; border: 2px dashed #eee; border-radius: 4px;">
                                            <small class="opacity-50">–°–≤–æ–±–æ–¥–Ω–æ</small>
                                        </div>
                                    {% endif %}
                                </td>
                                {% endwith %}
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 mt-5">
        <div class="text-center py-5">
            <i class="bi bi-arrow-up-circle text-primary" style="font-size: 3rem;"></i>
            <h4 class="mt-3">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ —Å–µ–º–µ—Å—Ç—Ä</h4>
            <p class="text-muted">–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –≤—ã—à–µ.</p>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> –í–Ω–∏–º–∞–Ω–∏–µ: –ö–æ–Ω—Ñ–ª–∏–∫—Ç</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="conflictMessage"></p>
                <div class="alert alert-warning">
                    –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ –∫–∞–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="forceSaveBtn">–í—Å–µ —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let draggedData = null;
    let lastAttemptData = null;

    function safeJson(response) {
        return response.text().then(text => {
            try { return JSON.parse(text); } catch(e) { return { success: false, error: 'Invalid JSON response' }; }
        });
    }

    function createSlot(group, day, timeSlot, subject, type, semesterId, weekType, isForce = false) {
        fetch('{% url "schedule:create_slot" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
            body: JSON.stringify({
                group: group, day_of_week: day, time_slot: timeSlot, subject: subject,
                lesson_type: type, semester_id: semesterId, force: isForce,
                week_type: weekType 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                if (data.is_conflict) {
                    document.getElementById('conflictMessage').innerHTML = `
                        <div class="text-danger fw-bold mb-2">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:</div>
                        ${data.error}
                    `;
                    lastAttemptData = {
                        groupId: group,
                        subjectId: subject,
                        dayOfWeek: day,
                        timeSlot: timeSlot,
                        lessonType: type,
                        semesterId: semesterId,
                        weekType: weekType     
                    };
                    const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
                    modal.show();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            }
        })
        .catch(err => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err));
    }

    const forceBtn = document.getElementById('forceSaveBtn');
    if (forceBtn) {
        forceBtn.addEventListener('click', function() {
            if (lastAttemptData) {
                createSlot(
                    lastAttemptData.groupId,
                    lastAttemptData.dayOfWeek,
                    lastAttemptData.timeSlot,
                    lastAttemptData.subjectId,
                    lastAttemptData.lessonType,
                    lastAttemptData.semesterId,
                    lastAttemptData.weekType,  
                    true                        
                );
                const modalEl = document.getElementById('conflictModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
            }
        });
    }

    function attachDragHandlers(el) {
        if (!el) return;
        if (el._hasDragHandler) return;
        el._hasDragHandler = true;

        el.addEventListener('dragstart', function(e) {
            const isStream = this.dataset.subjectIsStream === 'true';
            draggedData = {
                subjectId: this.dataset.subjectId,
                subjectName: this.dataset.subjectName,
                subjectType: this.dataset.subjectType,
                teacherName: this.dataset.teacherName || '',
                isStream: isStream,
                remaining: parseInt(this.dataset.remaining || '0')
            };

            try {
                const img = document.createElement('canvas');
                img.width = img.height = 1;
                e.dataTransfer.setDragImage(img, 0, 0);
            } catch (err) {}

            try { e.dataTransfer.setData('text/plain', JSON.stringify(draggedData)); } catch(e) {}
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.4';
        });

        el.addEventListener('dragend', function() {
            try { this.style.opacity = '1'; } catch(e){}
            draggedData = null;
            stopAutoScroll();
        });
    }

    const milItem = document.getElementById('militaryDragItem');
    if(milItem) {
        milItem.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                isMilitary: true
            }));
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.5';
        });
        milItem.addEventListener('dragend', function() {
            this.style.opacity = '1';
        });
    }

    document.querySelectorAll('.subject-item').forEach(attachDragHandlers);

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.delete-slot');
        if (!btn) return;
        e.stopPropagation();
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ? –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Ç–æ–∫, —É–¥–∞–ª–∏—Ç—Å—è —É –≤—Å–µ—Ö –≥—Ä—É–ø–ø.')) return;
        const slotId = btn.dataset.slotId;
        if (!slotId) return;
        fetch('/schedule/constructor/delete/' + slotId + '/', {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
        })
        .then(r => safeJson(r))
        .then(data => {
            if (data.success) {
                location.reload();
            } else alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        })
        .catch(err => { alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + (err.message || err)); });
    });
    window.isConfirmingRoom = false;

    window.editAud = function(el) {
        if (!el) return;
        const cell = el.closest('.aud-cell');
        const input = cell.querySelector('.aud-input');

        el.style.display = 'none';
        input.style.display = 'block';
        input.focus();
        
        input.onblur = function() {
            if (!window.isConfirmingRoom) {
                input.style.display = 'none';
                el.style.display = 'inline-block';
            }
        };
    };

window.saveAud = function(input, slotId, isForce = false) {
    const val = input.value; 
    const cell = input.closest('.aud-cell');
    const display = cell.querySelector('.aud-display');

    window.isConfirmingRoom = true;

    fetch(`/schedule/constructor/update-room/${slotId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ room_id: val, force: isForce })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            input.style.display = 'none';
            if (display) {
                display.innerText = data.room || '?';
                display.style.display = 'inline-block';
                display.classList.add('bg-success', 'text-white');
                setTimeout(() => display.classList.remove('bg-success', 'text-white'), 1000);
            }
        } else {
            if (data.is_capacity_warning || data.is_conflict || data.is_type_warning) {
                if (confirm(data.error + "\n\n–ù–∞–∂–º–∏—Ç–µ –û–ö, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.")) {
                    saveAud(input, slotId, true);
                } else {
                    input.value = ""; 
                    input.style.display = 'none';
                    if (display) display.style.display = 'inline-block';
                }
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
                input.focus();
            }
        }
    })
    .catch(err => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        console.error(err);
    })
    .finally(() => {
        window.isConfirmingRoom = false; 
    });
};



    let autoScrollState = {
        active: false,
        direction: 0,
        container: null,
        rafId: null
    };

    function autoScrollStep() {
        try {
            if (!autoScrollState.active) return;
            const dir = autoScrollState.direction;
            const container = autoScrollState.container;
            const step = Math.max(8, Math.min(40, Math.round((container ? container.clientHeight : window.innerHeight) * 0.02)));
            if (container) container.scrollTop += dir * step;
            else window.scrollBy(0, dir * step);
        } finally {
            autoScrollState.rafId = requestAnimationFrame(autoScrollStep);
        }
    }

    function startAutoScroll(direction, container = null) {
        if (autoScrollState.active && autoScrollState.direction === direction && autoScrollState.container === container) return;
        stopAutoScroll();
        autoScrollState.active = true;
        autoScrollState.direction = direction;
        autoScrollState.container = container;
        autoScrollState.rafId = requestAnimationFrame(autoScrollStep);
    }

    function stopAutoScroll() {
        autoScrollState.active = false;
        autoScrollState.direction = 0;
        autoScrollState.container = null;
        if (autoScrollState.rafId) {
            cancelAnimationFrame(autoScrollState.rafId);
            autoScrollState.rafId = null;
        }
    }

    document.addEventListener('dragover', function(e) {
        try {
            e.preventDefault();
            const margin = 120;
            const y = e.clientY;
            const h = window.innerHeight;
            if (y < margin) startAutoScroll(-1, null);
            else if (y > h - margin) startAutoScroll(1, null);
            else stopAutoScroll();
        } catch (ex) { console.error(ex); }
    });

    document.addEventListener('drop', function(e) { stopAutoScroll(); });
    document.addEventListener('dragend', function(e) { stopAutoScroll(); });

    const containerSelectors = ['.card-body.p-0', '.table-responsive'];
    const scrollContainers = [];
    containerSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(c => scrollContainers.push(c));
    });

    scrollContainers.forEach(container => {
        container.addEventListener('dragover', function(e) {
            try {
                e.preventDefault();
                const rect = this.getBoundingClientRect();
                const localY = e.clientY - rect.top;
                const margin = Math.min(80, rect.height * 0.18);
                if (localY < margin) startAutoScroll(-1, this);
                else if (localY > rect.height - margin) startAutoScroll(1, this);
                else stopAutoScroll();
            } catch (ex) { console.error(ex); }
        });
        container.addEventListener('dragleave', function(e) { stopAutoScroll(); });
        container.addEventListener('drop', function(e) { stopAutoScroll(); });
    });

    function handleDropZone(cell) {
        if (cell._hasDropHandler) return;
        cell._hasDropHandler = true;

        cell.addEventListener('dragover', function(e) {
            try { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; this.classList.add('drag-over'); } catch(e){}
        });

        cell.addEventListener('dragleave', function(e) {
            try {
                if (!this.contains(e.relatedTarget)) this.classList.remove('drag-over');
            } catch(e) { this.classList.remove('drag-over'); }
        });

        cell.addEventListener('drop', function(e) {
            try {
                e.preventDefault();
                this.classList.remove('drag-over');
                stopAutoScroll();

                try {
                    const txt = e.dataTransfer.getData('text/plain');
                    if (txt) draggedData = JSON.parse(txt);
                } catch (ex) { /* ignore */ }

                if (!draggedData) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π –ø—Ä–µ–¥–º–µ—Ç.');

                if (draggedData.isMilitary) {
                    if(!confirm('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–æ–µ–Ω–Ω—É—é –∫–∞—Ñ–µ–¥—Ä—É –Ω–∞ –í–ï–°–¨ —ç—Ç–æ—Ç –¥–µ–Ω—å? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä—ã –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;

                    const groupId = this.dataset.groupId;
                    const day = this.dataset.day;
                    const semesterId = document.querySelector('select[name="semester"]').value;

                    fetch('{% url "schedule:create_slot" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                        body: JSON.stringify({
                            is_military_day: true,
                            group: groupId,
                            day_of_week: day,
                            semester_id: semesterId
                        })
                    }).then(r => r.json()).then(resp => {
                        if(resp.success) location.reload();
                        else alert(resp.error);
                    });
                    return;
                }

                if (parseInt(draggedData.remaining || 0) <= 0) {
                    return alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —á–∞—Å–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞!');
                }

                const groupId = this.dataset.groupId;
                const day = this.dataset.day;
                const timeSlot = this.dataset.timeSlot;
                const semesterSelect = document.querySelector('select[name="semester"]');
                const semesterId = semesterSelect ? semesterSelect.value : null;

                const weekTypeRadio = document.querySelector('input[name="drag_week_type"]:checked');
                const weekType = weekTypeRadio ? weekTypeRadio.value : 'EVERY';

                lastAttemptData = {
                    groupId: groupId,
                    subjectId: draggedData.subjectId,
                    dayOfWeek: day,
                    timeSlot: timeSlot,
                    lessonType: draggedData.subjectType,
                    semesterId: semesterId,
                    weekType: weekType
                };

                createSlot(groupId, day, timeSlot, draggedData.subjectId, draggedData.subjectType, semesterId, weekType);

            } catch (ex) { console.error(ex); }
            finally {
                draggedData = null;
            }
        });
    }

    document.querySelectorAll('.schedule-drop-zone').forEach(handleDropZone);

    try {
        const mo = new MutationObserver(muts => {
            for (const m of muts) {
                if (m.addedNodes && m.addedNodes.length) {
                    m.addedNodes.forEach(n => {
                        if (!(n instanceof HTMLElement)) return;
                        if (n.matches && n.matches('.subject-item')) attachDragHandlers(n);
                        n.querySelectorAll && n.querySelectorAll('.subject-item').forEach(attachDragHandlers);
                        if (n.matches && n.matches('.schedule-drop-zone')) handleDropZone(n);
                        n.querySelectorAll && n.querySelectorAll('.schedule-drop-zone').forEach(handleDropZone);
                    });
                }
            }
        });
        mo.observe(document.body, { childList: true, subtree: true });
    } catch (e) { }
});

document.addEventListener('DOMContentLoaded', function() {
    const filters = document.querySelectorAll('.course-filter');
    const select = document.getElementById('groupSelect');
    if (!select) return;
    const allOptions = Array.from(select.querySelectorAll('option'));
    document.querySelectorAll('input[name="view_week"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const val = this.value;
            document.querySelectorAll('.lesson-card').forEach(card => {
                if (val === 'ALL') {
                    card.style.display = 'block';
                } else {
                    const wt = card.dataset.weekType;
                    if (wt === 'EVERY' || wt === val) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        });
    });
    filters.forEach(radio => {
        radio.addEventListener('change', function() {
            const course = this.value;
            
            select.innerHTML = '';
            
            allOptions.forEach(opt => {
                const optCourse = opt.getAttribute('data-course');
                if (opt.value === "" || course === 'all' || optCourse === course) {
                    select.appendChild(opt.cloneNode(true));
                }
            });
            select.value = ""; 
        });
    });
});
</script>


<style>
.schedule-table {
    font-size: 0.85rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
    vertical-align: middle !important;
}

.schedule-drop-zone {
    min-height: 60px !important;
    background-color: #fff;
    border: 2px dashed transparent;
    transition: all 0.2s;
    position: relative;
    cursor: crosshair;
}

.schedule-drop-zone .empty-slot {
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    font-size: 0.75rem;
}

.schedule-drop-zone:hover {
    background-color: #f8f9fa;
    border-color: #ccc;
}

.schedule-drop-zone.drag-over {
    background-color: #d1e7dd !important;
    border-color: #198754 !important;
    border-style: solid !important;
}

.lesson-card {
    position: relative;
    min-height: 50px;
}

.subject-item {
    cursor: move;
    transition: all 0.2s;
    user-select: none;
}

.subject-item:hover {
    background-color: #f0f0f0;
    transform: translateX(3px);
}

.subject-item:active {
    opacity: 0.5;
}

.aud-cell {
    vertical-align: middle !important;
}

.border-dashed {
    border-style: dashed !important;
}

.aud-display:hover {
    background-color: #e9ecef;
    cursor: pointer;
}
</style>
{% endblock %}