{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}

{% block title %}Конструктор расписания (Потоки){% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> Выбор группы и семестра
            </div>
            <div class="card-body">
                <form method="get" id="groupSelectionForm">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label">Группа</label>
                            <select class="form-select" name="group" required>
                                <option value="">Выберите группу...</option>
                                {% for g in groups %}
                                    <option value="{{ g.id }}" {% if group and group.id == g.id %}selected{% endif %}>
                                        {{ g.name }} - {{ g.specialty|truncatewords:5 }} ({{ g.students.count }} чел.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Семестр</label>
                            <select class="form-select" name="semester">
                                {% for sem in semesters %}
                                    <option value="{{ sem.id }}" {% if semester and semester.id == sem.id %}selected{% endif %}>
                                        {{ sem.name }} ({{ sem.get_shift_display }}) {% if sem.is_active %}[Активен]{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Загрузить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if group %}
    <div class="col-lg-3">
            {% if group.has_military_training %}
            <div class="card mb-3 border-dark shadow-sm">
                <div class="card-body p-2 text-center bg-dark text-white rounded">
                    <div draggable="true" id="militaryDragItem" style="cursor: move;">
                        <i class="bi bi-shield-shaded mb-1"></i> ВОЕННАЯ КАФЕДРА
                        <br><small style="font-size: 0.7rem;">Перетащите на день</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card shadow-sm sticky-top" style="top: 20px; max-height: 85vh;">
                <div class="card-header bg-white py-2">
                    <h6 class="mb-0 fw-bold text-muted text-uppercase small">Нераспределенные часы</h6>
                </div>
                <div class="card-body p-0 overflow-auto">
                    <div class="list-group list-group-flush">
                        {% for item in subjects_to_schedule %}
                            <div class="list-group-item subject-item p-3 border-bottom"
                                draggable="true"
                                data-subject-id="{{ item.obj.id }}"
                                data-subject-name="{{ item.obj.name }}"
                                data-subject-type="{{ item.type }}"
                                data-teacher-name="{{ item.obj.teacher.user.get_full_name|default:'Не назначен' }}"
                                data-remaining="{{ item.remaining }}"
                                data-subject-is-stream="{{ item.obj.is_stream_subject|yesno:'true,false' }}"
                                style="cursor: move;">
                                
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold text-dark">{{ item.obj.name }}</span>
                                    <span class="badge bg-{{ item.color }}">{{ item.label }}</span>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-end">
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> {{ item.obj.teacher.user.get_full_name|default:'-' }}
                                    </small>
                                    <span class="fw-bold text-{{ item.color }}">
                                        {{ item.remaining }} ч.
                                    </span>
                                </div>
                                
                                {% if item.obj.is_stream_subject %}
                                    <div class="mt-1">
                                        <span class="badge bg-indigo w-100" style="font-size: 0.65rem;">
                                            <i class="bi bi-diagram-3"></i> ПОТОК ({{ item.obj.groups.count }} групп)
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-check-circle fs-1 text-success opacity-50"></i>
                                <p class="mt-2 small mb-0">Все часы распределены!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>


    <div class="col-lg-9">
        <div class="card shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 text-primary"><i class="bi bi-calendar-week"></i> Расписание: {{ group.name }}</h5>
                <a href="{% url 'schedule:export' %}?group={{ group.id }}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-file-word"></i> Скачать DOCX
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 100px;" class="text-center align-middle">Время</th>
                                <th>Предмет / Преподаватель</th>
                                <th style="width: 80px;" class="text-center align-middle">Каб.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <tr class="table-secondary border-bottom-0">
                                    <td colspan="3" class="fw-bold ps-3 text-uppercase text-secondary" style="letter-spacing: 1px;">
                                        {{ day_name }}
                                    </td>
                                </tr>

                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center align-middle time-cell text-muted">
                                            {{ time_slot.start_time|time:"H:i" }}<br>
                                            <span style="font-size: 0.8em;">{{ time_slot.end_time|time:"H:i" }}</span>
                                        </td>

                                        {% with slot=schedule_data|get_slot:group.id|get_slot:day_num|get_slot:time_slot.id %}
                                        <td class="schedule-drop-zone p-1 align-middle"
                                            data-group-id="{{ group.id }}"
                                            data-day="{{ day_num }}"
                                            data-time-slot="{{ time_slot.id }}">
                                            {% if slot %}
                                            <div class="lesson-card p-2 rounded shadow-sm h-100 position-relative border-start border-4 border-{{ slot.get_color_class }}" style="background-color: #fff;">
                                                <div class="d-flex justify-content-between">
                                                    <span class="badge bg-{{ slot.get_color_class }} mb-1">
                                                        {{ slot.get_lesson_type_display }}
                                                        {% if slot.stream_id %}<i class="bi bi-diagram-3-fill ms-1" title="Поток"></i>{% endif %}
                                                    </span>
                                                    <button class="btn btn-link text-danger p-0 delete-slot"
                                                            data-slot-id="{{ slot.id }}"
                                                            title="Удалить"
                                                            style="line-height: 1;">
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    </button>
                                                </div>
                                                <div class="fw-bold text-dark">{{ slot.subject.name }}</div>
                                                <div class="small text-muted">{{ slot.teacher.user.get_full_name|default:'Преподаватель не назначен' }}</div>
                                            </div>
                                            {% else %}
                                            <div class="empty-slot d-flex align-items-center justify-content-center text-muted h-100" style="min-height: 60px; border: 2px dashed #eee; border-radius: 4px;">
                                                <small class="opacity-50">Свободно</small>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle text-center bg-light aud-cell">
                                            {% if slot %}
                                            <div class="aud-display badge bg-secondary text-wrap"
                                                 style="cursor: pointer; min-width: 40px;"
                                                 onclick="editAud(this)"
                                                 title="Нажмите, чтобы изменить">
                                                {{ slot.room|default:'?' }}
                                            </div>
                                            <input type="text" class="form-control form-control-sm aud-input text-center p-0"
                                                   value="{{ slot.room|default:'' }}"
                                                   style="display: none;"
                                                   onblur="saveAud(this, {{ slot.id }})"
                                                   onkeypress="if(event.key==='Enter') saveAud(this, {{ slot.id }})">
                                            {% endif %}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <div class="col-12 mt-5">
            <div class="text-center py-5">
                <i class="bi bi-arrow-up-circle text-primary" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Выберите группу и семестр</h4>
                <p class="text-muted">Для начала работы с расписанием используйте форму выше.</p>
            </div>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Внимание: Конфликт</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="conflictMessage"></p>
                <div class="alert alert-warning">
                    Вы можете проигнорировать это предупреждение и добавить занятие как исключение.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="forceSaveBtn">Все равно сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let draggedData = null;
    let lastAttemptData = null;

    function safeJson(response) {
        return response.text().then(text => {
            try { return JSON.parse(text); } catch(e) { return { success: false, error: 'Invalid JSON response' }; }
        });
    }

    function createSlot(group, day, timeSlot, subject, type, semesterId, isForce = false) {
        fetch('{% url "schedule:create_slot" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                group: group,
                day_of_week: day,
                time_slot: timeSlot,
                subject: subject,
                lesson_type: type,
                semester_id: semesterId,
                force: isForce
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_stream) {
                    console.log('Поток создан');
                }
                location.reload();
            } else {
                if (data.is_conflict) {
                    document.getElementById('conflictMessage').innerHTML = data.error;
                    lastAttemptData = {
                        groupId: group,
                        subjectId: subject,
                        dayOfWeek: day,
                        timeSlot: timeSlot,
                        lessonType: type,
                        semesterId: semesterId
                    };
                    const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
                    modal.show();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            }
        })
        .catch(err => alert('Ошибка сети: ' + err));
    }

    const forceBtn = document.getElementById('forceSaveBtn');
    if (forceBtn) {
        forceBtn.addEventListener('click', function() {
            if (lastAttemptData) {
                createSlot(
                    lastAttemptData.groupId,
                    lastAttemptData.dayOfWeek,
                    lastAttemptData.timeSlot,
                    lastAttemptData.subjectId,
                    lastAttemptData.lessonType,
                    lastAttemptData.semesterId,
                    true
                );
                const modalEl = document.getElementById('conflictModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
            }
        });
    }

    function attachDragHandlers(el) {
        if (!el) return;
        if (el._hasDragHandler) return;
        el._hasDragHandler = true;

        el.addEventListener('dragstart', function(e) {
            const isStream = this.dataset.subjectIsStream === 'true';
            draggedData = {
                subjectId: this.dataset.subjectId,
                subjectName: this.dataset.subjectName,
                subjectType: this.dataset.subjectType,
                teacherName: this.dataset.teacherName || '',
                isStream: isStream, 
                remaining: parseInt(this.dataset.remaining || '0')
            };

            try {
                const img = document.createElement('canvas');
                img.width = img.height = 1;
                e.dataTransfer.setDragImage(img, 0, 0);
            } catch (err) {}

            try { e.dataTransfer.setData('text/plain', JSON.stringify(draggedData)); } catch(e) {}
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.4';
        });

        el.addEventListener('dragend', function() {
            try { this.style.opacity = '1'; } catch(e){}
            draggedData = null;
            stopAutoScroll();
        });
    }


    const milItem = document.getElementById('militaryDragItem');
    if(milItem) {
        milItem.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                isMilitary: true
            }));
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.5';
        });
        milItem.addEventListener('dragend', function() {
            this.style.opacity = '1';
        });
    }

    document.querySelectorAll('.subject-item').forEach(attachDragHandlers);

    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.delete-slot');
        if (!btn) return;
        e.stopPropagation();
        if (!confirm('Удалить занятие? Если это поток, удалится у всех групп.')) return;
        const slotId = btn.dataset.slotId;
        if (!slotId) return;
        fetch('/schedule/constructor/delete/' + slotId + '/', {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
        })
        .then(r => safeJson(r))
        .then(data => {
            if (data.success) {
                location.reload();
            } else alert(data.error || 'Ошибка удаления');
        })
        .catch(err => { alert('Ошибка соединения: ' + (err.message || err)); });
    });

    window.editAud = function(el) {
        if (!el) return;
        const cell = el.closest('.aud-cell');
        const input = cell.querySelector('.aud-input');

        el.style.display = 'none';
        input.style.display = 'block';
        input.focus();
    };

    window.saveAud = function(input, slotId, isForce = false) {
        const val = input.value.trim();
        const cell = input.closest('.aud-cell');
        const display = cell.querySelector('.aud-display');

        fetch(`/schedule/constructor/update-room/${slotId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({
                room: val,
                force: isForce
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                input.style.display = 'none';
                if (display) {
                    display.innerText = data.room || '?';
                    display.style.display = 'inline-block';
                    display.classList.add('bg-success', 'text-white');
                    setTimeout(() => display.classList.remove('bg-success', 'text-white'), 1000);
                }
            } else {
                if (data.is_capacity_warning || data.is_conflict) {
                    if (confirm(data.error + "\n\nНажмите ОК, чтобы назначить принудительно.")) {
                        saveAud(input, slotId, true);
                    } else {
                        input.focus();
                    }
                } else {
                    alert('Ошибка: ' + data.error);
                    input.focus();
                }
            }
        })
        .catch(err => {
            alert('Ошибка сети');
            console.error(err);
        });
    };


    let autoScrollState = {
        active: false,
        direction: 0,
        container: null,
        rafId: null
    };

    function autoScrollStep() {
        try {
            if (!autoScrollState.active) return;
            const dir = autoScrollState.direction;
            const container = autoScrollState.container;
            const step = Math.max(8, Math.min(40, Math.round((container ? container.clientHeight : window.innerHeight) * 0.02)));
            if (container) container.scrollTop += dir * step;
            else window.scrollBy(0, dir * step);
        } finally {
            autoScrollState.rafId = requestAnimationFrame(autoScrollStep);
        }
    }

    function startAutoScroll(direction, container = null) {
        if (autoScrollState.active && autoScrollState.direction === direction && autoScrollState.container === container) return;
        stopAutoScroll();
        autoScrollState.active = true;
        autoScrollState.direction = direction;
        autoScrollState.container = container;
        autoScrollState.rafId = requestAnimationFrame(autoScrollStep);
    }

    function stopAutoScroll() {
        autoScrollState.active = false;
        autoScrollState.direction = 0;
        autoScrollState.container = null;
        if (autoScrollState.rafId) {
            cancelAnimationFrame(autoScrollState.rafId);
            autoScrollState.rafId = null;
        }
    }

    document.addEventListener('dragover', function(e) {
        try {
            e.preventDefault();
            const margin = 120;
            const y = e.clientY;
            const h = window.innerHeight;
            if (y < margin) startAutoScroll(-1, null);
            else if (y > h - margin) startAutoScroll(1, null);
            else stopAutoScroll();
        } catch (ex) { console.error(ex); }
    });

    document.addEventListener('drop', function(e) { stopAutoScroll(); });
    document.addEventListener('dragend', function(e) { stopAutoScroll(); });

    const containerSelectors = ['.card-body.p-0', '.table-responsive'];
    const scrollContainers = [];
    containerSelectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(c => scrollContainers.push(c));
    });

    scrollContainers.forEach(container => {
        container.addEventListener('dragover', function(e) {
            try {
                e.preventDefault();
                const rect = this.getBoundingClientRect();
                const localY = e.clientY - rect.top;
                const margin = Math.min(80, rect.height * 0.18);
                if (localY < margin) startAutoScroll(-1, this);
                else if (localY > rect.height - margin) startAutoScroll(1, this);
                else stopAutoScroll();
            } catch (ex) { console.error(ex); }
        });
        container.addEventListener('dragleave', function(e) { stopAutoScroll(); });
        container.addEventListener('drop', function(e) { stopAutoScroll(); });
    });

    function handleDropZone(cell) {
        if (cell._hasDropHandler) return;
        cell._hasDropHandler = true;

        cell.addEventListener('dragover', function(e) {
            try { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; this.classList.add('drag-over'); } catch(e){}
        });

        cell.addEventListener('dragleave', function(e) {
            try {
                if (!this.contains(e.relatedTarget)) this.classList.remove('drag-over');
            } catch(e) { this.classList.remove('drag-over'); }
        });

        cell.addEventListener('drop', function(e) {
            try {
                e.preventDefault();
                this.classList.remove('drag-over');
                stopAutoScroll();

                if (!draggedData) {
                    try {
                        const txt = e.dataTransfer.getData('text/plain');
                        if (txt) draggedData = JSON.parse(txt);
                    } catch (ex) { /* ignore */ }
                }

                if (!draggedData) return alert('Не удалось определить перетаскиваемый предмет.');

                if (draggedData.isMilitary) {
                    if(!confirm('Установить Военную кафедру на ВЕСЬ этот день? Все текущие пары в этот день будут удалены.')) return;

                    const groupId = this.dataset.groupId;
                    const day = this.dataset.day;
                    const semesterId = document.querySelector('select[name="semester"]').value;

                    fetch('{% url "schedule:create_slot" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                        body: JSON.stringify({
                            is_military_day: true,
                            group: groupId,
                            day_of_week: day,
                            semester_id: semesterId
                        })
                    }).then(r => r.json()).then(resp => {
                        if(resp.success) location.reload();
                        else alert(resp.error);
                    });
                    return;
                }

                if (parseInt(draggedData.remaining || 0) <= 0) {
                    return alert('Достигнут лимит часов для этого предмета!');
                }

                const groupId = this.dataset.groupId;
                const day = this.dataset.day;
                const timeSlot = this.dataset.timeSlot;
                const semesterSelect = document.querySelector('select[name="semester"]');
                const semesterId = semesterSelect ? semesterSelect.value : null;

                if (this.querySelector('.lesson-card')) {
                    alert('Ячейка уже занята. Удалите старое занятие.');
                    return;
                }

                createSlot(groupId, day, timeSlot, draggedData.subjectId, draggedData.subjectType, semesterId);

            } catch (ex) { console.error(ex); }
            finally {
                draggedData = null;
            }
        });
    }

    document.querySelectorAll('.schedule-drop-zone').forEach(handleDropZone);

    try {
        const mo = new MutationObserver(muts => {
            for (const m of muts) {
                if (m.addedNodes && m.addedNodes.length) {
                    m.addedNodes.forEach(n => {
                        if (!(n instanceof HTMLElement)) return;
                        if (n.matches && n.matches('.subject-item')) attachDragHandlers(n);
                        n.querySelectorAll && n.querySelectorAll('.subject-item').forEach(attachDragHandlers);
                        if (n.matches && n.matches('.schedule-drop-zone')) handleDropZone(n);
                        n.querySelectorAll && n.querySelectorAll('.schedule-drop-zone').forEach(handleDropZone);
                    });
                }
            }
        });
        mo.observe(document.body, { childList: true, subtree: true });
    } catch (e) { }
});
</script>

<style>
.schedule-table {
    font-size: 0.85rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
    vertical-align: middle !important;
}

.schedule-drop-zone {
    min-height: 60px !important;
    background-color: #fff;
    border: 2px dashed transparent;
    transition: all 0.2s;
    position: relative;
    cursor: crosshair;
}

.schedule-drop-zone .empty-slot {
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    font-size: 0.75rem;
}

.schedule-drop-zone:hover {
    background-color: #f8f9fa;
    border-color: #ccc;
}

.schedule-drop-zone.drag-over {
    background-color: #d1e7dd !important;
    border-color: #198754 !important;
    border-style: solid !important;
}

.lesson-card {
    position: relative;
    min-height: 50px;
}

.subject-item {
    cursor: move;
    transition: all 0.2s;
    user-select: none;
}

.subject-item:hover {
    background-color: #f0f0f0;
    transform: translateX(3px);
}

.subject-item:active {
    opacity: 0.5;
}

.aud-cell {
    background-color: #f8f9fa;
    vertical-align: middle !important;
}

.aud-display:hover {
    background-color: #e9ecef;
    cursor: pointer;
}
</style>
{% endblock %}
