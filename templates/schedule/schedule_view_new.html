{% extends 'base.html' %}
{% load static %}
{% load schedule_filters %}

{% block title %}Расписание{% endblock %}

{% block content %}
<div class="row mt-4">
    <!-- Выбор группы для декана или просмотр для студента/преподавателя -->
    {% if user.role == 'DEAN' %}
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> Выбор группы
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Группа</label>
                            <select class="form-select" name="group" onchange="this.form.submit()">
                                <option value="">Выбрать...</option>
                                {% for g in groups %}
                                    <option value="{{ g.id }}" {% if group and group.id == g.id %}selected{% endif %}>
                                        {{ g.name }} - {{ g.specialty|truncatewords:8 }} ({{ g.students.count }} чел.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if group or user.role != 'DEAN' %}
    <!-- Расписание в табличном формате -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-calendar-week"></i> ҶАДВАЛИ ДАРСӢ
                    {% if group %}- {{ group.name }}{% endif %}
                </span>
                <div>
                    <a href="{% url 'schedule:export' %}{% if group %}?group={{ group.id }}{% endif %}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Экспорт
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px; vertical-align: middle; text-align: center;">
                                    <strong>ҲАФТА<br>СОАТ</strong>
                                </th>
                                <th style="width: 45%;">Дарс / Устод</th>
                                <th style="width: 60px;">АУД</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <!-- Заголовок дня -->
                                <tr class="table-secondary">
                                    <td colspan="3" class="text-center">
                                        <strong>{{ day_name }}</strong>
                                    </td>
                                </tr>
                                
                                <!-- Временные слоты для этого дня -->
                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center align-middle">
                                            <strong style="font-size: 0.9rem;">{{ time_slot.start_time|time:"H" }}<sup>{{ time_slot.start_time|time:"i" }}</sup>-{{ time_slot.end_time|time:"H" }}<sup>{{ time_slot.end_time|time:"i" }}</sup></strong>
                                        </td>
                                        
                                        {% with slot=schedule_data|get_slot:group.id|get_slot:day_num|get_slot:time_slot.id %}
                                        <td class="p-2">
                                            {% if slot %}
                                            <div>
                                                <strong style="font-size: 0.9rem;">{{ slot.subject.name }} ({{ slot.subject.get_type_display }})</strong><br>
                                                <small class="text-muted">{{ slot.teacher.user.get_full_name|default:'—' }}</small><br>
                                                <small class="text-muted">{{ slot.subject.credits }} кр. | {{ slot.subject.hours_per_semester }} ч.</small>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle text-center" style="font-size: 0.85rem;">
                                            {% if slot %}
                                                <strong>{{ slot.room|default:'—' }}</strong>
                                            {% endif %}
                                        </td>
                                        {% endwith %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> Выберите группу для просмотра расписания
            </div>
        </div>
    {% endif %}
</div>

<style>
.schedule-table {
    font-size: 0.85rem;
}

.schedule-table th, .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}
</style>
{% endblock %}