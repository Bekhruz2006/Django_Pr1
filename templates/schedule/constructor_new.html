{% extends 'base.html' %}
{% load static %}

{% block title %}–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è{% endblock %}
{% load schedule_filters %}
{% block content %}
<div class="row mt-4">
    <!-- –í—ã–±–æ—Ä –≥—Ä—É–ø–ø -->
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-people"></i> –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            </div>
            <div class="card-body">
                <form method="get" id="groupSelectionForm">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label">–ì—Ä—É–ø–ø–∞ 1 (–ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞)</label>
                            <select class="form-select" name="group1" id="group1Select">
                                <option value="">–í—ã–±—Ä–∞—Ç—å...</option>
                                {% for group in groups %}
                                    <option value="{{ group.id }}" 
                                            {% if group1 and group1.id == group.id %}selected{% endif %}>
                                        {{ group.name }} - {{ group.specialty|truncatewords:5 }} ({{ group.students.count }} —á–µ–ª.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">–ì—Ä—É–ø–ø–∞ 2 (–ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞)</label>
                            <select class="form-select" name="group2" id="group2Select">
                                <option value="">–í—ã–±—Ä–∞—Ç—å...</option>
                                {% for group in groups %}
                                    <option value="{{ group.id }}"
                                            {% if group2 and group2.id == group.id %}selected{% endif %}>
                                        {{ group.name }} - {{ group.specialty|truncatewords:5 }} ({{ group.students.count }} —á–µ–ª.)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if group1 or group2 %}
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –ü—Ä–µ–¥–º–µ—Ç—ã -->
    <div class="col-lg-2">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <i class="bi bi-book"></i> –ü—Ä–µ–¥–º–µ—Ç—ã
            </div>
            <div class="card-body p-0" style="max-height: 700px; overflow-y: auto;">
                <div class="list-group list-group-flush" id="subjectsList">
                    {% for subject in subjects %}
                        <div class="list-group-item subject-item p-2"
                             draggable="true"
                             data-subject-id="{{ subject.id }}"
                             data-subject-name="{{ subject.name }}"
                             data-subject-type="{{ subject.get_type_display }}"
                             data-teacher-name="{{ subject.teacher.user.get_full_name|default:'–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' }}"
                             style="cursor: move; font-size: 0.8rem;">
                            <strong>{{ subject.name }}</strong><br>
                            <small class="text-muted">{{ subject.teacher.user.get_full_name|default:'‚Äî' }}</small><br>
                            <span class="badge bg-{{ subject.get_color_class }}">{{ subject.get_type_display }}</span>
                        </div>
                    {% empty %}
                        <div class="list-group-item text-muted small">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ß–ê–°–¢–¨: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ç–∞–±–ª–∏—Ü—ã -->
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-week"></i> “∂–ê–î–í–ê–õ–ò –î–ê–†–°”¢</span>
                <div>
                    <a href="{% url 'schedule:manage_academic_week' %}" class="btn btn-light btn-sm">
                        <i class="bi bi-calendar-range"></i> –ù–µ–¥–µ–ª–∏
                    </a>
                    <a href="{% url 'schedule:export_new_format' %}?group1={{ group1.id|default:'' }}&group2={{ group2.id|default:'' }}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç DOCX
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 schedule-table-new">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2" style="width: 100px; vertical-align: middle; text-align: center;">
                                    <strong>“≤–ê–§–¢–ê</strong><br>
                                    <strong>–°–û–ê–¢</strong>
                                </th>
                                {% if group1 %}
                                <th colspan="2" class="text-center bg-primary bg-opacity-10">
                                    <strong>{{ group1.name }}</strong><br>
                                    <small>{{ group1.specialty|truncatewords:8 }} ({{ group1.students.count }} –Ω–∞—Ñ–∞—Ä)</small>
                                </th>
                                {% endif %}
                                {% if group2 %}
                                <th colspan="2" class="text-center bg-success bg-opacity-10">
                                    <strong>{{ group2.name }}</strong><br>
                                    <small>{{ group2.specialty|truncatewords:8 }} ({{ group2.students.count }} –Ω–∞—Ñ–∞—Ä)</small>
                                </th>
                                {% endif %}
                            </tr>
                            <tr>
                                {% if group1 %}
                                <th style="width: 40%;">–î–∞—Ä—Å / –£—Å—Ç–æ–¥</th>
                                <th style="width: 60px; font-size: 0.85rem;">–ê–£–î</th>
                                {% endif %}
                                {% if group2 %}
                                <th style="width: 40%;">–î–∞—Ä—Å / –£—Å—Ç–æ–¥</th>
                                <th style="width: 60px; font-size: 0.85rem;">–ê–£–î</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_num, day_name in days %}
                                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è -->
                                <tr class="table-secondary">
                                    <td colspan="{{ colspan }}" class="text-center">
                                        <strong>{{ day_name }}</strong>
                                    </td>
                                </tr>
                                
                                <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è -->
                                {% for time_slot in time_slots %}
                                    <tr>
                                        <td class="text-center align-middle time-cell">
                                            <strong>{{ time_slot.start_time|time:"H" }}<sup>{{ time_slot.start_time|time:"i" }}</sup>-{{ time_slot.end_time|time:"H" }}<sup>{{ time_slot.end_time|time:"i" }}</sup></strong>
                                        </td>
                                        
                                        {% if group1 %}
                                            {% with slot=schedule_data|get_slot:group1.id|get_slot:day_num|get_slot:time_slot.id %}
                                            <td class="schedule-drop-zone p-2"
                                                data-group-id="{{ group1.id }}"
                                                data-day="{{ day_num }}"
                                                data-time-slot="{{ time_slot.id }}">
                                                {% if slot %}
                                                <div class="lesson-content" data-slot-id="{{ slot.id }}">
                                                    <strong style="font-size: 0.9rem;">{{ slot.subject.name }} ({{ slot.subject.get_type_display }})</strong><br>
                                                    <small class="text-muted">{{ slot.teacher.user.get_full_name|default:'‚Äî' }}</small>
                                                    <button class="btn btn-sm btn-danger delete-slot float-end" 
                                                            data-slot-id="{{ slot.id }}" 
                                                            style="font-size: 0.7rem; padding: 2px 6px;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td class="aud-cell align-middle text-center" 
                                                style="font-size: 0.85rem; cursor: pointer;"
                                                {% if slot %}data-slot-id="{{ slot.id }}"{% endif %}>
                                                {% if slot %}
                                                <div class="aud-display" onclick="editAud(this)">
                                                    <strong>{{ slot.room|default:'?' }}</strong>
                                                </div>
                                                <input type="text" 
                                                       class="form-control form-control-sm aud-input" 
                                                       value="{{ slot.room|default:'' }}"
                                                       maxlength="10"
                                                       style="display: none; width: 100%; font-size: 0.8rem;"
                                                       onblur="saveAud(this, {{ slot.id }})"
                                                       onkeypress="if(event.key==='Enter') saveAud(this, {{ slot.id }})">
                                                {% endif %}
                                            </td>
                                            {% endwith %}
                                        {% endif %}
                                        
                                        {% if group2 %}
                                            {% with slot=schedule_data|get_slot:group2.id|get_slot:day_num|get_slot:time_slot.id %}
                                            <td class="schedule-drop-zone p-2"
                                                data-group-id="{{ group2.id }}"
                                                data-day="{{ day_num }}"
                                                data-time-slot="{{ time_slot.id }}">
                                                {% if slot %}
                                                <div class="lesson-content" data-slot-id="{{ slot.id }}">
                                                    <strong style="font-size: 0.9rem;">{{ slot.subject.name }} ({{ slot.subject.get_type_display }})</strong><br>
                                                    <small class="text-muted">{{ slot.teacher.user.get_full_name|default:'‚Äî' }}</small>
                                                    <button class="btn btn-sm btn-danger delete-slot float-end" 
                                                            data-slot-id="{{ slot.id }}"
                                                            style="font-size: 0.7rem; padding: 2px 6px;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td class="aud-cell align-middle text-center" 
                                                style="font-size: 0.85rem; cursor: pointer;"
                                                {% if slot %}data-slot-id="{{ slot.id }}"{% endif %}>
                                                {% if slot %}
                                                <div class="aud-display" onclick="editAud(this)">
                                                    <strong>{{ slot.room|default:'?' }}</strong>
                                                </div>
                                                <input type="text" 
                                                       class="form-control form-control-sm aud-input" 
                                                       value="{{ slot.room|default:'' }}"
                                                       maxlength="10"
                                                       style="display: none; width: 100%; font-size: 0.8rem;"
                                                       onblur="saveAud(this, {{ slot.id }})"
                                                       onkeypress="if(event.key==='Enter') saveAud(this, {{ slot.id }})">
                                                {% endif %}
                                            </td>
                                            {% endwith %}
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
        <div class="alert alert-info mt-3">
            <h6><i class="bi bi-info-circle"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h6>
            <ol class="mb-0">
                <li>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏–∑ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –≤ –Ω—É–∂–Ω—É—é —è—á–µ–π–∫—É</li>
                <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–ê–£–î) —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ</li>
                <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã</li>
                <li>–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ <i class="bi bi-trash text-danger"></i></li>
            </ol>
        </div>
    </div>
    {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            </div>
        </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ -->
<div class="modal fade" id="conflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> –ö–æ–Ω—Ñ–ª–∏–∫—Ç</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="conflictMessage"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<style>
/* –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è */
.schedule-table-new {
    font-size: 0.85rem;
}

.schedule-table-new th, .schedule-table-new td {
    border: 1px solid #dee2e6;
    padding: 8px;
    vertical-align: top;
}

.time-cell {
    background-color: #f8f9fa;
    font-weight: bold;
}

.schedule-drop-zone {
    min-height: 60px;
    background-color: #fff;
    border: 2px dashed transparent;
    transition: all 0.2s;
    position: relative;
}

.schedule-drop-zone:hover {
    background-color: #f8f9fa;
}

.schedule-drop-zone.drag-over {
    background-color: #d1e7dd;
    border-color: #198754;
    border-style: solid;
}

/* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —É—Ä–æ–∫–∞ */
.lesson-content {
    position: relative;
    padding: 4px;
}

/* –Ø—á–µ–π–∫–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ */
.aud-cell {
    background-color: #f8f9fa;
}

.aud-display:hover {
    background-color: #e9ecef;
    cursor: pointer;
}

/* –ü—Ä–µ–¥–º–µ—Ç—ã */
.subject-item {
    cursor: move;
    transition: all 0.2s;
    user-select: none;
}

.subject-item:hover {
    background-color: #f0f0f0;
    transform: translateX(3px);
}

.subject-item:active {
    opacity: 0.5;
}

/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
.delete-slot {
    opacity: 0.7;
}

.delete-slot:hover {
    opacity: 1;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ù–æ–≤—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');

    // CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    let draggedData = {};

    // === DRAG AND DROP ===
    const subjectItems = document.querySelectorAll('.subject-item');
    subjectItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedData = {
                subjectId: this.dataset.subjectId,
                subjectName: this.dataset.subjectName,
                subjectType: this.dataset.subjectType,
                teacherName: this.dataset.teacherName
            };
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.4';
        });

        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
        });
    });

    // Drop –∑–æ–Ω—ã
    const dropZones = document.querySelectorAll('.schedule-drop-zone');
    dropZones.forEach(cell => {
        cell.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        cell.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });

        cell.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const groupId = this.dataset.groupId;
            const dayOfWeek = this.dataset.day;
            const timeSlot = this.dataset.timeSlot;

            if (!draggedData.subjectId) return;

            createScheduleSlot(groupId, draggedData.subjectId, dayOfWeek, timeSlot, this);
        });
    });

    // === –°–û–ó–î–ê–ù–ò–ï –ó–ê–ù–Ø–¢–ò–Ø ===
    function createScheduleSlot(groupId, subjectId, dayOfWeek, timeSlot, cellElement) {
        const originalContent = cellElement.innerHTML;
        cellElement.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

        fetch('/schedule/constructor/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                group: groupId,
                subject: subjectId,
                day_of_week: dayOfWeek,
                time_slot: timeSlot
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            } else {
                cellElement.innerHTML = originalContent;
                showConflictModal(data.error, data.conflicts || []);
            }
        })
        .catch(error => {
            cellElement.innerHTML = originalContent;
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
        });
    }

    // === –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ù–Ø–¢–ò–Ø ===
    document.querySelectorAll('.delete-slot').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ?')) return;

            const slotId = this.dataset.slotId;
            fetch(`/schedule/constructor/delete/${slotId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showNotification('‚ùå ' + data.error, 'danger');
                }
            });
        });
    });

    // === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ===
    function showConflictModal(message, conflicts) {
        const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
        const messageEl = document.getElementById('conflictMessage');
        
        let html = `<div class="alert alert-danger"><strong>${message}</strong></div>`;
        if (conflicts && conflicts.length > 0) {
            html += '<ul>';
            conflicts.forEach(c => html += `<li>${c}</li>`);
            html += '</ul>';
        }
        
        messageEl.innerHTML = html;
        modal.show();
    }

    // === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
    function showNotification(message, type) {
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
            document.body.appendChild(container);
        }

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        container.appendChild(alert);

        setTimeout(() => alert.remove(), 4000);
    }
});

// === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ê–£–î–ò–¢–û–†–ò–ò ===
function editAud(element) {
    const display = element;
    const input = element.nextElementSibling;
    
    display.style.display = 'none';
    input.style.display = 'block';
    input.focus();
    input.select();
}

function saveAud(input, slotId) {
    const display = input.previousElementSibling;
    const value = input.value.trim();
    
    fetch(`/schedule/constructor/update-room/${slotId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ room: value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            display.querySelector('strong').textContent = data.room || '?';
            display.style.display = 'block';
            input.style.display = 'none';
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}