{% extends 'base.html' %}

{% block title %}{{ title|default:"Добавить предмет" }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-lg-10 mx-auto">
        <form method="post" id="subject-form">
            {% csrf_token %}
            <div class="card shadow border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-book-half"></i> {{ title|default:"Добавить предмет" }}</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">{{ form.name.label_tag }} {{ form.name }}</div>
                        <div class="col-md-3">{{ form.code.label_tag }} {{ form.code }}</div>
                        <div class="col-md-3">{{ form.semester_weeks.label_tag }} {{ form.semester_weeks }}</div>
                    </div>

                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label class="fw-bold text-primary">Введите количество кредитов:</label>
                                    {{ form.total_credits_calc }}
                                </div>
                                <div class="col-md-8">
                                    <div class="alert alert-info mb-0 py-2">
                                        <i class="bi bi-info-circle"></i>
                                        <b>Логика:</b> 1 кредит = 24 часа. <br>
                                        2/3 времени — аудиторные (Л, А, СРСП), 1/3 — самостоятельная работа (КМД).
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="small fw-bold">Лекции (Л), ч.</label>
                            {{ form.lecture_hours }}
                            <div class="mt-1 small text-muted">Пар в неделю: <span id="view_l_slots" class="badge bg-primary">0</span></div>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold">Практика (А), ч.</label>
                            {{ form.practice_hours }}
                            <div class="mt-1 small text-muted">Пар в неделю: <span id="view_p_slots" class="badge bg-success">0</span></div>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold">СРСП (КМРО), ч.</label>
                            {{ form.control_hours }}
                            <div class="mt-1 small text-muted">Пар в неделю: <span id="view_c_slots" class="badge bg-warning text-dark">0</span></div>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold">КМД (Самост.), ч.</label>
                            {{ form.independent_work_hours }}
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">{{ form.teacher.label_tag }} {{ form.teacher }}</div>
                        <div class="col-md-6">{{ form.groups.label_tag }} {{ form.groups }}</div>
                    </div>
                </div>
                <div class="card-footer bg-white py-3">
                    <button type="submit" class="btn btn-success px-5"><i class="bi bi-check-lg"></i> Сохранить предмет</button>
                    <a href="{% url 'schedule:manage_subjects' %}" class="btn btn-light">Отмена</a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calcInput = document.getElementById('id_total_credits_calc');
    const weeksInput = document.getElementById('id_semester_weeks');
    
    const lecInput = document.getElementById('id_lecture_hours');
    const pracInput = document.getElementById('id_practice_hours');
    const ctrlInput = document.getElementById('id_control_hours');
    const kmdInput = document.getElementById('id_independent_work_hours');

    const viewL = document.getElementById('view_l_slots');
    const viewP = document.getElementById('view_p_slots');
    const viewC = document.getElementById('view_c_slots');

    function updateSlotPreview() {
        const weeks = parseInt(weeksInput.value) || 16;
        viewL.textContent = Math.round((parseInt(lecInput.value) || 0) / weeks);
        viewP.textContent = Math.round((parseInt(pracInput.value) || 0) / weeks);
        viewC.textContent = Math.round((parseInt(ctrlInput.value) || 0) / weeks);
    }

    function runAutoCalculation() {
        const credits = parseInt(calcInput.value) || 0;
        if (credits <= 0) return;

        const totalHours = credits * 24;
        const kmdHours = Math.round(totalHours / 3); 
        const auditoryHours = totalHours - kmdHours; 
        
        const part = Math.floor(auditoryHours / 3);

        lecInput.value = part;
        pracInput.value = part;
        ctrlInput.value = auditoryHours - (part * 2); 
        kmdInput.value = kmdHours;

        updateSlotPreview();

        [lecInput, pracInput, ctrlInput, kmdInput].forEach(el => {
            el.style.backgroundColor = '#e8f0fe';
            setTimeout(() => el.style.backgroundColor = '', 1000);
        });
    }

    if(calcInput) calcInput.addEventListener('input', runAutoCalculation);
    
    [lecInput, pracInput, ctrlInput, weeksInput].forEach(el => {
        if(el) el.addEventListener('input', updateSlotPreview);
    });

    updateSlotPreview();
});
</script>
{% endblock %}